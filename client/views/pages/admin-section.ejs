<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Section</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="/assets/css/pages/admin-section.css" />
</head>
<body>
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-admin') %>

  <main class="main-content admin-section-main py-5">
    <header class="mb-4">
      <h1 class="h3 mb-1">Admin Section</h1>
      <p class="text-muted mb-0">
        Configure how KeepUP behaves for your company. Tabs below will expand as new tools land.
      </p>
    </header>

    <div class="card shadow-sm">
      <div class="card-body">
        <% const showImpersonationTab = permissions && permissions.canUseImpersonation; %>
        <% const showPlatformBillingTab = permissions && permissions.isPlatformAdmin; %>
        <nav class="admin-tabs mb-4" aria-label="Admin tabs">
          <ul class="nav nav-pills flex-wrap gap-2" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="admin-tab-company" data-admin-target="company" type="button" role="tab" aria-controls="admin-panel-company" aria-selected="true">
                Company
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="admin-tab-users" data-admin-target="users" type="button" role="tab" aria-controls="admin-panel-users" aria-selected="false">
                Users
              </button>
            </li>
            <% if (showImpersonationTab) { %>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="admin-tab-impersonation" data-admin-target="impersonation" type="button" role="tab" aria-controls="admin-panel-impersonation" aria-selected="false">
                  Impersonation
                </button>
              </li>
            <% } %>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="admin-tab-billing" data-admin-target="billing" type="button" role="tab" aria-controls="admin-panel-billing" aria-selected="false">
                Billing
              </button>
            </li>
            <% if (showPlatformBillingTab) { %>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="admin-tab-platform-billing" data-admin-target="platform-billing" type="button" role="tab" aria-controls="admin-panel-platform-billing" aria-selected="false">
                  Platform Billing
                </button>
              </li>
            <% } %>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="admin-tab-settings" data-admin-target="settings" type="button" role="tab" aria-controls="admin-panel-settings" aria-selected="false">
                Settings
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="admin-tab-buildrootz" data-admin-target="buildrootz" type="button" role="tab" aria-controls="admin-panel-buildrootz" aria-selected="false">
                BuildRootz
              </button>
            </li>
          </ul>
        </nav>

        <section id="admin-panel-company" class="admin-panel" role="tabpanel" aria-labelledby="admin-tab-company">
          <h2 class="h4 mb-3">Company Info</h2>
          <p class="text-muted mb-4">
            These settings personalize KeepUP for your team. Changes here stay scoped to your company.
          </p>

          <form id="company-settings-form" class="row g-4">
            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Company Details</h3>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="companyName" class="form-label">Company Name</label>
                  <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Keep Up Homes" />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Company Address</h3>
              <div class="row g-3">
                <div class="col-12">
                  <label for="companyStreet" class="form-label">Street</label>
                  <input type="text" id="companyStreet" name="street" class="form-control" placeholder="123 Main Street" />
                </div>
                <div class="col-md-4">
                  <label for="companyCity" class="form-label">City</label>
                  <input type="text" id="companyCity" name="city" class="form-control" placeholder="Austin" />
                </div>
                <div class="col-md-4">
                  <label for="companyState" class="form-label">State</label>
                  <input type="text" id="companyState" name="state" class="form-control" placeholder="TX" />
                </div>
                <div class="col-md-4">
                  <label for="companyZip" class="form-label">ZIP</label>
                  <input type="text" id="companyZip" name="zip" class="form-control" placeholder="78701" />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Primary Contact</h3>
              <div class="row g-3">
                <div class="col-md-4">
                  <label for="primaryName" class="form-label">Name</label>
                  <input type="text" id="primaryName" name="primaryName" class="form-control" placeholder="Jane Smith" />
                </div>
                <div class="col-md-4">
                  <label for="primaryEmail" class="form-label">Email</label>
                  <input type="email" id="primaryEmail" name="primaryEmail" class="form-control" placeholder="jane@keepup.com" />
                </div>
                <div class="col-md-4">
                  <label for="primaryPhone" class="form-label">Phone</label>
                  <input type="tel" id="primaryPhone" name="primaryPhone" class="form-control" placeholder="(555) 555-5555" />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Branding</h3>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="companyLogo" class="form-label">Logo URL</label>
                  <input type="url" id="companyLogo" name="logo" class="form-control" placeholder="https://example.com/logo.png" />
                  <div class="form-text">Link to a high-resolution PNG or SVG.</div>
                </div>
                <div class="col-md-3">
                  <label for="colorPrimary" class="form-label">Primary Color</label>
                  <input type="color" id="colorPrimary" name="primaryColor" class="form-control form-control-color" value="#cc1d1d" title="Choose primary brand color" />
                </div>
                <div class="col-md-3">
                  <label for="colorSecondary" class="form-label">Secondary Color</label>
                  <input type="color" id="colorSecondary" name="secondaryColor" class="form-control form-control-color" value="#1f3c88" title="Choose secondary brand color" />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Timezone</h3>
              <div class="col-md-4">
                <label for="companyTimezone" class="form-label">Default Timezone</label>
                <select id="companyTimezone" name="timezone" class="form-select">
                  <option value="">Select timezone...</option>
                  <option value="America/New_York">Eastern (ET)</option>
                  <option value="America/Chicago">Central (CT)</option>
                  <option value="America/Denver">Mountain (MT)</option>
                  <option value="America/Los_Angeles">Pacific (PT)</option>
                </select>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Internal Notes</h3>
              <textarea id="companyNotes" name="notes" class="form-control" rows="4" placeholder="Keep internal reminders here."></textarea>
            </div>

            <div class="col-12 d-flex justify-content-end gap-2 align-items-center flex-wrap">
              <div id="company-settings-status" class="small text-muted me-auto"></div>
              <div class="d-flex gap-2">
                <button type="reset" class="btn btn-outline-secondary">Discard</button>
                <button type="submit" class="btn btn-primary" id="company-settings-save">Save Company Settings</button>
              </div>
            </div>
          </form>
        </section>

        <section id="admin-panel-users" class="admin-panel d-none" role="tabpanel" aria-labelledby="admin-tab-users">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
            <div>
              <h2 class="h4 mb-1">Team Members</h2>
              <p class="text-muted mb-0">
                Review the users tied to your company, along with their access, scope, and activity status.
              </p>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <button type="button" class="btn btn-outline-primary" id="admin-users-edit-toggle">
                Edit Users
              </button>
              <button type="button" class="btn btn-secondary" id="admin-users-invite-toggle">
                Invite User
              </button>
            </div>
          </div>
          <div class="alert alert-light border small mb-3 d-none" id="admin-users-seat-banner"></div>

          <div id="admin-users-invite-card" class="card mb-3 d-none">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div>
                  <h3 class="h6 mb-1">Invite a teammate</h3>
                  <p class="text-muted mb-0">Invites are scoped to your company automatically.</p>
                </div>
              </div>
              <form id="admin-users-invite-form" class="row gy-3 gx-3">
                <div class="col-md-6">
                  <label class="form-label" for="adminInviteEmail">Email</label>
                  <input type="email" class="form-control" id="adminInviteEmail" name="email" required placeholder="teammate@company.com" />
                </div>
                <div class="col-md-3">
                  <label class="form-label" for="adminInviteFirstName">First name</label>
                  <input type="text" class="form-control" id="adminInviteFirstName" name="firstName" />
                </div>
                <div class="col-md-3">
                  <label class="form-label" for="adminInviteLastName">Last name</label>
                  <input type="text" class="form-control" id="adminInviteLastName" name="lastName" />
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="adminInvitePhone">Phone</label>
                  <input type="tel" class="form-control" id="adminInvitePhone" name="phone" placeholder="(555) 555-5555" />
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="adminInviteRole">Role</label>
                  <select class="form-select" id="adminInviteRole" name="role"></select>
                </div>
                <div class="col-12 d-flex justify-content-end gap-2 align-items-center flex-wrap">
                  <div id="admin-users-invite-status" class="small text-muted me-auto"></div>
                  <button type="button" class="btn btn-outline-secondary" id="admin-users-invite-cancel">Cancel</button>
                  <button type="submit" class="btn btn-primary">Send Invite</button>
                </div>
              </form>
            </div>
          </div>

          <div id="admin-users-loading" class="text-muted">
            Loading users&hellip;
          </div>

          <div id="admin-users-error" class="alert alert-danger d-none" role="alert"></div>

          <div id="admin-users-list" class="table-responsive d-none">
            <table class="table table-striped table-hover table-sm align-middle" id="admin-users-table">
              <thead class="table-light">
                <tr>
                  <th scope="col">First Name</th>
                  <th scope="col">Last Name</th>
                  <th scope="col">Email</th>
                  <th scope="col">Password</th>
                  <th scope="col">Phone</th>
                  <th scope="col">Role</th>
                  <th scope="col">Status</th>
                  <th scope="col">Communities</th>
                  <th scope="col">Manager</th>
                  <th scope="col" class="text-end d-none" id="admin-users-actions-header">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="10" class="text-center text-muted">Loading users&hellip;</td>
                </tr>
              </tbody>
            </table>
        </div>
      </section>

        <% if (showImpersonationTab) { %>
        <section id="admin-panel-impersonation" class="admin-panel d-none" role="tabpanel" aria-labelledby="admin-tab-impersonation">
          <h2 class="h4 mb-3">Impersonation Mode</h2>
          <p class="text-muted mb-3">
            Temporarily adopt a company's context to troubleshoot issues or configure settings on their behalf. You'll retain SUPER ADMIN privileges while impersonating.
          </p>

          <div id="impersonation-status" class="alert <%= permissions.isImpersonating ? 'alert-warning' : 'alert-info' %>">
            <% if (permissions.isImpersonating && permissions.impersonation) { %>
              Currently impersonating <strong><%= permissions.impersonation.companyName || permissions.impersonation.companyId %></strong>.
              Any tenant-scoped views and APIs will respect this company until you stop impersonating.
            <% } else { %>
              Not impersonating any company. Select one below to assume their context.
            <% } %>
          </div>

          <div class="row g-3 align-items-end mb-3">
            <div class="col-md-5">
              <label for="impersonation-search" class="form-label">Find company</label>
              <input type="search" id="impersonation-search" class="form-control" placeholder="Search by name or slug" />
            </div>
            <div class="col-auto d-flex gap-2">
              <button type="button" class="btn btn-outline-primary" id="impersonation-search-button">Search</button>
              <button type="button" class="btn btn-outline-secondary <%= permissions.isImpersonating ? '' : 'd-none' %>" id="impersonation-clear-button">
                Stop impersonating
              </button>
            </div>
          </div>

          <div id="impersonation-error" class="alert alert-danger d-none" role="alert"></div>
          <div id="impersonation-loading" class="text-muted d-none">Loading companies...</div>

          <div class="table-responsive" id="impersonation-results">
            <table class="table table-striped table-hover table-sm align-middle" id="impersonation-table">
              <thead class="table-light">
                <tr>
                  <th scope="col">Company</th>
                  <th scope="col">Slug</th>
                  <th scope="col" class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" class="text-center text-muted py-4">Use the search to load companies.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="row g-4 mt-4">
            <div class="col-lg-6">
              <div class="card shadow-sm h-100">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h3 class="h6 mb-0">Create Company</h3>
                    <span class="badge bg-secondary">SUPER ADMIN</span>
                  </div>
                </div>
                <div class="card-body">
                  <form id="impersonation-create-company-form" class="row g-3">
                    <div class="col-12">
                      <label for="impersonationCompanyName" class="form-label">Company Name</label>
                      <input type="text" id="impersonationCompanyName" name="companyName" class="form-control" placeholder="Acme Homes" required />
                    </div>
                    <div class="col-12">
                      <label for="impersonationCompanySlug" class="form-label">Slug (optional)</label>
                      <input type="text" id="impersonationCompanySlug" name="slug" class="form-control" placeholder="acme-homes" />
                      <div class="form-text">Used in URLs; leave blank to auto-generate later.</div>
                    </div>
                    <div class="col-12 d-flex justify-content-between align-items-center">
                      <div id="impersonation-create-company-status" class="small text-muted"></div>
                      <button type="submit" class="btn btn-primary">Create Company</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card shadow-sm h-100">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h3 class="h6 mb-0">Create User</h3>
                    <span class="badge bg-secondary">SUPER ADMIN</span>
                  </div>
                </div>
                <div class="card-body">
                  <form id="impersonation-create-user-form" class="row g-3">
                    <div class="col-md-6">
                      <label for="impersonationUserEmail" class="form-label">Email</label>
                      <input type="email" id="impersonationUserEmail" name="email" class="form-control" placeholder="user@company.com" required />
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserPassword" class="form-label">Temporary Password</label>
                      <input type="text" id="impersonationUserPassword" name="password" class="form-control" placeholder="At least 8 characters" required />
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserFirstName" class="form-label">First Name</label>
                      <input type="text" id="impersonationUserFirstName" name="firstName" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserLastName" class="form-label">Last Name</label>
                      <input type="text" id="impersonationUserLastName" name="lastName" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserPhone" class="form-label">Phone</label>
                      <input type="tel" id="impersonationUserPhone" name="phone" class="form-control" placeholder="(555) 555-5555" />
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserRole" class="form-label">Role</label>
                      <select id="impersonationUserRole" name="role" class="form-select" required>
                        <option value="USER">User</option>
                        <option value="MANAGER">Manager</option>
                        <option value="COMPANY_ADMIN">Company Admin</option>
                        <option value="SUPER_ADMIN">Super Admin</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserStatus" class="form-label">Status</label>
                      <select id="impersonationUserStatus" name="status" class="form-select">
                        <option value="ACTIVE" selected>Active</option>
                        <option value="INVITED">Invited</option>
                        <option value="SUSPENDED">Suspended</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserCompanyId" class="form-label">Company ID</label>
                      <input
                        type="text"
                        id="impersonationUserCompanyId"
                        name="companyId"
                        class="form-control"
                        placeholder="64e1c..."
                        value="<%= permissions && permissions.isImpersonating && permissions.impersonation ? permissions.impersonation.companyId : '' %>"
                        required
                      />
                      <div class="form-text">Defaults to the impersonated company when available.</div>
                    </div>
                    <div class="col-12 d-flex justify-content-between align-items-center">
                      <div id="impersonation-create-user-status" class="small text-muted"></div>
                      <button type="submit" class="btn btn-primary">Create User</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </section>
        <% } %>

      <section id="admin-panel-billing" class="admin-panel d-none" role="tabpanel" aria-labelledby="admin-tab-billing">
        <h2 class="h4 mb-3">Billing Overview</h2>
        <p class="text-muted mb-4">
          Company Admins can confirm addresses, monitor seat usage, and request upgrades. Platform-level billing stays locked down.
        </p>

          <form id="billing-settings-form" class="row g-4">
            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Billing Contact</h3>
              <div class="row g-3">
                <div class="col-12">
                  <label for="billingStreet" class="form-label">Billing Address</label>
                  <input type="text" id="billingStreet" name="billingStreet" class="form-control" placeholder="456 Builder Way" />
                </div>
                <div class="col-md-4">
                  <label for="billingCity" class="form-label">City</label>
                  <input type="text" id="billingCity" name="billingCity" class="form-control" placeholder="Dallas" />
                </div>
                <div class="col-md-4">
                  <label for="billingState" class="form-label">State</label>
                  <input type="text" id="billingState" name="billingState" class="form-control" placeholder="TX" />
                </div>
                <div class="col-md-4">
                  <label for="billingZip" class="form-label">ZIP</label>
                  <input type="text" id="billingZip" name="billingZip" class="form-control" placeholder="75001" />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Subscription</h3>
              <div class="row g-3">
                <div class="col-md-4">
                  <label for="billingPlan" class="form-label">Plan</label>
                  <input type="text" id="billingPlan" name="billingPlan" class="form-control" value="Growth" readonly />
                  <div class="form-text">Plan labels are managed by the platform team.</div>
                </div>
                <div class="col-md-4">
                  <label for="billingStatus" class="form-label">Billing Status</label>
                  <input type="text" id="billingStatus" name="billingStatus" class="form-control" value="Active" readonly />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Seats</h3>
              <div class="row g-3 align-items-start">
                <div class="col-md-3">
                  <label for="seatsUsed" class="form-label">Seats Used</label>
                  <input type="number" id="seatsUsed" name="seatsUsed" class="form-control" value="0" readonly />
                  <div class="form-text">Active users with login access.</div>
                </div>
                <div class="col-md-3">
                  <label for="seatsInvited" class="form-label">Pending Invites</label>
                  <input type="number" id="seatsInvited" name="seatsInvited" class="form-control" value="0" readonly />
                  <div class="form-text">Invited users who have not accepted yet.</div>
                </div>
                <div class="col-md-3">
                  <label for="seatsMinimumBilled" class="form-label">Minimum billed seats</label>
                  <input type="number" id="seatsMinimumBilled" name="seatsMinimumBilled" class="form-control" value="0" readonly />
                  <div class="form-text" id="seatsMinimumBilledHelper">Baseline billed seats.</div>
                </div>
                <div class="col-md-3">
                  <label for="seatsBilled" class="form-label">Billable seats</label>
                  <input type="number" id="seatsBilled" name="seatsBilled" class="form-control" value="0" readonly />
                  <div class="form-text">Calculated from active users.</div>
                </div>
                <div class="col-12">
                  <div class="form-text">Billing is based on active users with a minimum billed seat count. Add as many team members as needed.</div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Current Usage &amp; Estimated Cost</h3>
              <div class="card shadow-sm billing-summary-card">
                <div class="card-body p-3">
                  <div class="alert alert-info small py-2 mb-2 d-none" id="billing-policy-banner"></div>
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-2" id="billing-summary-table">
                      <thead class="table-light">
                        <tr>
                          <th scope="col">Product</th>
                          <th scope="col">Scope</th>
                          <th scope="col">Quantity</th>
                          <th scope="col" class="text-end">Estimated Monthly</th>
                        </tr>
                      </thead>
                      <tbody id="billing-summary-body">
                        <tr>
                          <td colspan="4" class="text-center text-muted">Loading usage...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <span class="fw-semibold">Estimated Monthly Total: <span id="billing-summary-total">--</span></span>
                    <span class="small text-muted">Billing is managed by the KeepUp team.</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Products &amp; Add-Ons</h3>
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="product-card h-100">
                    <div class="d-flex align-items-start justify-content-between gap-3">
                      <div>
                        <div class="fw-semibold">Buildrootz</div>
                        <div class="form-text">Publish listings and updates to Buildrootz.</div>
                        <div class="small text-muted">Scope: Company</div>
                      </div>
                      <div class="form-check form-switch status-toggle" title="Managed by the KeepUp team">
                        <input class="form-check-input" type="checkbox" id="buildrootzStatusToggle" disabled aria-label="Buildrootz status" title="Managed by the KeepUp team" />
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-3">
                      <span class="fw-semibold" id="buildrootzPriceLabel">Pricing</span>
                      <span class="badge bg-secondary" id="buildrootzStatusBadge">Not enabled</span>
                    </div>
                    <div class="service-detail">
                      <p class="mb-2 small text-muted">Buildrootz listings keep your communities visible in their buyer network.</p>
                      <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="buildrootzRequestButton">Request activation</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="buildrootzCancelButton">Request cancellation</button>
                      </div>
                      <div class="small text-muted mt-2" id="buildrootzRequestStatus"></div>
                      <div class="small text-muted" id="buildrootzCancelStatus"></div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="product-card h-100">
                    <div class="d-flex align-items-start justify-content-between gap-3">
                      <div>
                        <div class="fw-semibold">Website Map</div>
                        <div class="form-text">Generate a sitemap and navigation update bundle. Licensed per community.</div>
                        <div class="small text-muted">Scope: Per community</div>
                      </div>
                      <div class="form-check form-switch status-toggle" title="Managed by the KeepUp team">
                        <input class="form-check-input" type="checkbox" id="websiteMapStatusToggle" disabled aria-label="Website Map status" title="Managed by the KeepUp team" />
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-3">
                      <span class="fw-semibold" id="websiteMapPriceLabel">Pricing</span>
                      <span class="badge bg-secondary" id="websiteMapStatusBadge">Not enabled</span>
                    </div>
                    <div class="service-detail">
                      <p class="mb-2 small text-muted">Website Map keeps your customer-facing pages and layouts in sync.</p>
                      <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="websiteMapRequestButton">Request activation</button>
                        <button type="button" class="btn btn-sm btn-outline-danger" id="websiteMapCancelButton">Request cancellation</button>
                      </div>
                      <div class="small text-muted mt-2" id="websiteMapRequestStatus"></div>
                      <div class="small text-muted" id="websiteMapCancelStatus"></div>
                    </div>
                  </div>
                </div>
                <div class="col-12 d-none" id="websiteMapPanel">
                  <div class="card shadow-sm">
                    <div class="card-body">
                      <div class="d-flex align-items-start justify-content-between gap-3">
                        <div>
                          <h4 class="h6 mb-1" id="websiteMapPanelTitle">Website Map Activation</h4>
                          <p class="text-muted mb-0" id="websiteMapPanelSubtitle">
                            Select communities to start trials or request activation. Managed by the KeepUp team.
                          </p>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                          <button type="button" class="btn btn-sm btn-outline-danger d-none" id="websiteMapCancelAllButton">
                            Cancel all maps
                          </button>
                          <button type="button" class="btn-close" id="websiteMapPanelClose" aria-label="Close"></button>
                        </div>
                      </div>
                      <div class="small text-muted mt-2" id="websiteMapPanelStatus"></div>
                      <div class="table-responsive mt-3">
                        <table class="table table-sm align-middle mb-0">
                          <thead class="table-light">
                            <tr>
                              <th scope="col">Community</th>
                              <th scope="col">Status</th>
                              <th scope="col">Trial Remaining</th>
                              <th scope="col" class="text-end">Action</th>
                            </tr>
                          </thead>
                          <tbody id="websiteMapCommunityTable">
                            <tr>
                              <td colspan="4" class="text-center text-muted">Loading communities...</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 d-flex justify-content-end gap-2">
              <button type="reset" class="btn btn-outline-secondary">Discard</button>
              <button type="submit" class="btn btn-primary">Save Billing Settings</button>
            </div>
          </form>
        </section>

        <% if (showPlatformBillingTab) { %>
        <section id="admin-panel-platform-billing" class="admin-panel d-none" role="tabpanel" aria-labelledby="admin-tab-platform-billing">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
            <div>
              <h2 class="h4 mb-1">Platform Billing</h2>
              <p class="text-muted mb-0">
                Super Admin controls for seats, entitlements, and activation requests.
              </p>
            </div>
            <% if (permissions && permissions.platformAccessLabel) { %>
              <div class="small text-muted">Platform Access: <strong><%= permissions.platformAccessLabel %></strong></div>
            <% } %>
          </div>

          <div class="row g-4">
            <div class="col-lg-4">
              <div class="card shadow-sm h-100">
                <div class="card-body">
                  <div class="d-flex gap-2 mb-3">
                    <input type="search" class="form-control" id="platform-company-search" placeholder="Search companies" />
                    <button type="button" class="btn btn-outline-secondary" id="platform-company-refresh">Refresh</button>
                  </div>
                  <div class="small text-muted mb-2" id="platform-company-status"></div>
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0" id="platform-company-table">
                      <thead class="table-light">
                        <tr>
                          <th scope="col">Company</th>
                          <th scope="col">Seats</th>
                          <th scope="col">Buildrootz</th>
                          <th scope="col">Map</th>
                        </tr>
                      </thead>
                      <tbody id="platform-company-table-body">
                        <tr>
                          <td colspan="4" class="text-center text-muted">Loading companies...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-lg-8">
              <div class="card shadow-sm mb-3">
                <div class="card-body">
                  <div id="platform-company-empty" class="text-muted">
                    Select a company to manage billing controls.
                  </div>
                  <div id="platform-company-detail" class="d-none">
                    <div class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-3">
                      <div>
                        <h3 class="h5 mb-1" id="platform-company-name">Company</h3>
                        <div class="text-muted small" id="platform-company-updated"></div>
                      </div>
                      <button type="button" class="btn btn-outline-secondary btn-sm" id="platform-company-reload">
                        Reload
                      </button>
                    </div>

                    <div class="row g-3 mb-3">
                      <div class="col-md-6">
                        <h4 class="h6 text-uppercase text-muted">Billing Contact</h4>
                        <div class="small text-muted" id="platform-billing-contact"></div>
                      </div>
                      <div class="col-md-6">
                        <h4 class="h6 text-uppercase text-muted">Primary Contact</h4>
                        <div class="small text-muted" id="platform-primary-contact"></div>
                      </div>
                    </div>

                    <div class="row g-3 align-items-end mb-3">
                      <div class="col-md-3">
                        <label class="form-label" for="platform-seats-used">Seats Used</label>
                        <input type="number" class="form-control" id="platform-seats-used" readonly />
                      </div>
                      <div class="col-md-3">
                        <label class="form-label" for="platform-seats-invited">Pending Invites</label>
                        <input type="number" class="form-control" id="platform-seats-invited" readonly />
                      </div>
                      <div class="col-md-3">
                        <label class="form-label" for="platform-seats-minimum">Minimum billed seats</label>
                        <input type="number" class="form-control" id="platform-seats-minimum" readonly />
                        <div class="form-text" id="platform-seats-minimum-helper">Minimum billed seats: --</div>
                      </div>
                      <div class="col-md-3">
                        <label class="form-label" for="platform-seats-billed">Billable seats</label>
                        <input type="number" class="form-control" id="platform-seats-billed" readonly />
                      </div>
                      <div class="col-12">
                        <div class="small text-muted">Billing is based on active users with a minimum billed seat count.</div>
                      </div>
                    </div>

                    <div class="border-top pt-3">
                      <h4 class="h6 text-uppercase text-muted mb-2">Company Products</h4>
                      <div class="row g-3 align-items-center">
                        <div class="col-md-6">
                          <label class="form-label" for="platform-buildrootz-status">Buildrootz Status</label>
                          <select class="form-select" id="platform-buildrootz-status">
                            <option value="inactive">Inactive</option>
                            <option value="active">Active</option>
                            <option value="pending">Pending</option>
                            <option value="trial">Trial</option>
                          </select>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label" for="platform-website-map-enabled">Website Map Enabled</label>
                          <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="platform-website-map-enabled" />
                            <label class="form-check-label" for="platform-website-map-enabled">Enabled for company</label>
                          </div>
                        </div>
                        <div class="col-12 d-flex justify-content-between align-items-center flex-wrap gap-2">
                          <div class="small text-muted" id="platform-features-status"></div>
                          <button type="button" class="btn btn-primary btn-sm" id="platform-features-save">Save Products</button>
                        </div>
                      </div>
                    </div>

                    <div class="border-top pt-3 mt-3">
                      <h4 class="h6 text-uppercase text-muted mb-2">Preset Plans</h4>
                      <div class="row g-3 align-items-end">
                        <div class="col-md-6">
                          <label class="form-label" for="platform-policy-preset">Choose a preset</label>
                          <select class="form-select" id="platform-policy-preset">
                            <option value="">Select preset...</option>
                            <option value="standard">Standard Plan</option>
                            <option value="grenadier">Grenadier Internal Plan</option>
                            <option value="pilot">Pilot Plan</option>
                          </select>
                        </div>
                        <div class="col-12 d-flex justify-content-between align-items-center flex-wrap gap-2">
                          <div class="small text-muted" id="platform-policy-preset-status"></div>
                          <button type="button" class="btn btn-outline-primary btn-sm" id="platform-policy-apply-preset">
                            Apply Preset
                          </button>
                        </div>
                      </div>
                    </div>

                    <div class="border-top pt-3 mt-3">
                      <h4 class="h6 text-uppercase text-muted mb-2">Billing Policy</h4>
                      <div class="row g-3 align-items-end">
                        <div class="col-md-4">
                          <label class="form-label" for="platform-policy-seats-mode">Seats mode</label>
                          <select class="form-select" id="platform-policy-seats-mode">
                            <option value="normal">Normal</option>
                            <option value="waived">Waived</option>
                            <option value="internal">Internal</option>
                          </select>
                        </div>
                        <div class="col-md-4">
                          <label class="form-label" for="platform-policy-min-seats">Minimum billed seats override</label>
                          <input type="number" min="0" step="1" class="form-control" id="platform-policy-min-seats" placeholder="(default)" />
                          <div class="form-text">Leave blank to use the standard minimum (3). Set to 0 for no minimum.</div>
                        </div>
                        <div class="col-md-4">
                          <label class="form-label" for="platform-policy-buildrootz">Buildrootz billing</label>
                          <select class="form-select" id="platform-policy-buildrootz">
                            <option value="normal">Normal</option>
                            <option value="comped">Comped</option>
                          </select>
                        </div>
                        <div class="col-md-4">
                          <label class="form-label" for="platform-policy-website-map">Website Map billing</label>
                          <select class="form-select" id="platform-policy-website-map">
                            <option value="normal">Normal</option>
                            <option value="comped">Comped</option>
                          </select>
                        </div>
                        <div class="col-12">
                          <label class="form-label" for="platform-policy-notes">Notes (internal)</label>
                          <textarea class="form-control" id="platform-policy-notes" rows="2" placeholder="Optional internal note..."></textarea>
                        </div>
                        <div class="col-12 d-flex justify-content-between align-items-center flex-wrap gap-2">
                          <div class="small text-muted" id="platform-policy-status"></div>
                          <button type="button" class="btn btn-primary btn-sm" id="platform-policy-save">Save Policy</button>
                        </div>
                      </div>
                    </div>

                    <div class="border-top pt-3 mt-3">
                      <h4 class="h6 text-uppercase text-muted mb-2">Recent Billing Changes</h4>
                      <div class="small text-muted mb-2" id="platform-policy-audit-status"></div>
                      <ul class="list-group list-group-flush" id="platform-policy-audit-list">
                        <li class="list-group-item text-muted">Select a company to view audit history.</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>

              <div class="card shadow-sm">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start flex-wrap gap-2 mb-2">
                    <div>
                      <h4 class="h6 text-uppercase text-muted mb-1">Website Map Communities</h4>
                      <div class="small text-muted" id="platform-website-map-summary"></div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-danger" id="platform-website-map-cancel-all">
                      Cancel all Website Maps
                    </button>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0" id="platform-communities-table">
                      <thead class="table-light">
                        <tr>
                          <th scope="col">Community</th>
                          <th scope="col">Status</th>
                          <th scope="col">Trial Ends</th>
                          <th scope="col" class="text-end">Action</th>
                        </tr>
                      </thead>
                      <tbody id="platform-communities-body">
                        <tr>
                          <td colspan="4" class="text-center text-muted">Select a company to view communities.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="small text-muted mt-2" id="platform-communities-status"></div>
                </div>
              </div>
            </div>
          </div>

          <div class="card shadow-sm mt-4">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                <div>
                  <h3 class="h5 mb-1">Feature Requests</h3>
                  <p class="text-muted mb-0">Pending activation requests across all companies.</p>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="platform-requests-refresh">Refresh</button>
              </div>
              <div class="table-responsive">
                <table class="table table-sm align-middle mb-0" id="platform-requests-table">
                  <thead class="table-light">
                    <tr>
                      <th scope="col">Company</th>
                      <th scope="col">Feature</th>
                      <th scope="col">Type</th>
                      <th scope="col">Community</th>
                      <th scope="col">Requested By</th>
                      <th scope="col">Created</th>
                      <th scope="col" class="text-end">Action</th>
                    </tr>
                  </thead>
                  <tbody id="platform-requests-body">
                    <tr>
                      <td colspan="7" class="text-center text-muted">Loading requests...</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <div class="small text-muted mt-2" id="platform-requests-status"></div>
            </div>
          </div>
        </section>
        <% } %>

        <section id="admin-panel-settings" class="admin-panel d-none" role="tabpanel" aria-labelledby="admin-tab-settings">
          <div class="text-muted">
            <p class="mb-1">Global settings will land in this tab.</p>
            <p class="mb-0">Feature toggles and preferences specific to your team.</p>
          </div>
        </section>

        <section id="admin-panel-buildrootz" class="admin-panel d-none" role="tabpanel" aria-labelledby="admin-tab-buildrootz">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <div>
              <h2 class="h4 mb-1">BuildRootz Profile</h2>
              <p class="text-muted mb-0">
                Control what BuildRootz sees for your builder profile: name, logo, and description.
              </p>
            </div>
          </div>

          <form id="buildrootz-form" class="row g-4">
            <div class="col-12 col-lg-6">
              <label for="buildrootzName" class="form-label">Builder Name</label>
              <input type="text" id="buildrootzName" class="form-control" readonly />
              <div class="form-text">Pulled from your Company name.</div>
            </div>
            <div class="col-12 col-lg-6">
              <label for="buildrootzLogo" class="form-label">Logo URL</label>
              <input type="url" id="buildrootzLogo" class="form-control" placeholder="https://example.com/logo.png" />
              <div class="form-text">Well send this logo to your BuildRootz builder profile.</div>
              <div class="mt-2" id="buildrootzLogoPreviewWrapper">
                <img id="buildrootzLogoPreview" src="" alt="Logo preview" style="max-height:60px; display:none;" />
              </div>
            </div>
            <div class="col-12">
              <label for="buildrootzDescription" class="form-label">Company Description</label>
              <textarea id="buildrootzDescription" class="form-control" rows="4" placeholder="Add a short bio for your builder profile on BuildRootz."></textarea>
            </div>

            <div class="col-12 d-flex justify-content-end align-items-center gap-2 flex-wrap">
              <div id="buildrootz-status" class="small text-muted me-auto"></div>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary" id="buildrootz-discard">Discard</button>
                <button type="submit" class="btn btn-secondary" id="buildrootz-save">Save</button>
                <button type="button" class="btn btn-primary" id="buildrootz-publish">Publish to BuildRootz</button>
              </div>
            </div>
          </form>
        </section>
      </div>
    </div>
  </main>

  <script nonce="<%= cspNonce %>">
    document.addEventListener('DOMContentLoaded', () => {
      const tabButtons = Array.from(document.querySelectorAll('[data-admin-target]'));
      const panels = new Map(
        Array.from(document.querySelectorAll('.admin-panel')).map((panel) => [panel.id.replace('admin-panel-', ''), panel])
      );

      const readJsonResponse = async (response) => {
        const contentType = (response.headers.get('content-type') || '').toLowerCase();
        if (!contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error(text.slice(0, 200) || 'Unexpected response format.');
        }
        return response.json();
      };

      const permissions = <%- JSON.stringify(permissions || {}) %>;
      const canEditCompany = !!(permissions && permissions.canEditCompany);
      const canManageUsers = !!(permissions && permissions.canManageUsers);
      const canManageBilling = canEditCompany;

      const state = {
        loadedPanels: new Set(),
        company: {
          loading: false,
          saving: false,
          data: null
        },
        buildrootz: {
          loading: false,
          saving: false,
          data: null
        },
        billing: {
          loading: false,
          data: null,
          websiteMapPanelMode: 'enable'
        },
        platformBilling: {
          loading: false,
          companyLoading: false,
          requestLoading: false,
          companies: [],
          selectedCompanyId: null,
          selectedCompany: null,
          requests: [],
          audits: [],
          selectedPresetKey: ''
        },
        users: {
          loading: false,
          payload: null,
          editing: false,
          currentUserId: null
        },
        impersonation: {
          loading: false,
          saving: false,
          data: null,
          lastQuery: ''
        }
      };

      const usersEls = {
        loading: document.getElementById('admin-users-loading'),
        error: document.getElementById('admin-users-error'),
        tableWrapper: document.getElementById('admin-users-list'),
        table: document.getElementById('admin-users-table'),
        tableBody: document.querySelector('#admin-users-table tbody'),
        actionsHeader: document.getElementById('admin-users-actions-header'),
        seatBanner: document.getElementById('admin-users-seat-banner')
      };

      const usersControls = {
        editToggle: document.getElementById('admin-users-edit-toggle'),
        inviteToggle: document.getElementById('admin-users-invite-toggle'),
        inviteCard: document.getElementById('admin-users-invite-card'),
        inviteForm: document.getElementById('admin-users-invite-form'),
        inviteStatus: document.getElementById('admin-users-invite-status'),
        inviteCancel: document.getElementById('admin-users-invite-cancel'),
        inviteRole: document.getElementById('adminInviteRole')
      };
      if (!canManageUsers) {
        if (usersControls.editToggle) usersControls.editToggle.classList.add('d-none');
        if (usersControls.inviteToggle) usersControls.inviteToggle.classList.add('d-none');
        if (usersControls.inviteCard) usersControls.inviteCard.classList.add('d-none');
      }

      const impersonationEls = {
        status: document.getElementById('impersonation-status'),
        error: document.getElementById('impersonation-error'),
        loading: document.getElementById('impersonation-loading'),
        tableBody: document.querySelector('#impersonation-table tbody'),
        searchInput: document.getElementById('impersonation-search'),
        searchButton: document.getElementById('impersonation-search-button'),
        clearButton: document.getElementById('impersonation-clear-button')
      };

      const impersonationForms = {
        createCompany: document.getElementById('impersonation-create-company-form'),
        createCompanyStatus: document.getElementById('impersonation-create-company-status'),
        createUser: document.getElementById('impersonation-create-user-form'),
        createUserStatus: document.getElementById('impersonation-create-user-status')
      };

      const companyForm = document.getElementById('company-settings-form');
      const companyStatusEl = document.getElementById('company-settings-status');
      const companySaveButton = document.getElementById('company-settings-save');

      const companyInputs = {
        name: document.getElementById('companyName'),
        street: document.getElementById('companyStreet'),
        city: document.getElementById('companyCity'),
        state: document.getElementById('companyState'),
        zip: document.getElementById('companyZip'),
        primaryName: document.getElementById('primaryName'),
        primaryEmail: document.getElementById('primaryEmail'),
        primaryPhone: document.getElementById('primaryPhone'),
        logoUrl: document.getElementById('companyLogo'),
        primaryColor: document.getElementById('colorPrimary'),
        secondaryColor: document.getElementById('colorSecondary'),
        timezone: document.getElementById('companyTimezone'),
        notes: document.getElementById('companyNotes')
      };
      const companyViewOnlyMessage =
        'Company settings are view-only for Manager accounts. Contact a Company Admin to make changes.';
      const billingViewOnlyMessage =
        'Billing access is view-only for Manager accounts. Contact a Company Admin to request activation.';

      const buildrootzEls = {
        form: document.getElementById('buildrootz-form'),
        name: document.getElementById('buildrootzName'),
        logo: document.getElementById('buildrootzLogo'),
        description: document.getElementById('buildrootzDescription'),
        status: document.getElementById('buildrootz-status'),
        save: document.getElementById('buildrootz-save'),
        publish: document.getElementById('buildrootz-publish'),
        discard: document.getElementById('buildrootz-discard'),
        logoPreview: document.getElementById('buildrootzLogoPreview'),
        logoPreviewWrapper: document.getElementById('buildrootzLogoPreviewWrapper')
      };

      const billingEls = {
        summaryBody: document.getElementById('billing-summary-body'),
        summaryTotal: document.getElementById('billing-summary-total'),
        policyBanner: document.getElementById('billing-policy-banner'),
        seatsUsed: document.getElementById('seatsUsed'),
        seatsInvited: document.getElementById('seatsInvited'),
        seatsMinimumBilled: document.getElementById('seatsMinimumBilled'),
        seatsMinimumBilledHelper: document.getElementById('seatsMinimumBilledHelper'),
        seatsBilled: document.getElementById('seatsBilled'),
        buildrootzPriceLabel: document.getElementById('buildrootzPriceLabel'),
        buildrootzStatusBadge: document.getElementById('buildrootzStatusBadge'),
        buildrootzToggle: document.getElementById('buildrootzStatusToggle'),
        buildrootzRequestButton: document.getElementById('buildrootzRequestButton'),
        buildrootzRequestStatus: document.getElementById('buildrootzRequestStatus'),
        buildrootzCancelButton: document.getElementById('buildrootzCancelButton'),
        buildrootzCancelStatus: document.getElementById('buildrootzCancelStatus'),
        websiteMapPriceLabel: document.getElementById('websiteMapPriceLabel'),
        websiteMapStatusBadge: document.getElementById('websiteMapStatusBadge'),
        websiteMapToggle: document.getElementById('websiteMapStatusToggle'),
        websiteMapRequestButton: document.getElementById('websiteMapRequestButton'),
        websiteMapRequestStatus: document.getElementById('websiteMapRequestStatus'),
        websiteMapCancelButton: document.getElementById('websiteMapCancelButton'),
        websiteMapCancelStatus: document.getElementById('websiteMapCancelStatus'),
        websiteMapPanel: document.getElementById('websiteMapPanel'),
        websiteMapPanelClose: document.getElementById('websiteMapPanelClose'),
        websiteMapPanelStatus: document.getElementById('websiteMapPanelStatus'),
        websiteMapCommunityTable: document.getElementById('websiteMapCommunityTable'),
        websiteMapPanelTitle: document.getElementById('websiteMapPanelTitle'),
        websiteMapPanelSubtitle: document.getElementById('websiteMapPanelSubtitle'),
        websiteMapCancelAllButton: document.getElementById('websiteMapCancelAllButton')
      };

      const platformBillingEls = {
        panel: document.getElementById('admin-panel-platform-billing'),
        companySearch: document.getElementById('platform-company-search'),
        companyRefresh: document.getElementById('platform-company-refresh'),
        companyStatus: document.getElementById('platform-company-status'),
        companyTableBody: document.getElementById('platform-company-table-body'),
        companyDetail: document.getElementById('platform-company-detail'),
        companyEmpty: document.getElementById('platform-company-empty'),
        companyName: document.getElementById('platform-company-name'),
        companyUpdated: document.getElementById('platform-company-updated'),
        companyReload: document.getElementById('platform-company-reload'),
        billingContact: document.getElementById('platform-billing-contact'),
        primaryContact: document.getElementById('platform-primary-contact'),
        seatsUsed: document.getElementById('platform-seats-used'),
        seatsInvited: document.getElementById('platform-seats-invited'),
        seatsMinimum: document.getElementById('platform-seats-minimum'),
        seatsMinimumHelper: document.getElementById('platform-seats-minimum-helper'),
        seatsBilled: document.getElementById('platform-seats-billed'),
        buildrootzStatus: document.getElementById('platform-buildrootz-status'),
        websiteMapEnabled: document.getElementById('platform-website-map-enabled'),
        featuresStatus: document.getElementById('platform-features-status'),
        featuresSave: document.getElementById('platform-features-save'),
        websiteMapSummary: document.getElementById('platform-website-map-summary'),
        websiteMapCancelAll: document.getElementById('platform-website-map-cancel-all'),
        presetSelect: document.getElementById('platform-policy-preset'),
        presetApply: document.getElementById('platform-policy-apply-preset'),
        presetStatus: document.getElementById('platform-policy-preset-status'),
        policySeatsMode: document.getElementById('platform-policy-seats-mode'),
        policyMinSeats: document.getElementById('platform-policy-min-seats'),
        policyBuildrootz: document.getElementById('platform-policy-buildrootz'),
        policyWebsiteMap: document.getElementById('platform-policy-website-map'),
        policyNotes: document.getElementById('platform-policy-notes'),
        policyStatus: document.getElementById('platform-policy-status'),
        policySave: document.getElementById('platform-policy-save'),
        policyAuditList: document.getElementById('platform-policy-audit-list'),
        policyAuditStatus: document.getElementById('platform-policy-audit-status'),
        communitiesBody: document.getElementById('platform-communities-body'),
        communitiesStatus: document.getElementById('platform-communities-status'),
        requestsRefresh: document.getElementById('platform-requests-refresh'),
        requestsBody: document.getElementById('platform-requests-body'),
        requestsStatus: document.getElementById('platform-requests-status')
      };

      if (companyForm && !canEditCompany) {
        companyForm.querySelectorAll('input, select, textarea').forEach((field) => {
          field.setAttribute('disabled', 'disabled');
        });
        if (companySaveButton) {
          companySaveButton.classList.add('d-none');
        }
        if (companyStatusEl) {
          companyStatusEl.textContent = companyViewOnlyMessage;
          companyStatusEl.classList.add('text-muted');
        }
      }

      if (buildrootzEls.form && !canEditCompany) {
        buildrootzEls.form.querySelectorAll('input, textarea, button').forEach((el) => {
          if (el.id === 'buildrootz-publish' || el.type === 'submit' || el.type === 'button') {
            el.setAttribute('disabled', 'disabled');
          } else {
            el.setAttribute('disabled', 'disabled');
          }
        });
        if (buildrootzEls.status) {
          buildrootzEls.status.textContent = companyViewOnlyMessage;
          buildrootzEls.status.classList.add('text-muted');
        }
      }

      const defaultPrimaryColor = companyInputs.primaryColor?.value || '#cc1d1d';
      const defaultSecondaryColor = companyInputs.secondaryColor?.value || '#1f3c88';

      const escapeHtml = (value) =>
        String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const formatPhoneNumber = (value) => {
        const raw = String(value ?? '').trim();
        if (!raw) return '';
        const digits = raw.replace(/\D+/g, '');
        if (digits.length === 11 && digits.startsWith('1')) {
          const national = digits.slice(-10);
          return `+1 (${national.slice(0, 3)}) ${national.slice(3, 6)}-${national.slice(6)}`;
        }
        if (digits.length === 10) {
          return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
        }
        return raw;
      };

      const statusMeta = {
        inactive: { label: 'Not enabled', badgeClass: 'bg-secondary' },
        pending: { label: 'Pending activation', badgeClass: 'bg-warning text-dark' },
        pending_enable: { label: 'Activation pending', badgeClass: 'bg-warning text-dark' },
        pending_cancel: { label: 'Cancellation pending', badgeClass: 'bg-warning text-dark' },
        trial: { label: 'Trial', badgeClass: 'bg-info text-dark' },
        trial_expired: { label: 'Trial expired', badgeClass: 'bg-secondary' },
        active: { label: 'Active', badgeClass: 'bg-success' }
      };

      const setCompanyStatus = (message, tone = 'muted') => {
        if (!companyStatusEl) return;
        companyStatusEl.textContent = message || '';
        companyStatusEl.classList.remove('text-muted', 'text-success', 'text-danger');
        if (!message) {
          companyStatusEl.classList.add('text-muted');
          return;
        }
        const toneClass = tone === 'success' ? 'text-success' : tone === 'danger' ? 'text-danger' : 'text-muted';
        companyStatusEl.classList.add(toneClass);
      };

      const clearCompanyStatus = () => setCompanyStatus('', 'muted');

      const setBuildrootzStatus = (message, tone = 'muted') => {
        if (!buildrootzEls.status) return;
        buildrootzEls.status.textContent = message || '';
        buildrootzEls.status.classList.remove('text-muted', 'text-success', 'text-danger');
        const toneClass = tone === 'success' ? 'text-success' : tone === 'danger' ? 'text-danger' : 'text-muted';
        buildrootzEls.status.classList.add(toneClass);
      };

      const clearBuildrootzStatus = () => setBuildrootzStatus('', 'muted');

      const getInputValue = (input) => {
        if (!input || typeof input.value !== 'string') return '';
        return input.value.trim();
      };

      const updateBuildrootzLogoPreview = (url) => {
        if (!buildrootzEls.logoPreview || !buildrootzEls.logoPreviewWrapper) return;
        const trimmed = (url || '').trim();
        if (trimmed) {
          buildrootzEls.logoPreview.src = trimmed;
          buildrootzEls.logoPreview.style.display = 'block';
          buildrootzEls.logoPreviewWrapper.classList.remove('d-none');
        } else {
          buildrootzEls.logoPreview.src = '';
          buildrootzEls.logoPreview.style.display = 'none';
          buildrootzEls.logoPreviewWrapper.classList.add('d-none');
        }
      };

      const populateBuildrootzForm = (data) => {
        if (!data) return;
        if (buildrootzEls.name) buildrootzEls.name.value = data.builderName || '';
        if (buildrootzEls.logo) buildrootzEls.logo.value = data.logoUrl || '';
        if (buildrootzEls.description) buildrootzEls.description.value = data.description || '';
        updateBuildrootzLogoPreview(data.logoUrl || data.fallbackLogoUrl || '');
        state.buildrootz.data = data;
      };

      const showUsersLoading = (message = 'Loading users...') => {
        if (usersEls.loading) {
          usersEls.loading.textContent = message;
          usersEls.loading.classList.remove('d-none');
        }
        usersEls.error?.classList.add('d-none');
        usersEls.tableWrapper?.classList.add('d-none');
      };

      const showUsersError = (message) => {
        if (usersEls.error) {
          usersEls.error.textContent = message || 'Unable to load users right now.';
          usersEls.error.classList.remove('d-none');
        }
        usersEls.loading?.classList.add('d-none');
        usersEls.tableWrapper?.classList.add('d-none');
      };

      const showUsersTable = () => {
        usersEls.loading?.classList.add('d-none');
        usersEls.error?.classList.add('d-none');
        usersEls.tableWrapper?.classList.remove('d-none');
        if (usersControls.inviteCard) {
          // Keep invite card hidden by default; only open when toggled
          usersControls.inviteCard.classList.add('d-none');
        }
      };

      const renderUserSeatBanner = (payload) => {
        if (!usersEls.seatBanner) return;
        const seats = payload?.seats;
        if (!seats) {
          usersEls.seatBanner.classList.add('d-none');
          return;
        }
        const used = Number(seats.used ?? 0);
        const invited = Number(seats.invited ?? 0);
        const minimum = Number(seats.minimumBilled ?? 0);
        const billed = Number(seats.billed ?? 0);
        usersEls.seatBanner.textContent =
          `Seats Used: ${used} - Pending Invites: ${invited} - Billed Seats: ${billed} (min ${minimum})`;
        usersEls.seatBanner.classList.remove('d-none');
      };

      const fetchCompanyPayload = async () => {
        const response = await fetch('/api/admin/company', {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        let data;
        try {
          data = await readJsonResponse(response);
        } catch (parseErr) {
          if (!response.ok) throw parseErr;
          throw parseErr;
        }
        if (!response.ok) {
          throw new Error(data?.error || `Request failed (${response.status})`);
        }
        return data;
      };

      const fetchBuildrootzProfile = async () => {
        const response = await fetch('/api/admin/buildrootz/profile', {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        const data = await readJsonResponse(response);
        if (!response.ok) {
          const message = data?.error || `Request failed (${response.status})`;
          throw new Error(message);
        }
        return data;
      };

      const fetchBillingOverview = async () => {
        const response = await fetch('/api/admin/billing/overview', {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        const data = await readJsonResponse(response);
        if (!response.ok) {
          const message = data?.error || `Request failed (${response.status})`;
          throw new Error(message);
        }
        return data;
      };

      const setStatusBadge = (element, status) => {
        if (!element) return;
        const meta = statusMeta[status] || statusMeta.inactive;
        element.textContent = meta.label;
        element.className = `badge ${meta.badgeClass}`;
      };

      const setStatusToggle = (element, status) => {
        if (!element) return;
        element.checked = status === 'active' || status === 'trial';
      };

      const setBillingStatusMessage = (element, message, tone = 'muted') => {
        if (!element) return;
        element.textContent = message || '';
        element.classList.remove('text-muted', 'text-success', 'text-danger');
        element.classList.add('small');
        if (!message) {
          element.classList.add('text-muted');
          return;
        }
        const toneClass = tone === 'success' ? 'text-success' : tone === 'danger' ? 'text-danger' : 'text-muted';
        element.classList.add(toneClass);
      };

      const getWebsiteMapCardStatus = (payload) => {
        return payload?.features?.websiteMap?.displayStatus || 'inactive';
      };

      
      const renderPricingLabels = () => {
        if (!state.billing.data) return;
        const pricing = state.billing.data.pricingDisplay || {};
        if (billingEls.buildrootzPriceLabel) {
          const brz = pricing.buildrootz?.monthlyFormatted || 'Pricing';
          billingEls.buildrootzPriceLabel.textContent = `${brz} / month`;
        }
        if (billingEls.websiteMapPriceLabel) {
          const map = pricing.websiteMap?.monthlyFormatted || 'Pricing';
          billingEls.websiteMapPriceLabel.textContent = `${map} / community / month`;
        }
      };

      const renderBillingSummary = () => {
        if (!billingEls.summaryBody || !billingEls.summaryTotal) return;
        if (!state.billing.data) {
          billingEls.summaryBody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-muted">Loading usage...</td>
            </tr>
          `;
          billingEls.summaryTotal.textContent = '--';
          if (billingEls.policyBanner) {
            billingEls.policyBanner.classList.add('d-none');
            billingEls.policyBanner.textContent = '';
          }
          return;
        }

        const payload = state.billing.data;
        const estimated = payload.estimated;
        const hasPolicyOverrides = !!payload.billingPolicy?.hasOverrides;
        if (billingEls.policyBanner) {
          if (hasPolicyOverrides) {
            billingEls.policyBanner.innerHTML = `
              <strong>Special billing terms applied</strong>
              <div>Your account has special billing terms configured by KeepUp. For changes, contact support.</div>
            `;
            billingEls.policyBanner.classList.remove('d-none');
          } else {
            billingEls.policyBanner.classList.add('d-none');
            billingEls.policyBanner.textContent = '';
          }
        }
        if (estimated && Array.isArray(estimated.lineItems)) {
          const rowsMarkup = estimated.lineItems
            .map((row) => {
              const badges = Array.isArray(row.badges) ? row.badges : [];
              const badgesMarkup = badges.length
                ? badges
                  .map((badge) => `
                    <span class="badge rounded-pill bg-secondary text-uppercase">${escapeHtml(badge)}</span>
                  `)
                  .join('')
                : '';
              const labelMarkup = badgesMarkup
                ? `
                    <div class="d-flex align-items-center flex-wrap gap-2">
                      <span>${escapeHtml(row.label || '')}</span>
                      ${badgesMarkup}
                    </div>
                  `
                : escapeHtml(row.label || '');
              return `
              <tr>
                <td>${labelMarkup}</td>
                <td>${escapeHtml(row.scope || '')}</td>
                <td>${escapeHtml(row.quantityText || '')}</td>
                <td class="text-end">${escapeHtml(row.monthlyFormatted || '--')}</td>
              </tr>
            `;
            })
            .join('');
          billingEls.summaryBody.innerHTML = rowsMarkup || `
            <tr>
              <td colspan="4" class="text-center text-muted">No active or trial products yet.</td>
            </tr>
          `;
          billingEls.summaryTotal.textContent = estimated.totalMonthlyFormatted || '--';
          return;
        }

        billingEls.summaryBody.innerHTML = `
          <tr>
            <td colspan="4" class="text-center text-muted">No active or trial products yet.</td>
          </tr>
        `;
        billingEls.summaryTotal.textContent = '--';
      };

      const renderSeatCounts = () => {
        if (!state.billing.data) return;
        const seats = state.billing.data.seats || {};
        const used = Number(seats.used ?? 0);
        const invited = Number(seats.invited ?? 0);
        const minimum = Number(seats.minimumBilled ?? 0);
        const billed = Number(seats.billed ?? 0);
        const minOverride = state.billing.data.billingPolicy?.seats?.minBilledOverride;

        if (billingEls.seatsUsed) billingEls.seatsUsed.value = Number.isFinite(used) ? used : 0;
        if (billingEls.seatsInvited) billingEls.seatsInvited.value = Number.isFinite(invited) ? invited : 0;
        if (billingEls.seatsMinimumBilled) {
          billingEls.seatsMinimumBilled.value = Number.isFinite(minimum) ? minimum : 0;
        }
        if (billingEls.seatsMinimumBilledHelper) {
          const isCustom = Number.isFinite(minOverride);
          const labelValue = Number.isFinite(minimum) ? minimum : 0;
          billingEls.seatsMinimumBilledHelper.textContent = isCustom
            ? `Minimum billed seats: ${labelValue} (custom)`
            : `Minimum billed seats: ${labelValue}`;
        }
        if (billingEls.seatsBilled) billingEls.seatsBilled.value = Number.isFinite(billed) ? billed : 0;
      };

      const renderWebsiteMapPanel = () => {
        if (!billingEls.websiteMapPanel || !billingEls.websiteMapCommunityTable) return;
        if (!state.billing.data) return;

        const payload = state.billing.data;
        const communities = Array.isArray(payload.communities) ? payload.communities : [];
        const mode = state.billing.websiteMapPanelMode || 'enable';

        if (!communities.length) {
          billingEls.websiteMapCommunityTable.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-muted">No communities found.</td>
            </tr>
          `;
          return;
        }

        if (billingEls.websiteMapPanelTitle) {
          billingEls.websiteMapPanelTitle.textContent =
            mode === 'cancel' ? 'Website Map Cancellation' : 'Website Map Activation';
        }
        if (billingEls.websiteMapPanelSubtitle) {
          billingEls.websiteMapPanelSubtitle.textContent =
            mode === 'cancel'
              ? 'Select communities to request cancellations. Managed by the KeepUp team.'
              : 'Select communities to start trials or request activation. Managed by the KeepUp team.';
        }
        if (billingEls.websiteMapCancelAllButton) {
          const cancelPending = payload.features?.websiteMap?.pendingCancel;
          const canShow = mode === 'cancel';
          billingEls.websiteMapCancelAllButton.classList.toggle('d-none', !canShow);
          billingEls.websiteMapCancelAllButton.disabled = !canManageBilling || !!cancelPending;
        }

        const rows = communities
          .map((community) => {
            const communityId = community.id;
            const map = community.websiteMap || {};
            const displayStatus = map.displayStatus || map.status || 'inactive';
            const meta = statusMeta[displayStatus] || statusMeta.inactive;
            const pendingEnable = !!map.pendingEnable || displayStatus === 'pending_enable';
            const pendingCancel = !!map.pendingCancel || displayStatus === 'pending_cancel';
            const trialExpired = !!map.trialExpired || displayStatus === 'trial_expired';
            const trialEligible = displayStatus === 'inactive' && !pendingEnable && !map.trialEndsAt && !trialExpired;

            let trialLabel = '-';
            if (displayStatus === 'trial') {
              const daysRemaining = Number.isFinite(map.trialEndsInDays) ? map.trialEndsInDays : null;
              const endsFormatted = map.trialEndsAtFormatted || null;
              if (daysRemaining !== null) {
                const dayLabel = daysRemaining === 1 ? 'day' : 'days';
                trialLabel = `Ends in ${daysRemaining} ${dayLabel}`;
                if (endsFormatted) {
                  trialLabel += ` (${endsFormatted})`;
                }
              } else if (endsFormatted) {
                trialLabel = endsFormatted;
              }
            } else if (displayStatus === 'trial_expired') {
              trialLabel = 'Expired';
            }

            let actionMarkup = '<span class="text-muted small">?</span>';
            if (!canManageBilling) {
              actionMarkup = '<span class="text-muted small">View only</span>';
            } else if (mode === 'cancel') {
              if (pendingCancel) {
                actionMarkup = '<button type="button" class="btn btn-sm btn-outline-secondary" disabled>Cancel pending</button>';
              } else if (displayStatus === 'active' || displayStatus === 'trial') {
                actionMarkup = `
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-danger"
                    data-action="website-map-cancel"
                    data-community-id="${escapeHtml(communityId)}"
                  >
                    Request cancellation
                  </button>
                `;
              } else {
                actionMarkup = '<span class="text-muted small">Inactive</span>';
              }
            } else {
              if (pendingEnable) {
                actionMarkup = '<button type="button" class="btn btn-sm btn-outline-secondary" disabled>Activation pending</button>';
              } else if (displayStatus === 'active' || displayStatus === 'trial') {
                actionMarkup = '<span class="text-muted small">Active</span>';
              } else if (trialExpired) {
                actionMarkup = '<span class="text-muted small">Trial expired</span>';
              } else if (trialEligible) {
                actionMarkup = `
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    data-action="website-map-trial"
                    data-community-id="${escapeHtml(communityId)}"
                  >
                    Start trial
                  </button>
                `;
              } else if (displayStatus === 'inactive') {
                actionMarkup = `
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-primary"
                    data-action="website-map-request"
                    data-community-id="${escapeHtml(communityId)}"
                  >
                    Request activation
                  </button>
                `;
              }
            }

            return `
              <tr data-community-id="${escapeHtml(communityId)}">
                <td>${escapeHtml(community.name || 'Unnamed Community')}</td>
                <td><span class="badge ${escapeHtml(meta.badgeClass)}">${escapeHtml(meta.label)}</span></td>
                <td>${escapeHtml(trialLabel)}</td>
                <td class="text-end">${actionMarkup}</td>
              </tr>
            `;
          })
          .join('');

        billingEls.websiteMapCommunityTable.innerHTML = rows;
      };

      const renderBillingCards = () => {
        if (!state.billing.data) return;
        const payload = state.billing.data;

        const buildrootzStatusRaw = payload.features?.buildrootz?.status || 'inactive';
        const buildrootzDisplayStatus = payload.features?.buildrootz?.displayStatus || buildrootzStatusRaw;
        const buildrootzPendingEnable = !!payload.features?.buildrootz?.pendingEnable
          || buildrootzDisplayStatus === 'pending_enable';
        const buildrootzPendingCancel = !!payload.features?.buildrootz?.pendingCancel
          || buildrootzDisplayStatus === 'pending_cancel';

        setStatusBadge(billingEls.buildrootzStatusBadge, buildrootzDisplayStatus);
        setStatusToggle(billingEls.buildrootzToggle, buildrootzStatusRaw);

        if (billingEls.buildrootzRequestButton) {
          const disableButton =
            !canManageBilling
            || buildrootzPendingCancel
            || ['active', 'trial'].includes(buildrootzStatusRaw)
            || buildrootzPendingEnable;
          billingEls.buildrootzRequestButton.disabled = disableButton;
          if (buildrootzPendingEnable) {
            setBillingStatusMessage(billingEls.buildrootzRequestStatus, 'Activation pending.', 'muted');
          } else {
            setBillingStatusMessage(billingEls.buildrootzRequestStatus, '', 'muted');
          }
        }
        if (billingEls.buildrootzCancelButton) {
          const canCancel = ['active', 'trial'].includes(buildrootzStatusRaw) || buildrootzPendingCancel;
          billingEls.buildrootzCancelButton.classList.toggle('d-none', !canCancel);
          billingEls.buildrootzCancelButton.disabled = !canManageBilling || !canCancel || buildrootzPendingCancel;
          if (buildrootzPendingCancel) {
            setBillingStatusMessage(billingEls.buildrootzCancelStatus, 'Cancellation pending.', 'muted');
          } else {
            setBillingStatusMessage(billingEls.buildrootzCancelStatus, '', 'muted');
          }
        }

        const websiteMapStatus = getWebsiteMapCardStatus(payload);
        const websiteMapPendingEnable = !!payload.features?.websiteMap?.pendingEnable
          || websiteMapStatus === 'pending_enable';
        const websiteMapPendingCancel = !!payload.features?.websiteMap?.pendingCancel
          || websiteMapStatus === 'pending_cancel';

        setStatusBadge(billingEls.websiteMapStatusBadge, websiteMapStatus);
        setStatusToggle(billingEls.websiteMapToggle, websiteMapStatus);

        if (billingEls.websiteMapRequestButton) {
          billingEls.websiteMapRequestButton.disabled =
            !canManageBilling || websiteMapPendingEnable || websiteMapPendingCancel;
          if (websiteMapPendingEnable) {
            setBillingStatusMessage(billingEls.websiteMapRequestStatus, 'Activation pending.', 'muted');
          } else {
            setBillingStatusMessage(billingEls.websiteMapRequestStatus, '', 'muted');
          }
        }
        if (billingEls.websiteMapCancelButton) {
          const canCancel = websiteMapStatus === 'active' || websiteMapPendingCancel;
          billingEls.websiteMapCancelButton.classList.toggle('d-none', !canCancel);
          billingEls.websiteMapCancelButton.disabled = !canManageBilling || !canCancel || websiteMapPendingCancel;
          if (websiteMapPendingCancel) {
            setBillingStatusMessage(billingEls.websiteMapCancelStatus, 'Cancellation pending.', 'muted');
          } else {
            setBillingStatusMessage(billingEls.websiteMapCancelStatus, '', 'muted');
          }
        }

        if (billingEls.websiteMapPanel && !billingEls.websiteMapPanel.classList.contains('d-none')) {
          renderWebsiteMapPanel();
        }
      };

      const renderBillingPanel = () => {
        renderBillingCards();
        renderSeatCounts();
        renderPricingLabels();
        renderBillingSummary();
        if (billingEls.websiteMapPanel && !billingEls.websiteMapPanel.classList.contains('d-none')) {
          renderWebsiteMapPanel();
        }
      };

      const loadBillingPanel = async ({ force = false } = {}) => {
        if (state.billing.loading) return;
        if (!force && state.loadedPanels.has('billing') && state.billing.data) {
          renderBillingPanel();
          return;
        }

        state.billing.loading = true;
        if (billingEls.summaryBody) {
          billingEls.summaryBody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-muted">Loading usage...</td>
            </tr>
          `;
        }

        try {
          const payload = await fetchBillingOverview();
          state.billing.data = payload;
          state.loadedPanels.add('billing');
          renderBillingPanel();
          if (!canManageBilling) {
            setBillingStatusMessage(billingEls.buildrootzRequestStatus, billingViewOnlyMessage, 'muted');
            setBillingStatusMessage(billingEls.buildrootzCancelStatus, billingViewOnlyMessage, 'muted');
            setBillingStatusMessage(billingEls.websiteMapRequestStatus, billingViewOnlyMessage, 'muted');
            setBillingStatusMessage(billingEls.websiteMapCancelStatus, billingViewOnlyMessage, 'muted');
            if (billingEls.websiteMapPanelStatus) {
              setBillingStatusMessage(billingEls.websiteMapPanelStatus, billingViewOnlyMessage, 'muted');
            }
          }
        } catch (err) {
          console.error('Failed to load billing overview', err);
          if (billingEls.summaryBody) {
            billingEls.summaryBody.innerHTML = `
              <tr>
                <td colspan="4" class="text-center text-danger">Unable to load billing overview.</td>
              </tr>
            `;
          }
        } finally {
          state.billing.loading = false;
        }
      };

      const requestBuildrootzActivation = async () => {
        if (!canManageBilling || !billingEls.buildrootzRequestButton) return;
        if (state.billing.requestingBuildrootz) return;

        state.billing.requestingBuildrootz = true;
        billingEls.buildrootzRequestButton.disabled = true;
        setBillingStatusMessage(billingEls.buildrootzRequestStatus, 'Sending request...', 'muted');

        try {
          const response = await fetch('/api/admin/billing/feature-requests', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ feature: 'buildrootz', action: 'enable' })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }

          setBillingStatusMessage(billingEls.buildrootzRequestStatus, 'Request sent. Pending activation.', 'success');
          renderBillingPanel();
          await loadBillingPanel({ force: true });
        } catch (err) {
          console.error('Buildrootz request failed', err);
          setBillingStatusMessage(
            billingEls.buildrootzRequestStatus,
            err.message || 'Unable to request activation.',
            'danger'
          );
        } finally {
          state.billing.requestingBuildrootz = false;
          renderBillingPanel();
        }
      };

      const requestBuildrootzCancellation = async () => {
        if (!canManageBilling || !billingEls.buildrootzCancelButton) return;
        if (state.billing.requestingBuildrootzCancel) return;

        state.billing.requestingBuildrootzCancel = true;
        billingEls.buildrootzCancelButton.disabled = true;
        setBillingStatusMessage(billingEls.buildrootzCancelStatus, 'Sending cancellation request...', 'muted');

        try {
          const response = await fetch('/api/admin/billing/feature-requests', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ feature: 'buildrootz', action: 'cancel' })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }
          setBillingStatusMessage(billingEls.buildrootzCancelStatus, 'Cancellation pending.', 'success');
          renderBillingPanel();
          await loadBillingPanel({ force: true });
        } catch (err) {
          console.error('Buildrootz cancellation failed', err);
          setBillingStatusMessage(
            billingEls.buildrootzCancelStatus,
            err.message || 'Unable to request cancellation.',
            'danger'
          );
        } finally {
          state.billing.requestingBuildrootzCancel = false;
        }
      };

      const openWebsiteMapPanel = async (mode = 'enable') => {
        if (!billingEls.websiteMapPanel) return;
        state.billing.websiteMapPanelMode = mode;
        billingEls.websiteMapPanel.classList.remove('d-none');
        setBillingStatusMessage(
          billingEls.websiteMapRequestStatus,
          canManageBilling
            ? mode === 'cancel'
              ? 'Select communities below to request cancellation.'
              : 'Select communities below to start a trial or request activation.'
            : billingViewOnlyMessage,
          'muted'
        );
        if (billingEls.websiteMapPanelStatus) {
          setBillingStatusMessage(billingEls.websiteMapPanelStatus, '', 'muted');
        }
        await loadBillingPanel();
        renderWebsiteMapPanel();
      };

      const closeWebsiteMapPanel = () => {
        billingEls.websiteMapPanel?.classList.add('d-none');
        state.billing.websiteMapPanelMode = 'enable';
      };

      const requestWebsiteMapActivation = async (communityId) => {
        if (!canManageBilling) return;
        if (!communityId) return;

        setBillingStatusMessage(billingEls.websiteMapPanelStatus, 'Sending request...', 'muted');

        try {
          const response = await fetch('/api/admin/billing/feature-requests', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ feature: 'websiteMap', communityId, action: 'enable' })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }

          setBillingStatusMessage(billingEls.websiteMapPanelStatus, 'Request sent. Pending activation.', 'success');
          renderBillingPanel();
          await loadBillingPanel({ force: true });
        } catch (err) {
          console.error('Website Map request failed', err);
          setBillingStatusMessage(
            billingEls.websiteMapPanelStatus,
            err.message || 'Unable to request activation.',
            'danger'
          );
        }
      };

      const startWebsiteMapTrial = async (communityId) => {
        if (!canManageBilling) return;
        if (!communityId) return;

        setBillingStatusMessage(billingEls.websiteMapPanelStatus, 'Starting trial...', 'muted');

        try {
          const response = await fetch('/api/admin/billing/website-map/trial', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ communityId })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }

          setBillingStatusMessage(billingEls.websiteMapPanelStatus, 'Trial started.', 'success');
          renderBillingPanel();
          await loadBillingPanel({ force: true });
        } catch (err) {
          console.error('Website Map trial failed', err);
          setBillingStatusMessage(
            billingEls.websiteMapPanelStatus,
            err.message || 'Unable to start trial.',
            'danger'
          );
        }
      };

      const handleWebsiteMapTableClick = async (event) => {
        const actionButton = event.target.closest('button[data-action]');
        if (!actionButton) return;
        const action = actionButton.dataset.action;
        const communityId = actionButton.dataset.communityId;
        if (!communityId) return;

        if (action === 'website-map-trial') {
          await startWebsiteMapTrial(communityId);
          return;
        }

        if (action === 'website-map-request') {
          await requestWebsiteMapActivation(communityId);
        }
        if (action === 'website-map-cancel') {
          await requestWebsiteMapCancellation({ communityId });
        }
      };

      const requestWebsiteMapCancellation = async ({ communityId = null, cancelAll = false } = {}) => {
        if (!canManageBilling) return;

        setBillingStatusMessage(billingEls.websiteMapPanelStatus, 'Sending cancellation request...', 'muted');

        try {
          const response = await fetch('/api/admin/billing/feature-requests', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
              feature: 'websiteMap',
              action: 'cancel',
              communityId: cancelAll ? null : communityId
            })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }
          setBillingStatusMessage(billingEls.websiteMapPanelStatus, 'Cancellation pending.', 'success');
          renderBillingPanel();
          await loadBillingPanel({ force: true });
        } catch (err) {
          console.error('Website Map cancellation failed', err);
          setBillingStatusMessage(
            billingEls.websiteMapPanelStatus,
            err.message || 'Unable to request cancellation.',
            'danger'
          );
        }
      };

      const fetchPlatformCompanies = async (query = '') => {
        const url = new URL('/api/platform/billing/companies', window.location.origin);
        if (query) url.searchParams.set('q', query);
        const response = await fetch(url.toString(), {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        const data = await readJsonResponse(response);
        if (!response.ok) {
          const message = data?.error || `Request failed (${response.status})`;
          throw new Error(message);
        }
        return data;
      };

      const fetchPlatformCompanyDetail = async (companyId) => {
        const response = await fetch(`/api/platform/billing/company/${encodeURIComponent(companyId)}`, {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        const data = await readJsonResponse(response);
        if (!response.ok) {
          const message = data?.error || `Request failed (${response.status})`;
          throw new Error(message);
        }
        return data;
      };

      const fetchPlatformRequests = async () => {
        const response = await fetch('/api/platform/billing/requests?status=pending', {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        const data = await readJsonResponse(response);
        if (!response.ok) {
          const message = data?.error || `Request failed (${response.status})`;
          throw new Error(message);
        }
        return data;
      };

      const renderPlatformCompanies = () => {
        if (!platformBillingEls.companyTableBody) return;
        const companies = state.platformBilling.companies || [];
        if (!companies.length) {
          platformBillingEls.companyTableBody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-muted">No companies found.</td>
            </tr>
          `;
          return;
        }

        const rows = companies
          .map((company) => {
            const selected = company.id === state.platformBilling.selectedCompanyId;
            const used = Number(company.seatsUsed ?? 0);
            const minimum = Number(company.seatsMinimum ?? 0);
            const billed = Number(company.seatsBilled ?? 0);
            const seatLabel = `Used ${used} - Billed ${billed} (min ${minimum})`;
            const buildrootzStatus = company.buildrootzDisplayStatus || company.buildrootzStatus || 'inactive';
            const mapStatus = company.websiteMapDisplayStatus || (company.websiteMapEnabled ? 'active' : 'inactive');
            const formatStatusLabel = (status) => {
              if (status === 'pending') return 'Pending';
              if (status === 'inactive') return 'Inactive';
              return statusMeta[status]?.label || status || 'Inactive';
            };
            const brzLabel = formatStatusLabel(buildrootzStatus);
            const mapLabel = formatStatusLabel(mapStatus);
            const mapCount = Number(company.mapsActiveCount ?? 0);
            const mapCountLabel = `Maps Active: ${mapCount} ${mapCount === 1 ? 'community' : 'communities'}`;
            const updatedAt = company.updatedAt ? new Date(company.updatedAt).toLocaleDateString() : '';
            return `
              <tr data-company-id="${escapeHtml(company.id)}" class="${selected ? 'table-active' : ''}">
                <td>
                  <button type="button" class="btn btn-link p-0 text-start" data-action="select-company">
                    ${escapeHtml(company.name)}
                  </button>
                  <div class="small text-muted">${escapeHtml(updatedAt ? `Updated ${updatedAt}` : '')}</div>
                </td>
                <td>${escapeHtml(seatLabel)}</td>
                <td><span class="badge ${escapeHtml(statusMeta[buildrootzStatus]?.badgeClass || 'bg-secondary')}">
                  ${escapeHtml(brzLabel)}
                </span></td>
                <td>
                  <span class="badge ${escapeHtml(statusMeta[mapStatus]?.badgeClass || 'bg-secondary')}">
                    ${escapeHtml(mapLabel)}
                  </span>
                  <div class="small text-muted mt-1">${escapeHtml(mapCountLabel)}</div>
                </td>
              </tr>
            `;
          })
          .join('');

        platformBillingEls.companyTableBody.innerHTML = rows;
      };

      const renderPlatformCompanyDetail = () => {
        if (!platformBillingEls.companyDetail || !platformBillingEls.companyEmpty) return;
        const detail = state.platformBilling.selectedCompany;
        if (!detail) {
          platformBillingEls.companyDetail.classList.add('d-none');
          platformBillingEls.companyEmpty.classList.remove('d-none');
          if (platformBillingEls.websiteMapCancelAll) {
            platformBillingEls.websiteMapCancelAll.disabled = true;
          }
          return;
        }

        platformBillingEls.companyDetail.classList.remove('d-none');
        platformBillingEls.companyEmpty.classList.add('d-none');
        platformBillingEls.companyName.textContent = detail.company?.name || 'Company';
        platformBillingEls.companyUpdated.textContent = detail.company?.updatedAt
          ? `Last updated ${new Date(detail.company.updatedAt).toLocaleString()}`
          : '';

        const address = detail.company?.address || {};
        const billingParts = [address.street, address.city, address.state, address.zip].filter(Boolean);
        platformBillingEls.billingContact.textContent = billingParts.length ? billingParts.join(', ') : 'Not set';

        const primary = detail.company?.primaryContact || {};
        const primaryParts = [primary.name, primary.email, primary.phone].filter(Boolean);
        platformBillingEls.primaryContact.textContent = primaryParts.length ? primaryParts.join('  ') : 'Not set';

        const seatsUsed = Number(detail.seats?.used ?? 0);
        const seatsInvited = Number(detail.seats?.invited ?? 0);
        const seatsMinimum = Number(detail.seats?.minimumBilled ?? 0);
        const seatsBilled = Number(detail.seats?.billed ?? 0);

        if (platformBillingEls.seatsUsed) {
          platformBillingEls.seatsUsed.value = seatsUsed;
        }
        if (platformBillingEls.seatsInvited) {
          platformBillingEls.seatsInvited.value = seatsInvited;
        }
        if (platformBillingEls.seatsMinimum) {
          platformBillingEls.seatsMinimum.value = seatsMinimum;
        }
        if (platformBillingEls.seatsMinimumHelper) {
          const minOverride = detail.company?.billingPolicy?.seats?.minBilledOverride;
          const isCustom = Number.isFinite(minOverride);
          platformBillingEls.seatsMinimumHelper.textContent = isCustom
            ? `Minimum billed seats: ${seatsMinimum} (custom)`
            : `Minimum billed seats: ${seatsMinimum}`;
        }
        if (platformBillingEls.seatsBilled) {
          platformBillingEls.seatsBilled.value = seatsBilled;
        }

        const buildrootzStatus = detail.company?.features?.buildrootz?.status
          || (detail.company?.features?.buildrootz?.enabled ? 'active' : 'inactive');
        if (platformBillingEls.buildrootzStatus) {
          platformBillingEls.buildrootzStatus.value = buildrootzStatus;
        }
        if (platformBillingEls.websiteMapEnabled) {
          platformBillingEls.websiteMapEnabled.checked = !!detail.company?.features?.websiteMap?.enabled;
        }

        if (platformBillingEls.websiteMapSummary) {
          const summary = detail.websiteMapSummary || {};
          platformBillingEls.websiteMapSummary.textContent =
            `Free setups remaining: ${summary.freeCommunitySetupsRemaining ?? 0}  Trial days: ${summary.trialDays ?? 30}`;
        }
        if (platformBillingEls.websiteMapCancelAll) {
          platformBillingEls.websiteMapCancelAll.disabled = false;
        }

        const policy = detail.company?.billingPolicy || {};
        if (platformBillingEls.policySeatsMode) {
          platformBillingEls.policySeatsMode.value = policy.seats?.mode || 'normal';
        }
        if (platformBillingEls.policyMinSeats) {
          const override = policy.seats?.minBilledOverride;
          platformBillingEls.policyMinSeats.value = Number.isFinite(override) ? override : '';
        }
        if (platformBillingEls.policyBuildrootz) {
          platformBillingEls.policyBuildrootz.value = policy.addons?.buildrootz || 'normal';
        }
        if (platformBillingEls.policyWebsiteMap) {
          platformBillingEls.policyWebsiteMap.value = policy.addons?.websiteMap || 'normal';
        }
        if (platformBillingEls.policyNotes) {
          platformBillingEls.policyNotes.value = policy.notes || '';
        }
        if (platformBillingEls.policyStatus) {
          platformBillingEls.policyStatus.textContent = '';
        }
        if (platformBillingEls.presetSelect) {
          platformBillingEls.presetSelect.value = '';
        }
        state.platformBilling.selectedPresetKey = '';
        if (platformBillingEls.presetStatus) {
          platformBillingEls.presetStatus.textContent = '';
        }
        if (platformBillingEls.policyAuditStatus) {
          platformBillingEls.policyAuditStatus.textContent = '';
        }

        renderPlatformCommunities();
        renderPlatformPolicyAudit();
      };

      const policyPresets = {
        standard: {
          label: 'Standard Plan',
          values: {
            seatsMode: 'normal',
            minBilledOverride: null,
            buildrootzBilling: 'normal',
            websiteMapBilling: 'normal',
            notes: ''
          }
        },
        grenadier: {
          label: 'Grenadier Internal Plan',
          values: {
            seatsMode: 'internal',
            minBilledOverride: null,
            buildrootzBilling: 'comped',
            websiteMapBilling: 'comped',
            notes: 'Grenadier internal'
          }
        },
        pilot: {
          label: 'Pilot Plan',
          values: {
            seatsMode: 'waived',
            minBilledOverride: null,
            buildrootzBilling: 'comped',
            websiteMapBilling: 'normal',
            notes: 'Pilot'
          }
        }
      };

      const applyPresetToForm = (presetKey) => {
        const preset = policyPresets[presetKey];
        if (!preset) return;
        const values = preset.values || {};
        if (platformBillingEls.policySeatsMode) {
          platformBillingEls.policySeatsMode.value = values.seatsMode || 'normal';
        }
        if (platformBillingEls.policyMinSeats) {
          platformBillingEls.policyMinSeats.value =
            values.minBilledOverride === null || values.minBilledOverride === undefined
              ? ''
              : values.minBilledOverride;
        }
        if (platformBillingEls.policyBuildrootz) {
          platformBillingEls.policyBuildrootz.value = values.buildrootzBilling || 'normal';
        }
        if (platformBillingEls.policyWebsiteMap) {
          platformBillingEls.policyWebsiteMap.value = values.websiteMapBilling || 'normal';
        }
        if (platformBillingEls.policyNotes) {
          platformBillingEls.policyNotes.value = values.notes || '';
        }
        if (platformBillingEls.presetStatus) {
          platformBillingEls.presetStatus.textContent = 'Preset loaded. Click Apply Preset to save.';
        }
      };

      const buildPolicyPayloadFromForm = () => ({
        seatsMode: platformBillingEls.policySeatsMode?.value,
        minBilledOverride: platformBillingEls.policyMinSeats?.value === '' ? null : platformBillingEls.policyMinSeats?.value,
        buildrootzBilling: platformBillingEls.policyBuildrootz?.value,
        websiteMapBilling: platformBillingEls.policyWebsiteMap?.value,
        notes: platformBillingEls.policyNotes?.value
      });

      const submitPolicyUpdate = async (payload, { presetName = null, statusEl = null } = {}) => {
        if (!state.platformBilling.selectedCompanyId) return;
        if (statusEl) statusEl.textContent = 'Saving policy...';
        try {
          const body = { ...payload };
          if (presetName) body.presetName = presetName;
          const response = await fetch(
            `/api/platform/billing/company/${encodeURIComponent(state.platformBilling.selectedCompanyId)}/policy`,
            {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify(body)
            }
          );

          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Save failed (${response.status})`;
            throw new Error(message);
          }

          if (statusEl) statusEl.textContent = 'Policy updated.';
          await loadPlatformCompanyDetail(state.platformBilling.selectedCompanyId);
          await loadPlatformCompanies({ force: true });
          await loadPlatformPolicyAudit(state.platformBilling.selectedCompanyId);
        } catch (err) {
          console.error('Failed to update billing policy', err);
          if (statusEl) {
            statusEl.textContent = err.message || 'Unable to update policy.';
          }
        }
      };

      const savePlatformPolicy = async () => {
        const payload = buildPolicyPayloadFromForm();
        await submitPolicyUpdate(payload, { statusEl: platformBillingEls.policyStatus });
      };

      const applyPolicyPreset = async () => {
        const presetKey = platformBillingEls.presetSelect?.value || '';
        const preset = policyPresets[presetKey];
        if (!preset) {
          if (platformBillingEls.presetStatus) {
            platformBillingEls.presetStatus.textContent = 'Select a preset first.';
          }
          return;
        }
        const confirmed = window.confirm(`Apply preset: ${preset.label}? This only changes billing policy.`);
        if (!confirmed) return;
        applyPresetToForm(presetKey);
        await submitPolicyUpdate(preset.values, {
          presetName: preset.label,
          statusEl: platformBillingEls.presetStatus
        });
      };

      const renderPlatformPolicyAudit = () => {
        if (!platformBillingEls.policyAuditList) return;
        const detail = state.platformBilling.selectedCompany;
        if (!detail) {
          platformBillingEls.policyAuditList.innerHTML =
            '<li class="list-group-item text-muted">Select a company to view audit history.</li>';
          return;
        }
        const audits = state.platformBilling.audits || [];
        if (!audits.length) {
          platformBillingEls.policyAuditList.innerHTML =
            '<li class="list-group-item text-muted">No billing policy changes yet.</li>';
          return;
        }
        platformBillingEls.policyAuditList.innerHTML = audits
          .map((audit) => {
            const timestamp = audit.createdAt ? new Date(audit.createdAt).toLocaleString() : '';
            const actor = audit.actorName || audit.actorEmail || 'Unknown';
            return `
              <li class="list-group-item">
                <div class="d-flex justify-content-between flex-wrap gap-2">
                  <div>
                    <div class="fw-semibold">${escapeHtml(audit.summary || 'Policy updated')}</div>
                    <div class="small text-muted">${escapeHtml(actor)}</div>
                  </div>
                  <div class="small text-muted">${escapeHtml(timestamp)}</div>
                </div>
              </li>
            `;
          })
          .join('');
      };

      const loadPlatformPolicyAudit = async (companyId) => {
        if (!platformBillingEls.policyAuditStatus) return;
        platformBillingEls.policyAuditStatus.textContent = 'Loading recent changes...';
        try {
          const response = await fetch(
            `/api/platform/billing/company/${encodeURIComponent(companyId)}/audit?limit=20`,
            { headers: { Accept: 'application/json' }, credentials: 'same-origin' }
          );
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }
          state.platformBilling.audits = data.audits || [];
          platformBillingEls.policyAuditStatus.textContent = '';
          renderPlatformPolicyAudit();
        } catch (err) {
          console.error('Failed to load billing audit', err);
          platformBillingEls.policyAuditStatus.textContent = err.message || 'Unable to load audit history.';
        }
      };

      const renderPlatformCommunities = () => {
        if (!platformBillingEls.communitiesBody) return;
        const detail = state.platformBilling.selectedCompany;
        const communities = detail?.communities || [];

        if (!detail) {
          platformBillingEls.communitiesBody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-muted">Select a company to view communities.</td>
            </tr>
          `;
          return;
        }

        if (!communities.length) {
          platformBillingEls.communitiesBody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-muted">No communities available.</td>
            </tr>
          `;
          return;
        }

        const rows = communities
          .map((community) => {
            const displayStatus = community.websiteMap?.displayStatus || community.websiteMap?.status || 'inactive';
            const meta = statusMeta[displayStatus] || statusMeta.inactive;
            const daysRemaining = Number.isFinite(community.websiteMap?.trialEndsInDays)
              ? community.websiteMap.trialEndsInDays
              : null;
            const endsFormatted = community.websiteMap?.trialEndsAtFormatted || null;
            let trialEndsLabel = '-';
            if (displayStatus === 'trial') {
              if (daysRemaining !== null) {
                const dayLabel = daysRemaining === 1 ? 'day' : 'days';
                trialEndsLabel = `Ends in ${daysRemaining} ${dayLabel}`;
                if (endsFormatted) {
                  trialEndsLabel += ` (${endsFormatted})`;
                }
              } else if (endsFormatted) {
                trialEndsLabel = endsFormatted;
              }
            } else if (displayStatus === 'trial_expired') {
              trialEndsLabel = 'Expired';
            } else if (endsFormatted) {
              trialEndsLabel = endsFormatted;
            }

            let actions = '';
            if (displayStatus === 'active' || displayStatus === 'trial') {
              actions = `
                <button type="button" class="btn btn-sm btn-outline-danger" data-action="website-map-deactivate" data-community-id="${escapeHtml(community.id)}">
                  Cancel Map
                </button>
              `;
            }
            if (displayStatus === 'inactive') {
              actions += `
                <button type="button" class="btn btn-sm btn-outline-primary" data-action="website-map-trial" data-community-id="${escapeHtml(community.id)}">
                  Start Trial
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary ms-2" data-action="website-map-activate" data-community-id="${escapeHtml(community.id)}">
                  Activate
                </button>
              `;
            }
            if (displayStatus === 'trial') {
              actions += `
                <button type="button" class="btn btn-sm btn-outline-primary ms-2" data-action="website-map-activate" data-community-id="${escapeHtml(community.id)}">
                  Activate
                </button>
              `;
            }
            if (displayStatus === 'trial_expired') {
              actions = `
                <button type="button" class="btn btn-sm btn-outline-primary" data-action="website-map-activate" data-community-id="${escapeHtml(community.id)}">
                  Activate
                </button>
              `;
            }
            if (!actions) {
              actions = '<span class="text-muted small">?</span>';
            }

            return `
              <tr data-community-id="${escapeHtml(community.id)}">
                <td>${escapeHtml(community.name || 'Unnamed Community')}</td>
                <td><span class="badge ${escapeHtml(meta.badgeClass)}">${escapeHtml(meta.label)}</span></td>
                <td>${escapeHtml(trialEndsLabel)}</td>
                <td class="text-end">${actions}</td>
              </tr>
            `;
          })
          .join('');

        platformBillingEls.communitiesBody.innerHTML = rows;
      };

      const renderPlatformRequests = () => {
        if (!platformBillingEls.requestsBody) return;
        const requests = state.platformBilling.requests || [];
        if (!requests.length) {
          platformBillingEls.requestsBody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center text-muted">No pending requests.</td>
            </tr>
          `;
          return;
        }

        const rows = requests
          .map((request) => {
            const featureLabel = request.feature === 'buildrootz' ? 'Buildrootz' : 'Website Map';
            const actionLabel = request.action === 'cancel' ? 'Cancel' : 'Enable';
            const createdAt = request.createdAt ? new Date(request.createdAt).toLocaleString() : '';
            return `
              <tr data-request-id="${escapeHtml(request.id)}">
                <td>${escapeHtml(request.companyName || 'Company')}</td>
                <td>${escapeHtml(featureLabel)}</td>
                <td>${escapeHtml(actionLabel)}</td>
                <td>${escapeHtml(request.communityName || '')}</td>
                <td>${escapeHtml(request.requestedBy || '')}</td>
                <td>${escapeHtml(createdAt)}</td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm btn-primary" data-action="approve-request">Approve</button>
                  <button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-action="deny-request">Deny</button>
                </td>
              </tr>
            `;
          })
          .join('');

        platformBillingEls.requestsBody.innerHTML = rows;
      };

      const loadPlatformCompanies = async ({ force = false } = {}) => {
        if (!platformBillingEls.panel) return;
        if (state.platformBilling.loading) return;
        if (!force && state.platformBilling.companies.length) {
          renderPlatformCompanies();
          return;
        }

        state.platformBilling.loading = true;
        if (platformBillingEls.companyStatus) {
          platformBillingEls.companyStatus.textContent = 'Loading companies...';
        }
        const query = platformBillingEls.companySearch?.value?.trim() || '';

        try {
          const data = await fetchPlatformCompanies(query);
          state.platformBilling.companies = data.companies || [];
          renderPlatformCompanies();
          if (platformBillingEls.companyStatus) {
            platformBillingEls.companyStatus.textContent = state.platformBilling.companies.length
              ? `${state.platformBilling.companies.length} companies`
              : 'No companies found.';
          }
        } catch (err) {
          console.error('Failed to load platform companies', err);
          if (platformBillingEls.companyStatus) {
            platformBillingEls.companyStatus.textContent = err.message || 'Unable to load companies.';
          }
        } finally {
          state.platformBilling.loading = false;
        }
      };

      const loadPlatformCompanyDetail = async (companyId) => {
        if (!companyId) return;
        state.platformBilling.companyLoading = true;
        if (platformBillingEls.companyStatus) {
          platformBillingEls.companyStatus.textContent = 'Loading company...';
        }

        try {
          const detail = await fetchPlatformCompanyDetail(companyId);
          state.platformBilling.selectedCompany = detail;
          state.platformBilling.selectedCompanyId = companyId;
          renderPlatformCompanyDetail();
          renderPlatformCompanies();
          await loadPlatformPolicyAudit(companyId);
          if (platformBillingEls.companyStatus) platformBillingEls.companyStatus.textContent = '';
        } catch (err) {
          console.error('Failed to load platform company detail', err);
          if (platformBillingEls.companyStatus) {
            platformBillingEls.companyStatus.textContent = err.message || 'Unable to load company.';
          }
        } finally {
          state.platformBilling.companyLoading = false;
        }
      };

      const loadPlatformRequests = async () => {
        if (!platformBillingEls.requestsBody) return;
        if (state.platformBilling.requestLoading) return;
        state.platformBilling.requestLoading = true;
        if (platformBillingEls.requestsStatus) platformBillingEls.requestsStatus.textContent = 'Loading requests...';

        try {
          const data = await fetchPlatformRequests();
          state.platformBilling.requests = data.requests || [];
          renderPlatformRequests();
          if (platformBillingEls.requestsStatus) {
            platformBillingEls.requestsStatus.textContent = '';
          }
        } catch (err) {
          console.error('Failed to load platform requests', err);
          if (platformBillingEls.requestsStatus) {
            platformBillingEls.requestsStatus.textContent = err.message || 'Unable to load requests.';
          }
        } finally {
          state.platformBilling.requestLoading = false;
        }
      };

      const savePlatformFeatures = async () => {
        if (!state.platformBilling.selectedCompanyId) return;
        if (platformBillingEls.featuresStatus) platformBillingEls.featuresStatus.textContent = 'Saving products...';
        try {
          const response = await fetch(`/api/platform/billing/company/${encodeURIComponent(state.platformBilling.selectedCompanyId)}/features`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
              buildrootzStatus: platformBillingEls.buildrootzStatus?.value,
              websiteMapEnabled: !!platformBillingEls.websiteMapEnabled?.checked
            })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }
          if (platformBillingEls.featuresStatus) platformBillingEls.featuresStatus.textContent = 'Products updated.';
          await loadPlatformCompanyDetail(state.platformBilling.selectedCompanyId);
          await loadPlatformCompanies({ force: true });
        } catch (err) {
          console.error('Failed to update features', err);
          if (platformBillingEls.featuresStatus) platformBillingEls.featuresStatus.textContent = err.message || 'Unable to update products.';
        }
      };

      const updatePlatformCommunityStatus = async (communityId, status) => {
        if (!communityId) return;
        if (platformBillingEls.communitiesStatus) platformBillingEls.communitiesStatus.textContent = 'Updating community...';
        try {
          const response = await fetch(`/api/platform/billing/community/${encodeURIComponent(communityId)}/website-map`, {
            method: 'PATCH',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ status })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }
          if (platformBillingEls.communitiesStatus) platformBillingEls.communitiesStatus.textContent = 'Community updated.';
          await loadPlatformCompanyDetail(state.platformBilling.selectedCompanyId);
          await loadPlatformCompanies({ force: true });
        } catch (err) {
          console.error('Failed to update community', err);
          if (platformBillingEls.communitiesStatus) platformBillingEls.communitiesStatus.textContent = err.message || 'Unable to update community.';
        }
      };

      const cancelAllWebsiteMaps = async () => {
        if (!state.platformBilling.selectedCompanyId) return;
        const confirmed = window.confirm('Cancel Website Map for all communities in this company?');
        if (!confirmed) return;

        if (platformBillingEls.communitiesStatus) platformBillingEls.communitiesStatus.textContent = 'Cancelling all maps...';
        try {
          const response = await fetch(
            `/api/platform/billing/company/${encodeURIComponent(state.platformBilling.selectedCompanyId)}/website-map/cancel-all`,
            {
              method: 'POST',
              headers: { Accept: 'application/json' },
              credentials: 'same-origin'
            }
          );
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }
          if (platformBillingEls.communitiesStatus) platformBillingEls.communitiesStatus.textContent = 'All maps cancelled.';
          await loadPlatformCompanyDetail(state.platformBilling.selectedCompanyId);
          await loadPlatformCompanies({ force: true });
        } catch (err) {
          console.error('Failed to cancel all maps', err);
          if (platformBillingEls.communitiesStatus) {
            platformBillingEls.communitiesStatus.textContent = err.message || 'Unable to cancel all maps.';
          }
        }
      };

      const handlePlatformCompanyTableClick = (event) => {
        const button = event.target.closest('button[data-action="select-company"]');
        if (!button) return;
        const row = button.closest('tr[data-company-id]');
        const companyId = row?.dataset?.companyId;
        if (companyId) {
          loadPlatformCompanyDetail(companyId);
        }
      };

      const handlePlatformCommunitiesClick = (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const action = button.dataset.action;
        const communityId = button.dataset.communityId;
        if (!communityId) return;
        if (action === 'website-map-trial') {
          updatePlatformCommunityStatus(communityId, 'trial');
        }
        if (action === 'website-map-activate') {
          updatePlatformCommunityStatus(communityId, 'active');
        }
        if (action === 'website-map-deactivate') {
          updatePlatformCommunityStatus(communityId, 'inactive');
        }
      };

      const handlePlatformRequestsClick = async (event) => {
        const button = event.target.closest('button[data-action]');
        if (!button) return;
        const action = button.dataset.action;
        const row = button.closest('tr[data-request-id]');
        const requestId = row?.dataset?.requestId;
        if (!requestId) return;

        if (platformBillingEls.requestsStatus) platformBillingEls.requestsStatus.textContent = 'Updating request...';
        try {
          const endpoint = action === 'approve-request' ? 'approve' : 'deny';
          const response = await fetch(`/api/platform/billing/requests/${encodeURIComponent(requestId)}/${endpoint}`, {
            method: 'POST',
            headers: { Accept: 'application/json' },
            credentials: 'same-origin'
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }
          if (platformBillingEls.requestsStatus) platformBillingEls.requestsStatus.textContent = 'Request updated.';
          await loadPlatformRequests();
          if (state.platformBilling.selectedCompanyId) {
            await loadPlatformCompanyDetail(state.platformBilling.selectedCompanyId);
          }
          await loadPlatformCompanies({ force: true });
        } catch (err) {
          console.error('Failed to update request', err);
          if (platformBillingEls.requestsStatus) platformBillingEls.requestsStatus.textContent = err.message || 'Unable to update request.';
        }
      };

      const loadPlatformBillingPanel = async () => {
        if (!platformBillingEls.panel) return;
        if (state.loadedPanels.has('platform-billing') && state.platformBilling.companies.length) {
          renderPlatformCompanies();
          renderPlatformRequests();
          if (state.platformBilling.selectedCompanyId) {
            renderPlatformCompanyDetail();
          }
          return;
        }
        await loadPlatformCompanies();
        await loadPlatformRequests();
        if (state.platformBilling.selectedCompanyId) {
          await loadPlatformCompanyDetail(state.platformBilling.selectedCompanyId);
        }
        state.loadedPanels.add('platform-billing');
      };

      const populateCompanyForm = (payload) => {
        if (!companyForm || !payload) return;
        const address = payload.address || {};
        const primaryContact = payload.primaryContact || {};
        const branding = payload.branding || {};

        if (companyInputs.name) companyInputs.name.value = payload.companyName || '';
        if (companyInputs.street) companyInputs.street.value = address.street || '';
        if (companyInputs.city) companyInputs.city.value = address.city || '';
        if (companyInputs.state) companyInputs.state.value = address.state || '';
        if (companyInputs.zip) companyInputs.zip.value = address.zip || '';

        if (companyInputs.primaryName) companyInputs.primaryName.value = primaryContact.name || '';
        if (companyInputs.primaryEmail) companyInputs.primaryEmail.value = primaryContact.email || '';
        if (companyInputs.primaryPhone) {
          companyInputs.primaryPhone.value = primaryContact.phoneDisplay || primaryContact.phone || '';
        }

        if (companyInputs.logoUrl) companyInputs.logoUrl.value = branding.logoUrl || '';
        if (companyInputs.primaryColor) {
          companyInputs.primaryColor.value = branding.primaryColor || defaultPrimaryColor;
        }
        if (companyInputs.secondaryColor) {
          companyInputs.secondaryColor.value = branding.secondaryColor || defaultSecondaryColor;
        }

        if (companyInputs.timezone) {
          const tzValue = payload.timezone || '';
          Array.from(companyInputs.timezone.querySelectorAll('option[data-dynamic="true"]') || []).forEach((option) =>
            option.remove()
          );
          if (tzValue) {
            const hasOption = Array.from(companyInputs.timezone.options || []).some(
              (option) => option.value === tzValue
            );
            if (!hasOption) {
              const option = document.createElement('option');
              option.value = tzValue;
              option.textContent = tzValue;
              option.dataset.dynamic = 'true';
              companyInputs.timezone.appendChild(option);
            }
          }
          companyInputs.timezone.value = tzValue;
        }
        if (companyInputs.notes) companyInputs.notes.value = payload.notes || '';
      };

      const loadCompanyPanel = async ({ force = false } = {}) => {
        if (!companyForm) return;
        if (state.company.loading) return;
        if (!force && state.loadedPanels.has('company') && state.company.data) {
          populateCompanyForm(state.company.data);
          return;
        }

        state.company.loading = true;
        setCompanyStatus('Loading company settings...', 'muted');
        if (companySaveButton && !state.company.saving && canEditCompany) {
          companySaveButton.disabled = true;
        }

        try {
          const payload = await fetchCompanyPayload();
          state.company.data = payload;
          state.loadedPanels.add('company');
          populateCompanyForm(payload);
          if (canEditCompany) {
            clearCompanyStatus();
          } else if (companyStatusEl) {
            companyStatusEl.textContent = companyViewOnlyMessage;
            companyStatusEl.classList.remove('text-success', 'text-danger');
            companyStatusEl.classList.add('text-muted');
          }
        } catch (err) {
          console.error('Failed to load company tab:', err);
          setCompanyStatus(err.message || 'Unable to load company settings.', 'danger');
        } finally {
          state.company.loading = false;
          if (companySaveButton && !state.company.saving && canEditCompany) {
            companySaveButton.disabled = false;
          }
        }
      };

      const loadBuildrootzPanel = async ({ force = false } = {}) => {
        if (!buildrootzEls.form) return;
        if (state.buildrootz.loading) return;
        if (!force && state.loadedPanels.has('buildrootz') && state.buildrootz.data) {
          populateBuildrootzForm(state.buildrootz.data);
          return;
        }
        state.buildrootz.loading = true;
        setBuildrootzStatus('Loading BuildRootz profile...', 'muted');
        try {
          const payload = await fetchBuildrootzProfile();
          state.buildrootz.data = payload;
          state.loadedPanels.add('buildrootz');
          populateBuildrootzForm(payload);
          if (payload.publishedAt) {
            setBuildrootzStatus('Last published to BuildRootz', 'muted');
          } else {
            clearBuildrootzStatus();
          }
        } catch (err) {
          console.error('Failed to load BuildRootz profile', err);
          setBuildrootzStatus(err.message || 'Unable to load BuildRootz profile.', 'danger');
        } finally {
          state.buildrootz.loading = false;
        }
      };

      const handleCompanySubmit = async (event) => {
        event.preventDefault();
        if (!companyForm || state.company.saving || state.company.loading) return;
        if (!canEditCompany) return;

        const payload = {
          companyId: state.company.data?.companyId,
          companyName: getInputValue(companyInputs.name),
          address: {
            street: getInputValue(companyInputs.street),
            city: getInputValue(companyInputs.city),
            state: getInputValue(companyInputs.state),
            zip: getInputValue(companyInputs.zip)
          },
          primaryContact: {
            name: getInputValue(companyInputs.primaryName),
            email: getInputValue(companyInputs.primaryEmail),
            phone: getInputValue(companyInputs.primaryPhone)
          },
          branding: {
            logoUrl: getInputValue(companyInputs.logoUrl),
            primaryColor: companyInputs.primaryColor?.value || '',
            secondaryColor: companyInputs.secondaryColor?.value || ''
          },
          timezone: getInputValue(companyInputs.timezone),
          notes: getInputValue(companyInputs.notes)
        };

        state.company.saving = true;
        setCompanyStatus('Saving...', 'muted');
        if (companySaveButton) companySaveButton.disabled = true;

        try {
          const response = await fetch('/api/admin/company', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });

          let data;
          try {
            data = await readJsonResponse(response);
          } catch (parseErr) {
            if (!response.ok) throw parseErr;
            throw parseErr;
          }

          if (!response.ok) {
            throw new Error(data?.error || `Save failed (${response.status})`);
          }

          state.company.data = data;
          state.loadedPanels.add('company');
          populateCompanyForm(data);
          setCompanyStatus('Company settings saved.', 'success');
          setTimeout(() => {
            if (!state.company.saving) clearCompanyStatus();
          }, 4000);
        } catch (err) {
          console.error('Failed to save company settings:', err);
          setCompanyStatus(err.message || 'Failed to save company settings.', 'danger');
        } finally {
          state.company.saving = false;
          if (companySaveButton) companySaveButton.disabled = false;
        }
      };

      const handleBuildrootzSubmit = async (event) => {
        event.preventDefault();
        if (!buildrootzEls.form || state.buildrootz.saving || state.buildrootz.loading) return;
        if (!canEditCompany) return;

        const payload = {
          companyId: state.company.data?.companyId,
          description: getInputValue(buildrootzEls.description),
          logoUrl: getInputValue(buildrootzEls.logo)
        };

        state.buildrootz.saving = true;
        setBuildrootzStatus('Saving...', 'muted');
        if (buildrootzEls.save) buildrootzEls.save.disabled = true;
        if (buildrootzEls.publish) buildrootzEls.publish.disabled = true;

        try {
          const response = await fetch('/api/admin/buildrootz/profile', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Save failed (${response.status})`;
            throw new Error(message);
          }
          state.buildrootz.data = data;
          populateBuildrootzForm(data);
          setBuildrootzStatus('Saved.', 'success');
        } catch (err) {
          console.error('BuildRootz save failed', err);
          setBuildrootzStatus(err.message || 'Save failed.', 'danger');
        } finally {
          state.buildrootz.saving = false;
          if (buildrootzEls.save) buildrootzEls.save.disabled = false;
          if (buildrootzEls.publish) buildrootzEls.publish.disabled = false;
        }
      };

      const handleBuildrootzPublish = async (event) => {
        event.preventDefault();
        if (!buildrootzEls.form || state.buildrootz.saving || state.buildrootz.loading) return;
        if (!canEditCompany) return;

        const payload = {
          companyId: state.company.data?.companyId,
          description: getInputValue(buildrootzEls.description),
          logoUrl: getInputValue(buildrootzEls.logo)
        };

        state.buildrootz.saving = true;
        setBuildrootzStatus('Publishing to BuildRootz...', 'muted');
        if (buildrootzEls.publish) buildrootzEls.publish.disabled = true;
        if (buildrootzEls.save) buildrootzEls.save.disabled = true;

        try {
          const response = await fetch('/api/admin/buildrootz/profile/publish', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Publish failed (${response.status})`;
            throw new Error(message);
          }
          state.buildrootz.data = data;
          populateBuildrootzForm(data);
          setBuildrootzStatus('Published to BuildRootz.', 'success');
        } catch (err) {
          console.error('BuildRootz publish failed', err);
          setBuildrootzStatus(err.message || 'Publish failed.', 'danger');
        } finally {
          state.buildrootz.saving = false;
          if (buildrootzEls.publish) buildrootzEls.publish.disabled = false;
          if (buildrootzEls.save) buildrootzEls.save.disabled = false;
        }
      };

      const handleBuildrootzDiscard = (event) => {
        if (event) event.preventDefault();
        if (state.buildrootz.data) {
          populateBuildrootzForm(state.buildrootz.data);
          clearBuildrootzStatus();
        } else {
          if (buildrootzEls.logo) buildrootzEls.logo.value = '';
          if (buildrootzEls.description) buildrootzEls.description.value = '';
          clearBuildrootzStatus();
        }
      };

      const fetchUsersPayload = async () => {
        const response = await fetch('/api/admin/users', {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        if (!response.ok) {
          throw new Error(`Request failed (${response.status})`);
        }
        return readJsonResponse(response);
      };

      const renderUsers = () => {
        if (!usersEls.tableBody) return;

        const payload = state.users.payload;
        const editing = state.users.editing;
        const currentUserId = state.users.currentUserId || null;
        if (!payload) {
          usersEls.tableBody.innerHTML = `
            <tr>
              <td colspan="${editing ? 10 : 9}" class="text-center text-muted py-4">
                No users loaded.
              </td>
            </tr>
          `;
          return;
        }

        // Populate invite role options using the same role options available in the table
        if (usersControls.inviteRole) {
          const options = (payload.roleOptions || [])
            .filter((opt) => opt.value !== 'SUPER_ADMIN')
            .map((opt) => `<option value="${escapeHtml(opt.value)}">${escapeHtml(opt.label)}</option>`)
            .join('');
          usersControls.inviteRole.innerHTML = options;
        }

        if (usersEls.actionsHeader) {
          usersEls.actionsHeader.classList.toggle('d-none', !editing);
        }

        const roleOptions = payload.roleOptions || [];
        const statusOptionsAll = payload.statusOptions || [];
        const statusOptionsEditable = statusOptionsAll.filter((option) =>
          ['ACTIVE', 'SUSPENDED'].includes(option.value)
        );
        const communityOptions = payload.communities || [];
        const managerOptions = payload.managers || [];

        if (!payload.users || !payload.users.length) {
          usersEls.tableBody.innerHTML = `
            <tr>
              <td colspan="${editing ? 10 : 9}" class="text-center text-muted py-4">
                No users found for this company yet.
              </td>
            </tr>
          `;
          return;
        }

        const roleLookup = new Map(roleOptions.map((option) => [option.value, option.label]));
        const statusLookup = new Map(statusOptionsAll.map((option) => [option.value, option.label]));
        const communityLookup = new Map(communityOptions.map((community) => [community.id, community.label]));

        const renderReadOnlyRow = (user) => {
          const phoneDisplay = user.phoneDisplay || formatPhoneNumber(user.phone);
          const roleLabel = (Array.isArray(user.roles) ? user.roles : [])
            .map((role) => roleLookup.get(role))
            .find(Boolean) || 'User';
          const statusLabel = statusLookup.get(user.status)?.replace('Suspended', 'Inactive')
            || (user.status === 'SUSPENDED' ? 'Inactive' : user.status || 'Unknown');
          const communityLabels = (Array.isArray(user.communities) ? user.communities : [])
            .map((id) => communityLookup.get(id))
            .filter(Boolean);
          const communitiesDisplay = communityLabels.length ? communityLabels.join(', ') : 'All Communities';
          const managerDisplay = user.managerName
            ? escapeHtml(user.managerName)
            : '&mdash;';

          const baseCells = `
            <tr data-user-id="${escapeHtml(user.id)}">
              <td>${escapeHtml(user.firstName || '')}</td>
              <td>${escapeHtml(user.lastName || '')}</td>
              <td>${escapeHtml(user.email)}</td>
              <td class="text-muted">Hidden</td>
              <td>${escapeHtml(phoneDisplay || '')}</td>
              <td>${escapeHtml(roleLabel)}</td>
              <td>${escapeHtml(statusLabel)}</td>
              <td>${escapeHtml(communitiesDisplay)}</td>
              <td>${managerDisplay}</td>`;

          return editing
            ? `${baseCells}<td class="text-end text-muted">&mdash;</td></tr>`
            : `${baseCells}</tr>`;
        };

        const renderEditableRow = (user) => {
          const selectedCommunities = new Set(Array.isArray(user.communities) ? user.communities : []);
          const managerValue = user.managerId || '';
          const isSelf = currentUserId && user.id === currentUserId;

          const roleSelect = roleOptions
            .map((option) => {
              const selected = (Array.isArray(user.roles) ? user.roles : []).includes(option.value) ? 'selected' : '';
              return `<option value="${escapeHtml(option.value)}" ${selected}>${escapeHtml(option.label)}</option>`;
            })
            .join('');

          const statusOptionMarkup = (() => {
            const options = statusOptionsEditable
              .map((option) => {
                const normalizedLabel = option.value === 'SUSPENDED' ? 'Inactive' : option.label;
                const selected = option.value === user.status ? 'selected' : '';
                return `<option value="${escapeHtml(option.value)}" ${selected}>${escapeHtml(normalizedLabel)}</option>`;
              });

            if (user.status && !statusOptionsEditable.some((option) => option.value === user.status)) {
              const fallbackLabel = statusLookup.get(user.status) || user.status;
              options.unshift(
                `<option value="${escapeHtml(user.status)}" selected disabled>${escapeHtml(fallbackLabel)} (read-only)</option>`
              );
            }

            return options.join('');
          })();

          const communitySelect = communityOptions
            .map((community) => {
              const selected = selectedCommunities.has(community.id) ? 'selected' : '';
              return `<option value="${escapeHtml(community.id)}" ${selected}>${escapeHtml(community.label)}</option>`;
            })
            .join('');

          const managerSelect = [
            '<option value="">None</option>',
            ...managerOptions.map((manager) => {
              const selected = manager.id === managerValue ? 'selected' : '';
              return `<option value="${escapeHtml(manager.id)}" ${selected}>${escapeHtml(manager.label)}</option>`;
            })
          ].join('');

          const deleteButton = isSelf
            ? '<button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-action="delete-user" disabled title="You cannot delete your own account.">Delete</button>'
            : '<button type="button" class="btn btn-sm btn-danger ms-2" data-action="delete-user">Delete</button>';

          return `
            <tr data-user-id="${escapeHtml(user.id)}">
              <td>
                <input type="text" class="form-control form-control-sm" name="firstName" value="${escapeHtml(user.firstName || '')}" />
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" name="lastName" value="${escapeHtml(user.lastName || '')}" />
              </td>
              <td>
                <span class="form-control-plaintext form-control-sm">${escapeHtml(user.email)}</span>
              </td>
              <td>
                <input
                  type="password"
                  class="form-control form-control-sm admin-users-password"
                  name="password"
                  placeholder="Set password (min 8)"
                  autocomplete="new-password"
                />
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" name="phone" value="${escapeHtml(user.phone || '')}" placeholder="(555) 555-5555" />
              </td>
              <td>
                <select class="form-select form-select-sm" name="role">
                  ${roleSelect}
                </select>
              </td>
              <td>
                <select class="form-select form-select-sm" name="status">
                  ${statusOptionMarkup}
                </select>
              </td>
              <td>
                <select class="form-select form-select-sm admin-users-multiselect" name="communities" multiple size="4">
                  ${communitySelect}
                </select>
              </td>
              <td>
                <select class="form-select form-select-sm" name="manager">
                  ${managerSelect}
                </select>
              </td>
              <td class="text-end">
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-primary" data-action="save-user">Save</button>
                  <button type="button" class="btn btn-outline-secondary" data-action="cancel-user">Cancel</button>
                </div>
                ${deleteButton}
              </td>
            </tr>
          `;
        };

        const rows = payload.users
          .map((user) => (editing ? renderEditableRow(user) : renderReadOnlyRow(user)))
          .join('');

        usersEls.tableBody.innerHTML = rows;

        if (editing && usersEls.table) {
          usersEls.table.classList.add('table-editing');
        } else {
          usersEls.table?.classList.remove('table-editing');
        }
      };

      const loadUsersPanel = async ({ force = false, silent = false } = {}) => {
        if (state.users.loading) return;

        if (!force && state.loadedPanels.has('users')) {
          renderUsers();
          updateEditToggleVisual();
          showUsersTable();
          return;
        }

        state.users.loading = true;
        if (!silent) showUsersLoading();

        try {
          const payload = await fetchUsersPayload();
          state.users.payload = payload;
          state.users.currentUserId = payload.currentUserId || null;
          state.loadedPanels.add('users');
          renderUserSeatBanner(payload);
          renderUsers();
          updateEditToggleVisual();
          showUsersTable();
        } catch (err) {
          console.error('Failed to load users tab:', err);
          showUsersError(err.message || 'Unable to load users right now.');
        } finally {
          state.users.loading = false;
        }
      };

      const refreshUsersData = (options = {}) => loadUsersPanel({ ...options, force: true });

      const showImpersonationLoading = (message = 'Loading companies...') => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (impersonationEls.loading) {
          impersonationEls.loading.textContent = message;
          impersonationEls.loading.classList.remove('d-none');
        }
      };

      const hideImpersonationLoading = () => {
        impersonationEls.loading?.classList.add('d-none');
      };

      const setImpersonationFormStatus = (element, message, tone = 'muted') => {
        if (!element) return;
        element.textContent = message || '';
        element.classList.remove('text-muted', 'text-success', 'text-danger');
        if (!message) {
          element.classList.add('text-muted');
          return;
        }
        const toneClass = tone === 'success' ? 'text-success' : tone === 'danger' ? 'text-danger' : 'text-muted';
        element.classList.add(toneClass);
      };

      const showImpersonationError = (message) => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (!impersonationEls.error) return;
        impersonationEls.error.textContent = message || 'Something went wrong.';
        impersonationEls.error.classList.remove('d-none');
        hideImpersonationLoading();
      };

      const fetchImpersonationPayload = async (query = '') => {
        const url = new URL('/api/admin/impersonation', window.location.origin);
        if (query) url.searchParams.set('search', query);
        const response = await fetch(url.toString(), {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });

        let data;
        try {
          data = await readJsonResponse(response);
        } catch (err) {
          if (!response.ok) throw err;
          throw err;
        }

        if (!response.ok) {
          throw new Error(data?.error || `Request failed (${response.status})`);
        }

        return data;
      };

      const renderImpersonation = () => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (!state.impersonation.data) return;

        const payload = state.impersonation.data;
        const active = payload.active && payload.active.companyId ? payload.active : null;

        if (impersonationEls.status) {
          impersonationEls.status.classList.remove('alert-warning', 'alert-info');
          if (active) {
            impersonationEls.status.classList.add('alert-warning');
            impersonationEls.status.innerHTML = `Currently impersonating <strong>${escapeHtml(
              active.companyName || active.companyId
            )}</strong>. Any tenant-scoped views and APIs will respect this company until you stop impersonating.`;
          } else {
            impersonationEls.status.classList.add('alert-info');
            impersonationEls.status.innerHTML =
              'Not impersonating any company. Select one below to assume their context.';
          }
        }

        if (impersonationEls.clearButton) {
          const disableClear = !active || state.impersonation.saving;
          impersonationEls.clearButton.classList.toggle('d-none', !active);
          impersonationEls.clearButton.disabled = disableClear;
        }

        if (!impersonationEls.tableBody) return;

        const companies = Array.isArray(payload.companies) ? payload.companies : [];
        if (!companies.length) {
          impersonationEls.tableBody.innerHTML = `
            <tr>
              <td colspan="3" class="text-center text-muted py-4">
                ${escapeHtml(
                  state.impersonation.lastQuery ? 'No companies match this search.' : 'No companies available.'
                )}
              </td>
            </tr>
          `;
          return;
        }

        const disableButtons = state.impersonation.saving;
        const rows = companies
          .map((company) => {
            const isActive = active && active.companyId === company.id;
            const buttonLabel = isActive ? 'Active' : 'Impersonate';
            const buttonVariant = isActive ? 'btn-secondary' : 'btn-outline-primary';
            const disabledAttr = isActive || disableButtons ? 'disabled' : '';
            return `
              <tr data-company-id="${escapeHtml(company.id)}">
                <td>${escapeHtml(company.name || 'Unnamed Company')}</td>
                <td></td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm ${buttonVariant}" data-action="impersonate" ${disabledAttr}>
                    ${escapeHtml(buttonLabel)}
                  </button>
                </td>
              </tr>
            `;
          })
          .join('');

        impersonationEls.tableBody.innerHTML = rows;
      };

      const loadImpersonationPanel = async ({ force = false } = {}) => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (state.impersonation.loading) return;

        const query = impersonationEls.searchInput ? impersonationEls.searchInput.value.trim() : '';
        if (
          !force &&
          state.loadedPanels.has('impersonation') &&
          state.impersonation.data &&
          state.impersonation.lastQuery === query
        ) {
          renderImpersonation();
          return;
        }

        state.impersonation.loading = true;
        showImpersonationLoading(query ? 'Searching companies...' : 'Loading companies...');
        impersonationEls.error?.classList.add('d-none');

        try {
          const payload = await fetchImpersonationPayload(query);
          state.impersonation.data = payload;
          state.impersonation.lastQuery = query;
          state.loadedPanels.add('impersonation');
          renderImpersonation();
        } catch (err) {
          console.error('Failed to load impersonation data:', err);
          showImpersonationError(err.message || 'Unable to load impersonation data.');
        } finally {
          state.impersonation.loading = false;
          hideImpersonationLoading();
        }
      };

      const impersonateCompany = async (companyId) => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (!companyId || state.impersonation.saving) return;

        state.impersonation.saving = true;
        showImpersonationLoading('Switching company...');
        impersonationEls.error?.classList.add('d-none');

        try {
          const response = await fetch('/api/admin/impersonation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ companyId })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }
          window.location.reload();
        } catch (err) {
          console.error('Failed to impersonate company:', err);
          showImpersonationError(err.message || 'Failed to impersonate company.');
        } finally {
          state.impersonation.saving = false;
          hideImpersonationLoading();
        }
      };

      const clearImpersonation = async () => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (state.impersonation.saving) return;

        state.impersonation.saving = true;
        showImpersonationLoading('Clearing impersonation...');
        impersonationEls.error?.classList.add('d-none');

        try {
          const response = await fetch('/api/admin/impersonation', {
            method: 'DELETE',
            headers: { Accept: 'application/json' },
            credentials: 'same-origin'
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }
          window.location.reload();
        } catch (err) {
          console.error('Failed to stop impersonating:', err);
          showImpersonationError(err.message || 'Failed to stop impersonating.');
        } finally {
          state.impersonation.saving = false;
          hideImpersonationLoading();
        }
      };

      if (permissions && permissions.canUseImpersonation) {
        if (impersonationForms.createCompany) {
          impersonationForms.createCompany.addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.currentTarget;
            const submitButton = form.querySelector('button[type="submit"]');
            const statusEl = impersonationForms.createCompanyStatus;
            const formData = new FormData(form);
            const companyName = (formData.get('companyName') || '').toString().trim();
            const slug = (formData.get('slug') || '').toString().trim();

            if (!companyName) {
              setImpersonationFormStatus(statusEl, 'Company name is required.', 'danger');
              return;
            }

            if (submitButton) submitButton.disabled = true;
            setImpersonationFormStatus(statusEl, 'Creating company...', 'muted');

            try {
              const response = await fetch('/api/admin/company', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Accept: 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify({ companyName, slug })
              });

              const data = await readJsonResponse(response);
              if (!response.ok) {
                const message = data?.error || `Create failed (${response.status})`;
                throw new Error(message);
              }

              setImpersonationFormStatus(statusEl, 'Company created successfully.', 'success');
              form.reset();
              await loadImpersonationPanel({ force: true });
            } catch (err) {
              console.error('Failed to create company:', err);
              setImpersonationFormStatus(statusEl, err.message || 'Failed to create company.', 'danger');
            } finally {
              if (submitButton) submitButton.disabled = false;
            }
          });
        }

        if (impersonationForms.createUser) {
          impersonationForms.createUser.addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.currentTarget;
            const submitButton = form.querySelector('button[type="submit"]');
            const statusEl = impersonationForms.createUserStatus;
            const formData = new FormData(form);

            const email = (formData.get('email') || '').toString().trim();
            const password = (formData.get('password') || '').toString().trim();
            const companyId = (formData.get('companyId') || '').toString().trim();
            const role = (formData.get('role') || '').toString().trim();
            const status = (formData.get('status') || '').toString().trim() || 'ACTIVE';
            const firstName = (formData.get('firstName') || '').toString().trim();
            const lastName = (formData.get('lastName') || '').toString().trim();
            const phone = (formData.get('phone') || '').toString().trim();

            if (!email || !password || !companyId) {
              setImpersonationFormStatus(statusEl, 'Email, password, and company ID are required.', 'danger');
              return;
            }

            if (submitButton) submitButton.disabled = true;
            setImpersonationFormStatus(statusEl, 'Creating user...', 'muted');

            try {
              const payload = {
                email,
                password,
                companyId,
                role,
                status
              };
              if (firstName) payload.firstName = firstName;
              if (lastName) payload.lastName = lastName;
              if (phone) payload.phone = phone;

              const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Accept: 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify(payload)
              });

              const data = await readJsonResponse(response);
              if (!response.ok) {
                const message = data?.error || `Create failed (${response.status})`;
                throw new Error(message);
              }

              setImpersonationFormStatus(statusEl, 'User created successfully.', 'success');
              form.reset();
              const companyInput = form.querySelector('input[name="companyId"]');
              if (companyInput && permissions.isImpersonating && permissions.impersonation) {
                companyInput.value = permissions.impersonation.companyId;
              }
              const statusSelect = form.querySelector('select[name="status"]');
              if (statusSelect) statusSelect.value = 'ACTIVE';

              await refreshUsersData({ force: true, silent: true });
            } catch (err) {
              console.error('Failed to create user:', err);
              setImpersonationFormStatus(statusEl, err.message || 'Failed to create user.', 'danger');
            } finally {
              if (submitButton) submitButton.disabled = false;
            }
          });
        }
      }

      const panelLoaders = {
        company: loadCompanyPanel,
        users: loadUsersPanel,
        billing: loadBillingPanel,
        'platform-billing': loadPlatformBillingPanel,
        buildrootz: loadBuildrootzPanel
      };
      if (permissions && permissions.canUseImpersonation) {
        panelLoaders.impersonation = loadImpersonationPanel;
      }

      const activatePanel = (target, button) => {
        if (!target) return;

        tabButtons.forEach((btn) => {
          const isActive = btn === button;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', String(isActive));
        });

        panels.forEach((panel, key) => {
          const show = key === target;
          panel.classList.toggle('d-none', !show);
          panel.classList.toggle('active', show);
        });

        const loader = panelLoaders[target];
        if (typeof loader === 'function') {
          loader();
        }
      };

      const updateEditToggleVisual = () => {
        if (!usersControls.editToggle) return;
        const editing = state.users.editing;
        usersControls.editToggle.textContent = editing ? 'Done Editing' : 'Edit Users';
        usersControls.editToggle.classList.toggle('btn-outline-primary', !editing);
        usersControls.editToggle.classList.toggle('btn-primary', editing);
      };

      const handleEditToggle = async () => {
        if (!state.users.payload) {
          await loadUsersPanel();
        }
        state.users.editing = !state.users.editing;
        updateEditToggleVisual();
        renderUsers();
        showUsersTable();
      };

      const showInviteCard = (show) => {
        if (!usersControls.inviteCard) return;
        usersControls.inviteCard.classList.toggle('d-none', !show);
        if (show && usersControls.inviteStatus) {
          usersControls.inviteStatus.textContent = '';
          usersControls.inviteStatus.className = 'small text-muted me-auto';
        }
      };

      const setInviteStatus = (message, tone = 'muted') => {
        if (!usersControls.inviteStatus) return;
        usersControls.inviteStatus.textContent = message || '';
        usersControls.inviteStatus.className = 'small me-auto';
        usersControls.inviteStatus.classList.add(
          tone === 'success' ? 'text-success' : tone === 'danger' ? 'text-danger' : 'text-muted'
        );
      };

      const resetInviteForm = () => {
        if (!usersControls.inviteForm) return;
        usersControls.inviteForm.reset();
      };

      const collectMultiSelectValues = (select) =>
        Array.from(select?.selectedOptions || []).map((option) => option.value);

      const saveUserRow = async (row, triggerButton, userId) => {
        if (!row || !userId) return;

        const firstName = row.querySelector('[name="firstName"]')?.value ?? '';
        const lastName = row.querySelector('[name="lastName"]')?.value ?? '';
        const phone = row.querySelector('[name="phone"]')?.value ?? '';
        const role = row.querySelector('[name="role"]')?.value ?? '';
        const status = row.querySelector('[name="status"]')?.value ?? '';
        const communities = collectMultiSelectValues(row.querySelector('[name="communities"]'));
        const manager = row.querySelector('[name="manager"]')?.value ?? '';
        const passwordRaw = row.querySelector('[name="password"]')?.value ?? '';
        const password = passwordRaw.toString().trim();
        const payload = {
          firstName,
          lastName,
          phone,
          role,
          status,
          communities,
          manager: manager || null
        };
        if (password) {
          payload.password = password;
        }

        triggerButton.disabled = true;
        const cancelButton = row.querySelector('button[data-action="cancel-user"]');
        if (cancelButton) cancelButton.disabled = true;

        try {
          const response = await fetch(`/api/admin/users/${encodeURIComponent(userId)}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            const message = errorPayload.error || `Save failed (${response.status})`;
            throw new Error(message);
          }

          await refreshUsersData({ silent: true });
          renderUsers();
          updateEditToggleVisual();
          showUsersTable();
          usersEls.error?.classList.add('d-none');
        } catch (err) {
          console.error('Failed to save user', err);
          showUsersError(err.message || 'Failed to save user changes.');
          if (state.users.payload) {
            usersEls.tableWrapper?.classList.remove('d-none');
          }
        } finally {
          triggerButton.disabled = false;
          if (cancelButton) cancelButton.disabled = false;
        }
      };

      const deleteUserRow = async (row, triggerButton, userId) => {
        if (!row || !userId) return;

        if (state.users.currentUserId && userId === state.users.currentUserId) {
          showUsersError('You cannot delete your own account.');
          usersEls.loading?.classList.add('d-none');
          usersEls.tableWrapper?.classList.remove('d-none');
          return;
        }

        const confirmed = window.confirm('Delete this user? This action cannot be undone.');
        if (!confirmed) return;

        triggerButton.disabled = true;

        try {
          const response = await fetch(`/api/admin/users/${encodeURIComponent(userId)}`, {
            method: 'DELETE',
            headers: { Accept: 'application/json' },
            credentials: 'same-origin'
          });

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            const message = errorPayload.error || `Delete failed (${response.status})`;
            throw new Error(message);
          }

          await refreshUsersData({ silent: true });
          renderUsers();
          updateEditToggleVisual();
          showUsersTable();
          usersEls.error?.classList.add('d-none');
        } catch (err) {
          console.error('Failed to delete user', err);
          showUsersError(err.message || 'Failed to delete user.');
          if (state.users.payload) {
            usersEls.tableWrapper?.classList.remove('d-none');
          }
        } finally {
          triggerButton.disabled = false;
        }
      };

      const handleUserTableClick = async (event) => {
        const actionButton = event.target.closest('button[data-action]');
        if (!actionButton) return;
        const action = actionButton.dataset.action;
        if (!action) return;

        const row = actionButton.closest('tr[data-user-id]');
        if (!row) return;
        const userId = row.dataset.userId;

        if (action === 'cancel-user') {
          renderUsers();
          return;
        }

        if (action === 'save-user') {
          await saveUserRow(row, actionButton, userId);
          return;
        }

        if (action === 'delete-user') {
          await deleteUserRow(row, actionButton, userId);
          return;
        }
      };

      if (usersEls.tableBody) {
        usersEls.tableBody.addEventListener('click', handleUserTableClick);
      }

      if (usersControls.editToggle) {
        usersControls.editToggle.addEventListener('click', handleEditToggle);
      }

      if (usersControls.inviteToggle) {
        usersControls.inviteToggle.addEventListener('click', () => {
          const isOpen = usersControls.inviteCard && !usersControls.inviteCard.classList.contains('d-none');
          showInviteCard(!isOpen);
        });
      }

      if (usersControls.inviteCancel) {
        usersControls.inviteCancel.addEventListener('click', (event) => {
          event.preventDefault();
          resetInviteForm();
          showInviteCard(false);
        });
      }

      if (usersControls.inviteForm) {
        usersControls.inviteForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!canManageUsers) return;

          const form = event.currentTarget;
          const submitBtn = form.querySelector('button[type="submit"]');
          const formData = new FormData(form);
          const email = (formData.get('email') || '').toString().trim();
          const firstName = (formData.get('firstName') || '').toString().trim();
          const lastName = (formData.get('lastName') || '').toString().trim();
          const phone = (formData.get('phone') || '').toString().trim();
          const role = (formData.get('role') || '').toString().trim();

          if (!email) {
            setInviteStatus('Email is required.', 'danger');
            return;
          }

          const payload = { email };
          if (firstName) payload.firstName = firstName;
          if (lastName) payload.lastName = lastName;
          if (phone) payload.phone = phone;
          if (role) payload.role = role;

          if (submitBtn) submitBtn.disabled = true;
          setInviteStatus('Sending invite...', 'muted');

          try {
            const response = await fetch('/api/admin/users/invite', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify(payload)
            });
            const data = await readJsonResponse(response);
            if (!response.ok) {
              const msg = data?.error || `Invite failed (${response.status})`;
              throw new Error(msg);
            }
            setInviteStatus('Invite sent. We emailed their setup link.', 'success');
            resetInviteForm();
            await refreshUsersData({ silent: true });
          } catch (err) {
            console.error('Invite user failed', err);
            setInviteStatus(err.message || 'Invite failed.', 'danger');
          } finally {
            if (submitBtn) submitBtn.disabled = false;
          }
        });
      }

      if (companyForm) {
        companyForm.addEventListener('submit', handleCompanySubmit);
        companyForm.addEventListener('reset', (event) => {
          event.preventDefault();
          if (state.company.data) {
            populateCompanyForm(state.company.data);
          }
          clearCompanyStatus();
        });
      }

      if (buildrootzEls.form) {
        buildrootzEls.form.addEventListener('submit', handleBuildrootzSubmit);
        if (buildrootzEls.publish) {
          buildrootzEls.publish.addEventListener('click', handleBuildrootzPublish);
        }
        if (buildrootzEls.discard) {
          buildrootzEls.discard.addEventListener('click', handleBuildrootzDiscard);
        }
        if (buildrootzEls.logo) {
          buildrootzEls.logo.addEventListener('input', () => {
            updateBuildrootzLogoPreview(getInputValue(buildrootzEls.logo));
          });
        }
      }

      if (billingEls.buildrootzRequestButton) {
        billingEls.buildrootzRequestButton.addEventListener('click', (event) => {
          event.preventDefault();
          requestBuildrootzActivation();
        });
      }

      if (billingEls.buildrootzCancelButton) {
        billingEls.buildrootzCancelButton.addEventListener('click', (event) => {
          event.preventDefault();
          requestBuildrootzCancellation();
        });
      }

      if (billingEls.websiteMapRequestButton) {
        billingEls.websiteMapRequestButton.addEventListener('click', (event) => {
          event.preventDefault();
          openWebsiteMapPanel('enable');
        });
      }

      if (billingEls.websiteMapCancelButton) {
        billingEls.websiteMapCancelButton.addEventListener('click', (event) => {
          event.preventDefault();
          openWebsiteMapPanel('cancel');
        });
      }

      if (billingEls.websiteMapPanelClose) {
        billingEls.websiteMapPanelClose.addEventListener('click', (event) => {
          event.preventDefault();
          closeWebsiteMapPanel();
        });
      }

      if (billingEls.websiteMapCancelAllButton) {
        billingEls.websiteMapCancelAllButton.addEventListener('click', (event) => {
          event.preventDefault();
          if (!canManageBilling) return;
          const confirmed = window.confirm('Cancel Website Map for all communities?');
          if (!confirmed) return;
          requestWebsiteMapCancellation({ cancelAll: true });
        });
      }

      if (billingEls.websiteMapCommunityTable) {
        billingEls.websiteMapCommunityTable.addEventListener('click', handleWebsiteMapTableClick);
      }

      if (platformBillingEls.panel) {
        if (platformBillingEls.companyRefresh) {
          platformBillingEls.companyRefresh.addEventListener('click', (event) => {
            event.preventDefault();
            loadPlatformCompanies({ force: true });
          });
        }
        if (platformBillingEls.companySearch) {
          platformBillingEls.companySearch.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
              event.preventDefault();
              loadPlatformCompanies({ force: true });
            }
          });
        }
        if (platformBillingEls.companyTableBody) {
          platformBillingEls.companyTableBody.addEventListener('click', handlePlatformCompanyTableClick);
        }
        if (platformBillingEls.companyReload) {
          platformBillingEls.companyReload.addEventListener('click', (event) => {
            event.preventDefault();
            if (state.platformBilling.selectedCompanyId) {
              loadPlatformCompanyDetail(state.platformBilling.selectedCompanyId);
            }
          });
        }
        if (platformBillingEls.featuresSave) {
          platformBillingEls.featuresSave.addEventListener('click', (event) => {
            event.preventDefault();
            savePlatformFeatures();
          });
        }
        if (platformBillingEls.presetSelect) {
          platformBillingEls.presetSelect.addEventListener('change', () => {
            const key = platformBillingEls.presetSelect?.value || '';
            state.platformBilling.selectedPresetKey = key;
            if (key) {
              applyPresetToForm(key);
            } else if (platformBillingEls.presetStatus) {
              platformBillingEls.presetStatus.textContent = '';
            }
          });
        }
        if (platformBillingEls.presetApply) {
          platformBillingEls.presetApply.addEventListener('click', (event) => {
            event.preventDefault();
            applyPolicyPreset();
          });
        }
        if (platformBillingEls.policySave) {
          platformBillingEls.policySave.addEventListener('click', (event) => {
            event.preventDefault();
            savePlatformPolicy();
          });
        }
        if (platformBillingEls.communitiesBody) {
          platformBillingEls.communitiesBody.addEventListener('click', handlePlatformCommunitiesClick);
        }
        if (platformBillingEls.websiteMapCancelAll) {
          platformBillingEls.websiteMapCancelAll.addEventListener('click', (event) => {
            event.preventDefault();
            cancelAllWebsiteMaps();
          });
        }
        if (platformBillingEls.requestsRefresh) {
          platformBillingEls.requestsRefresh.addEventListener('click', (event) => {
            event.preventDefault();
            loadPlatformRequests();
          });
        }
        if (platformBillingEls.requestsBody) {
          platformBillingEls.requestsBody.addEventListener('click', handlePlatformRequestsClick);
        }
      }

      if (permissions && permissions.canUseImpersonation) {
        if (impersonationEls.searchButton) {
          impersonationEls.searchButton.addEventListener('click', (event) => {
            event.preventDefault();
            loadImpersonationPanel({ force: true });
          });
        }
        if (impersonationEls.searchInput) {
          impersonationEls.searchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
              event.preventDefault();
              loadImpersonationPanel({ force: true });
            }
          });
        }
        if (impersonationEls.tableBody) {
          impersonationEls.tableBody.addEventListener('click', (event) => {
            const actionButton = event.target.closest('button[data-action="impersonate"]');
            if (!actionButton || actionButton.disabled) return;
            const row = actionButton.closest('tr[data-company-id]');
            if (!row) return;
            const companyId = row.dataset.companyId;
            impersonateCompany(companyId);
          });
        }
        if (impersonationEls.clearButton) {
          impersonationEls.clearButton.addEventListener('click', (event) => {
            event.preventDefault();
            clearImpersonation();
          });
        }
      }

      tabButtons.forEach((button) => {
        button.addEventListener('click', () => activatePanel(button.dataset.adminTarget, button));
      });

      loadCompanyPanel();
      updateEditToggleVisual();
    });
  </script>
</body>
</html>
