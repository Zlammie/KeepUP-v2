<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Section</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="/assets/css/pages/admin-section.css" />
</head>
<body>
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-admin') %>

  <main class="main-content admin-section-main py-5">
    <header class="mb-4">
      <h1 class="h3 mb-1">Admin Section</h1>
      <p class="text-muted mb-0">
        Configure how KeepUP behaves for your company. Tabs below will expand as new tools land.
      </p>
    </header>

    <div class="card shadow-sm">
      <div class="card-body">
        <% const showImpersonationTab = permissions && permissions.canUseImpersonation; %>
        <nav class="admin-tabs mb-4" aria-label="Admin tabs">
          <ul class="nav nav-pills flex-wrap gap-2" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="admin-tab-company" data-admin-target="company" type="button" role="tab" aria-controls="admin-panel-company" aria-selected="true">
                Company
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="admin-tab-users" data-admin-target="users" type="button" role="tab" aria-controls="admin-panel-users" aria-selected="false">
                Users
              </button>
            </li>
            <% if (showImpersonationTab) { %>
              <li class="nav-item" role="presentation">
                <button class="nav-link" id="admin-tab-impersonation" data-admin-target="impersonation" type="button" role="tab" aria-controls="admin-panel-impersonation" aria-selected="false">
                  Impersonation
                </button>
              </li>
            <% } %>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="admin-tab-billing" data-admin-target="billing" type="button" role="tab" aria-controls="admin-panel-billing" aria-selected="false">
                Billing
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="admin-tab-settings" data-admin-target="settings" type="button" role="tab" aria-controls="admin-panel-settings" aria-selected="false">
                Settings
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="admin-tab-buildrootz" data-admin-target="buildrootz" type="button" role="tab" aria-controls="admin-panel-buildrootz" aria-selected="false">
                BuildRootz
              </button>
            </li>
          </ul>
        </nav>

        <section id="admin-panel-company" class="admin-panel" role="tabpanel" aria-labelledby="admin-tab-company">
          <h2 class="h4 mb-3">Company Info</h2>
          <p class="text-muted mb-4">
            These settings personalize KeepUP for your team. Changes here stay scoped to your company.
          </p>

          <form id="company-settings-form" class="row g-4">
            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Company Details</h3>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="companyName" class="form-label">Company Name</label>
                  <input type="text" id="companyName" name="companyName" class="form-control" placeholder="Keep Up Homes" />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Company Address</h3>
              <div class="row g-3">
                <div class="col-12">
                  <label for="companyStreet" class="form-label">Street</label>
                  <input type="text" id="companyStreet" name="street" class="form-control" placeholder="123 Main Street" />
                </div>
                <div class="col-md-4">
                  <label for="companyCity" class="form-label">City</label>
                  <input type="text" id="companyCity" name="city" class="form-control" placeholder="Austin" />
                </div>
                <div class="col-md-4">
                  <label for="companyState" class="form-label">State</label>
                  <input type="text" id="companyState" name="state" class="form-control" placeholder="TX" />
                </div>
                <div class="col-md-4">
                  <label for="companyZip" class="form-label">ZIP</label>
                  <input type="text" id="companyZip" name="zip" class="form-control" placeholder="78701" />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Primary Contact</h3>
              <div class="row g-3">
                <div class="col-md-4">
                  <label for="primaryName" class="form-label">Name</label>
                  <input type="text" id="primaryName" name="primaryName" class="form-control" placeholder="Jane Smith" />
                </div>
                <div class="col-md-4">
                  <label for="primaryEmail" class="form-label">Email</label>
                  <input type="email" id="primaryEmail" name="primaryEmail" class="form-control" placeholder="jane@keepup.com" />
                </div>
                <div class="col-md-4">
                  <label for="primaryPhone" class="form-label">Phone</label>
                  <input type="tel" id="primaryPhone" name="primaryPhone" class="form-control" placeholder="(555) 555-5555" />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Branding</h3>
              <div class="row g-3">
                <div class="col-md-6">
                  <label for="companyLogo" class="form-label">Logo URL</label>
                  <input type="url" id="companyLogo" name="logo" class="form-control" placeholder="https://example.com/logo.png" />
                  <div class="form-text">Link to a high-resolution PNG or SVG.</div>
                </div>
                <div class="col-md-3">
                  <label for="colorPrimary" class="form-label">Primary Color</label>
                  <input type="color" id="colorPrimary" name="primaryColor" class="form-control form-control-color" value="#cc1d1d" title="Choose primary brand color" />
                </div>
                <div class="col-md-3">
                  <label for="colorSecondary" class="form-label">Secondary Color</label>
                  <input type="color" id="colorSecondary" name="secondaryColor" class="form-control form-control-color" value="#1f3c88" title="Choose secondary brand color" />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Timezone</h3>
              <div class="col-md-4">
                <label for="companyTimezone" class="form-label">Default Timezone</label>
                <select id="companyTimezone" name="timezone" class="form-select">
                  <option value="">Select timezone...</option>
                  <option value="America/New_York">Eastern (ET)</option>
                  <option value="America/Chicago">Central (CT)</option>
                  <option value="America/Denver">Mountain (MT)</option>
                  <option value="America/Los_Angeles">Pacific (PT)</option>
                </select>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Email Sending Limits</h3>
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <label class="form-label d-block">Daily cap</label>
                  <div class="form-check form-switch mt-2">
                    <input class="form-check-input" type="checkbox" id="companyEmailDailyCapEnabled" />
                    <label class="form-check-label" for="companyEmailDailyCapEnabled">Enable daily cap</label>
                  </div>
                </div>
                <div class="col-md-4">
                  <label for="companyEmailDailyCap" class="form-label">Daily email cap</label>
                  <input
                    type="number"
                    min="0"
                    max="100000"
                    step="1"
                    id="companyEmailDailyCap"
                    class="form-control"
                    placeholder="500"
                  />
                  <div class="form-text">Max emails per day (server enforced).</div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Deliverability Protection</h3>
              <div class="row g-3 align-items-end">
                <div class="col-md-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="companyAutoPauseSpamReport" />
                    <label class="form-check-label" for="companyAutoPauseSpamReport">Auto-pause on spam report</label>
                  </div>
                  <div class="form-text">Pause sending if a recipient marks email as spam.</div>
                </div>
                <div class="col-md-4">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="companyAutoPauseBounceRate" />
                    <label class="form-check-label" for="companyAutoPauseBounceRate">Auto-pause on bounce rate</label>
                  </div>
                  <div class="form-text">Pause if bounce rate exceeds threshold.</div>
                </div>
                <div class="col-md-2">
                  <label for="companyBounceRateThreshold" class="form-label">Bounce threshold (%)</label>
                  <input
                    type="number"
                    min="0"
                    max="100"
                    step="0.1"
                    id="companyBounceRateThreshold"
                    class="form-control"
                    placeholder="5.0"
                  />
                </div>
                <div class="col-md-2">
                  <label for="companyBounceMinSent" class="form-label">Min sent</label>
                  <input
                    type="number"
                    min="0"
                    max="100000"
                    step="1"
                    id="companyBounceMinSent"
                    class="form-control"
                    placeholder="50"
                  />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Internal Notes</h3>
              <textarea id="companyNotes" name="notes" class="form-control" rows="4" placeholder="Keep internal reminders here."></textarea>
            </div>

            <div class="col-12 d-flex justify-content-end gap-2 align-items-center flex-wrap">
              <div id="company-settings-status" class="small text-muted me-auto"></div>
              <div class="d-flex gap-2">
                <button type="reset" class="btn btn-outline-secondary">Discard</button>
                <button type="submit" class="btn btn-primary" id="company-settings-save">Save Company Settings</button>
              </div>
            </div>
          </form>

          <div class="mt-5" id="company-email-deliverability">
            <h3 class="h5 mb-2">Email Deliverability</h3>
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
                  <div>
                    <h4 class="h6 mb-1">Status</h4>
                    <p class="fw-semibold mb-1" id="deliverability-health-state">Loading...</p>
                    <p class="text-muted small mb-0" id="deliverability-status-message"></p>
                    <p class="text-muted small mb-0" id="deliverability-health-action"></p>
                  </div>
                  <span class="badge bg-secondary" id="deliverability-status-badge">Unknown</span>
                </div>
                <div class="small text-muted mt-2" id="deliverability-status-meta"></div>
                <div class="small text-muted mt-2" id="deliverability-warmup-badge"></div>

                <div class="alert alert-warning d-none mt-3" id="email-readiness-banner">
                  <strong>Blast sending disabled:</strong>
                  <span id="email-readiness-message"></span>
                  <div class="small text-muted mt-1" id="email-readiness-details"></div>
                </div>

                <div class="row g-3 mt-3">
                  <div class="col-md-3">
                    <div class="text-muted small">Sent today</div>
                    <div class="fw-semibold" id="deliverability-sent-today">--</div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-muted small">Bounces today</div>
                    <div class="fw-semibold" id="deliverability-bounces-today">--</div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-muted small">Spam reports today</div>
                    <div class="fw-semibold" id="deliverability-spamreports-today">--</div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-muted small">Remaining</div>
                    <div class="fw-semibold" id="deliverability-remaining">--</div>
                  </div>
                </div>

                <div class="row g-3 mt-3">
                  <div class="col-md-3">
                    <div class="text-muted small">Base cap</div>
                    <div class="fw-semibold" id="deliverability-base-cap">--</div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-muted small">Effective cap</div>
                    <div class="fw-semibold" id="deliverability-effective-cap">--</div>
                  </div>
                </div>

                <div class="small text-muted mt-3" id="deliverability-reset">Reset: --</div>

                <div class="mt-3 d-flex justify-content-end gap-2 flex-wrap">
                  <button type="button" class="btn btn-danger d-none" id="deliverability-resume">
                    Resume sending
                  </button>
                  <button type="button" class="btn btn-outline-primary d-none" id="deliverability-warmup-reset">
                    Reset warm-up
                  </button>
                  <button type="button" class="btn btn-outline-secondary d-none" id="deliverability-warmup-disable">
                    Disable warm-up
                  </button>
                  <button type="button" class="btn btn-outline-primary d-none" id="deliverability-warmup-enable">
                    Enable warm-up
                  </button>
                  <button type="button" class="btn btn-outline-primary d-none" id="deliverability-verify-domain">
                    Verify domain
                  </button>
                </div>

                <div class="mt-4 border-top pt-3">
                  <h5 class="h6 mb-2">Admin tools</h5>
                  <div class="row g-2 align-items-center">
                    <div class="col-md-6">
                      <input type="email" class="form-control" id="email-tools-test-email" placeholder="test@example.com" />
                    </div>
                    <div class="col-md-6 d-flex gap-2 flex-wrap">
                      <button type="button" class="btn btn-outline-primary btn-sm" id="email-tools-preview">
                        Preview blast footer
                      </button>
                      <button type="button" class="btn btn-outline-secondary btn-sm" id="email-tools-generate">
                        Generate test unsubscribe link
                      </button>
                    </div>
                  </div>
                  <div class="mt-3 d-none" id="email-tools-output">
                    <div class="text-muted small">HTML</div>
                    <div class="border rounded p-2 mb-2" id="email-tools-html"></div>
                    <div class="text-muted small">Text</div>
                    <pre class="border rounded p-2 mb-0" id="email-tools-text"></pre>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4" id="company-email-system-check">
            <h3 class="h5 mb-2">Email System Check</h3>
            <div class="card shadow-sm">
              <div class="card-header d-flex flex-wrap justify-content-between align-items-center gap-2">
                <h4 class="h6 mb-0">Diagnostics</h4>
                <div class="d-flex gap-2">
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="email-system-check-refresh">
                    Refresh
                  </button>
                  <button
                    class="btn btn-outline-secondary btn-sm"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#email-system-check-body"
                    aria-expanded="true"
                    aria-controls="email-system-check-body"
                  >
                    Toggle
                  </button>
                </div>
              </div>
              <div id="email-system-check-body" class="collapse show">
                <div class="card-body">
                  <div class="mb-3">
                    <h5 class="h6 text-uppercase text-muted mb-2">Environment</h5>
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="badge bg-secondary" id="email-check-sendgrid-key">Unknown</span>
                      <span>SendGrid API key present</span>
                    </div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="badge bg-secondary" id="email-check-webhook-secret">Unknown</span>
                      <span>Webhook secret configured</span>
                    </div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="badge bg-secondary" id="email-check-unsub-secret">Unknown</span>
                      <span>Unsubscribe secret configured</span>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                      <span class="badge bg-secondary" id="email-check-base-url">Unknown</span>
                      <span>Base URL resolved</span>
                      <span class="text-muted small" id="email-check-base-url-value"></span>
                    </div>
                  </div>

                  <div class="mb-3">
                    <h5 class="h6 text-uppercase text-muted mb-2">Scheduler</h5>
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="badge bg-secondary" id="email-check-scheduler">Unknown</span>
                      <span id="email-check-scheduler-text">Scheduler status</span>
                    </div>
                    <div class="small text-muted" id="email-check-scheduler-meta"></div>
                  </div>

                  <div>
                    <h5 class="h6 text-uppercase text-muted mb-2">Sending Status</h5>
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="badge bg-secondary" id="email-check-transactional">Unknown</span>
                      <span>Transactional enabled</span>
                    </div>
                    <div class="d-flex align-items-center gap-2 mb-2">
                      <span class="badge bg-secondary" id="email-check-blast">Unknown</span>
                      <span>Blast enabled</span>
                    </div>
                    <div class="small text-muted" id="email-check-blockers"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-5" id="company-email-queue-debug">
            <h3 class="h5 mb-2">Email Queue Debug</h3>
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
                  <div>
                    <h4 class="h6 mb-1">Blocked reasons</h4>
                    <p class="text-muted small mb-0">Queued jobs currently blocked from sending.</p>
                  </div>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="email-queue-refresh">Refresh</button>
                </div>

                <div class="table-responsive mt-3">
                  <table class="table table-sm align-middle mb-0">
                    <thead class="table-light">
                      <tr>
                        <th scope="col">Reason</th>
                        <th scope="col">Count</th>
                        <th scope="col">Next attempt</th>
                      </tr>
                    </thead>
                    <tbody id="email-queue-summary">
                      <tr>
                        <td colspan="3" class="text-center text-muted">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>

                <div class="mt-3">
                  <h5 class="h6">Recent blocked jobs</h5>
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th scope="col">Email</th>
                          <th scope="col">Reason</th>
                        <th scope="col">Scheduled for</th>
                        <th scope="col" class="text-end">Details</th>
                      </tr>
                    </thead>
                    <tbody id="email-queue-samples">
                      <tr>
                        <td colspan="4" class="text-center text-muted">Loading...</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              </div>
            </div>
          </div>

          <div class="mt-5" id="company-email-domain-section">
            <h3 class="h5 mb-2">Email Sending Domain</h3>
            <p class="text-muted mb-3">
              Verify a domain to align KeepUP emails with your brand. This step does not change sending behavior yet.
            </p>
            <div class="card shadow-sm">
              <div class="card-body">
                <div class="d-flex flex-wrap justify-content-between align-items-start gap-2">
                  <div>
                    <h4 class="h6 mb-1">Domain verification</h4>
                    <p class="text-muted mb-0">Add the DNS records SendGrid provides, then validate.</p>
                  </div>
                  <span class="badge bg-secondary" id="email-domain-status-badge">Not started</span>
                </div>

                <div id="email-domain-status-message" class="small text-muted mt-2"></div>

                <form id="email-domain-form" class="row g-3 mt-2">
                  <div class="col-md-5">
                    <label for="emailDomainInput" class="form-label">Domain</label>
                    <input type="text" class="form-control" id="emailDomainInput" placeholder="grenadierhomes.com" />
                  </div>
                  <div class="col-md-3">
                    <label for="emailSubdomainInput" class="form-label">Subdomain</label>
                    <input type="text" class="form-control" id="emailSubdomainInput" placeholder="email" value="email" />
                    <div class="form-text">Creates email.yourdomain.com</div>
                  </div>
                  <div class="col-md-4">
                    <label class="form-label d-block">Link branding</label>
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" id="emailLinkBranding" checked />
                      <label class="form-check-label" for="emailLinkBranding">Brand links (recommended)</label>
                    </div>
                  </div>
                  <div class="col-12 d-flex justify-content-end gap-2 flex-wrap">
                    <button type="button" class="btn btn-outline-secondary" id="email-domain-remove">Remove</button>
                    <button type="button" class="btn btn-outline-primary" id="email-domain-validate">Validate</button>
                    <button type="submit" class="btn btn-primary" id="email-domain-start">Start verification</button>
                  </div>
                </form>

                <div class="mt-3 d-none" id="email-domain-dns">
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th scope="col">Type</th>
                          <th scope="col">Host</th>
                          <th scope="col">Value</th>
                          <th scope="col">Purpose</th>
                          <th scope="col" class="text-end">Copy</th>
                        </tr>
                      </thead>
                      <tbody id="email-domain-dns-body">
                        <tr>
                          <td colspan="5" class="text-center text-muted">No DNS records available.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="form-text mt-2">Add these records in DNS (Cloudflare). Set CNAME to DNS Only.</div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="admin-panel-users" class="admin-panel d-none" role="tabpanel" aria-labelledby="admin-tab-users">
          <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
            <div>
              <h2 class="h4 mb-1">Team Members</h2>
              <p class="text-muted mb-0">
                Review the users tied to your company, along with their access, scope, and activity status.
              </p>
            </div>
            <div class="d-flex flex-wrap gap-2">
              <button type="button" class="btn btn-outline-primary" id="admin-users-edit-toggle">
                Edit Users
              </button>
              <button type="button" class="btn btn-secondary" id="admin-users-invite-toggle">
                Invite User
              </button>
            </div>
          </div>

          <div id="admin-users-invite-card" class="card mb-3 d-none">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div>
                  <h3 class="h6 mb-1">Invite a teammate</h3>
                  <p class="text-muted mb-0">Invites are scoped to your company automatically.</p>
                </div>
              </div>
              <form id="admin-users-invite-form" class="row gy-3 gx-3">
                <div class="col-md-6">
                  <label class="form-label" for="adminInviteEmail">Email</label>
                  <input type="email" class="form-control" id="adminInviteEmail" name="email" required placeholder="teammate@company.com" />
                </div>
                <div class="col-md-3">
                  <label class="form-label" for="adminInviteFirstName">First name</label>
                  <input type="text" class="form-control" id="adminInviteFirstName" name="firstName" />
                </div>
                <div class="col-md-3">
                  <label class="form-label" for="adminInviteLastName">Last name</label>
                  <input type="text" class="form-control" id="adminInviteLastName" name="lastName" />
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="adminInvitePhone">Phone</label>
                  <input type="tel" class="form-control" id="adminInvitePhone" name="phone" placeholder="(555) 555-5555" />
                </div>
                <div class="col-md-4">
                  <label class="form-label" for="adminInviteRole">Role</label>
                  <select class="form-select" id="adminInviteRole" name="role"></select>
                </div>
                <div class="col-12 d-flex justify-content-end gap-2 align-items-center flex-wrap">
                  <div id="admin-users-invite-status" class="small text-muted me-auto"></div>
                  <button type="button" class="btn btn-outline-secondary" id="admin-users-invite-cancel">Cancel</button>
                  <button type="submit" class="btn btn-primary">Send Invite</button>
                </div>
              </form>
            </div>
          </div>

          <div id="admin-users-loading" class="text-muted">
            Loading users&hellip;
          </div>

          <div id="admin-users-error" class="alert alert-danger d-none" role="alert"></div>

          <div id="admin-users-list" class="table-responsive d-none">
            <table class="table table-striped table-hover table-sm align-middle" id="admin-users-table">
              <thead class="table-light">
                <tr>
                  <th scope="col">First Name</th>
                  <th scope="col">Last Name</th>
                  <th scope="col">Email</th>
                  <th scope="col">Password</th>
                  <th scope="col">Phone</th>
                  <th scope="col">Role</th>
                  <th scope="col">Status</th>
                  <th scope="col">Communities</th>
                  <th scope="col">Manager</th>
                  <th scope="col" class="text-end d-none" id="admin-users-actions-header">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="10" class="text-center text-muted">Loading users&hellip;</td>
                </tr>
              </tbody>
            </table>
        </div>
      </section>

        <% if (showImpersonationTab) { %>
        <section id="admin-panel-impersonation" class="admin-panel d-none" role="tabpanel" aria-labelledby="admin-tab-impersonation">
          <h2 class="h4 mb-3">Impersonation Mode</h2>
          <p class="text-muted mb-3">
            Temporarily adopt a company's context to troubleshoot issues or configure settings on their behalf. You'll retain SUPER ADMIN privileges while impersonating.
          </p>

          <div id="impersonation-status" class="alert <%= permissions.isImpersonating ? 'alert-warning' : 'alert-info' %>">
            <% if (permissions.isImpersonating && permissions.impersonation) { %>
              Currently impersonating <strong><%= permissions.impersonation.companyName || permissions.impersonation.companyId %></strong>.
              Any tenant-scoped views and APIs will respect this company until you stop impersonating.
            <% } else { %>
              Not impersonating any company. Select one below to assume their context.
            <% } %>
          </div>

          <div class="row g-3 align-items-end mb-3">
            <div class="col-md-5">
              <label for="impersonation-search" class="form-label">Find company</label>
              <input type="search" id="impersonation-search" class="form-control" placeholder="Search by name or slug" />
            </div>
            <div class="col-auto d-flex gap-2">
              <button type="button" class="btn btn-outline-primary" id="impersonation-search-button">Search</button>
              <button type="button" class="btn btn-outline-secondary <%= permissions.isImpersonating ? '' : 'd-none' %>" id="impersonation-clear-button">
                Stop impersonating
              </button>
            </div>
          </div>

          <div id="impersonation-error" class="alert alert-danger d-none" role="alert"></div>
          <div id="impersonation-loading" class="text-muted d-none">Loading companies...</div>

          <div class="table-responsive" id="impersonation-results">
            <table class="table table-striped table-hover table-sm align-middle" id="impersonation-table">
              <thead class="table-light">
                <tr>
                  <th scope="col">Company</th>
                  <th scope="col">Slug</th>
                  <th scope="col" class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="3" class="text-center text-muted py-4">Use the search to load companies.</td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="row g-4 mt-4">
            <div class="col-lg-6">
              <div class="card shadow-sm h-100">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h3 class="h6 mb-0">Create Company</h3>
                    <span class="badge bg-secondary">SUPER ADMIN</span>
                  </div>
                </div>
                <div class="card-body">
                  <form id="impersonation-create-company-form" class="row g-3">
                    <div class="col-12">
                      <label for="impersonationCompanyName" class="form-label">Company Name</label>
                      <input type="text" id="impersonationCompanyName" name="companyName" class="form-control" placeholder="Acme Homes" required />
                    </div>
                    <div class="col-12">
                      <label for="impersonationCompanySlug" class="form-label">Slug (optional)</label>
                      <input type="text" id="impersonationCompanySlug" name="slug" class="form-control" placeholder="acme-homes" />
                      <div class="form-text">Used in URLs; leave blank to auto-generate later.</div>
                    </div>
                    <div class="col-12 d-flex justify-content-between align-items-center">
                      <div id="impersonation-create-company-status" class="small text-muted"></div>
                      <button type="submit" class="btn btn-primary">Create Company</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
            <div class="col-lg-6">
              <div class="card shadow-sm h-100">
                <div class="card-header">
                  <div class="d-flex justify-content-between align-items-center">
                    <h3 class="h6 mb-0">Create User</h3>
                    <span class="badge bg-secondary">SUPER ADMIN</span>
                  </div>
                </div>
                <div class="card-body">
                  <form id="impersonation-create-user-form" class="row g-3">
                    <div class="col-md-6">
                      <label for="impersonationUserEmail" class="form-label">Email</label>
                      <input type="email" id="impersonationUserEmail" name="email" class="form-control" placeholder="user@company.com" required />
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserPassword" class="form-label">Temporary Password</label>
                      <input type="text" id="impersonationUserPassword" name="password" class="form-control" placeholder="At least 8 characters" required />
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserFirstName" class="form-label">First Name</label>
                      <input type="text" id="impersonationUserFirstName" name="firstName" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserLastName" class="form-label">Last Name</label>
                      <input type="text" id="impersonationUserLastName" name="lastName" class="form-control" />
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserPhone" class="form-label">Phone</label>
                      <input type="tel" id="impersonationUserPhone" name="phone" class="form-control" placeholder="(555) 555-5555" />
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserRole" class="form-label">Role</label>
                      <select id="impersonationUserRole" name="role" class="form-select" required>
                        <option value="USER">User</option>
                        <option value="MANAGER">Manager</option>
                        <option value="COMPANY_ADMIN">Company Admin</option>
                        <option value="SUPER_ADMIN">Super Admin</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserStatus" class="form-label">Status</label>
                      <select id="impersonationUserStatus" name="status" class="form-select">
                        <option value="ACTIVE" selected>Active</option>
                        <option value="INVITED">Invited</option>
                        <option value="SUSPENDED">Suspended</option>
                      </select>
                    </div>
                    <div class="col-md-6">
                      <label for="impersonationUserCompanyId" class="form-label">Company ID</label>
                      <input
                        type="text"
                        id="impersonationUserCompanyId"
                        name="companyId"
                        class="form-control"
                        placeholder="64e1c..."
                        value="<%= permissions && permissions.isImpersonating && permissions.impersonation ? permissions.impersonation.companyId : '' %>"
                        required
                      />
                      <div class="form-text">Defaults to the impersonated company when available.</div>
                    </div>
                    <div class="col-12 d-flex justify-content-between align-items-center">
                      <div id="impersonation-create-user-status" class="small text-muted"></div>
                      <button type="submit" class="btn btn-primary">Create User</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </section>
        <% } %>

      <section id="admin-panel-billing" class="admin-panel d-none" role="tabpanel" aria-labelledby="admin-tab-billing">
        <h2 class="h4 mb-3">Billing Overview</h2>
        <p class="text-muted mb-4">
          Company Admins can confirm addresses, monitor seat usage, and request upgrades. Platform-level billing stays locked down.
        </p>

          <form id="billing-settings-form" class="row g-4">
            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Billing Contact</h3>
              <div class="row g-3">
                <div class="col-12">
                  <label for="billingStreet" class="form-label">Billing Address</label>
                  <input type="text" id="billingStreet" name="billingStreet" class="form-control" placeholder="456 Builder Way" />
                </div>
                <div class="col-md-4">
                  <label for="billingCity" class="form-label">City</label>
                  <input type="text" id="billingCity" name="billingCity" class="form-control" placeholder="Dallas" />
                </div>
                <div class="col-md-4">
                  <label for="billingState" class="form-label">State</label>
                  <input type="text" id="billingState" name="billingState" class="form-control" placeholder="TX" />
                </div>
                <div class="col-md-4">
                  <label for="billingZip" class="form-label">ZIP</label>
                  <input type="text" id="billingZip" name="billingZip" class="form-control" placeholder="75001" />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Subscription</h3>
              <div class="row g-3">
                <div class="col-md-4">
                  <label for="billingPlan" class="form-label">Plan</label>
                  <input type="text" id="billingPlan" name="billingPlan" class="form-control" value="Growth" readonly />
                  <div class="form-text">Plan labels are managed by the platform team.</div>
                </div>
                <div class="col-md-4">
                  <label for="billingStatus" class="form-label">Billing Status</label>
                  <input type="text" id="billingStatus" name="billingStatus" class="form-control" value="Active" readonly />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Seats</h3>
              <div class="row g-3 align-items-start">
                <div class="col-md-3">
                  <label for="seatsPurchased" class="form-label">Seats Purchased</label>
                  <input type="number" id="seatsPurchased" name="seatsPurchased" class="form-control" min="1" value="10" readonly />
                  <div class="form-text">Managed by the KeepUp team.</div>
                </div>
                <div class="col-md-3">
                  <label for="seatsUsed" class="form-label">Seats Used</label>
                  <input type="number" id="seatsUsed" name="seatsUsed" class="form-control" value="8" readonly />
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Current Usage &amp; Estimated Cost</h3>
              <div class="card shadow-sm billing-summary-card">
                <div class="card-body p-3">
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-2" id="billing-summary-table">
                      <thead class="table-light">
                        <tr>
                          <th scope="col">Product</th>
                          <th scope="col">Scope</th>
                          <th scope="col">Quantity</th>
                          <th scope="col" class="text-end">Estimated Monthly</th>
                        </tr>
                      </thead>
                      <tbody id="billing-summary-body">
                        <tr>
                          <td colspan="4" class="text-center text-muted">Loading usage...</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <span class="fw-semibold">Estimated Monthly Total: <span id="billing-summary-total">$0</span></span>
                    <span class="small text-muted">Billing is managed by the KeepUp team.</span>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12">
              <h3 class="h6 text-uppercase text-muted mb-2">Products &amp; Add-Ons</h3>
              <div class="row g-3">
                <div class="col-md-4">
                  <div class="product-card h-100">
                    <div class="d-flex align-items-start justify-content-between gap-3">
                      <div>
                        <div class="fw-semibold">Buildrootz</div>
                        <div class="form-text">Publish listings and updates to Buildrootz.</div>
                        <div class="small text-muted">Scope: Company</div>
                      </div>
                      <div class="form-check form-switch status-toggle" title="Managed by the KeepUp team">
                        <input class="form-check-input" type="checkbox" id="buildrootzStatusToggle" disabled aria-label="Buildrootz status" title="Managed by the KeepUp team" />
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-3">
                      <span class="fw-semibold">$99 / month</span>
                      <span class="badge bg-secondary" id="buildrootzStatusBadge">Not enabled</span>
                    </div>
                    <div class="service-detail">
                      <p class="mb-2 small text-muted">Buildrootz listings keep your communities visible in their buyer network.</p>
                      <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="buildrootzRequestButton">Request activation</button>
                        <span class="small text-muted" id="buildrootzRequestStatus"></span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="product-card h-100">
                    <div class="d-flex align-items-start justify-content-between gap-3">
                      <div>
                        <div class="fw-semibold">Website Map</div>
                        <div class="form-text">Generate a sitemap and navigation update bundle. Licensed per community.</div>
                        <div class="small text-muted">Scope: Per community</div>
                      </div>
                      <div class="form-check form-switch status-toggle" title="Managed by the KeepUp team">
                        <input class="form-check-input" type="checkbox" id="websiteMapStatusToggle" disabled aria-label="Website Map status" title="Managed by the KeepUp team" />
                      </div>
                    </div>
                    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mt-3">
                      <span class="fw-semibold">$125 / community / month</span>
                      <span class="badge bg-secondary" id="websiteMapStatusBadge">Not enabled</span>
                    </div>
                    <div class="service-detail">
                      <p class="mb-2 small text-muted">Website Map keeps your customer-facing pages and layouts in sync.</p>
                      <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
                        <button type="button" class="btn btn-sm btn-outline-primary" id="websiteMapRequestButton">Request activation</button>
                        <span class="small text-muted" id="websiteMapRequestStatus"></span>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-12 d-none" id="websiteMapPanel">
                  <div class="card shadow-sm">
                    <div class="card-body">
                      <div class="d-flex align-items-start justify-content-between gap-3">
                        <div>
                          <h4 class="h6 mb-1">Website Map Activation</h4>
                          <p class="text-muted mb-0">
                            Select communities to start trials or request activation. Managed by the KeepUp team.
                          </p>
                        </div>
                        <button type="button" class="btn-close" id="websiteMapPanelClose" aria-label="Close"></button>
                      </div>
                      <div class="small text-muted mt-2" id="websiteMapPanelStatus"></div>
                      <div class="table-responsive mt-3">
                        <table class="table table-sm align-middle mb-0">
                          <thead class="table-light">
                            <tr>
                              <th scope="col">Community</th>
                              <th scope="col">Status</th>
                              <th scope="col">Trial Remaining</th>
                              <th scope="col" class="text-end">Action</th>
                            </tr>
                          </thead>
                          <tbody id="websiteMapCommunityTable">
                            <tr>
                              <td colspan="4" class="text-center text-muted">Loading communities...</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-12 d-flex justify-content-end gap-2">
              <button type="reset" class="btn btn-outline-secondary">Discard</button>
              <button type="submit" class="btn btn-primary">Save Billing Settings</button>
            </div>
          </form>
        </section>

        <section id="admin-panel-settings" class="admin-panel d-none" role="tabpanel" aria-labelledby="admin-tab-settings">
          <div class="text-muted">
            <p class="mb-1">Global settings will land in this tab.</p>
            <p class="mb-0">Feature toggles and preferences specific to your team.</p>
          </div>
        </section>

        <section id="admin-panel-buildrootz" class="admin-panel d-none" role="tabpanel" aria-labelledby="admin-tab-buildrootz">
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <div>
              <h2 class="h4 mb-1">BuildRootz Profile</h2>
              <p class="text-muted mb-0">
                Control what BuildRootz sees for your builder profile: name, logo, and description.
              </p>
            </div>
          </div>

          <form id="buildrootz-form" class="row g-4">
            <div class="col-12 col-lg-6">
              <label for="buildrootzName" class="form-label">Builder Name</label>
              <input type="text" id="buildrootzName" class="form-control" readonly />
              <div class="form-text">Pulled from your Company name.</div>
            </div>
            <div class="col-12 col-lg-6">
              <label for="buildrootzLogo" class="form-label">Logo URL</label>
              <input type="url" id="buildrootzLogo" class="form-control" placeholder="https://example.com/logo.png" />
              <div class="form-text">We'll send this logo to your BuildRootz builder profile.</div>
              <div class="mt-2" id="buildrootzLogoPreviewWrapper">
                <img id="buildrootzLogoPreview" src="" alt="Logo preview" style="max-height:60px; display:none;" />
              </div>
            </div>
            <div class="col-12">
              <label for="buildrootzDescription" class="form-label">Company Description</label>
              <textarea id="buildrootzDescription" class="form-control" rows="4" placeholder="Add a short bio for your builder profile on BuildRootz."></textarea>
            </div>

            <div class="col-12 d-flex justify-content-end align-items-center gap-2 flex-wrap">
              <div id="buildrootz-status" class="small text-muted me-auto"></div>
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary" id="buildrootz-discard">Discard</button>
                <button type="submit" class="btn btn-secondary" id="buildrootz-save">Save</button>
                <button type="button" class="btn btn-primary" id="buildrootz-publish">Publish to BuildRootz</button>
              </div>
            </div>
          </form>
        </section>
      </div>
    </div>
  </main>

  <script defer src="/assets/js/shared/emailErrorLabels.js"></script>
  <script nonce="<%= cspNonce %>">
    document.addEventListener('DOMContentLoaded', () => {
      const tabButtons = Array.from(document.querySelectorAll('[data-admin-target]'));
      const panels = new Map(
        Array.from(document.querySelectorAll('.admin-panel')).map((panel) => [panel.id.replace('admin-panel-', ''), panel])
      );

      const readJsonResponse = async (response) => {
        const contentType = (response.headers.get('content-type') || '').toLowerCase();
        if (!contentType.includes('application/json')) {
          const text = await response.text();
          throw new Error(text.slice(0, 200) || 'Unexpected response format.');
        }
        return response.json();
      };

      const permissions = <%- JSON.stringify(permissions || {}) %>;
      const canEditCompany = !!(permissions && permissions.canEditCompany);
      const canManageUsers = !!(permissions && permissions.canManageUsers);
      const canManageBilling = canEditCompany;

      const state = {
        loadedPanels: new Set(),
        company: {
          loading: false,
          saving: false,
          data: null
        },
        emailDomain: {
          loading: false,
          saving: false,
          data: null
        },
        emailDeliverability: {
          loading: false,
          data: null
        },
        emailSystemCheck: {
          loading: false,
          data: null
        },
        emailQueue: {
          loading: false,
          data: null
        },
        buildrootz: {
          loading: false,
          saving: false,
          data: null
        },
        billing: {
          loading: false,
          data: null
        },
        users: {
          loading: false,
          payload: null,
          editing: false,
          currentUserId: null
        },
        impersonation: {
          loading: false,
          saving: false,
          data: null,
          lastQuery: ''
        }
      };

      const usersEls = {
        loading: document.getElementById('admin-users-loading'),
        error: document.getElementById('admin-users-error'),
        tableWrapper: document.getElementById('admin-users-list'),
        table: document.getElementById('admin-users-table'),
        tableBody: document.querySelector('#admin-users-table tbody'),
        actionsHeader: document.getElementById('admin-users-actions-header')
      };

      const usersControls = {
        editToggle: document.getElementById('admin-users-edit-toggle'),
        inviteToggle: document.getElementById('admin-users-invite-toggle'),
        inviteCard: document.getElementById('admin-users-invite-card'),
        inviteForm: document.getElementById('admin-users-invite-form'),
        inviteStatus: document.getElementById('admin-users-invite-status'),
        inviteCancel: document.getElementById('admin-users-invite-cancel'),
        inviteRole: document.getElementById('adminInviteRole')
      };
      if (!canManageUsers) {
        if (usersControls.editToggle) usersControls.editToggle.classList.add('d-none');
        if (usersControls.inviteToggle) usersControls.inviteToggle.classList.add('d-none');
        if (usersControls.inviteCard) usersControls.inviteCard.classList.add('d-none');
      }

      const impersonationEls = {
        status: document.getElementById('impersonation-status'),
        error: document.getElementById('impersonation-error'),
        loading: document.getElementById('impersonation-loading'),
        tableBody: document.querySelector('#impersonation-table tbody'),
        searchInput: document.getElementById('impersonation-search'),
        searchButton: document.getElementById('impersonation-search-button'),
        clearButton: document.getElementById('impersonation-clear-button')
      };

      const impersonationForms = {
        createCompany: document.getElementById('impersonation-create-company-form'),
        createCompanyStatus: document.getElementById('impersonation-create-company-status'),
        createUser: document.getElementById('impersonation-create-user-form'),
        createUserStatus: document.getElementById('impersonation-create-user-status')
      };

      const companyForm = document.getElementById('company-settings-form');
      const companyStatusEl = document.getElementById('company-settings-status');
      const companySaveButton = document.getElementById('company-settings-save');

      const emailDomainEls = {
        section: document.getElementById('company-email-domain-section'),
        form: document.getElementById('email-domain-form'),
        statusBadge: document.getElementById('email-domain-status-badge'),
        statusMessage: document.getElementById('email-domain-status-message'),
        domain: document.getElementById('emailDomainInput'),
        subdomain: document.getElementById('emailSubdomainInput'),
        linkBranding: document.getElementById('emailLinkBranding'),
        startButton: document.getElementById('email-domain-start'),
        validateButton: document.getElementById('email-domain-validate'),
        removeButton: document.getElementById('email-domain-remove'),
        dnsWrapper: document.getElementById('email-domain-dns'),
        dnsBody: document.getElementById('email-domain-dns-body')
      };

      const deliverabilityEls = {
        section: document.getElementById('company-email-deliverability'),
        statusBadge: document.getElementById('deliverability-status-badge'),
        healthState: document.getElementById('deliverability-health-state'),
        statusMessage: document.getElementById('deliverability-status-message'),
        healthAction: document.getElementById('deliverability-health-action'),
        statusMeta: document.getElementById('deliverability-status-meta'),
        warmupBadge: document.getElementById('deliverability-warmup-badge'),
        readinessBanner: document.getElementById('email-readiness-banner'),
        readinessMessage: document.getElementById('email-readiness-message'),
        readinessDetails: document.getElementById('email-readiness-details'),
        resumeButton: document.getElementById('deliverability-resume'),
        warmupResetButton: document.getElementById('deliverability-warmup-reset'),
        warmupDisableButton: document.getElementById('deliverability-warmup-disable'),
        warmupEnableButton: document.getElementById('deliverability-warmup-enable'),
        verifyDomainButton: document.getElementById('deliverability-verify-domain'),
        sentToday: document.getElementById('deliverability-sent-today'),
        bouncesToday: document.getElementById('deliverability-bounces-today'),
        spamreportsToday: document.getElementById('deliverability-spamreports-today'),
        baseCap: document.getElementById('deliverability-base-cap'),
        effectiveCap: document.getElementById('deliverability-effective-cap'),
        remaining: document.getElementById('deliverability-remaining'),
        reset: document.getElementById('deliverability-reset'),
        toolsEmail: document.getElementById('email-tools-test-email'),
        toolsPreview: document.getElementById('email-tools-preview'),
        toolsGenerate: document.getElementById('email-tools-generate'),
        toolsOutput: document.getElementById('email-tools-output'),
        toolsHtml: document.getElementById('email-tools-html'),
        toolsText: document.getElementById('email-tools-text')
      };

      const emailSystemCheckEls = {
        section: document.getElementById('company-email-system-check'),
        refresh: document.getElementById('email-system-check-refresh'),
        sendgridKey: document.getElementById('email-check-sendgrid-key'),
        webhookSecret: document.getElementById('email-check-webhook-secret'),
        unsubSecret: document.getElementById('email-check-unsub-secret'),
        baseUrl: document.getElementById('email-check-base-url'),
        baseUrlValue: document.getElementById('email-check-base-url-value'),
        scheduler: document.getElementById('email-check-scheduler'),
        schedulerText: document.getElementById('email-check-scheduler-text'),
        schedulerMeta: document.getElementById('email-check-scheduler-meta'),
        transactional: document.getElementById('email-check-transactional'),
        blast: document.getElementById('email-check-blast'),
        blockers: document.getElementById('email-check-blockers')
      };

      const emailQueueEls = {
        section: document.getElementById('company-email-queue-debug'),
        refresh: document.getElementById('email-queue-refresh'),
        summaryBody: document.getElementById('email-queue-summary'),
        samplesBody: document.getElementById('email-queue-samples')
      };

      const companyInputs = {
        name: document.getElementById('companyName'),
        street: document.getElementById('companyStreet'),
        city: document.getElementById('companyCity'),
        state: document.getElementById('companyState'),
        zip: document.getElementById('companyZip'),
        primaryName: document.getElementById('primaryName'),
        primaryEmail: document.getElementById('primaryEmail'),
        primaryPhone: document.getElementById('primaryPhone'),
        logoUrl: document.getElementById('companyLogo'),
        primaryColor: document.getElementById('colorPrimary'),
        secondaryColor: document.getElementById('colorSecondary'),
        timezone: document.getElementById('companyTimezone'),
        notes: document.getElementById('companyNotes'),
        emailDailyCapEnabled: document.getElementById('companyEmailDailyCapEnabled'),
        emailDailyCap: document.getElementById('companyEmailDailyCap'),
        emailAutoPauseSpamReport: document.getElementById('companyAutoPauseSpamReport'),
        emailAutoPauseBounceRate: document.getElementById('companyAutoPauseBounceRate'),
        emailBounceRateThreshold: document.getElementById('companyBounceRateThreshold'),
        emailBounceMinSent: document.getElementById('companyBounceMinSent')
      };
      const companyViewOnlyMessage =
        'Company settings are view-only for Manager accounts. Contact a Company Admin to make changes.';
      const billingViewOnlyMessage =
        'Billing access is view-only for Manager accounts. Contact a Company Admin to request activation.';

      const buildrootzEls = {
        form: document.getElementById('buildrootz-form'),
        name: document.getElementById('buildrootzName'),
        logo: document.getElementById('buildrootzLogo'),
        description: document.getElementById('buildrootzDescription'),
        status: document.getElementById('buildrootz-status'),
        save: document.getElementById('buildrootz-save'),
        publish: document.getElementById('buildrootz-publish'),
        discard: document.getElementById('buildrootz-discard'),
        logoPreview: document.getElementById('buildrootzLogoPreview'),
        logoPreviewWrapper: document.getElementById('buildrootzLogoPreviewWrapper')
      };

      const billingEls = {
        summaryBody: document.getElementById('billing-summary-body'),
        summaryTotal: document.getElementById('billing-summary-total'),
        buildrootzStatusBadge: document.getElementById('buildrootzStatusBadge'),
        buildrootzToggle: document.getElementById('buildrootzStatusToggle'),
        buildrootzRequestButton: document.getElementById('buildrootzRequestButton'),
        buildrootzRequestStatus: document.getElementById('buildrootzRequestStatus'),
        websiteMapStatusBadge: document.getElementById('websiteMapStatusBadge'),
        websiteMapToggle: document.getElementById('websiteMapStatusToggle'),
        websiteMapRequestButton: document.getElementById('websiteMapRequestButton'),
        websiteMapRequestStatus: document.getElementById('websiteMapRequestStatus'),
        websiteMapPanel: document.getElementById('websiteMapPanel'),
        websiteMapPanelClose: document.getElementById('websiteMapPanelClose'),
        websiteMapPanelStatus: document.getElementById('websiteMapPanelStatus'),
        websiteMapCommunityTable: document.getElementById('websiteMapCommunityTable')
      };

      if (companyForm && !canEditCompany) {
        companyForm.querySelectorAll('input, select, textarea').forEach((field) => {
          field.setAttribute('disabled', 'disabled');
        });
        if (companySaveButton) {
          companySaveButton.classList.add('d-none');
        }
        if (companyStatusEl) {
          companyStatusEl.textContent = companyViewOnlyMessage;
          companyStatusEl.classList.add('text-muted');
        }
      }

      if (emailDomainEls.form && !canEditCompany) {
        emailDomainEls.form.querySelectorAll('input, button').forEach((field) => {
          field.setAttribute('disabled', 'disabled');
        });
        if (emailDomainEls.statusMessage) {
          emailDomainEls.statusMessage.textContent = companyViewOnlyMessage;
          emailDomainEls.statusMessage.classList.add('text-muted');
        }
      }

      if (buildrootzEls.form && !canEditCompany) {
        buildrootzEls.form.querySelectorAll('input, textarea, button').forEach((el) => {
          if (el.id === 'buildrootz-publish' || el.type === 'submit' || el.type === 'button') {
            el.setAttribute('disabled', 'disabled');
          } else {
            el.setAttribute('disabled', 'disabled');
          }
        });
        if (buildrootzEls.status) {
          buildrootzEls.status.textContent = companyViewOnlyMessage;
          buildrootzEls.status.classList.add('text-muted');
        }
      }

      const defaultPrimaryColor = companyInputs.primaryColor?.value || '#cc1d1d';
      const defaultSecondaryColor = companyInputs.secondaryColor?.value || '#1f3c88';

      const updateDailyCapInputs = () => {
        if (!companyInputs.emailDailyCap) return;
        const enabled = companyInputs.emailDailyCapEnabled
          ? companyInputs.emailDailyCapEnabled.checked
          : true;
        if (!canEditCompany) {
          companyInputs.emailDailyCapEnabled?.setAttribute('disabled', 'disabled');
          companyInputs.emailDailyCap?.setAttribute('disabled', 'disabled');
          return;
        }
        companyInputs.emailDailyCap.disabled = !enabled;
      };

      const updateBounceRateInputs = () => {
        if (!companyInputs.emailBounceRateThreshold || !companyInputs.emailBounceMinSent) return;
        const enabled = companyInputs.emailAutoPauseBounceRate
          ? companyInputs.emailAutoPauseBounceRate.checked
          : true;
        if (!canEditCompany) {
          companyInputs.emailAutoPauseBounceRate?.setAttribute('disabled', 'disabled');
          companyInputs.emailBounceRateThreshold?.setAttribute('disabled', 'disabled');
          companyInputs.emailBounceMinSent?.setAttribute('disabled', 'disabled');
          return;
        }
        companyInputs.emailBounceRateThreshold.disabled = !enabled;
        companyInputs.emailBounceMinSent.disabled = !enabled;
      };

      const escapeHtml = (value) =>
        String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');

      const copyText = async (text) => {
        const value = String(text ?? '');
        if (!value) return false;
        if (navigator?.clipboard?.writeText) {
          await navigator.clipboard.writeText(value);
          return true;
        }
        const textarea = document.createElement('textarea');
        textarea.value = value;
        textarea.setAttribute('readonly', 'readonly');
        textarea.style.position = 'absolute';
        textarea.style.left = '-9999px';
        document.body.appendChild(textarea);
        textarea.select();
        try {
          document.execCommand('copy');
          return true;
        } finally {
          document.body.removeChild(textarea);
        }
      };

      const formatPhoneNumber = (value) => {
        const raw = String(value ?? '').trim();
        if (!raw) return '';
        const digits = raw.replace(/\D+/g, '');
        if (digits.length === 11 && digits.startsWith('1')) {
          const national = digits.slice(-10);
          return `+1 (${national.slice(0, 3)}) ${national.slice(3, 6)}-${national.slice(6)}`;
        }
        if (digits.length === 10) {
          return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6)}`;
        }
        return raw;
      };

      const PRICING = {
        buildrootzMonthly: 99,
        websiteMapMonthlyPerCommunity: 125
      };

      const statusMeta = {
        inactive: { label: 'Not enabled', badgeClass: 'bg-secondary' },
        pending: { label: 'Pending activation', badgeClass: 'bg-warning text-dark' },
        trial: { label: 'Trial', badgeClass: 'bg-info text-dark' },
        active: { label: 'Active', badgeClass: 'bg-success' }
      };

      const currencyFormatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        maximumFractionDigits: 0
      });

      const formatCurrency = (value) => currencyFormatter.format(Number(value || 0));

      const setCompanyStatus = (message, tone = 'muted') => {
        if (!companyStatusEl) return;
        companyStatusEl.textContent = message || '';
        companyStatusEl.classList.remove('text-muted', 'text-success', 'text-danger');
        if (!message) {
          companyStatusEl.classList.add('text-muted');
          return;
        }
        const toneClass = tone === 'success' ? 'text-success' : tone === 'danger' ? 'text-danger' : 'text-muted';
        companyStatusEl.classList.add(toneClass);
      };

      const clearCompanyStatus = () => setCompanyStatus('', 'muted');

      const emailDomainStatusMeta = {
        not_started: { label: 'Not started', badgeClass: 'bg-secondary' },
        pending: { label: 'Pending', badgeClass: 'bg-warning text-dark' },
        verified: { label: 'Verified', badgeClass: 'bg-success' },
        failed: { label: 'Failed', badgeClass: 'bg-danger' },
        removed: { label: 'Removed', badgeClass: 'bg-secondary' }
      };

      const setEmailDomainBadge = (status) => {
        if (!emailDomainEls.statusBadge) return;
        const meta = emailDomainStatusMeta[status] || emailDomainStatusMeta.not_started;
        emailDomainEls.statusBadge.textContent = meta.label;
        emailDomainEls.statusBadge.className = `badge ${meta.badgeClass}`;
      };

      const setEmailDomainStatus = (message, tone = 'muted') => {
        if (!emailDomainEls.statusMessage) return;
        emailDomainEls.statusMessage.textContent = message || '';
        emailDomainEls.statusMessage.classList.remove('text-muted', 'text-success', 'text-danger');
        const toneClass = tone === 'success' ? 'text-success' : tone === 'danger' ? 'text-danger' : 'text-muted';
        emailDomainEls.statusMessage.classList.add(toneClass);
      };

      const clearEmailDomainStatus = () => setEmailDomainStatus('', 'muted');

      const setBuildrootzStatus = (message, tone = 'muted') => {
        if (!buildrootzEls.status) return;
        buildrootzEls.status.textContent = message || '';
        buildrootzEls.status.classList.remove('text-muted', 'text-success', 'text-danger');
        const toneClass = tone === 'success' ? 'text-success' : tone === 'danger' ? 'text-danger' : 'text-muted';
        buildrootzEls.status.classList.add(toneClass);
      };

      const clearBuildrootzStatus = () => setBuildrootzStatus('', 'muted');

      const getInputValue = (input) => {
        if (!input || typeof input.value !== 'string') return '';
        return input.value.trim();
      };

      const updateBuildrootzLogoPreview = (url) => {
        if (!buildrootzEls.logoPreview || !buildrootzEls.logoPreviewWrapper) return;
        const trimmed = (url || '').trim();
        if (trimmed) {
          buildrootzEls.logoPreview.src = trimmed;
          buildrootzEls.logoPreview.style.display = 'block';
          buildrootzEls.logoPreviewWrapper.classList.remove('d-none');
        } else {
          buildrootzEls.logoPreview.src = '';
          buildrootzEls.logoPreview.style.display = 'none';
          buildrootzEls.logoPreviewWrapper.classList.add('d-none');
        }
      };

      const populateBuildrootzForm = (data) => {
        if (!data) return;
        if (buildrootzEls.name) buildrootzEls.name.value = data.builderName || '';
        if (buildrootzEls.logo) buildrootzEls.logo.value = data.logoUrl || '';
        if (buildrootzEls.description) buildrootzEls.description.value = data.description || '';
        updateBuildrootzLogoPreview(data.logoUrl || data.fallbackLogoUrl || '');
        state.buildrootz.data = data;
      };

      const showUsersLoading = (message = 'Loading users...') => {
        if (usersEls.loading) {
          usersEls.loading.textContent = message;
          usersEls.loading.classList.remove('d-none');
        }
        usersEls.error?.classList.add('d-none');
        usersEls.tableWrapper?.classList.add('d-none');
      };

      const showUsersError = (message) => {
        if (usersEls.error) {
          usersEls.error.textContent = message || 'Unable to load users right now.';
          usersEls.error.classList.remove('d-none');
        }
        usersEls.loading?.classList.add('d-none');
        usersEls.tableWrapper?.classList.add('d-none');
      };

      const showUsersTable = () => {
        usersEls.loading?.classList.add('d-none');
        usersEls.error?.classList.add('d-none');
        usersEls.tableWrapper?.classList.remove('d-none');
        if (usersControls.inviteCard) {
          // Keep invite card hidden by default; only open when toggled
          usersControls.inviteCard.classList.add('d-none');
        }
      };

      const fetchCompanyPayload = async () => {
        const response = await fetch('/api/admin/company', {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        let data;
        try {
          data = await readJsonResponse(response);
        } catch (parseErr) {
          if (!response.ok) throw parseErr;
          throw parseErr;
        }
        if (!response.ok) {
          throw new Error(data?.error || `Request failed (${response.status})`);
        }
        return data;
      };

      const fetchEmailDomain = async (companyId) => {
        if (!companyId) throw new Error('Missing company id.');
        const response = await fetch(`/api/admin/company/${encodeURIComponent(companyId)}/email-domain`, {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        const data = await readJsonResponse(response);
        if (!response.ok) {
          const message = data?.error || `Request failed (${response.status})`;
          throw new Error(message);
        }
        return data;
      };

      const fetchBuildrootzProfile = async () => {
        const response = await fetch('/api/admin/buildrootz/profile', {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        const data = await readJsonResponse(response);
        if (!response.ok) {
          const message = data?.error || `Request failed (${response.status})`;
          throw new Error(message);
        }
        return data;
      };

      const fetchBillingOverview = async () => {
        const response = await fetch('/api/admin/billing/overview', {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        const data = await readJsonResponse(response);
        if (!response.ok) {
          const message = data?.error || `Request failed (${response.status})`;
          throw new Error(message);
        }
        return data;
      };

      const setStatusBadge = (element, status) => {
        if (!element) return;
        const meta = statusMeta[status] || statusMeta.inactive;
        element.textContent = meta.label;
        element.className = `badge ${meta.badgeClass}`;
      };

      const setStatusToggle = (element, status) => {
        if (!element) return;
        element.checked = status === 'active' || status === 'trial';
      };

      const setBillingStatusMessage = (element, message, tone = 'muted') => {
        if (!element) return;
        element.textContent = message || '';
        element.classList.remove('text-muted', 'text-success', 'text-danger');
        element.classList.add('small');
        if (!message) {
          element.classList.add('text-muted');
          return;
        }
        const toneClass = tone === 'success' ? 'text-success' : tone === 'danger' ? 'text-danger' : 'text-muted';
        element.classList.add(toneClass);
      };

      const getWebsiteMapCardStatus = (payload) => {
        const communities = Array.isArray(payload?.communities) ? payload.communities : [];
        const hasActive = communities.some((community) => community.websiteMap?.status === 'active');
        if (hasActive) return 'active';
        const hasTrial = communities.some((community) => community.websiteMap?.status === 'trial');
        if (hasTrial) return 'trial';
        const hasPending = communities.some((community) => community.pendingRequest);
        if (hasPending) return 'pending';
        return 'inactive';
      };

      const getTrialDaysRemaining = (trialEndsAt, now) => {
        if (!trialEndsAt) return null;
        const end = new Date(trialEndsAt);
        if (Number.isNaN(end.getTime())) return null;
        const diffMs = end.getTime() - now.getTime();
        return Math.ceil(diffMs / (24 * 60 * 60 * 1000));
      };

      const renderBillingSummary = () => {
        if (!billingEls.summaryBody || !billingEls.summaryTotal) return;
        if (!state.billing.data) {
          billingEls.summaryBody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-muted">Loading usage...</td>
            </tr>
          `;
          billingEls.summaryTotal.textContent = formatCurrency(0);
          return;
        }

        const payload = state.billing.data;
        const rows = [];
        let total = 0;

        const buildrootzStatus = payload.features?.buildrootz?.status || 'inactive';
        if (buildrootzStatus === 'active' || buildrootzStatus === 'trial') {
          total += PRICING.buildrootzMonthly;
          rows.push(`
            <tr>
              <td>${escapeHtml('Buildrootz')}</td>
              <td>${escapeHtml('Company')}</td>
              <td>1</td>
              <td class="text-end">${escapeHtml(formatCurrency(PRICING.buildrootzMonthly))}</td>
            </tr>
          `);
        }

        const communities = Array.isArray(payload.communities) ? payload.communities : [];
        const activeWebsiteMap = communities.filter((community) =>
          ['active', 'trial'].includes(community.websiteMap?.status)
        );
        if (activeWebsiteMap.length) {
          const freeSetups = payload.entitlements?.websiteMap?.freeCommunitySetups || 0;
          const billableCount = Math.max(0, activeWebsiteMap.length - freeSetups);
          const websiteMapCost = billableCount * PRICING.websiteMapMonthlyPerCommunity;
          total += websiteMapCost;
          rows.push(`
            <tr>
              <td>${escapeHtml('Website Map')}</td>
              <td>${escapeHtml('Per community')}</td>
              <td>${escapeHtml(String(activeWebsiteMap.length))}</td>
              <td class="text-end">${escapeHtml(formatCurrency(websiteMapCost))}</td>
            </tr>
          `);
        }

        if (!rows.length) {
          billingEls.summaryBody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-muted">No active or trial products yet.</td>
            </tr>
          `;
        } else {
          billingEls.summaryBody.innerHTML = rows.join('');
        }

        billingEls.summaryTotal.textContent = formatCurrency(total);
      };

      const renderWebsiteMapPanel = () => {
        if (!billingEls.websiteMapPanel || !billingEls.websiteMapCommunityTable) return;
        if (!state.billing.data) return;

        const payload = state.billing.data;
        const now = new Date(payload.serverTime || Date.now());
        const communities = Array.isArray(payload.communities) ? payload.communities : [];

        if (!communities.length) {
          billingEls.websiteMapCommunityTable.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-muted">No communities found.</td>
            </tr>
          `;
          return;
        }

        const rows = communities
          .map((community) => {
            const communityId = community.id;
            const rawStatus = community.websiteMap?.status || 'inactive';
            const status = community.pendingRequest ? 'pending' : rawStatus;
            const meta = statusMeta[status] || statusMeta.inactive;
            const daysRemaining = rawStatus === 'trial'
              ? getTrialDaysRemaining(community.websiteMap?.trialEndsAt, now)
              : null;
            const trialLabel = rawStatus === 'trial'
              ? daysRemaining == null
                ? '--'
                : daysRemaining <= 0
                  ? 'Expired'
                  : `${daysRemaining} day${daysRemaining === 1 ? '' : 's'} left`
              : '--';

            const trialEligible =
              rawStatus === 'inactive' && !community.pendingRequest && !community.websiteMap?.trialEndsAt;

            let actionMarkup = '<span class="text-muted small">--</span>';
            if (!canManageBilling) {
              actionMarkup = '<span class="text-muted small">View only</span>';
            } else if (status === 'pending') {
              actionMarkup = '<button type="button" class="btn btn-sm btn-outline-secondary" disabled>Pending</button>';
            } else if (rawStatus === 'active') {
              actionMarkup = '<span class="text-muted small">Active</span>';
            } else if (rawStatus === 'trial') {
              actionMarkup = '<span class="text-muted small">In trial</span>';
            } else if (trialEligible) {
              actionMarkup = `
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  data-action="website-map-trial"
                  data-community-id="${escapeHtml(communityId)}"
                >
                  Start trial
                </button>
              `;
            } else if (rawStatus === 'inactive') {
              actionMarkup = `
                <button
                  type="button"
                  class="btn btn-sm btn-outline-primary"
                  data-action="website-map-request"
                  data-community-id="${escapeHtml(communityId)}"
                >
                  Request activation
                </button>
              `;
            }

            return `
              <tr data-community-id="${escapeHtml(communityId)}">
                <td>${escapeHtml(community.name || 'Unnamed Community')}</td>
                <td><span class="badge ${escapeHtml(meta.badgeClass)}">${escapeHtml(meta.label)}</span></td>
                <td>${escapeHtml(trialLabel)}</td>
                <td class="text-end">${actionMarkup}</td>
              </tr>
            `;
          })
          .join('');

        billingEls.websiteMapCommunityTable.innerHTML = rows;
      };

      const renderBillingCards = () => {
        if (!state.billing.data) return;
        const payload = state.billing.data;

        const buildrootzStatus = payload.features?.buildrootz?.status || 'inactive';
        setStatusBadge(billingEls.buildrootzStatusBadge, buildrootzStatus);
        setStatusToggle(billingEls.buildrootzToggle, buildrootzStatus);

        if (billingEls.buildrootzRequestButton) {
          const disableButton =
            !canManageBilling || ['active', 'trial', 'pending'].includes(buildrootzStatus);
          billingEls.buildrootzRequestButton.disabled = disableButton;
        }

        const websiteMapStatus = getWebsiteMapCardStatus(payload);
        setStatusBadge(billingEls.websiteMapStatusBadge, websiteMapStatus);
        setStatusToggle(billingEls.websiteMapToggle, websiteMapStatus);
      };

      const renderBillingPanel = () => {
        renderBillingCards();
        renderBillingSummary();
        if (billingEls.websiteMapPanel && !billingEls.websiteMapPanel.classList.contains('d-none')) {
          renderWebsiteMapPanel();
        }
      };

      const loadBillingPanel = async ({ force = false } = {}) => {
        if (state.billing.loading) return;
        if (!force && state.loadedPanels.has('billing') && state.billing.data) {
          renderBillingPanel();
          return;
        }

        state.billing.loading = true;
        if (billingEls.summaryBody) {
          billingEls.summaryBody.innerHTML = `
            <tr>
              <td colspan="4" class="text-center text-muted">Loading usage...</td>
            </tr>
          `;
        }

        try {
          const payload = await fetchBillingOverview();
          state.billing.data = payload;
          state.loadedPanels.add('billing');
          renderBillingPanel();
          if (!canManageBilling) {
            setBillingStatusMessage(billingEls.buildrootzRequestStatus, billingViewOnlyMessage, 'muted');
            setBillingStatusMessage(billingEls.websiteMapRequestStatus, billingViewOnlyMessage, 'muted');
            if (billingEls.websiteMapPanelStatus) {
              setBillingStatusMessage(billingEls.websiteMapPanelStatus, billingViewOnlyMessage, 'muted');
            }
          }
        } catch (err) {
          console.error('Failed to load billing overview', err);
          if (billingEls.summaryBody) {
            billingEls.summaryBody.innerHTML = `
              <tr>
                <td colspan="4" class="text-center text-danger">Unable to load billing overview.</td>
              </tr>
            `;
          }
        } finally {
          state.billing.loading = false;
        }
      };

      const requestBuildrootzActivation = async () => {
        if (!canManageBilling || !billingEls.buildrootzRequestButton) return;
        if (state.billing.requestingBuildrootz) return;

        state.billing.requestingBuildrootz = true;
        billingEls.buildrootzRequestButton.disabled = true;
        setBillingStatusMessage(billingEls.buildrootzRequestStatus, 'Sending request...', 'muted');

        try {
          const response = await fetch('/api/admin/billing/feature-requests', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ feature: 'buildrootz' })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }

          if (state.billing.data?.features?.buildrootz) {
            state.billing.data.features.buildrootz.status = 'pending';
          }
          if (state.billing.data?.pendingRequests) {
            state.billing.data.pendingRequests.buildrootz = true;
          }
          setBillingStatusMessage(billingEls.buildrootzRequestStatus, 'Request sent. Pending activation.', 'success');
          renderBillingPanel();
        } catch (err) {
          console.error('Buildrootz request failed', err);
          setBillingStatusMessage(
            billingEls.buildrootzRequestStatus,
            err.message || 'Unable to request activation.',
            'danger'
          );
        } finally {
          state.billing.requestingBuildrootz = false;
          renderBillingPanel();
        }
      };

      const openWebsiteMapPanel = async () => {
        if (!billingEls.websiteMapPanel) return;
        billingEls.websiteMapPanel.classList.remove('d-none');
        setBillingStatusMessage(
          billingEls.websiteMapRequestStatus,
          canManageBilling ? 'Select communities below to start a trial or request activation.' : billingViewOnlyMessage,
          'muted'
        );
        await loadBillingPanel();
        renderWebsiteMapPanel();
      };

      const closeWebsiteMapPanel = () => {
        billingEls.websiteMapPanel?.classList.add('d-none');
      };

      const requestWebsiteMapActivation = async (communityId) => {
        if (!canManageBilling) return;
        if (!communityId) return;

        setBillingStatusMessage(billingEls.websiteMapPanelStatus, 'Sending request...', 'muted');

        try {
          const response = await fetch('/api/admin/billing/feature-requests', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ feature: 'websiteMap', communityId })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }

          if (state.billing.data?.communities) {
            const match = state.billing.data.communities.find((community) => community.id === communityId);
            if (match) {
              match.pendingRequest = true;
            }
          }
          setBillingStatusMessage(billingEls.websiteMapPanelStatus, 'Request sent. Pending activation.', 'success');
          renderBillingPanel();
        } catch (err) {
          console.error('Website Map request failed', err);
          setBillingStatusMessage(
            billingEls.websiteMapPanelStatus,
            err.message || 'Unable to request activation.',
            'danger'
          );
        }
      };

      const startWebsiteMapTrial = async (communityId) => {
        if (!canManageBilling) return;
        if (!communityId) return;

        setBillingStatusMessage(billingEls.websiteMapPanelStatus, 'Starting trial...', 'muted');

        try {
          const response = await fetch('/api/admin/billing/website-map/trial', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ communityId })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }

          if (state.billing.data?.communities) {
            const match = state.billing.data.communities.find((community) => community.id === communityId);
            if (match) {
              match.websiteMap = match.websiteMap || {};
              match.websiteMap.status = 'trial';
              match.websiteMap.trialEndsAt = data?.trialEndsAt || null;
              match.pendingRequest = false;
            }
          }
          setBillingStatusMessage(billingEls.websiteMapPanelStatus, 'Trial started.', 'success');
          renderBillingPanel();
        } catch (err) {
          console.error('Website Map trial failed', err);
          setBillingStatusMessage(
            billingEls.websiteMapPanelStatus,
            err.message || 'Unable to start trial.',
            'danger'
          );
        }
      };

      const handleWebsiteMapTableClick = async (event) => {
        const actionButton = event.target.closest('button[data-action]');
        if (!actionButton) return;
        const action = actionButton.dataset.action;
        const communityId = actionButton.dataset.communityId;
        if (!communityId) return;

        if (action === 'website-map-trial') {
          await startWebsiteMapTrial(communityId);
          return;
        }

        if (action === 'website-map-request') {
          await requestWebsiteMapActivation(communityId);
        }
      };

      const populateCompanyForm = (payload) => {
        if (!companyForm || !payload) return;
        const address = payload.address || {};
        const primaryContact = payload.primaryContact || {};
        const branding = payload.branding || {};

        if (companyInputs.name) companyInputs.name.value = payload.companyName || '';
        if (companyInputs.street) companyInputs.street.value = address.street || '';
        if (companyInputs.city) companyInputs.city.value = address.city || '';
        if (companyInputs.state) companyInputs.state.value = address.state || '';
        if (companyInputs.zip) companyInputs.zip.value = address.zip || '';

        if (companyInputs.primaryName) companyInputs.primaryName.value = primaryContact.name || '';
        if (companyInputs.primaryEmail) companyInputs.primaryEmail.value = primaryContact.email || '';
        if (companyInputs.primaryPhone) {
          companyInputs.primaryPhone.value = primaryContact.phoneDisplay || primaryContact.phone || '';
        }

        if (companyInputs.logoUrl) companyInputs.logoUrl.value = branding.logoUrl || '';
        if (companyInputs.primaryColor) {
          companyInputs.primaryColor.value = branding.primaryColor || defaultPrimaryColor;
        }
        if (companyInputs.secondaryColor) {
          companyInputs.secondaryColor.value = branding.secondaryColor || defaultSecondaryColor;
        }

        if (companyInputs.timezone) {
          const tzValue = payload.timezone || '';
          Array.from(companyInputs.timezone.querySelectorAll('option[data-dynamic="true"]') || []).forEach((option) =>
            option.remove()
          );
          if (tzValue) {
            const hasOption = Array.from(companyInputs.timezone.options || []).some(
              (option) => option.value === tzValue
            );
            if (!hasOption) {
              const option = document.createElement('option');
              option.value = tzValue;
              option.textContent = tzValue;
              option.dataset.dynamic = 'true';
              companyInputs.timezone.appendChild(option);
            }
          }
          companyInputs.timezone.value = tzValue;
        }
        if (companyInputs.emailDailyCapEnabled) {
          companyInputs.emailDailyCapEnabled.checked = payload.emailDailyCapEnabled !== false;
        }
        if (companyInputs.emailDailyCap) {
          const capValue = Number(payload.emailDailyCap);
          companyInputs.emailDailyCap.value = Number.isFinite(capValue) ? capValue : 500;
        }
        if (companyInputs.emailAutoPauseSpamReport) {
          companyInputs.emailAutoPauseSpamReport.checked = payload.emailAutoPauseOnSpamReport !== false;
        }
        if (companyInputs.emailAutoPauseBounceRate) {
          companyInputs.emailAutoPauseBounceRate.checked = payload.emailAutoPauseOnBounceRate !== false;
        }
        if (companyInputs.emailBounceRateThreshold) {
          const threshold = Number(payload.emailBounceRateThreshold);
          const percent = Number.isFinite(threshold) ? threshold * 100 : 5;
          companyInputs.emailBounceRateThreshold.value = Number.isFinite(percent) ? percent : 5;
        }
        if (companyInputs.emailBounceMinSent) {
          const minSent = Number(payload.emailBounceMinSentForEvaluation);
          companyInputs.emailBounceMinSent.value = Number.isFinite(minSent) ? minSent : 50;
        }
        updateDailyCapInputs();
        updateBounceRateInputs();
        renderDeliverabilityStatus(payload);
        if (companyInputs.notes) companyInputs.notes.value = payload.notes || '';
      };

      const formatDateTime = (value) => {
        if (!value) return '';
        const date = new Date(value);
        if (Number.isNaN(date.getTime())) return '';
        return date.toLocaleString();
      };

      const formatPauseReason = (reason) => {
        switch (String(reason || '').toLowerCase()) {
          case 'spamreport':
            return 'spam complaint';
          case 'bounce_rate':
            return 'high bounce rate';
          case 'manual':
            return 'manual pause';
          default:
            return 'deliverability protection';
        }
      };

      const formatHealthState = (state) => {
        switch (String(state || '').toUpperCase()) {
          case 'ACTIVE':
            return 'Active';
          case 'PAUSED':
            return 'Paused';
          case 'WARMING_UP':
            return 'Warming up';
          case 'LIMITED':
            return 'Limited';
          case 'MISCONFIGURED':
            return 'Misconfigured';
          default:
            return 'Unknown';
        }
      };

      const setDeliverabilityStatusBadge = (status) => {
        if (!deliverabilityEls.statusBadge) return;
        deliverabilityEls.statusBadge.className = 'badge';
        if (status === 'PAUSED') {
          deliverabilityEls.statusBadge.classList.add('bg-danger');
          deliverabilityEls.statusBadge.textContent = 'Paused';
        } else if (status === 'WARMING_UP') {
          deliverabilityEls.statusBadge.classList.add('bg-warning', 'text-dark');
          deliverabilityEls.statusBadge.textContent = 'Warm-up';
        } else if (status === 'LIMITED') {
          deliverabilityEls.statusBadge.classList.add('bg-warning', 'text-dark');
          deliverabilityEls.statusBadge.textContent = 'Limited';
        } else if (status === 'MISCONFIGURED') {
          deliverabilityEls.statusBadge.classList.add('bg-warning', 'text-dark');
          deliverabilityEls.statusBadge.textContent = 'Needs setup';
        } else if (status === 'ACTIVE') {
          deliverabilityEls.statusBadge.classList.add('bg-success');
          deliverabilityEls.statusBadge.textContent = 'Active';
        } else {
          deliverabilityEls.statusBadge.classList.add('bg-secondary');
          deliverabilityEls.statusBadge.textContent = 'Unknown';
        }
      };

      const getEmailErrorLabelSafe = (value) => {
        if (typeof window !== 'undefined' && typeof window.getEmailErrorLabel === 'function') {
          return window.getEmailErrorLabel(value);
        }
        return value;
      };

      const renderDeliverabilityStatus = (payload) => {
        if (!deliverabilityEls.section || !payload) return;
        const fallbackHealth = payload.sendingPaused
          ? {
            state: payload.sendingPaused.paused ? 'PAUSED' : 'ACTIVE',
            reason: payload.sendingPaused.reason || '',
            recommendedAction: payload.sendingPaused.paused
              ? 'Review deliverability and resume when ready.'
              : 'No action needed.'
          }
          : {
            state: payload.emailSendingPaused ? 'PAUSED' : 'ACTIVE',
            reason: payload.emailSendingPausedReason || (payload.emailSendingPaused ? '' : 'Sending active.'),
            recommendedAction: payload.emailSendingPaused
              ? 'Review deliverability and resume when ready.'
              : 'No action needed.'
          };
        const health = payload.health || fallbackHealth;
        const state = String(health.state || 'UNKNOWN').toUpperCase();
        const rawReason = health.reason || '';
        let reason = rawReason;
        if (state === 'PAUSED' && rawReason) {
          reason = `Paused due to ${formatPauseReason(rawReason)}.`;
        }
        const action = health.recommendedAction || '';

        setDeliverabilityStatusBadge(state);
        if (deliverabilityEls.healthState) {
          deliverabilityEls.healthState.textContent = formatHealthState(state);
        }
        if (deliverabilityEls.statusMessage) {
          deliverabilityEls.statusMessage.textContent = reason || '';
        }
        if (deliverabilityEls.healthAction) {
          deliverabilityEls.healthAction.textContent = action || '';
        }

        const pausedMetaSource = payload.sendingPaused?.meta || payload.emailSendingPausedMeta || null;
        if (deliverabilityEls.statusMeta) {
          const metaParts = [];
          if (pausedMetaSource?.recipientEmail) metaParts.push(`Recipient: ${pausedMetaSource.recipientEmail}`);
          if (pausedMetaSource?.bounceRate != null) {
            const ratePct = Math.round(Number(pausedMetaSource.bounceRate || 0) * 1000) / 10;
            metaParts.push(`Bounce rate: ${ratePct}%`);
          }
          deliverabilityEls.statusMeta.textContent = metaParts.join(' - ');
        }

        const warmup = payload.warmup || null;
        if (deliverabilityEls.warmupBadge) {
          if (warmup?.active) {
            const dayIndex = warmup.dayIndex || 1;
            const daysTotal = warmup.daysTotal || 14;
            const cap = warmup.capOverrideToday || warmup.capOverride || warmup.cap || '--';
            deliverabilityEls.warmupBadge.textContent = `Warm-up Day ${dayIndex}/${daysTotal} - Today cap: ${cap}`;
          } else {
            deliverabilityEls.warmupBadge.textContent = '';
          }
        }

        if (deliverabilityEls.resumeButton) {
          const shouldShowResume = state === 'PAUSED' && canEditCompany;
          deliverabilityEls.resumeButton.classList.toggle('d-none', !shouldShowResume);
          deliverabilityEls.resumeButton.disabled = !canEditCompany;
        }
      };

      const renderDeliverabilityMetrics = (payload) => {
        if (!deliverabilityEls.section || !payload) return;
        const sentToday = Number(payload.dailyCap?.sentToday || 0);
        const bouncesToday = Number(payload.eventsToday?.bounces || 0);
        const spamreportsToday = Number(payload.eventsToday?.spamreports || 0);
        const capEnabled = payload.dailyCap?.enabled !== false;
        const baseCap = Number(payload.dailyCap?.baseCap ?? payload.dailyCap?.cap ?? 0);
        const effectiveCap = Number(payload.dailyCap?.effectiveCap ?? payload.dailyCap?.cap ?? 0);
        const remaining = capEnabled ? Math.max(0, Number(payload.dailyCap?.remaining || 0)) : null;

        if (deliverabilityEls.sentToday) deliverabilityEls.sentToday.textContent = String(sentToday);
        if (deliverabilityEls.bouncesToday) deliverabilityEls.bouncesToday.textContent = String(bouncesToday);
        if (deliverabilityEls.spamreportsToday) deliverabilityEls.spamreportsToday.textContent = String(spamreportsToday);

        if (deliverabilityEls.baseCap) {
          deliverabilityEls.baseCap.textContent = capEnabled ? String(baseCap) : 'Disabled';
        }
        if (deliverabilityEls.effectiveCap) {
          deliverabilityEls.effectiveCap.textContent = capEnabled ? String(effectiveCap) : 'Disabled';
        }
        if (deliverabilityEls.remaining) {
          deliverabilityEls.remaining.textContent = capEnabled ? String(remaining) : 'Disabled';
        }

        if (deliverabilityEls.reset) {
          const resetAt = payload.day?.resetAt;
          const tz = payload.timezone || payload.day?.timeZone || 'UTC';
          if (resetAt) {
            const resetDate = new Date(resetAt);
            const resetText = Number.isNaN(resetDate.getTime())
              ? 'Reset: --'
              : `Reset: ${resetDate.toLocaleString('en-US', { timeZone: tz })} (${tz})`;
            deliverabilityEls.reset.textContent = resetText;
          } else {
            deliverabilityEls.reset.textContent = 'Reset: --';
          }
        }
      };

      const renderEmailReadiness = (payload) => {
        if (!deliverabilityEls.readinessBanner) return;
        const readiness = payload?.emailReadiness;
        const blockers = Array.isArray(readiness?.blast?.blockers) ? readiness.blast.blockers : [];
        if (!readiness || readiness.blast?.enabled || blockers.length === 0) {
          deliverabilityEls.readinessBanner.classList.add('d-none');
          if (deliverabilityEls.readinessMessage) deliverabilityEls.readinessMessage.textContent = '';
          if (deliverabilityEls.readinessDetails) deliverabilityEls.readinessDetails.textContent = '';
          return;
        }

        const blockerText = blockers.map((blocker) => blocker.message).filter(Boolean).join(' ');
        if (deliverabilityEls.readinessMessage) {
          deliverabilityEls.readinessMessage.textContent = blockerText || 'Configuration missing.';
        }

        const baseUrlSource = readiness.blast?.unsubscribe?.baseUrlSource || null;
        const baseSourceLabel =
          baseUrlSource === 'email_unsubscribe_base_url'
            ? 'EMAIL_UNSUBSCRIBE_BASE_URL'
            : baseUrlSource === 'base_url'
              ? 'BASE_URL'
              : null;
        const detailParts = [];
        if (baseSourceLabel) detailParts.push(`Base URL source: ${baseSourceLabel}.`);
        if (blockers.length) {
          const codes = blockers.map((blocker) => blocker.code).filter(Boolean).join(', ');
          if (codes) detailParts.push(`Blockers: ${codes}.`);
        }
        if (deliverabilityEls.readinessDetails) {
          deliverabilityEls.readinessDetails.textContent = detailParts.join(' ');
        }

        deliverabilityEls.readinessBanner.classList.remove('d-none');
      };

      const renderDeliverabilityActions = (payload) => {
        if (!deliverabilityEls.section) return;
        const healthState = String(payload?.health?.state || '').toUpperCase();
        const ctaAction = String(payload?.health?.cta?.action || '').toLowerCase();
        const warmup = payload?.warmup || {};
        const domainStatus = String(payload?.domain?.status || '').toLowerCase();

        if (deliverabilityEls.warmupResetButton) {
          const show = Boolean(warmup?.enabled && warmup?.active && canEditCompany);
          deliverabilityEls.warmupResetButton.classList.toggle('d-none', !show);
          deliverabilityEls.warmupResetButton.disabled = !show;
        }
        if (deliverabilityEls.warmupDisableButton) {
          const show = Boolean(warmup?.enabled && warmup?.active && canEditCompany);
          deliverabilityEls.warmupDisableButton.classList.toggle('d-none', !show);
          deliverabilityEls.warmupDisableButton.disabled = !show;
        }
        if (deliverabilityEls.warmupEnableButton) {
          const show = Boolean(!warmup?.enabled && domainStatus === 'verified' && canEditCompany);
          deliverabilityEls.warmupEnableButton.classList.toggle('d-none', !show);
          deliverabilityEls.warmupEnableButton.disabled = !show;
        }
        if (deliverabilityEls.verifyDomainButton) {
          const show = healthState === 'MISCONFIGURED' || ctaAction === 'verify_domain';
          deliverabilityEls.verifyDomainButton.classList.toggle('d-none', !show);
        }
      };

      const renderEmailQueueSummary = (payload) => {
        if (!emailQueueEls.section || !emailQueueEls.summaryBody) return;
        const rows = Array.isArray(payload?.summary) ? payload.summary : [];
        if (!rows.length) {
          emailQueueEls.summaryBody.innerHTML =
            '<tr><td colspan="3" class="text-center text-muted">No blocked jobs.</td></tr>';
          return;
        }
        emailQueueEls.summaryBody.innerHTML = rows
          .map((row) => {
            const label = getEmailErrorLabelSafe(row.reason) || row.reason || 'Unknown';
            const nextAttempt = row.nextAttemptAt ? formatDateTime(row.nextAttemptAt) : '--';
            return `
              <tr>
                <td>${escapeHtml(label)}</td>
                <td>${Number(row.count || 0)}</td>
                <td>${escapeHtml(nextAttempt)}</td>
              </tr>
            `;
          })
          .join('');
      };

      const renderEmailQueueSamples = (payload) => {
        if (!emailQueueEls.section || !emailQueueEls.samplesBody) return;
        const rows = Array.isArray(payload?.samples) ? payload.samples : [];
        if (!rows.length) {
          emailQueueEls.samplesBody.innerHTML =
            '<tr><td colspan="4" class="text-center text-muted">No blocked jobs.</td></tr>';
          return;
        }
        emailQueueEls.samplesBody.innerHTML = rows
          .map((row) => {
            const label = getEmailErrorLabelSafe(row.lastError) || row.lastError || 'Unknown';
            const scheduledFor = row.scheduledFor ? formatDateTime(row.scheduledFor) : '--';
            const createdAt = row.createdAt ? formatDateTime(row.createdAt) : '--';
            const nextAttemptAt = row.nextAttemptAt ? formatDateTime(row.nextAttemptAt) : '--';
            const details = [
              `Reason: ${escapeHtml(label)}`,
              `Created: ${escapeHtml(createdAt)}`,
              `Scheduled: ${escapeHtml(scheduledFor)}`,
              `Next attempt: ${escapeHtml(nextAttemptAt)}`,
              `From mode: ${escapeHtml(row.fromMode || '--')}`,
              `From email: ${escapeHtml(row.fromEmailUsed || '--')}`,
              `Reply-to: ${escapeHtml(row.replyToUsed || '--')}`
            ].join('<br />');
            return `
              <tr data-email-row="${row.id}">
                <td>${escapeHtml(row.to || '')}</td>
                <td>${escapeHtml(label)}</td>
                <td>${escapeHtml(scheduledFor)}</td>
                <td class="text-end">
                  <button type="button" class="btn btn-link btn-sm" data-action="toggle-email-details" data-job-id="${row.id}">
                    Details
                  </button>
                </td>
              </tr>
              <tr class="d-none" data-email-details="${row.id}">
                <td colspan="4">
                  <div class="small text-muted">${details}</div>
                </td>
              </tr>
            `;
          })
          .join('');
      };

      const setSystemCheckBadge = (el, ok, labels = {}) => {
        if (!el) return;
        const okLabel = labels.ok || 'OK';
        const badLabel = labels.bad || 'Missing';
        const unknownLabel = labels.unknown || 'Unknown';
        el.className = 'badge';
        if (ok === true) {
          el.classList.add('bg-success');
          el.textContent = okLabel;
        } else if (ok === false) {
          el.classList.add('bg-danger');
          el.textContent = badLabel;
        } else {
          el.classList.add('bg-secondary');
          el.textContent = unknownLabel;
        }
      };

      const renderEmailSystemCheck = (payload) => {
        if (!emailSystemCheckEls.section || !payload) return;
        const sendgrid = payload.sendgrid || {};
        const unsubscribe = payload.unsubscribe || {};
        const scheduler = payload.scheduler || {};
        const readiness = payload.readiness || {};

        setSystemCheckBadge(emailSystemCheckEls.sendgridKey, sendgrid.apiKeyPresent);
        setSystemCheckBadge(emailSystemCheckEls.webhookSecret, sendgrid.webhookSecretPresent);
        setSystemCheckBadge(emailSystemCheckEls.unsubSecret, unsubscribe.secretPresent);
        setSystemCheckBadge(emailSystemCheckEls.baseUrl, unsubscribe.baseUrlResolved);

        if (emailSystemCheckEls.baseUrlValue) {
          emailSystemCheckEls.baseUrlValue.textContent = unsubscribe.effectiveBaseUrl
            ? `(${unsubscribe.effectiveBaseUrl})`
            : '';
        }

        setSystemCheckBadge(emailSystemCheckEls.scheduler, scheduler.heartbeatOk, {
          ok: 'Running',
          bad: 'Not running'
        });
        if (emailSystemCheckEls.schedulerText) {
          emailSystemCheckEls.schedulerText.textContent = scheduler.heartbeatOk
            ? 'Scheduler running'
            : 'Scheduler not running';
        }
        if (emailSystemCheckEls.schedulerMeta) {
          const lastRun = scheduler.lastRunAt ? formatDateTime(scheduler.lastRunAt) : '--';
          const minutes = Number.isFinite(scheduler.minutesSinceLastRun)
            ? `${scheduler.minutesSinceLastRun} min ago`
            : 'n/a';
          emailSystemCheckEls.schedulerMeta.textContent = `Last run: ${lastRun} (${minutes})`;
        }

        setSystemCheckBadge(emailSystemCheckEls.transactional, readiness.transactionalEnabled, {
          ok: 'Enabled',
          bad: 'Disabled'
        });
        setSystemCheckBadge(emailSystemCheckEls.blast, readiness.blastEnabled, {
          ok: 'Enabled',
          bad: 'Disabled'
        });

        if (emailSystemCheckEls.blockers) {
          const blockers = Array.isArray(readiness.blockers) ? readiness.blockers : [];
          emailSystemCheckEls.blockers.textContent = blockers.length
            ? blockers
              .map((blocker) => `${blocker.code || 'UNKNOWN'}: ${blocker.message || ''}`.trim())
              .join(' | ')
            : 'No blockers detected.';
        }
      };

      const fetchEmailDeliverability = async (companyId) => {
        const response = await fetch(`/api/admin/company/${encodeURIComponent(companyId)}/email-deliverability`, {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        const data = await readJsonResponse(response);
        if (!response.ok) {
          throw new Error(data?.error || `Request failed (${response.status})`);
        }
        return data;
      };

      const fetchEmailSystemCheck = async (companyId) => {
        const response = await fetch(`/api/admin/company/${encodeURIComponent(companyId)}/email-system-check`, {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        const data = await readJsonResponse(response);
        if (!response.ok) {
          throw new Error(data?.error || `Request failed (${response.status})`);
        }
        return data;
      };

      const fetchEmailQueueDebug = async (companyId) => {
        const response = await fetch(
          `/api/admin/company/${encodeURIComponent(companyId)}/email-jobs/blocked?limit=15`,
          {
            headers: { Accept: 'application/json' },
            credentials: 'same-origin'
          }
        );
        const data = await readJsonResponse(response);
        if (!response.ok) {
          throw new Error(data?.error || `Request failed (${response.status})`);
        }
        return data;
      };

      const renderEmailDomainDns = (records = []) => {
        if (!emailDomainEls.dnsBody) return;
        if (!records.length) {
          emailDomainEls.dnsBody.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted">No DNS records available.</td>
            </tr>
          `;
          return;
        }

        emailDomainEls.dnsBody.innerHTML = records
          .map((record) => `
            <tr>
              <td>${escapeHtml(record.type || '')}</td>
              <td>${escapeHtml(record.host || '')}</td>
              <td class="text-break">${escapeHtml(record.value || record.data || '')}</td>
              <td>${escapeHtml(record.purpose || '')}</td>
              <td class="text-end">
                <div class="btn-group btn-group-sm" role="group">
                  <button type="button" class="btn btn-outline-secondary" data-copy="${escapeHtml(record.host || '')}">Host</button>
                  <button type="button" class="btn btn-outline-secondary" data-copy="${escapeHtml(record.value || record.data || '')}">Value</button>
                </div>
              </td>
            </tr>
          `)
          .join('');
      };

      const renderEmailDomain = () => {
        if (!emailDomainEls.section) return;
        const data = state.emailDomain.data || { status: 'not_started' };
        const status = data.status || 'not_started';
        const hasStarted = status !== 'not_started' && status !== 'removed' && data.domain;

        setEmailDomainBadge(status);

        if (emailDomainEls.domain) emailDomainEls.domain.value = data.domain || '';
        if (emailDomainEls.subdomain) emailDomainEls.subdomain.value = data.subdomain || 'email';
        if (emailDomainEls.linkBranding) {
          emailDomainEls.linkBranding.checked = data.linkBranding !== false;
        }

        const lockInputs = hasStarted;
        [emailDomainEls.domain, emailDomainEls.subdomain, emailDomainEls.linkBranding].forEach((el) => {
          if (!el) return;
          if (!canEditCompany) {
            el.setAttribute('disabled', 'disabled');
          } else {
            el.toggleAttribute('disabled', lockInputs);
          }
        });

        if (emailDomainEls.startButton) {
          const canStart = canEditCompany && !hasStarted;
          emailDomainEls.startButton.disabled = !canStart;
        }
        if (emailDomainEls.validateButton) {
          emailDomainEls.validateButton.disabled = !canEditCompany || !hasStarted;
        }
        if (emailDomainEls.removeButton) {
          emailDomainEls.removeButton.disabled = !canEditCompany || !hasStarted;
          emailDomainEls.removeButton.classList.toggle('d-none', !hasStarted);
        }

        if (emailDomainEls.dnsWrapper) {
          emailDomainEls.dnsWrapper.classList.toggle('d-none', !hasStarted);
        }
        if (hasStarted) {
          renderEmailDomainDns(data.dnsRecords || []);
        }

        let statusMessage = '';
        if (status === 'verified') {
          statusMessage = `Verified ${formatDateTime(data.verifiedAt) || ''}`.trim();
        } else if (status === 'pending') {
          statusMessage = 'Pending verification. Add the DNS records below and click Validate.';
        } else if (status === 'failed') {
          const errorText = data?.lastValidation?.results?.errors?.[0]?.message;
          statusMessage = errorText
            ? `Validation failed: ${errorText}`
            : 'Validation failed. Check your DNS records and try again.';
        } else if (status === 'removed' || status === 'not_started') {
          statusMessage = 'No domain configured yet.';
        }
        setEmailDomainStatus(statusMessage || '', status === 'failed' ? 'danger' : 'muted');
      };

      const loadCompanyPanel = async ({ force = false } = {}) => {
        if (!companyForm) return;
        if (state.company.loading) return;
        if (!force && state.loadedPanels.has('company') && state.company.data) {
          populateCompanyForm(state.company.data);
          if (state.emailDomain.data) {
            renderEmailDomain();
          }
          if (state.emailDeliverability.data) {
            renderDeliverabilityStatus(state.emailDeliverability.data);
            renderDeliverabilityMetrics(state.emailDeliverability.data);
            renderDeliverabilityActions(state.emailDeliverability.data);
            renderEmailReadiness(state.emailDeliverability.data);
          } else {
            loadEmailDeliverabilityPanel();
          }
          if (state.emailSystemCheck.data) {
            renderEmailSystemCheck(state.emailSystemCheck.data);
          } else {
            loadEmailSystemCheckPanel();
          }
          if (state.emailQueue.data) {
            renderEmailQueueSummary(state.emailQueue.data);
            renderEmailQueueSamples(state.emailQueue.data);
          } else {
            loadEmailQueuePanel();
          }
          return;
        }

        state.company.loading = true;
        setCompanyStatus('Loading company settings...', 'muted');
        if (companySaveButton && !state.company.saving && canEditCompany) {
          companySaveButton.disabled = true;
        }

        try {
          const payload = await fetchCompanyPayload();
          state.company.data = payload;
          state.loadedPanels.add('company');
          populateCompanyForm(payload);
          await loadEmailDomainPanel();
          await loadEmailDeliverabilityPanel();
          await loadEmailSystemCheckPanel();
          await loadEmailQueuePanel();
          if (canEditCompany) {
            clearCompanyStatus();
          } else if (companyStatusEl) {
            companyStatusEl.textContent = companyViewOnlyMessage;
            companyStatusEl.classList.remove('text-success', 'text-danger');
            companyStatusEl.classList.add('text-muted');
          }
        } catch (err) {
          console.error('Failed to load company tab:', err);
          setCompanyStatus(err.message || 'Unable to load company settings.', 'danger');
        } finally {
          state.company.loading = false;
          if (companySaveButton && !state.company.saving && canEditCompany) {
            companySaveButton.disabled = false;
          }
        }
      };

      const loadEmailDomainPanel = async () => {
        if (!emailDomainEls.section) return;
        if (state.emailDomain.loading) return;
        const companyId = state.company.data?.companyId;
        if (!companyId) return;

        state.emailDomain.loading = true;
        setEmailDomainStatus('Loading email domain settings...', 'muted');
        if (emailDomainEls.startButton) emailDomainEls.startButton.disabled = true;
        if (emailDomainEls.validateButton) emailDomainEls.validateButton.disabled = true;
        if (emailDomainEls.removeButton) emailDomainEls.removeButton.disabled = true;

        try {
          const payload = await fetchEmailDomain(companyId);
          state.emailDomain.data = payload;
          renderEmailDomain();
        } catch (err) {
          console.error('Failed to load email domain settings', err);
          setEmailDomainStatus(err.message || 'Unable to load email domain settings.', 'danger');
        } finally {
          state.emailDomain.loading = false;
        }
      };

      const loadEmailDeliverabilityPanel = async () => {
        if (!deliverabilityEls.section) return;
        if (state.emailDeliverability.loading) return;
        const companyId = state.company.data?.companyId;
        if (!companyId) return;

        state.emailDeliverability.loading = true;
        if (deliverabilityEls.statusMessage) {
          deliverabilityEls.statusMessage.textContent = 'Loading deliverability stats...';
        }
        if (deliverabilityEls.healthState) {
          deliverabilityEls.healthState.textContent = 'Loading...';
        }
        try {
          const payload = await fetchEmailDeliverability(companyId);
          state.emailDeliverability.data = payload;
          renderDeliverabilityStatus(payload);
          renderDeliverabilityMetrics(payload);
          renderDeliverabilityActions(payload);
          renderEmailReadiness(payload);
        } catch (err) {
          console.error('Failed to load deliverability stats', err);
          if (deliverabilityEls.statusMessage) {
            deliverabilityEls.statusMessage.textContent = err.message || 'Could not load deliverability stats.';
          }
        } finally {
          state.emailDeliverability.loading = false;
        }
      };

      const loadEmailSystemCheckPanel = async () => {
        if (!emailSystemCheckEls.section) return;
        if (state.emailSystemCheck.loading) return;
        const companyId = state.company.data?.companyId;
        if (!companyId) return;

        state.emailSystemCheck.loading = true;
        if (emailSystemCheckEls.schedulerText) {
          emailSystemCheckEls.schedulerText.textContent = 'Loading system check...';
        }
        try {
          const payload = await fetchEmailSystemCheck(companyId);
          state.emailSystemCheck.data = payload;
          renderEmailSystemCheck(payload);
        } catch (err) {
          console.error('Failed to load email system check', err);
          if (emailSystemCheckEls.schedulerText) {
            emailSystemCheckEls.schedulerText.textContent = 'Unable to load system check.';
          }
        } finally {
          state.emailSystemCheck.loading = false;
        }
      };

      const loadEmailQueuePanel = async () => {
        if (!emailQueueEls.section) return;
        if (state.emailQueue.loading) return;
        const companyId = state.company.data?.companyId;
        if (!companyId) return;

        state.emailQueue.loading = true;
        if (emailQueueEls.summaryBody) {
          emailQueueEls.summaryBody.innerHTML =
            '<tr><td colspan="3" class="text-center text-muted">Loading...</td></tr>';
        }
        if (emailQueueEls.samplesBody) {
          emailQueueEls.samplesBody.innerHTML =
            '<tr><td colspan="4" class="text-center text-muted">Loading...</td></tr>';
        }

        try {
          const payload = await fetchEmailQueueDebug(companyId);
          state.emailQueue.data = payload;
          renderEmailQueueSummary(payload);
          renderEmailQueueSamples(payload);
        } catch (err) {
          console.error('Failed to load email queue debug', err);
          if (emailQueueEls.summaryBody) {
            emailQueueEls.summaryBody.innerHTML =
              '<tr><td colspan="3" class="text-center text-muted">Unable to load.</td></tr>';
          }
          if (emailQueueEls.samplesBody) {
            emailQueueEls.samplesBody.innerHTML =
              '<tr><td colspan="4" class="text-center text-muted">Unable to load.</td></tr>';
          }
        } finally {
          state.emailQueue.loading = false;
        }
      };

      const startEmailDomain = async (event) => {
        event.preventDefault();
        if (!canEditCompany || state.emailDomain.loading || state.emailDomain.saving) return;
        const companyId = state.company.data?.companyId;
        if (!companyId) return;

        const domain = getInputValue(emailDomainEls.domain);
        const subdomain = getInputValue(emailDomainEls.subdomain);
        const linkBranding = Boolean(emailDomainEls.linkBranding?.checked);

        if (!domain) {
          setEmailDomainStatus('Domain is required.', 'danger');
          return;
        }

        state.emailDomain.saving = true;
        setEmailDomainStatus('Starting verification...', 'muted');
        if (emailDomainEls.startButton) emailDomainEls.startButton.disabled = true;

        try {
          const response = await fetch(
            `/api/admin/company/${encodeURIComponent(companyId)}/email-domain/start`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Accept: 'application/json'
              },
              credentials: 'same-origin',
              body: JSON.stringify({ domain, subdomain, linkBranding })
            }
          );
          const data = await readJsonResponse(response);
          if (!response.ok) {
            throw new Error(data?.error || `Request failed (${response.status})`);
          }
          state.emailDomain.data = data;
          renderEmailDomain();
          setEmailDomainStatus('Verification started. Add DNS records below.', 'success');
        } catch (err) {
          console.error('Email domain start failed', err);
          setEmailDomainStatus(err.message || 'Failed to start verification.', 'danger');
        } finally {
          state.emailDomain.saving = false;
        }
      };

      const validateEmailDomain = async () => {
        if (!canEditCompany || state.emailDomain.loading || state.emailDomain.saving) return;
        const companyId = state.company.data?.companyId;
        if (!companyId) return;

        state.emailDomain.saving = true;
        setEmailDomainStatus('Validating...', 'muted');
        if (emailDomainEls.validateButton) emailDomainEls.validateButton.disabled = true;

        try {
          const response = await fetch(
            `/api/admin/company/${encodeURIComponent(companyId)}/email-domain/validate`,
            {
              method: 'POST',
              headers: { Accept: 'application/json' },
              credentials: 'same-origin'
            }
          );
          const data = await readJsonResponse(response);
          if (!response.ok) {
            throw new Error(data?.error || `Request failed (${response.status})`);
          }
          state.emailDomain.data = data;
          renderEmailDomain();
          if (data.status === 'verified') {
            setEmailDomainStatus('Domain verified.', 'success');
          } else if (data.status === 'failed') {
            setEmailDomainStatus('Validation failed. Check DNS records.', 'danger');
          } else {
            setEmailDomainStatus('Validation pending. DNS may still be propagating.', 'muted');
          }
        } catch (err) {
          console.error('Email domain validation failed', err);
          setEmailDomainStatus(err.message || 'Validation failed.', 'danger');
        } finally {
          state.emailDomain.saving = false;
        }
      };

      const removeEmailDomain = async () => {
        if (!canEditCompany || state.emailDomain.loading || state.emailDomain.saving) return;
        const companyId = state.company.data?.companyId;
        if (!companyId) return;

        const confirmed = window.confirm('Remove this email domain configuration?');
        if (!confirmed) return;

        state.emailDomain.saving = true;
        setEmailDomainStatus('Removing...', 'muted');
        if (emailDomainEls.removeButton) emailDomainEls.removeButton.disabled = true;

        try {
          const response = await fetch(
            `/api/admin/company/${encodeURIComponent(companyId)}/email-domain`,
            {
              method: 'DELETE',
              headers: { Accept: 'application/json' },
              credentials: 'same-origin'
            }
          );
          const data = await readJsonResponse(response);
          if (!response.ok) {
            throw new Error(data?.error || `Request failed (${response.status})`);
          }
          state.emailDomain.data = data;
          renderEmailDomain();
          setEmailDomainStatus('Email domain removed.', 'muted');
        } catch (err) {
          console.error('Email domain removal failed', err);
          setEmailDomainStatus(err.message || 'Failed to remove email domain.', 'danger');
        } finally {
          state.emailDomain.saving = false;
        }
      };

      const resumeEmailSending = async () => {
        if (!canEditCompany) return;
        const companyId = state.company.data?.companyId;
        if (!companyId) return;

        const confirmed = window.prompt('Type RESUME to confirm resuming email sending.');
        if (confirmed !== 'RESUME') return;

        if (deliverabilityEls.resumeButton) deliverabilityEls.resumeButton.disabled = true;
        if (deliverabilityEls.statusMessage) {
          deliverabilityEls.statusMessage.textContent = 'Resuming sending...';
        }

        try {
          const response = await fetch(
            `/api/admin/company/${encodeURIComponent(companyId)}/email-sending/resume`,
            {
              method: 'POST',
              headers: { Accept: 'application/json' },
              credentials: 'same-origin'
            }
          );
          const data = await readJsonResponse(response);
          if (!response.ok) {
            throw new Error(data?.error || `Request failed (${response.status})`);
          }
          state.company.data = data;
          populateCompanyForm(data);
          await loadEmailDeliverabilityPanel();
          setCompanyStatus('Email sending resumed.', 'success');
          setTimeout(() => {
            if (!state.company.saving) clearCompanyStatus();
          }, 4000);
        } catch (err) {
          console.error('Resume sending failed', err);
          if (deliverabilityEls.statusMessage) {
            deliverabilityEls.statusMessage.textContent = err.message || 'Unable to resume sending.';
          }
        } finally {
          if (deliverabilityEls.resumeButton) deliverabilityEls.resumeButton.disabled = false;
        }
      };

      const runWarmupAction = async (action) => {
        if (!canEditCompany) return;
        const companyId = state.company.data?.companyId;
        if (!companyId) return;

        if (deliverabilityEls.statusMessage) {
          deliverabilityEls.statusMessage.textContent = 'Updating warm-up settings...';
        }

        try {
          const response = await fetch(
            `/api/admin/company/${encodeURIComponent(companyId)}/email-warmup`,
            {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                Accept: 'application/json'
              },
              credentials: 'same-origin',
              body: JSON.stringify({ action })
            }
          );
          const data = await readJsonResponse(response);
          if (!response.ok) {
            throw new Error(data?.error || `Request failed (${response.status})`);
          }
          await loadEmailDeliverabilityPanel();
          if (deliverabilityEls.statusMessage) {
            deliverabilityEls.statusMessage.textContent = 'Warm-up settings updated.';
          }
        } catch (err) {
          console.error('Warm-up action failed', err);
          if (deliverabilityEls.statusMessage) {
            deliverabilityEls.statusMessage.textContent = err.message || 'Unable to update warm-up settings.';
          }
        }
      };

      const focusEmailDomainSection = () => {
        if (!emailDomainEls.section) return;
        emailDomainEls.section.scrollIntoView({ behavior: 'smooth', block: 'start' });
      };

      const getToolsEmailValue = () => {
        const value = getInputValue(deliverabilityEls.toolsEmail);
        return value || 'test@example.com';
      };

      const previewBlastFooter = async () => {
        if (!canEditCompany) return;
        const companyId = state.company.data?.companyId;
        if (!companyId) return;

        const email = getToolsEmailValue();
        if (deliverabilityEls.toolsOutput) {
          deliverabilityEls.toolsOutput.classList.add('d-none');
        }
        if (deliverabilityEls.statusMessage) {
          deliverabilityEls.statusMessage.textContent = 'Generating footer preview...';
        }

        try {
          const response = await fetch(
            `/api/admin/company/${encodeURIComponent(companyId)}/email-tools/footer-preview?email=${encodeURIComponent(email)}`,
            {
              headers: { Accept: 'application/json' },
              credentials: 'same-origin'
            }
          );
          const data = await readJsonResponse(response);
          if (!response.ok) {
            throw new Error(data?.error || `Request failed (${response.status})`);
          }
          if (deliverabilityEls.toolsHtml) {
            deliverabilityEls.toolsHtml.innerHTML = data?.html || '';
          }
          if (deliverabilityEls.toolsText) {
            deliverabilityEls.toolsText.textContent = data?.text || '';
          }
          if (deliverabilityEls.toolsOutput) {
            deliverabilityEls.toolsOutput.classList.remove('d-none');
          }
          if (deliverabilityEls.statusMessage) {
            deliverabilityEls.statusMessage.textContent = 'Footer preview ready.';
          }
        } catch (err) {
          console.error('Footer preview failed', err);
          if (deliverabilityEls.statusMessage) {
            deliverabilityEls.statusMessage.textContent = err.message || 'Unable to preview footer.';
          }
        }
      };

      const generateTestUnsubscribeLink = async () => {
        if (!canEditCompany) return;
        const companyId = state.company.data?.companyId;
        if (!companyId) return;

        const email = getToolsEmailValue();
        if (deliverabilityEls.statusMessage) {
          deliverabilityEls.statusMessage.textContent = 'Generating unsubscribe link...';
        }

        try {
          const response = await fetch(
            `/api/admin/company/${encodeURIComponent(companyId)}/email-tools/test-unsubscribe?email=${encodeURIComponent(email)}`,
            {
              headers: { Accept: 'application/json' },
              credentials: 'same-origin'
            }
          );
          const data = await readJsonResponse(response);
          if (!response.ok) {
            throw new Error(data?.error || `Request failed (${response.status})`);
          }
          const url = data?.unsubscribeUrl;
          if (url) {
            window.open(url, '_blank', 'noopener,noreferrer');
          }
          if (deliverabilityEls.statusMessage) {
            deliverabilityEls.statusMessage.textContent = 'Unsubscribe link generated.';
          }
        } catch (err) {
          console.error('Generate unsubscribe link failed', err);
          if (deliverabilityEls.statusMessage) {
            deliverabilityEls.statusMessage.textContent = err.message || 'Unable to generate unsubscribe link.';
          }
        }
      };

      const loadBuildrootzPanel = async ({ force = false } = {}) => {
        if (!buildrootzEls.form) return;
        if (state.buildrootz.loading) return;
        if (!force && state.loadedPanels.has('buildrootz') && state.buildrootz.data) {
          populateBuildrootzForm(state.buildrootz.data);
          return;
        }
        state.buildrootz.loading = true;
        setBuildrootzStatus('Loading BuildRootz profile...', 'muted');
        try {
          const payload = await fetchBuildrootzProfile();
          state.buildrootz.data = payload;
          state.loadedPanels.add('buildrootz');
          populateBuildrootzForm(payload);
          if (payload.publishedAt) {
            setBuildrootzStatus('Last published to BuildRootz', 'muted');
          } else {
            clearBuildrootzStatus();
          }
        } catch (err) {
          console.error('Failed to load BuildRootz profile', err);
          setBuildrootzStatus(err.message || 'Unable to load BuildRootz profile.', 'danger');
        } finally {
          state.buildrootz.loading = false;
        }
      };

      const handleCompanySubmit = async (event) => {
        event.preventDefault();
        if (!companyForm || state.company.saving || state.company.loading) return;
        if (!canEditCompany) return;

        const payload = {
          companyId: state.company.data?.companyId,
          companyName: getInputValue(companyInputs.name),
          address: {
            street: getInputValue(companyInputs.street),
            city: getInputValue(companyInputs.city),
            state: getInputValue(companyInputs.state),
            zip: getInputValue(companyInputs.zip)
          },
          primaryContact: {
            name: getInputValue(companyInputs.primaryName),
            email: getInputValue(companyInputs.primaryEmail),
            phone: getInputValue(companyInputs.primaryPhone)
          },
          branding: {
            logoUrl: getInputValue(companyInputs.logoUrl),
            primaryColor: companyInputs.primaryColor?.value || '',
            secondaryColor: companyInputs.secondaryColor?.value || ''
          },
          timezone: getInputValue(companyInputs.timezone),
          notes: getInputValue(companyInputs.notes),
          emailDailyCapEnabled: Boolean(companyInputs.emailDailyCapEnabled?.checked),
          emailDailyCap: companyInputs.emailDailyCap?.value != null && companyInputs.emailDailyCap.value !== ''
            ? Number(companyInputs.emailDailyCap.value)
            : null,
          emailAutoPauseOnSpamReport: Boolean(companyInputs.emailAutoPauseSpamReport?.checked),
          emailAutoPauseOnBounceRate: Boolean(companyInputs.emailAutoPauseBounceRate?.checked),
          emailBounceRateThreshold: companyInputs.emailBounceRateThreshold?.value != null && companyInputs.emailBounceRateThreshold.value !== ''
            ? Number(companyInputs.emailBounceRateThreshold.value) / 100
            : null,
          emailBounceMinSentForEvaluation: companyInputs.emailBounceMinSent?.value != null && companyInputs.emailBounceMinSent.value !== ''
            ? Number(companyInputs.emailBounceMinSent.value)
            : null
        };

        state.company.saving = true;
        setCompanyStatus('Saving...', 'muted');
        if (companySaveButton) companySaveButton.disabled = true;

        try {
          const response = await fetch('/api/admin/company', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });

          let data;
          try {
            data = await readJsonResponse(response);
          } catch (parseErr) {
            if (!response.ok) throw parseErr;
            throw parseErr;
          }

          if (!response.ok) {
            throw new Error(data?.error || `Save failed (${response.status})`);
          }

          state.company.data = data;
          state.loadedPanels.add('company');
          populateCompanyForm(data);
          await loadEmailDeliverabilityPanel();
          setCompanyStatus('Company settings saved.', 'success');
          setTimeout(() => {
            if (!state.company.saving) clearCompanyStatus();
          }, 4000);
        } catch (err) {
          console.error('Failed to save company settings:', err);
          setCompanyStatus(err.message || 'Failed to save company settings.', 'danger');
        } finally {
          state.company.saving = false;
          if (companySaveButton) companySaveButton.disabled = false;
        }
      };

      const handleBuildrootzSubmit = async (event) => {
        event.preventDefault();
        if (!buildrootzEls.form || state.buildrootz.saving || state.buildrootz.loading) return;
        if (!canEditCompany) return;

        const payload = {
          companyId: state.company.data?.companyId,
          description: getInputValue(buildrootzEls.description),
          logoUrl: getInputValue(buildrootzEls.logo)
        };

        state.buildrootz.saving = true;
        setBuildrootzStatus('Saving...', 'muted');
        if (buildrootzEls.save) buildrootzEls.save.disabled = true;
        if (buildrootzEls.publish) buildrootzEls.publish.disabled = true;

        try {
          const response = await fetch('/api/admin/buildrootz/profile', {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Save failed (${response.status})`;
            throw new Error(message);
          }
          state.buildrootz.data = data;
          populateBuildrootzForm(data);
          setBuildrootzStatus('Saved.', 'success');
        } catch (err) {
          console.error('BuildRootz save failed', err);
          setBuildrootzStatus(err.message || 'Save failed.', 'danger');
        } finally {
          state.buildrootz.saving = false;
          if (buildrootzEls.save) buildrootzEls.save.disabled = false;
          if (buildrootzEls.publish) buildrootzEls.publish.disabled = false;
        }
      };

      const handleBuildrootzPublish = async (event) => {
        event.preventDefault();
        if (!buildrootzEls.form || state.buildrootz.saving || state.buildrootz.loading) return;
        if (!canEditCompany) return;

        const payload = {
          companyId: state.company.data?.companyId,
          description: getInputValue(buildrootzEls.description),
          logoUrl: getInputValue(buildrootzEls.logo)
        };

        state.buildrootz.saving = true;
        setBuildrootzStatus('Publishing to BuildRootz...', 'muted');
        if (buildrootzEls.publish) buildrootzEls.publish.disabled = true;
        if (buildrootzEls.save) buildrootzEls.save.disabled = true;

        try {
          const response = await fetch('/api/admin/buildrootz/profile/publish', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Publish failed (${response.status})`;
            throw new Error(message);
          }
          state.buildrootz.data = data;
          populateBuildrootzForm(data);
          setBuildrootzStatus('Published to BuildRootz.', 'success');
        } catch (err) {
          console.error('BuildRootz publish failed', err);
          setBuildrootzStatus(err.message || 'Publish failed.', 'danger');
        } finally {
          state.buildrootz.saving = false;
          if (buildrootzEls.publish) buildrootzEls.publish.disabled = false;
          if (buildrootzEls.save) buildrootzEls.save.disabled = false;
        }
      };

      const handleBuildrootzDiscard = (event) => {
        if (event) event.preventDefault();
        if (state.buildrootz.data) {
          populateBuildrootzForm(state.buildrootz.data);
          clearBuildrootzStatus();
        } else {
          if (buildrootzEls.logo) buildrootzEls.logo.value = '';
          if (buildrootzEls.description) buildrootzEls.description.value = '';
          clearBuildrootzStatus();
        }
      };

      const fetchUsersPayload = async () => {
        const response = await fetch('/api/admin/users', {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });
        if (!response.ok) {
          throw new Error(`Request failed (${response.status})`);
        }
        return readJsonResponse(response);
      };

      const renderUsers = () => {
        if (!usersEls.tableBody) return;

        const payload = state.users.payload;
        const editing = state.users.editing;
        const currentUserId = state.users.currentUserId || null;
        if (!payload) {
          usersEls.tableBody.innerHTML = `
            <tr>
              <td colspan="${editing ? 10 : 9}" class="text-center text-muted py-4">
                No users loaded.
              </td>
            </tr>
          `;
          return;
        }

        // Populate invite role options using the same role options available in the table
        if (usersControls.inviteRole) {
          const options = (payload.roleOptions || [])
            .filter((opt) => opt.value !== 'SUPER_ADMIN')
            .map((opt) => `<option value="${escapeHtml(opt.value)}">${escapeHtml(opt.label)}</option>`)
            .join('');
          usersControls.inviteRole.innerHTML = options;
        }

        if (usersEls.actionsHeader) {
          usersEls.actionsHeader.classList.toggle('d-none', !editing);
        }

        const roleOptions = payload.roleOptions || [];
        const statusOptionsAll = payload.statusOptions || [];
        const statusOptionsEditable = statusOptionsAll.filter((option) =>
          ['ACTIVE', 'SUSPENDED'].includes(option.value)
        );
        const communityOptions = payload.communities || [];
        const managerOptions = payload.managers || [];

        if (!payload.users || !payload.users.length) {
          usersEls.tableBody.innerHTML = `
            <tr>
              <td colspan="${editing ? 10 : 9}" class="text-center text-muted py-4">
                No users found for this company yet.
              </td>
            </tr>
          `;
          return;
        }

        const roleLookup = new Map(roleOptions.map((option) => [option.value, option.label]));
        const statusLookup = new Map(statusOptionsAll.map((option) => [option.value, option.label]));
        const communityLookup = new Map(communityOptions.map((community) => [community.id, community.label]));

        const renderReadOnlyRow = (user) => {
          const phoneDisplay = user.phoneDisplay || formatPhoneNumber(user.phone);
          const roleLabel = (Array.isArray(user.roles) ? user.roles : [])
            .map((role) => roleLookup.get(role))
            .find(Boolean) || 'User';
          const statusLabel = statusLookup.get(user.status)?.replace('Suspended', 'Inactive')
            || (user.status === 'SUSPENDED' ? 'Inactive' : user.status || 'Unknown');
          const communityLabels = (Array.isArray(user.communities) ? user.communities : [])
            .map((id) => communityLookup.get(id))
            .filter(Boolean);
          const communitiesDisplay = communityLabels.length ? communityLabels.join(', ') : 'All Communities';
          const managerDisplay = user.managerName
            ? escapeHtml(user.managerName)
            : '&mdash;';

          const baseCells = `
            <tr data-user-id="${escapeHtml(user.id)}">
              <td>${escapeHtml(user.firstName || '')}</td>
              <td>${escapeHtml(user.lastName || '')}</td>
              <td>${escapeHtml(user.email)}</td>
              <td class="text-muted">Hidden</td>
              <td>${escapeHtml(phoneDisplay || '')}</td>
              <td>${escapeHtml(roleLabel)}</td>
              <td>${escapeHtml(statusLabel)}</td>
              <td>${escapeHtml(communitiesDisplay)}</td>
              <td>${managerDisplay}</td>`;

          return editing
            ? `${baseCells}<td class="text-end text-muted">&mdash;</td></tr>`
            : `${baseCells}</tr>`;
        };

        const renderEditableRow = (user) => {
          const selectedCommunities = new Set(Array.isArray(user.communities) ? user.communities : []);
          const managerValue = user.managerId || '';
          const isSelf = currentUserId && user.id === currentUserId;

          const roleSelect = roleOptions
            .map((option) => {
              const selected = (Array.isArray(user.roles) ? user.roles : []).includes(option.value) ? 'selected' : '';
              return `<option value="${escapeHtml(option.value)}" ${selected}>${escapeHtml(option.label)}</option>`;
            })
            .join('');

          const statusOptionMarkup = (() => {
            const options = statusOptionsEditable
              .map((option) => {
                const normalizedLabel = option.value === 'SUSPENDED' ? 'Inactive' : option.label;
                const selected = option.value === user.status ? 'selected' : '';
                return `<option value="${escapeHtml(option.value)}" ${selected}>${escapeHtml(normalizedLabel)}</option>`;
              });

            if (user.status && !statusOptionsEditable.some((option) => option.value === user.status)) {
              const fallbackLabel = statusLookup.get(user.status) || user.status;
              options.unshift(
                `<option value="${escapeHtml(user.status)}" selected disabled>${escapeHtml(fallbackLabel)} (read-only)</option>`
              );
            }

            return options.join('');
          })();

          const communitySelect = communityOptions
            .map((community) => {
              const selected = selectedCommunities.has(community.id) ? 'selected' : '';
              return `<option value="${escapeHtml(community.id)}" ${selected}>${escapeHtml(community.label)}</option>`;
            })
            .join('');

          const managerSelect = [
            '<option value="">None</option>',
            ...managerOptions.map((manager) => {
              const selected = manager.id === managerValue ? 'selected' : '';
              return `<option value="${escapeHtml(manager.id)}" ${selected}>${escapeHtml(manager.label)}</option>`;
            })
          ].join('');

          const deleteButton = isSelf
            ? '<button type="button" class="btn btn-sm btn-outline-secondary ms-2" data-action="delete-user" disabled title="You cannot delete your own account.">Delete</button>'
            : '<button type="button" class="btn btn-sm btn-danger ms-2" data-action="delete-user">Delete</button>';

          return `
            <tr data-user-id="${escapeHtml(user.id)}">
              <td>
                <input type="text" class="form-control form-control-sm" name="firstName" value="${escapeHtml(user.firstName || '')}" />
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" name="lastName" value="${escapeHtml(user.lastName || '')}" />
              </td>
              <td>
                <span class="form-control-plaintext form-control-sm">${escapeHtml(user.email)}</span>
              </td>
              <td>
                <input
                  type="password"
                  class="form-control form-control-sm admin-users-password"
                  name="password"
                  placeholder="Set password (min 8)"
                  autocomplete="new-password"
                />
              </td>
              <td>
                <input type="text" class="form-control form-control-sm" name="phone" value="${escapeHtml(user.phone || '')}" placeholder="(555) 555-5555" />
              </td>
              <td>
                <select class="form-select form-select-sm" name="role">
                  ${roleSelect}
                </select>
              </td>
              <td>
                <select class="form-select form-select-sm" name="status">
                  ${statusOptionMarkup}
                </select>
              </td>
              <td>
                <select class="form-select form-select-sm admin-users-multiselect" name="communities" multiple size="4">
                  ${communitySelect}
                </select>
              </td>
              <td>
                <select class="form-select form-select-sm" name="manager">
                  ${managerSelect}
                </select>
              </td>
              <td class="text-end">
                <div class="btn-group btn-group-sm">
                  <button type="button" class="btn btn-primary" data-action="save-user">Save</button>
                  <button type="button" class="btn btn-outline-secondary" data-action="cancel-user">Cancel</button>
                </div>
                ${deleteButton}
              </td>
            </tr>
          `;
        };

        const rows = payload.users
          .map((user) => (editing ? renderEditableRow(user) : renderReadOnlyRow(user)))
          .join('');

        usersEls.tableBody.innerHTML = rows;

        if (editing && usersEls.table) {
          usersEls.table.classList.add('table-editing');
        } else {
          usersEls.table?.classList.remove('table-editing');
        }
      };

      const loadUsersPanel = async ({ force = false, silent = false } = {}) => {
        if (state.users.loading) return;

        if (!force && state.loadedPanels.has('users')) {
          renderUsers();
          updateEditToggleVisual();
          showUsersTable();
          return;
        }

        state.users.loading = true;
        if (!silent) showUsersLoading();

        try {
          const payload = await fetchUsersPayload();
          state.users.payload = payload;
          state.users.currentUserId = payload.currentUserId || null;
          state.loadedPanels.add('users');
          renderUsers();
          updateEditToggleVisual();
          showUsersTable();
        } catch (err) {
          console.error('Failed to load users tab:', err);
          showUsersError(err.message || 'Unable to load users right now.');
        } finally {
          state.users.loading = false;
        }
      };

      const refreshUsersData = (options = {}) => loadUsersPanel({ ...options, force: true });

      const showImpersonationLoading = (message = 'Loading companies...') => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (impersonationEls.loading) {
          impersonationEls.loading.textContent = message;
          impersonationEls.loading.classList.remove('d-none');
        }
      };

      const hideImpersonationLoading = () => {
        impersonationEls.loading?.classList.add('d-none');
      };

      const setImpersonationFormStatus = (element, message, tone = 'muted') => {
        if (!element) return;
        element.textContent = message || '';
        element.classList.remove('text-muted', 'text-success', 'text-danger');
        if (!message) {
          element.classList.add('text-muted');
          return;
        }
        const toneClass = tone === 'success' ? 'text-success' : tone === 'danger' ? 'text-danger' : 'text-muted';
        element.classList.add(toneClass);
      };

      const showImpersonationError = (message) => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (!impersonationEls.error) return;
        impersonationEls.error.textContent = message || 'Something went wrong.';
        impersonationEls.error.classList.remove('d-none');
        hideImpersonationLoading();
      };

      const fetchImpersonationPayload = async (query = '') => {
        const url = new URL('/api/admin/impersonation', window.location.origin);
        if (query) url.searchParams.set('search', query);
        const response = await fetch(url.toString(), {
          headers: { Accept: 'application/json' },
          credentials: 'same-origin'
        });

        let data;
        try {
          data = await readJsonResponse(response);
        } catch (err) {
          if (!response.ok) throw err;
          throw err;
        }

        if (!response.ok) {
          throw new Error(data?.error || `Request failed (${response.status})`);
        }

        return data;
      };

      const renderImpersonation = () => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (!state.impersonation.data) return;

        const payload = state.impersonation.data;
        const active = payload.active && payload.active.companyId ? payload.active : null;

        if (impersonationEls.status) {
          impersonationEls.status.classList.remove('alert-warning', 'alert-info');
          if (active) {
            impersonationEls.status.classList.add('alert-warning');
            impersonationEls.status.innerHTML = `Currently impersonating <strong>${escapeHtml(
              active.companyName || active.companyId
            )}</strong>. Any tenant-scoped views and APIs will respect this company until you stop impersonating.`;
          } else {
            impersonationEls.status.classList.add('alert-info');
            impersonationEls.status.innerHTML =
              'Not impersonating any company. Select one below to assume their context.';
          }
        }

        if (impersonationEls.clearButton) {
          const disableClear = !active || state.impersonation.saving;
          impersonationEls.clearButton.classList.toggle('d-none', !active);
          impersonationEls.clearButton.disabled = disableClear;
        }

        if (!impersonationEls.tableBody) return;

        const companies = Array.isArray(payload.companies) ? payload.companies : [];
        if (!companies.length) {
          impersonationEls.tableBody.innerHTML = `
            <tr>
              <td colspan="3" class="text-center text-muted py-4">
                ${escapeHtml(
                  state.impersonation.lastQuery ? 'No companies match this search.' : 'No companies available.'
                )}
              </td>
            </tr>
          `;
          return;
        }

        const disableButtons = state.impersonation.saving;
        const rows = companies
          .map((company) => {
            const isActive = active && active.companyId === company.id;
            const buttonLabel = isActive ? 'Active' : 'Impersonate';
            const buttonVariant = isActive ? 'btn-secondary' : 'btn-outline-primary';
            const disabledAttr = isActive || disableButtons ? 'disabled' : '';
            return `
              <tr data-company-id="${escapeHtml(company.id)}">
                <td>${escapeHtml(company.name || 'Unnamed Company')}</td>
                <td></td>
                <td class="text-end">
                  <button type="button" class="btn btn-sm ${buttonVariant}" data-action="impersonate" ${disabledAttr}>
                    ${escapeHtml(buttonLabel)}
                  </button>
                </td>
              </tr>
            `;
          })
          .join('');

        impersonationEls.tableBody.innerHTML = rows;
      };

      const loadImpersonationPanel = async ({ force = false } = {}) => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (state.impersonation.loading) return;

        const query = impersonationEls.searchInput ? impersonationEls.searchInput.value.trim() : '';
        if (
          !force &&
          state.loadedPanels.has('impersonation') &&
          state.impersonation.data &&
          state.impersonation.lastQuery === query
        ) {
          renderImpersonation();
          return;
        }

        state.impersonation.loading = true;
        showImpersonationLoading(query ? 'Searching companies...' : 'Loading companies...');
        impersonationEls.error?.classList.add('d-none');

        try {
          const payload = await fetchImpersonationPayload(query);
          state.impersonation.data = payload;
          state.impersonation.lastQuery = query;
          state.loadedPanels.add('impersonation');
          renderImpersonation();
        } catch (err) {
          console.error('Failed to load impersonation data:', err);
          showImpersonationError(err.message || 'Unable to load impersonation data.');
        } finally {
          state.impersonation.loading = false;
          hideImpersonationLoading();
        }
      };

      const impersonateCompany = async (companyId) => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (!companyId || state.impersonation.saving) return;

        state.impersonation.saving = true;
        showImpersonationLoading('Switching company...');
        impersonationEls.error?.classList.add('d-none');

        try {
          const response = await fetch('/api/admin/impersonation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify({ companyId })
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }
          window.location.reload();
        } catch (err) {
          console.error('Failed to impersonate company:', err);
          showImpersonationError(err.message || 'Failed to impersonate company.');
        } finally {
          state.impersonation.saving = false;
          hideImpersonationLoading();
        }
      };

      const clearImpersonation = async () => {
        if (!permissions || !permissions.canUseImpersonation) return;
        if (state.impersonation.saving) return;

        state.impersonation.saving = true;
        showImpersonationLoading('Clearing impersonation...');
        impersonationEls.error?.classList.add('d-none');

        try {
          const response = await fetch('/api/admin/impersonation', {
            method: 'DELETE',
            headers: { Accept: 'application/json' },
            credentials: 'same-origin'
          });
          const data = await readJsonResponse(response);
          if (!response.ok) {
            const message = data?.error || `Request failed (${response.status})`;
            throw new Error(message);
          }
          window.location.reload();
        } catch (err) {
          console.error('Failed to stop impersonating:', err);
          showImpersonationError(err.message || 'Failed to stop impersonating.');
        } finally {
          state.impersonation.saving = false;
          hideImpersonationLoading();
        }
      };

      if (permissions && permissions.canUseImpersonation) {
        if (impersonationForms.createCompany) {
          impersonationForms.createCompany.addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.currentTarget;
            const submitButton = form.querySelector('button[type="submit"]');
            const statusEl = impersonationForms.createCompanyStatus;
            const formData = new FormData(form);
            const companyName = (formData.get('companyName') || '').toString().trim();
            const slug = (formData.get('slug') || '').toString().trim();

            if (!companyName) {
              setImpersonationFormStatus(statusEl, 'Company name is required.', 'danger');
              return;
            }

            if (submitButton) submitButton.disabled = true;
            setImpersonationFormStatus(statusEl, 'Creating company...', 'muted');

            try {
              const response = await fetch('/api/admin/company', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Accept: 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify({ companyName, slug })
              });

              const data = await readJsonResponse(response);
              if (!response.ok) {
                const message = data?.error || `Create failed (${response.status})`;
                throw new Error(message);
              }

              setImpersonationFormStatus(statusEl, 'Company created successfully.', 'success');
              form.reset();
              await loadImpersonationPanel({ force: true });
            } catch (err) {
              console.error('Failed to create company:', err);
              setImpersonationFormStatus(statusEl, err.message || 'Failed to create company.', 'danger');
            } finally {
              if (submitButton) submitButton.disabled = false;
            }
          });
        }

        if (impersonationForms.createUser) {
          impersonationForms.createUser.addEventListener('submit', async (event) => {
            event.preventDefault();
            const form = event.currentTarget;
            const submitButton = form.querySelector('button[type="submit"]');
            const statusEl = impersonationForms.createUserStatus;
            const formData = new FormData(form);

            const email = (formData.get('email') || '').toString().trim();
            const password = (formData.get('password') || '').toString().trim();
            const companyId = (formData.get('companyId') || '').toString().trim();
            const role = (formData.get('role') || '').toString().trim();
            const status = (formData.get('status') || '').toString().trim() || 'ACTIVE';
            const firstName = (formData.get('firstName') || '').toString().trim();
            const lastName = (formData.get('lastName') || '').toString().trim();
            const phone = (formData.get('phone') || '').toString().trim();

            if (!email || !password || !companyId) {
              setImpersonationFormStatus(statusEl, 'Email, password, and company ID are required.', 'danger');
              return;
            }

            if (submitButton) submitButton.disabled = true;
            setImpersonationFormStatus(statusEl, 'Creating user...', 'muted');

            try {
              const payload = {
                email,
                password,
                companyId,
                role,
                status
              };
              if (firstName) payload.firstName = firstName;
              if (lastName) payload.lastName = lastName;
              if (phone) payload.phone = phone;

              const response = await fetch('/api/admin/users', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  Accept: 'application/json'
                },
                credentials: 'same-origin',
                body: JSON.stringify(payload)
              });

              const data = await readJsonResponse(response);
              if (!response.ok) {
                const message = data?.error || `Create failed (${response.status})`;
                throw new Error(message);
              }

              setImpersonationFormStatus(statusEl, 'User created successfully.', 'success');
              form.reset();
              const companyInput = form.querySelector('input[name="companyId"]');
              if (companyInput && permissions.isImpersonating && permissions.impersonation) {
                companyInput.value = permissions.impersonation.companyId;
              }
              const statusSelect = form.querySelector('select[name="status"]');
              if (statusSelect) statusSelect.value = 'ACTIVE';

              await refreshUsersData({ force: true, silent: true });
            } catch (err) {
              console.error('Failed to create user:', err);
              setImpersonationFormStatus(statusEl, err.message || 'Failed to create user.', 'danger');
            } finally {
              if (submitButton) submitButton.disabled = false;
            }
          });
        }
      }

      const panelLoaders = {
        company: loadCompanyPanel,
        users: loadUsersPanel,
        billing: loadBillingPanel,
        buildrootz: loadBuildrootzPanel
      };
      if (permissions && permissions.canUseImpersonation) {
        panelLoaders.impersonation = loadImpersonationPanel;
      }

      const activatePanel = (target, button) => {
        if (!target) return;

        tabButtons.forEach((btn) => {
          const isActive = btn === button;
          btn.classList.toggle('active', isActive);
          btn.setAttribute('aria-selected', String(isActive));
        });

        panels.forEach((panel, key) => {
          const show = key === target;
          panel.classList.toggle('d-none', !show);
          panel.classList.toggle('active', show);
        });

        const loader = panelLoaders[target];
        if (typeof loader === 'function') {
          loader();
        }
      };

      const updateEditToggleVisual = () => {
        if (!usersControls.editToggle) return;
        const editing = state.users.editing;
        usersControls.editToggle.textContent = editing ? 'Done Editing' : 'Edit Users';
        usersControls.editToggle.classList.toggle('btn-outline-primary', !editing);
        usersControls.editToggle.classList.toggle('btn-primary', editing);
      };

      const handleEditToggle = async () => {
        if (!state.users.payload) {
          await loadUsersPanel();
        }
        state.users.editing = !state.users.editing;
        updateEditToggleVisual();
        renderUsers();
        showUsersTable();
      };

      const showInviteCard = (show) => {
        if (!usersControls.inviteCard) return;
        usersControls.inviteCard.classList.toggle('d-none', !show);
        if (show && usersControls.inviteStatus) {
          usersControls.inviteStatus.textContent = '';
          usersControls.inviteStatus.className = 'small text-muted me-auto';
        }
      };

      const setInviteStatus = (message, tone = 'muted') => {
        if (!usersControls.inviteStatus) return;
        usersControls.inviteStatus.textContent = message || '';
        usersControls.inviteStatus.className = 'small me-auto';
        usersControls.inviteStatus.classList.add(
          tone === 'success' ? 'text-success' : tone === 'danger' ? 'text-danger' : 'text-muted'
        );
      };

      const resetInviteForm = () => {
        if (!usersControls.inviteForm) return;
        usersControls.inviteForm.reset();
      };

      const collectMultiSelectValues = (select) =>
        Array.from(select?.selectedOptions || []).map((option) => option.value);

      const saveUserRow = async (row, triggerButton, userId) => {
        if (!row || !userId) return;

        const firstName = row.querySelector('[name="firstName"]')?.value ?? '';
        const lastName = row.querySelector('[name="lastName"]')?.value ?? '';
        const phone = row.querySelector('[name="phone"]')?.value ?? '';
        const role = row.querySelector('[name="role"]')?.value ?? '';
        const status = row.querySelector('[name="status"]')?.value ?? '';
        const communities = collectMultiSelectValues(row.querySelector('[name="communities"]'));
        const manager = row.querySelector('[name="manager"]')?.value ?? '';
        const passwordRaw = row.querySelector('[name="password"]')?.value ?? '';
        const password = passwordRaw.toString().trim();
        const payload = {
          firstName,
          lastName,
          phone,
          role,
          status,
          communities,
          manager: manager || null
        };
        if (password) {
          payload.password = password;
        }

        triggerButton.disabled = true;
        const cancelButton = row.querySelector('button[data-action="cancel-user"]');
        if (cancelButton) cancelButton.disabled = true;

        try {
          const response = await fetch(`/api/admin/users/${encodeURIComponent(userId)}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              Accept: 'application/json'
            },
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            const message = errorPayload.error || `Save failed (${response.status})`;
            throw new Error(message);
          }

          await refreshUsersData({ silent: true });
          renderUsers();
          updateEditToggleVisual();
          showUsersTable();
          usersEls.error?.classList.add('d-none');
        } catch (err) {
          console.error('Failed to save user', err);
          showUsersError(err.message || 'Failed to save user changes.');
          if (state.users.payload) {
            usersEls.tableWrapper?.classList.remove('d-none');
          }
        } finally {
          triggerButton.disabled = false;
          if (cancelButton) cancelButton.disabled = false;
        }
      };

      const deleteUserRow = async (row, triggerButton, userId) => {
        if (!row || !userId) return;

        if (state.users.currentUserId && userId === state.users.currentUserId) {
          showUsersError('You cannot delete your own account.');
          usersEls.loading?.classList.add('d-none');
          usersEls.tableWrapper?.classList.remove('d-none');
          return;
        }

        const confirmed = window.confirm('Delete this user? This action cannot be undone.');
        if (!confirmed) return;

        triggerButton.disabled = true;

        try {
          const response = await fetch(`/api/admin/users/${encodeURIComponent(userId)}`, {
            method: 'DELETE',
            headers: { Accept: 'application/json' },
            credentials: 'same-origin'
          });

          if (!response.ok) {
            const errorPayload = await response.json().catch(() => ({}));
            const message = errorPayload.error || `Delete failed (${response.status})`;
            throw new Error(message);
          }

          await refreshUsersData({ silent: true });
          renderUsers();
          updateEditToggleVisual();
          showUsersTable();
          usersEls.error?.classList.add('d-none');
        } catch (err) {
          console.error('Failed to delete user', err);
          showUsersError(err.message || 'Failed to delete user.');
          if (state.users.payload) {
            usersEls.tableWrapper?.classList.remove('d-none');
          }
        } finally {
          triggerButton.disabled = false;
        }
      };

      const handleUserTableClick = async (event) => {
        const actionButton = event.target.closest('button[data-action]');
        if (!actionButton) return;
        const action = actionButton.dataset.action;
        if (!action) return;

        const row = actionButton.closest('tr[data-user-id]');
        if (!row) return;
        const userId = row.dataset.userId;

        if (action === 'cancel-user') {
          renderUsers();
          return;
        }

        if (action === 'save-user') {
          await saveUserRow(row, actionButton, userId);
          return;
        }

        if (action === 'delete-user') {
          await deleteUserRow(row, actionButton, userId);
          return;
        }
      };

      if (usersEls.tableBody) {
        usersEls.tableBody.addEventListener('click', handleUserTableClick);
      }

      if (usersControls.editToggle) {
        usersControls.editToggle.addEventListener('click', handleEditToggle);
      }

      if (usersControls.inviteToggle) {
        usersControls.inviteToggle.addEventListener('click', () => {
          const isOpen = usersControls.inviteCard && !usersControls.inviteCard.classList.contains('d-none');
          showInviteCard(!isOpen);
        });
      }

      if (usersControls.inviteCancel) {
        usersControls.inviteCancel.addEventListener('click', (event) => {
          event.preventDefault();
          resetInviteForm();
          showInviteCard(false);
        });
      }

      if (usersControls.inviteForm) {
        usersControls.inviteForm.addEventListener('submit', async (event) => {
          event.preventDefault();
          if (!canManageUsers) return;

          const form = event.currentTarget;
          const submitBtn = form.querySelector('button[type="submit"]');
          const formData = new FormData(form);
          const email = (formData.get('email') || '').toString().trim();
          const firstName = (formData.get('firstName') || '').toString().trim();
          const lastName = (formData.get('lastName') || '').toString().trim();
          const phone = (formData.get('phone') || '').toString().trim();
          const role = (formData.get('role') || '').toString().trim();

          if (!email) {
            setInviteStatus('Email is required.', 'danger');
            return;
          }

          const payload = { email };
          if (firstName) payload.firstName = firstName;
          if (lastName) payload.lastName = lastName;
          if (phone) payload.phone = phone;
          if (role) payload.role = role;

          if (submitBtn) submitBtn.disabled = true;
          setInviteStatus('Sending invite...', 'muted');

          try {
            const response = await fetch('/api/admin/users/invite', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json', Accept: 'application/json' },
              credentials: 'same-origin',
              body: JSON.stringify(payload)
            });
            const data = await readJsonResponse(response);
            if (!response.ok) {
              const msg = data?.error || `Invite failed (${response.status})`;
              throw new Error(msg);
            }
            setInviteStatus('Invite sent. We emailed their setup link.', 'success');
            resetInviteForm();
            await refreshUsersData({ silent: true });
          } catch (err) {
            console.error('Invite user failed', err);
            setInviteStatus(err.message || 'Invite failed.', 'danger');
          } finally {
            if (submitBtn) submitBtn.disabled = false;
          }
        });
      }

      if (companyForm) {
        companyForm.addEventListener('submit', handleCompanySubmit);
        companyForm.addEventListener('reset', (event) => {
          event.preventDefault();
          if (state.company.data) {
            populateCompanyForm(state.company.data);
          }
          clearCompanyStatus();
        });
      }
      if (companyInputs.emailDailyCapEnabled) {
        companyInputs.emailDailyCapEnabled.addEventListener('change', updateDailyCapInputs);
      }
      if (companyInputs.emailAutoPauseBounceRate) {
        companyInputs.emailAutoPauseBounceRate.addEventListener('change', updateBounceRateInputs);
      }
      if (deliverabilityEls.resumeButton) {
        deliverabilityEls.resumeButton.addEventListener('click', (event) => {
          event.preventDefault();
          resumeEmailSending();
        });
      }
      if (deliverabilityEls.warmupResetButton) {
        deliverabilityEls.warmupResetButton.addEventListener('click', (event) => {
          event.preventDefault();
          runWarmupAction('reset');
        });
      }
      if (deliverabilityEls.warmupDisableButton) {
        deliverabilityEls.warmupDisableButton.addEventListener('click', (event) => {
          event.preventDefault();
          runWarmupAction('disable');
        });
      }
      if (deliverabilityEls.warmupEnableButton) {
        deliverabilityEls.warmupEnableButton.addEventListener('click', (event) => {
          event.preventDefault();
          runWarmupAction('enable');
        });
      }
      if (deliverabilityEls.verifyDomainButton) {
        deliverabilityEls.verifyDomainButton.addEventListener('click', (event) => {
          event.preventDefault();
          focusEmailDomainSection();
        });
      }
      if (deliverabilityEls.toolsPreview) {
        deliverabilityEls.toolsPreview.addEventListener('click', (event) => {
          event.preventDefault();
          previewBlastFooter();
        });
      }
      if (deliverabilityEls.toolsGenerate) {
        deliverabilityEls.toolsGenerate.addEventListener('click', (event) => {
          event.preventDefault();
          generateTestUnsubscribeLink();
        });
      }
      if (emailSystemCheckEls.refresh) {
        emailSystemCheckEls.refresh.addEventListener('click', (event) => {
          event.preventDefault();
          loadEmailSystemCheckPanel();
        });
      }
      if (emailQueueEls.refresh) {
        emailQueueEls.refresh.addEventListener('click', (event) => {
          event.preventDefault();
          loadEmailQueuePanel();
        });
      }
      if (emailQueueEls.samplesBody) {
        emailQueueEls.samplesBody.addEventListener('click', (event) => {
          const button = event.target.closest('button[data-action="toggle-email-details"]');
          if (!button) return;
          const jobId = button.dataset.jobId;
          if (!jobId) return;
          const detailRow = emailQueueEls.samplesBody.querySelector(`tr[data-email-details="${jobId}"]`);
          if (!detailRow) return;
          detailRow.classList.toggle('d-none');
        });
      }

      if (emailDomainEls.form) {
        emailDomainEls.form.addEventListener('submit', startEmailDomain);
      }
      if (emailDomainEls.validateButton) {
        emailDomainEls.validateButton.addEventListener('click', (event) => {
          event.preventDefault();
          validateEmailDomain();
        });
      }
      if (emailDomainEls.removeButton) {
        emailDomainEls.removeButton.addEventListener('click', (event) => {
          event.preventDefault();
          removeEmailDomain();
        });
      }
      if (emailDomainEls.dnsBody) {
        emailDomainEls.dnsBody.addEventListener('click', async (event) => {
          const button = event.target.closest('button[data-copy]');
          if (!button) return;
          const value = button.dataset.copy || '';
          try {
            await copyText(value);
            setEmailDomainStatus('Copied to clipboard.', 'success');
            setTimeout(() => {
              if (!state.emailDomain.saving && !state.emailDomain.loading) {
                renderEmailDomain();
              }
            }, 1200);
          } catch (err) {
            console.error('Copy failed', err);
            setEmailDomainStatus('Failed to copy.', 'danger');
          }
        });
      }

      if (buildrootzEls.form) {
        buildrootzEls.form.addEventListener('submit', handleBuildrootzSubmit);
        if (buildrootzEls.publish) {
          buildrootzEls.publish.addEventListener('click', handleBuildrootzPublish);
        }
        if (buildrootzEls.discard) {
          buildrootzEls.discard.addEventListener('click', handleBuildrootzDiscard);
        }
        if (buildrootzEls.logo) {
          buildrootzEls.logo.addEventListener('input', () => {
            updateBuildrootzLogoPreview(getInputValue(buildrootzEls.logo));
          });
        }
      }

      if (billingEls.buildrootzRequestButton) {
        billingEls.buildrootzRequestButton.addEventListener('click', (event) => {
          event.preventDefault();
          requestBuildrootzActivation();
        });
      }

      if (billingEls.websiteMapRequestButton) {
        billingEls.websiteMapRequestButton.addEventListener('click', (event) => {
          event.preventDefault();
          openWebsiteMapPanel();
        });
      }

      if (billingEls.websiteMapPanelClose) {
        billingEls.websiteMapPanelClose.addEventListener('click', (event) => {
          event.preventDefault();
          closeWebsiteMapPanel();
        });
      }

      if (billingEls.websiteMapCommunityTable) {
        billingEls.websiteMapCommunityTable.addEventListener('click', handleWebsiteMapTableClick);
      }

      if (permissions && permissions.canUseImpersonation) {
        if (impersonationEls.searchButton) {
          impersonationEls.searchButton.addEventListener('click', (event) => {
            event.preventDefault();
            loadImpersonationPanel({ force: true });
          });
        }
        if (impersonationEls.searchInput) {
          impersonationEls.searchInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
              event.preventDefault();
              loadImpersonationPanel({ force: true });
            }
          });
        }
        if (impersonationEls.tableBody) {
          impersonationEls.tableBody.addEventListener('click', (event) => {
            const actionButton = event.target.closest('button[data-action="impersonate"]');
            if (!actionButton || actionButton.disabled) return;
            const row = actionButton.closest('tr[data-company-id]');
            if (!row) return;
            const companyId = row.dataset.companyId;
            impersonateCompany(companyId);
          });
        }
        if (impersonationEls.clearButton) {
          impersonationEls.clearButton.addEventListener('click', (event) => {
            event.preventDefault();
            clearImpersonation();
          });
        }
      }

      tabButtons.forEach((button) => {
        button.addEventListener('click', () => activatePanel(button.dataset.adminTarget, button));
      });

      loadCompanyPanel();
      updateEditToggleVisual();
    });
  </script>
</body>
</html>
