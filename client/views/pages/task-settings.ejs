<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Automation Settings</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/main.css" />
  <style>
    .task-settings-page .schedule-stat-card {
      border-radius: 1rem;
      border: 1px solid rgba(15, 26, 58, 0.08);
      padding: 1.25rem;
      background: linear-gradient(140deg, #ffffff 0%, #f7f9fc 100%);
      height: 100%;
    }

    .task-settings-page .schedule-stat-card .stat-label {
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: #6c757d;
    }

    .task-settings-page .schedule-stat-card .stat-value {
      font-size: 1.75rem;
      font-weight: 600;
      color: #0f1a3a;
    }

    .task-settings-page .builder-step {
      border: 1px solid rgba(15, 26, 58, 0.12);
      border-radius: 1rem;
      background-color: #fff;
    }

    .task-settings-page .timeline {
      position: relative;
      padding-left: 1rem;
    }

    .task-settings-page .timeline::before {
      content: "";
      position: absolute;
      left: 12px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(180deg, rgba(15, 26, 58, 0.15) 0%, rgba(15, 26, 58, 0) 100%);
    }

    .task-settings-page .timeline-step {
      position: relative;
      padding-left: 2.5rem;
      margin-bottom: 1.25rem;
    }

    .task-settings-page .timeline-step:last-child {
      margin-bottom: 0;
    }

    .task-settings-page .timeline-point {
      position: absolute;
      left: 6px;
      top: 4px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid #0f62fe;
      background: #fff;
    }
  </style>
</head>
<body>
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-task', { activeTab: (taskView || 'settings') }) %>

  <main class="container py-4 task-settings-page">
    <% const schedules = Array.isArray(followUpSchedules) ? followUpSchedules : []; %>
    <% const builder = scheduleBuilderPreset || {}; %>
    <% const builderSteps = Array.isArray(builder.steps) ? builder.steps : []; %>
    <% const stats = autoFollowUpStats || {}; %>
    <% const teamAssignments = Array.isArray(teamScheduleAssignments) ? teamScheduleAssignments : []; %>
    <% const stageOptions = Array.isArray(builder.stageOptions) ? builder.stageOptions : []; %>
    <% const ownerOptions = Array.isArray(builder.ownerOptions) ? builder.ownerOptions : []; %>
    <% const channelOptions = Array.isArray(builder.channelOptions) ? builder.channelOptions : ['SMS', 'Email', 'Call', 'Reminder']; %>

    <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-4">
      <div>
        <p class="text-uppercase text-muted fw-semibold mb-1 small">Task Automation</p>
        <h1 class="h3 mb-2">Auto Follow-Up Schedules</h1>
        <p class="text-muted mb-0">
          Design multi-touch cadences that KeepUP can run automatically and then assign them to your team with one click.
        </p>
      </div>
      <div class="d-flex gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm">Import Template</button>
        <button type="button" class="btn btn-primary btn-sm" data-new-schedule>New Draft Schedule</button>
      </div>
    </div>

    <section class="mb-5">
      <div class="row g-3">
        <div class="col-md-3 col-sm-6">
          <div class="schedule-stat-card">
            <div class="stat-label">Schedule Library</div>
            <div class="stat-value"><%= stats.librarySize ?? schedules.length %></div>
            <p class="text-muted small mb-0">Ready-to-use cadences for your org</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="schedule-stat-card">
            <div class="stat-label">Active Teammates</div>
            <div class="stat-value"><%= stats.activeTeammates ?? teamAssignments.length %></div>
            <p class="text-muted small mb-0">Currently eligible for automation</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="schedule-stat-card">
            <div class="stat-label">Avg Touches</div>
            <div class="stat-value"><%= stats.averageTouches ? stats.averageTouches + 'x' : '—' %></div>
            <p class="text-muted small mb-0">Per auto follow-up program</p>
          </div>
        </div>
        <div class="col-md-3 col-sm-6">
          <div class="schedule-stat-card">
            <div class="stat-label">Longest Cadence</div>
            <div class="stat-value">
              <%= stats.longestCadenceDays ? stats.longestCadenceDays + 'd' : '—' %>
            </div>
            <p class="text-muted small mb-0">Days of automated coverage</p>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-5">
      <div class="row g-4">
        <div class="col-lg-7">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-3 flex-wrap gap-2">
                <div>
                  <p class="text-uppercase text-muted fw-semibold small mb-1">Builder</p>
                  <h2 class="h5 mb-0" data-builder-title>Schedule Canvas</h2>
                </div>
                <button type="button" class="btn btn-outline-primary btn-sm" data-add-step>Add Touchpoint</button>
              </div>

              <form class="schedule-builder" data-task-settings-form>
                <div class="row g-3 mb-3">
                  <div class="col-md-6">
                    <label class="form-label">Schedule Name</label>
                    <input type="text" class="form-control" name="scheduleName" value="<%= builder.name || '' %>" placeholder="e.g. Rapid Lead Reply" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Pipeline Stage</label>
                    <select class="form-select" name="pipelineStage">
                      <% (stageOptions.length ? stageOptions : ['New Lead']).forEach((stage) => { %>
                        <option value="<%= stage %>" <%= stage === builder.defaultStage ? 'selected' : '' %>>
                          <%= stage %>
                        </option>
                      <% }) %>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Default Owner</label>
                    <select class="form-select" name="owner">
                      <% (ownerOptions.length ? ownerOptions : ['Online Sales Concierge']).forEach((owner) => { %>
                        <option value="<%= owner %>" <%= owner === builder.defaultOwner ? 'selected' : '' %>>
                          <%= owner %>
                        </option>
                      <% }) %>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Fallback Escalation</label>
                    <select class="form-select" name="escalationOwner">
                      <% (ownerOptions.length ? ownerOptions : ['Sales Manager']).forEach((owner) => { %>
                        <option value="<%= owner %>"><%= owner %></option>
                      <% }) %>
                    </select>
                  </div>
                </div>
                <div class="mb-4">
                  <label class="form-label">Internal Description</label>
                  <textarea class="form-control" rows="3" name="description" placeholder="Explain when this cadence should be used."><%= builder.description || '' %></textarea>
                </div>

                <div>
                  <div class="d-flex align-items-center justify-content-between">
                    <h3 class="h6 mb-0">Follow-Up Steps</h3>
                    <small class="text-muted">Drag order coming soon</small>
                  </div>
                  <div id="builder-step-list" class="mt-3" data-step-list>
                    <% const safeOwnerOptions = ownerOptions.length ? ownerOptions : ['Online Sales Concierge', 'Sales Manager']; %>
                    <% const safeChannelOptions = channelOptions.length ? channelOptions : ['SMS', 'Email', 'Call']; %>
                    <% builderSteps.forEach((step) => {
                         const selectedChannel = safeChannelOptions.includes(step.channel) ? step.channel : safeChannelOptions[0];
                         const selectedOwner = safeOwnerOptions.includes(step.ownerRole) ? step.ownerRole : safeOwnerOptions[0];
                    %>
                      <div class="builder-step p-3 mb-3" data-step-id="<%= step.id %>">
                        <div class="row g-3 align-items-end">
                          <div class="col-6 col-md-2">
                            <label class="form-label text-muted text-uppercase small fw-semibold">Day</label>
                            <input type="number" class="form-control" min="0" value="<%= step.dayOffset ?? 0 %>" data-step-field="day" />
                          </div>
                          <div class="col-6 col-md-3">
                            <label class="form-label text-muted text-uppercase small fw-semibold">Channel</label>
                            <select class="form-select" data-step-field="channel">
                              <% safeChannelOptions.forEach((channel) => { %>
                                <option value="<%= channel %>" <%= channel === selectedChannel ? 'selected' : '' %>>
                                  <%= channel %>
                                </option>
                              <% }) %>
                            </select>
                          </div>
                          <div class="col-12 col-md-7">
                            <label class="form-label text-muted text-uppercase small fw-semibold">Touchpoint summary</label>
                            <input type="text" class="form-control" value="<%= step.title || '' %>" placeholder="What happens during this touch?" data-step-field="title" />
                          </div>
                          <div class="col-12 col-md-6">
                            <label class="form-label text-muted text-uppercase small fw-semibold">Owner</label>
                            <select class="form-select" data-step-field="owner">
                              <% safeOwnerOptions.forEach((owner) => { %>
                                <option value="<%= owner %>" <%= owner === selectedOwner ? 'selected' : '' %>>
                                  <%= owner %>
                                </option>
                              <% }) %>
                            </select>
                          </div>
                          <div class="col-12 col-md-6">
                            <label class="form-label text-muted text-uppercase small fw-semibold">Auto-complete rule</label>
                            <select class="form-select" data-step-field="rule">
                              <option value="manual" <%= step.waitForReply ? '' : 'selected' %>>Requires manual check-in</option>
                              <option value="reply" <%= step.waitForReply ? 'selected' : '' %>>Mark complete when contact replies</option>
                            </select>
                          </div>
                          <div class="col-12">
                            <label class="form-label text-muted text-uppercase small fw-semibold">Internal instructions</label>
                            <textarea class="form-control" rows="2" data-step-field="instructions" placeholder="Provide talking points or templates."><%= step.instructions || '' %></textarea>
                          </div>
                        </div>
                        <div class="d-flex align-items-center mt-3 gap-3">
                          <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" role="switch" <%= step.waitForReply ? 'checked' : '' %> data-step-field="wait" />
                            <label class="form-check-label small text-muted">Pause cadence until reply arrives</label>
                          </div>
                          <button type="button" class="btn btn-sm btn-outline-danger ms-auto" data-remove-step>&times; Remove</button>
                        </div>
                      </div>
                    <% }) %>
                  </div>
                </div>

                <div class="d-flex flex-wrap gap-3 mt-4">
                  <button type="button" class="btn btn-primary" data-save-schedule>Save Schedule</button>
                  <button type="button" class="btn btn-outline-secondary">Save as Template</button>
                  <button type="button" class="btn btn-link text-decoration-none">Preview automation rules</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="col-lg-5">
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <p class="text-uppercase text-muted fw-semibold small mb-1">Preview</p>
              <h2 class="h6 mb-3">Timeline Overview</h2>
              <% const previewSteps = builderSteps.slice().sort((a, b) => (a.dayOffset || 0) - (b.dayOffset || 0)); %>
              <div class="timeline">
                <% if (!previewSteps.length) { %>
                  <p class="text-muted small mb-0">Add at least one step to see how the cadence plays out.</p>
                <% } else { %>
                  <% previewSteps.forEach((step) => { %>
                    <div class="timeline-step">
                      <span class="timeline-point" aria-hidden="true"></span>
                      <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                        <div>
                          <div class="fw-semibold">
                            Day <%= step.dayOffset ?? 0 %> &middot; <%= step.channel || 'Touchpoint' %>
                          </div>
                          <p class="text-muted small mb-1"><%= step.title || 'Touchpoint' %></p>
                          <span class="badge bg-light text-dark border">
                            Owner: <%= step.ownerRole || builder.defaultOwner || 'Team' %>
                          </span>
                        </div>
                        <small class="text-muted">
                          <%= step.waitForReply ? 'Wait for reply' : 'Auto-advance' %>
                        </small>
                      </div>
                    </div>
                  <% }) %>
                <% } %>
              </div>
            </div>
          </div>

          <div class="card shadow-sm h-100">
            <div class="card-body">
              <p class="text-uppercase text-muted fw-semibold small mb-1">Library</p>
              <h2 class="h6 mb-3">Saved Schedules</h2>
              <div class="vstack gap-3" data-schedule-list>
                <% if (!schedules.length) { %>
                  <div class="border rounded-3 p-3 text-center text-muted">
                    No schedules saved yet. Build one on the left to get started.
                  </div>
                <% } else { %>
                  <% schedules.forEach((schedule) => { %>
                    <div class="border rounded-3 p-3">
                      <div class="d-flex justify-content-between align-items-start gap-2">
                        <div>
                          <div class="fw-semibold"><%= schedule.name %></div>
                          <p class="text-muted small mb-1"><%= schedule.summary %></p>
                          <div class="d-flex flex-wrap gap-1">
                            <% (schedule.tags || []).forEach((tag) => { %>
                              <span class="badge bg-light text-dark border"><%= tag %></span>
                            <% }) %>
                          </div>
                        </div>
                        <div class="text-end">
                          <small class="text-muted d-block">
                            Updated <%= schedule.lastUpdatedAt ? new Date(schedule.lastUpdatedAt).toLocaleDateString() : '' %>
                          </small>
                          <span class="badge rounded-pill bg-primary-subtle text-primary mt-1">
                            <%= schedule.metrics?.touchpoints || schedule.steps?.length || 0 %> touches
                          </span>
                        </div>
                      </div>
                      <div class="d-flex gap-2 mt-3">
                        <button type="button" class="btn btn-sm btn-outline-primary flex-grow-1" data-load-schedule="<%= schedule.id %>">Load into builder</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" title="Duplicate schedule">
                          Duplicate
                        </button>
                      </div>
                    </div>
                  <% }) %>
                <% } %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-5">
      <div class="card shadow-sm">
        <div class="card-body">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-3">
            <div>
              <p class="text-uppercase text-muted fw-semibold small mb-1">Assignment</p>
              <h2 class="h5 mb-1">Apply Auto Follow-Up to Teammates</h2>
              <p class="text-muted mb-0">Choose a cadence for each team member. KeepUP will keep them on schedule.</p>
            </div>
            <button type="button" class="btn btn-outline-secondary btn-sm">Download coverage</button>
          </div>

          <% if (!teamAssignments.length) { %>
            <div class="alert alert-info mt-4 mb-0">
              Add teammates in the Admin area to start assigning auto follow-up schedules.
            </div>
          <% } else { %>
            <div class="table-responsive mt-4">
              <table class="table align-middle" data-assignment-table>
                <thead>
                  <tr>
                    <th scope="col">Team Member</th>
                    <th scope="col">Role</th>
                    <th scope="col">Status</th>
                    <th scope="col">Current Schedule</th>
                    <th scope="col" class="text-end">Apply New</th>
                  </tr>
                </thead>
                <tbody>
                  <% teamAssignments.forEach((member) => { %>
                    <tr data-member-id="<%= member.id %>" data-member-name="<%= member.name %>">
                      <td>
                        <div class="fw-semibold"><%= member.name %></div>
                        <div class="text-muted small"><%= member.email || 'No email on file' %></div>
                      </td>
                      <td><span class="badge bg-light text-dark border"><%= member.role %></span></td>
                      <td>
                        <% const isActive = (member.status || '').toUpperCase() === 'ACTIVE'; %>
                        <span class="badge <%= isActive ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary' %>">
                          <%= member.status || 'Active' %>
                        </span>
                      </td>
                      <td>
                        <div data-current-schedule class="text-muted">
                          <%= member.currentScheduleId
                                ? (schedules.find((s) => s.id === member.currentScheduleId)?.name || 'Custom cadence')
                                : 'Not assigned yet' %>
                        </div>
                      </td>
                      <td>
                        <div class="d-flex gap-2 align-items-center justify-content-end flex-wrap">
                          <select class="form-select form-select-sm" data-schedule-select>
                            <option value="">Select schedule</option>
                            <% schedules.forEach((schedule) => { %>
                              <option value="<%= schedule.id %>"><%= schedule.name %></option>
                            <% }) %>
                          </select>
                          <button type="button" class="btn btn-sm btn-outline-primary" data-apply-schedule>Apply</button>
                        </div>
                      </td>
                    </tr>
                  <% }) %>
                </tbody>
              </table>
            </div>
          <% } %>
        </div>
      </div>
      <div class="visually-hidden" aria-live="polite" data-apply-toast></div>
    </section>
  </main>

  <% const taskSettingsJson = typeof taskSettingsData === 'object' && taskSettingsData
      ? taskSettingsData
      : {
          schedules,
          builderPreset: builder,
          stats,
          teamAssignments,
          endpoints: {
            schedules: '/api/task-schedules',
            assignments: '/api/task-schedules/assignments'
          }
        };
  %>
  <script id="task-settings-data" type="application/json">
    <%- JSON.stringify(taskSettingsJson) %>
  </script>
  <script defer src="/assets/js/task/settings.js"></script>
</body>
</html>
