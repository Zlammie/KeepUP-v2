<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Company - Competition</title>
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/pages/competition-shared.css">
  <link rel="stylesheet" href="/assets/css/pages/myCommunity.css">

  

</head>
<body>
  <%- include('../partials/nav') %>
 <%- include('../partials/top-nav-competition') %>

  <main>
    <div class="page-with-task">
    <div class="horizontal-cont">
      <!-- LEFT: side bar card (same class names for consistency) -->
      <div class="side-bar card card--grey main-cont" id="leftSidebar" aria-disabled="true">
        <section class="card card--white card--margin-bottom community-actions-card">
          
          <div class="form-group">
            <label for="communitySelect">Select a community</label>
            <select id="communitySelect" class="community-select">
              <option value="">-- Select a community --</option>
            </select>
          </div>
          <button id="manageCommunityBtn" class="manage-community-btn manage-community-btn--solid" type="button" aria-label="Monthly Info">
            <span class="mcb-label">Monthly Info</span>
          </button>
        </section>
        <script nonce="<%= cspNonce %>">
          document.getElementById('manageCommunityBtn').addEventListener('click', () => {
            const communityId = document.getElementById('communitySelect').value;
            if (!communityId) {
              alert('Please select a community first.');
              return;
            }
            window.location.href = `/manage-my-community-competition/${communityId}`;
          });
        </script>
        <!-- Sales-like section (we'll use it for contact/admin info as needed) -->
        <section class="card card--white card--margin-bottom">
          <h2>Primary Community Contact</h2>
          <div class="form-group">
            <label for="salesPerson">Sales Person</label>
            <input type="text" id="salesPerson" name="salesPerson">
          </div>
          <div class="form-group">
            <label for="salesPersonPhone">Sales Person Phone #</label>
            <input type="text" id="salesPersonPhone" name="salesPersonPhone">
          </div>
          <div class="form-group">
            <label for="salesPersonEmail">Sales Person Email</label>
            <input type="email" id="salesPersonEmail" name="salesPersonEmail">
          </div>
        </section>

        <!-- Builder-like section populated from Community + editable profile -->
        <section class="card card--white card--margin-bottom">
          <h2>Community / Builder Info</h2>

          <div class="form-group">
            <label for="address">Address</label>
            <input type="text" id="address" name="address">
          </div>
          <div class="form-group">
            <label for="city">City</label>
            <input type="text" id="city" name="city">
          </div>
          <div class="form-group">
            <label for="zip">ZIP</label>
            <input type="text" id="zip" name="zip">
          </div>

          <div class="form-group">
            <label for="modelPlan">Model Floor Plan</label>
            <select id="modelPlan" name="modelPlan">
              <option value="">-- Select a floor plan --</option>
              <!-- options filled by JS if you want parity -->
            </select>
          </div>

          <div class="form-group">
            <label for="lotSize">Lot Size</label>
            <input type="text" id="lotSize" name="lotSize">
          </div>

          <fieldset class="form-group">
            <legend>Garage Type</legend>
            <label><input type="radio" name="garageType" value="Front"> Front</label>
            <label><input type="radio" name="garageType" value="Rear"> Rear</label>
          </fieldset>

          <div class="form-group">
            <label for="totalLots">Total Lots</label>
            <input type="number" id="totalLots" name="totalLots">
          </div>
        </section>

        <section class="card card--white card--margin-bottom">
          <h2>School Info</h2>
          <div class="form-group">
            <label for="schoolISD">School ISD</label>
            <input type="text" id="schoolISD" name="schoolISD">
          </div>
          <div class="form-group">
            <label for="elementarySchool">Elementary School</label>
            <input type="text" id="elementarySchool" name="elementarySchool">
          </div>
          <div class="form-group">
            <label for="middleSchool">Middle School</label>
            <input type="text" id="middleSchool" name="middleSchool">
          </div>
          <div class="form-group">
            <label for="highSchool">High School</label>
            <input type="text" id="highSchool" name="highSchool">
          </div>
        </section>

        <section class="card card--white">
          <h2>Community Info</h2>

          <div class="form-group">
            <label for="hoaFee">HOA Fee</label>
            <input type="number" id="hoaFee" name="hoaFee">
          </div>

          <div class="form-group">
            <label for="hoaFrequency">HOA Frequency</label>
            <select id="hoaFrequency" name="hoaFrequency">
              <option value="">-- Select Frequency --</option>
              <option value="Monthly">Monthly</option>
              <option value="Bi-Annually">Bi-Annually</option>
              <option value="Annually">Annually</option>
            </select>
          </div>

          <div class="form-group">
            <label for="tax">Annual Tax (%)</label>
            <input type="number" id="tax" name="tax" step="0.01">
          </div>

          <div class="form-group">
            <label>Additional Fees</label>
            <div class="fee-option">
              <label><input type="checkbox" id="feeMud" name="feeTypes" value="MUD"> MUD</label>
              <div class="fee-subgroup" id="mudFeeGroup" style="display:none;">
                <label for="mudFee">MUD Fee</label>
                <input type="number" id="mudFee" name="mudFee">
              </div>
            </div>
            <div class="fee-option">
              <label><input type="checkbox" id="feePid" name="feeTypes" value="PID"> PID</label>
              <div class="fee-subgroup" id="pidFeeGroup" style="display:none;">
                <div class="fee-inline">
                  <div class="fee-field">
                    <label for="pidFee">PID Fee</label>
                    <input type="number" id="pidFee" name="pidFee">
                  </div>
                  <div class="fee-field">
                    <label for="pidFeeFrequency">Frequency</label>
                    <select id="pidFeeFrequency" name="pidFeeFrequency">
                      <option value="">-- Select Frequency --</option>
                      <option value="Monthly">Monthly</option>
                      <option value="Yearly">Yearly</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
            <div class="fee-option">
              <label><input type="checkbox" id="feeNone" name="feeTypes" value="None"> None</label>
            </div>
          </div>

          <div class="form-group">
            <label for="earnestAmount">Earnest Amount</label>
            <input type="number" id="earnestAmount" name="earnestAmount" step="0.01">
          </div>

          <div class="form-group">
            <label for="realtorCommission">Realtor Commission (%)</label>
            <input type="number" id="realtorCommission" name="realtorCommission" step="0.01">
          </div>
          <button type="button" id="openAmenitiesBtn" class="btn btn-sm btn-primary">Edit Amenities</button>
        </section>
      </div>

      <!-- RIGHT: top container (same card grid and section-boxes) -->
      <div class="top-content-cont card card--grey top-container" id="rightTop" aria-disabled="true">
        <div class="top-card-grid">
          <!-- Builder title and amenities, mirrored -->
          <div class="title-and-amenities">
            <h1 class="builder-title" id="builderTitle">—</h1>
            <ul class="amenity-chiplist" id="amenityList">
              <!-- chips inserted by JS -->
            </ul>
          </div>

          <ul class="lot-stats">
            <li class="lot-stat">
              <span class="stat-label">Total Lots</span>
              <span class="stat-value" id="statTotalLots">—</span>
            </li>
            <li class="lot-stat">
              <span class="stat-label">Lots Sold</span>
              <span class="stat-value" id="statLotsSold">—</span>
            </li>
            <li class="lot-stat">
              <span class="stat-label">Remaining</span>
              <span class="stat-value" id="statLotsRemaining">—</span>
            </li>
            <li class="lot-stat">
              <span class="stat-label">QMI</span>
              <span class="stat-value" id="statQmiAvailable">—</span>
            </li>
          </ul>

          <div id="overviewCollapsedBar" class="overview-collapsed span-full is-hidden" role="status">
            <span>Promotion & HOA, Pros & Cons hidden</span>
            <button type="button" id="overviewExpandBtn" class="btn btn-sm btn-primary">Show Sections</button>
          </div>

          <div id="overviewSections" class="overview-sections span-full">
            <section class="section-box span-full card card--white overview-nested-card">
              <div class="overview-nested-card__header">
                <button type="button" id="overviewCollapseToggle" class="btn btn-sm btn-outline-secondary">Hide</button>
              </div>
              <div class="overview-nested-card__grid">
                <!-- Promotion & HOA row -->
                <section class="section-box card card--white overview-nested-card__item">
                  <div class="section-box__header">
                    <h4>Promotion & HOA</h4>
                  </div>
                  <div id="promoHoaContent" class="promo-hoa-row">
                    <div class="promo">
                      <p id="promoText">Select a community to load promotions.</p>
                    </div>
                    <div class="hoa-tax">
                      <div class="kv"><span class="k">HOA</span><span class="v" id="hoaDisplay">Not specified</span></div>
                      <div class="kv"><span class="k">Tax Rate</span><span class="v" id="taxDisplay">Not specified</span></div>
                    </div>
                  </div>
                </section>

                <!-- Pros & Cons full width -->
                <section class="section-box card card--white overview-nested-card__item">
                  <div class="section-box__header">
                    <h4>Pros & Cons</h4>
                  </div>
                  <div id="prosConsContent" class="proscons-grid">
                    <div>
                      <h5>Pros</h5>
                      <ul id="prosUl"></ul>
                    </div>
                    <div>
                      <h5>Cons</h5>
                      <ul id="consUl"></ul>
                    </div>
                  </div>
                </section>
              </div>
            </section>
          </div>

          <!-- Graphs wrapper to match the look -->
          
            <section class="section-box span-full card card--white mt-3" id="graphsSection">
              <div class="section-box__header graphs-header">
                <h4 class="graphs-title">Performance Graphs</h4>
                <div class="graphs-controls">
                  <div class="tab-nav" role="tablist" aria-label="Graph selector">
                    <button class="tab-btn is-active" data-tab="sales" role="tab" aria-selected="true">Sales</button>
                    <button class="tab-btn" data-tab="sqft" role="tab" aria-selected="false">Sqft Comparison</button>
                    <button class="tab-btn" data-tab="base" role="tab" aria-selected="false">Base Price</button>
                    <button class="tab-btn" data-tab="qmi" role="tab" aria-selected="false">QMI / Solds</button>
                  </div>
                  <div class="graph-filter is-hidden" id="sqftMonthFilter">
                    <label class="sr-only" for="sqftMonthSelect">Select month</label>
                    <select id="sqftMonthSelect" class="graph-select">
                      <option value="">Latest Month</option>
                    </select>
                  </div>
                </div>
              </div>
              <div id="graphMount" class="graph-mount" role="region" aria-live="polite" aria-busy="false"></div>
            </section>
          

          <section class="section-box span-full card card--white mt-3" id="qmiSoldSection">
            <div class="section-box__header">
              <h4>QMI vs Sold Tables</h4>
              <small class="text-muted">Last 12 recorded months</small>
            </div>
            <div class="row g-3">
              <div class="col-md-6" id="qmiTableCardWrap">
                <div class="card card--white p-3 expandable-table-card h-100" id="qmiTableCard">
                  <div class="expandable-table-card-header mb-2">
                    <h5 class="mb-0">Quick Move-In Homes</h5>
                    <button type="button"
                            id="qmiTableToggle"
                            class="btn btn-sm btn-outline-secondary expandable-table-toggle"
                            aria-expanded="false"
                            aria-controls="qmiTable"
                            aria-label="Expand quick move-in table">
                      <span class="expandable-table-toggle-icon" aria-hidden="true">[+]</span>
                      <span class="visually-hidden">Expand quick move-in table</span>
                    </button>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-sm table-striped" id="qmiTable">
                      <thead>
                        <tr>
                          <th scope="col">Month</th>
                          <th scope="col">Address</th>
                          <th scope="col">Floor Plan</th>
                          <th scope="col">Sqft</th>
                          <th scope="col">List Price</th>
                          <th scope="col">Status</th>
                        </tr>
                      </thead>
                      <tbody id="qmiTableBody">
                        <tr>
                          <td colspan="6" class="text-muted">Select a community to load data.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="card card--white p-3 h-100">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <h5 class="mb-0">Sold Homes</h5>
                  </div>
                  <div class="table-responsive">
                    <table class="table table-sm table-striped" id="soldTable">
                      <thead>
                        <tr>
                          <th scope="col">Month</th>
                          <th scope="col">Address</th>
                          <th scope="col">Floor Plan</th>
                          <th scope="col">Sqft</th>
                          <th scope="col">List Price</th>
                          <th scope="col">Sold Price</th>
                          <th scope="col">Sold Date</th>
                        </tr>
                      </thead>
                      <tbody id="soldTableBody">
                        <tr>
                          <td colspan="7" class="text-muted">Select a community to load data.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- Linked competitors selector (full width) -->
          <section class="section-box span-full card card--white mt-3" id="linkedCompetitorsSection">
            <div class="section-box__header">
              <h4>Linked Competitors</h4>
              <span class="linked-badge" id="linkedCountBadge">0 linked</span>
            </div>
            <div class="competitor-grid">
              <div class="competitor-column">
                <div class="competitor-header">
                  <div>
                    <h6 class="mb-1">All Competitors</h6>
                    <small class="text-muted" id="availableListCount">0 builders</small>
                  </div>
                  <div class="competitor-toggle" id="competitorModeToggle">
                    <button type="button" class="mode-btn is-active" data-mode="external">Builders</button>
                    <button type="button" class="mode-btn" data-mode="internal">My Communities</button>
                  </div>
                  <div class="competitor-search">
                    <label for="allCompetitionsSearch" class="sr-only">Search competitors</label>
                    <input type="search" id="allCompetitionsSearch" placeholder="Search by builder or community" autocomplete="off">
                  </div>
                </div>
                <div id="allCompetitionsEmpty" class="empty-state is-hidden">No competitors match your search.</div>
                <div id="internalCommunitiesEmpty" class="empty-state is-hidden">No communities available.</div>
                <div id="allCompetitionsList" class="list-group"></div>
                <div id="internalCommunitiesList" class="list-group is-hidden"></div>
              </div>
              <div class="competitor-column">
                <div class="competitor-header">
                  <h6 class="mb-1">Linked</h6>
                  <small class="text-muted" id="linkedCompetitorsCount">0 linked</small>
                </div>
                <div id="linkedCompetitorsEmpty" class="empty-state">No competitors linked yet.</div>
                <div id="linkedCompetitors" class="list-group"></div>
              </div>
            </div>
          </section>
        </div>
      </div>

      <aside class="task-bar-outside card task-panel-card">
        <div id="todo-panel" class="todo-panel" aria-live="polite">
          <header class="todo-header">
            <button id="todo-toggle" class="todo-toggle" type="button" aria-expanded="true">
              <span class="todo-toggle-icon" aria-hidden="true">&#9662;</span>
              <span class="todo-toggle-text">Tasks</span>
              <span id="todo-count" class="todo-count">0</span>
            </button>
            <button id="todo-add" class="todo-add-btn" type="button" disabled>
              <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
              <span>Add Task</span>
            </button>
          </header>

          <section id="todo-panel-body" class="todo-body">
            <div class="todo-summary">
              <button type="button" class="todo-pill is-active" data-filter="all">
                <span class="pill-label">All</span>
                <span class="pill-count" aria-hidden="true">0</span>
              </button>
              <button type="button" class="todo-pill" data-filter="Pending">
                <span class="pill-label">Pending</span>
                <span class="pill-count" aria-hidden="true">0</span>
              </button>
              <button type="button" class="todo-pill" data-filter="Completed">
                <span class="pill-label">Completed</span>
                <span class="pill-count" aria-hidden="true">0</span>
              </button>
            </div>

            <div class="todo-helper">
              <p class="todo-helper-title">Stay ahead of your community</p>
              <p class="todo-helper-body">
                Select a community to review follow-ups, then add reminders or assignments in one place.
              </p>
            </div>

            <ul id="todo-list" class="todo-list">
              <li class="todo-empty">
                <div class="todo-empty-state">
                  <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
                  <p class="todo-empty-text">Select a community to view or add tasks.</p>
                </div>
              </li>
            </ul>
            <footer class="todo-footer">
              <button id="todo-view-all" class="todo-view-all-btn" type="button">View All Tasks</button>
            </footer>
          </section>
        </div>
      </aside>
    </div>

  <div id="task-modal" class="task-modal" aria-hidden="true" hidden>
    <div class="task-modal__backdrop" data-task-modal-close></div>
    <div class="task-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
      <header class="task-modal__header">
        <h2 id="task-modal-title">Edit Task</h2>
        <button type="button" id="task-modal-close" class="task-modal__close" aria-label="Close task editor">&times;</button>
      </header>
      <form id="task-modal-form" class="task-modal__form" novalidate>
        <div class="task-modal__content">
          <div class="task-modal__row">
            <label for="task-modal-title-input">Title</label>
            <input id="task-modal-title-input" name="title" type="text" maxlength="160" required />
          </div>
          <div class="task-modal__row">
            <span class="task-modal__row-label">Task Type</span>
            <div id="task-type-buttons" class="task-type-group" role="group" aria-label="Task type">
              <button type="button" class="task-type-button is-selected" data-type="Follow-Up" aria-pressed="true">Follow-Up</button>
              <button type="button" class="task-type-button" data-type="Reminder" aria-pressed="false">Reminder</button>
              <button type="button" class="task-type-button" data-type="Document" aria-pressed="false">Document</button>
              <button type="button" class="task-type-button" data-type="Approval" aria-pressed="false">Approval</button>
              <button type="button" class="task-type-button" data-type="Review" aria-pressed="false">Review</button>
              <button type="button" class="task-type-button" data-type="Note" aria-pressed="false">Note</button>
              <button type="button" class="task-type-button" data-type="Custom" aria-pressed="false">Custom</button>
            </div>
            <div id="task-followup-sub" class="task-type-subgroup" hidden aria-hidden="true">
              <span class="task-type-subtitle">Follow-Up via</span>
              <div class="task-type-subbuttons" role="group" aria-label="Follow-up method">
                <button type="button" class="task-type-subbutton is-selected" data-followup="Follow-Up" aria-pressed="true">General</button>
                <button type="button" class="task-type-subbutton" data-followup="Call" aria-pressed="false">Call</button>
                <button type="button" class="task-type-subbutton" data-followup="Email" aria-pressed="false">Email</button>
                <button type="button" class="task-type-subbutton" data-followup="Meeting" aria-pressed="false">Meeting</button>
              </div>
            </div>
          </div>
          <div class="task-modal__grid two-col">
            <div class="task-modal__row">
              <label for="task-modal-due">Due date</label>
              <input id="task-modal-due" name="dueDate" type="date" />
            </div>
            <div class="task-modal__row">
              <label for="task-modal-priority">Priority</label>
              <select id="task-modal-priority" name="priority"></select>
            </div>
          </div>
          <div class="task-modal__grid two-col">
            <div class="task-modal__row">
              <label for="task-modal-status">Status</label>
              <select id="task-modal-status" name="status"></select>
            </div>
          </div>
          <div class="task-modal__row">
            <label for="task-modal-notes">Notes</label>
            <textarea id="task-modal-notes" name="description" rows="4" maxlength="2000"></textarea>
          </div>
        </div>
        <p id="task-modal-error" class="task-modal__error" role="alert" hidden></p>
        <div class="task-modal__actions">
          <div class="task-modal__actions-left">
            <button type="button" id="task-modal-complete" class="task-modal__secondary">Mark as Completed</button>
          </div>
          <div class="task-modal__actions-right">
            <button type="button" id="task-modal-cancel" class="task-modal__secondary">Cancel</button>
            <button type="submit" id="task-modal-save" class="task-modal__primary">Save Changes</button>
          </div>
        </div>
      </form>
    </div>
  </div>
  </main>

  <div id="amenitiesModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" id="closeAmenitiesModal">&times;</span>
      <h2>Select Community Amenities</h2>
      <form id="amenitiesForm">
        <div id="amenitiesContainer"></div>
        <div class="modal-actions">
          <button type="submit" class="btn btn-sm btn-primary">Save Amenities</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Page script -->
   <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js" nonce="<%= cspNonce %>"></script>
  <script type="module" src="/assets/js/pages/my-community-competition/index.js"></script>
</body>
</html>






