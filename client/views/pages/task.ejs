<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Planner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head>
<body>
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-contacts') %>

  <main class="container py-4 task-page">
    <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-4">
      <div>
        <h1 class="h2 mb-1">Tasks Due</h1>
        <p class="text-muted mb-0">
          Stay ahead on follow-ups across teams. Due and overdue items are grouped by category.
        </p>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-outline-secondary" id="task-refresh">Refresh</button>
        <button type="button" class="btn btn-primary task-add-trigger" id="task-add">Add Task</button>
      </div>
    </div>

    <% const startOfToday = new Date(); startOfToday.setHours(0, 0, 0, 0); %>
    <% const totalDue = Array.isArray(taskGroups) ? taskGroups.reduce((sum, group) => sum + (Array.isArray(group.tasks) ? group.tasks.length : 0), 0) : 0; %>
    <% const overdueCount = Array.isArray(taskGroups) ? taskGroups.reduce((sum, group) => {
         if (!Array.isArray(group.tasks)) return sum;
         return sum + group.tasks.filter((task) => {
           if (!task || !task.dueDate) return false;
           const due = new Date(task.dueDate);
           return !Number.isNaN(due.getTime()) && due < startOfToday;
         }).length;
       }, 0) : 0;
    %>
    <% const endOfToday = new Date(startOfToday); endOfToday.setHours(23, 59, 59, 999); %>
    <% const flattenedTasks = Array.isArray(taskGroups)
         ? taskGroups.reduce((acc, group) => acc.concat(Array.isArray(group.tasks) ? group.tasks : []), [])
         : [];
       const contactTaskCount = flattenedTasks.filter((task) => task && task.linkedModel === 'Contact').length;
       const communityTaskMap = new Map();
       const competitionCommunitiesMap = new Map();
       flattenedTasks.forEach((task) => {
         if (!task) return;
         if (task.linkedModel === 'Community' || task.linkedCommunityId) {
           const label = task.linkedModel === 'Community'
             ? (task.linkedName || 'Community')
             : (task.linkedCommunityName || 'Community');
           const key = task.linkedModel === 'Community'
             ? (task.linkedId ? String(task.linkedId) : label)
             : String(task.linkedCommunityId);
           if (key) {
             if (!communityTaskMap.has(key)) {
               communityTaskMap.set(key, { key, label, count: 0 });
             }
             communityTaskMap.get(key).count += 1;
           }
         }
         if (task.linkedModel === 'Competition') {
           const label = task.linkedName || 'Competition';
           const key = task.linkedId ? String(task.linkedId) : label;
           if (!competitionCommunitiesMap.has(key)) {
             competitionCommunitiesMap.set(key, { label, count: 0 });
           }
           competitionCommunitiesMap.get(key).count += 1;
         }
       });
       const communityTaskCount = Array.from(communityTaskMap.values()).reduce((sum, entry) => sum + entry.count, 0);
       const competitionTaskCount = Array.from(competitionCommunitiesMap.values()).reduce((sum, entry) => sum + entry.count, 0);
       const competitionCommunities = Array.from(competitionCommunitiesMap.values()).sort((a, b) => a.label.localeCompare(b.label));
       const managedCommunityList = Array.isArray(managedCommunities) && managedCommunities.length
         ? managedCommunities.map((community) => {
             const key = community && community._id ? String(community._id) : (community && community.name) || '';
             const taskEntry = communityTaskMap.get(key);
             const locationParts = [];
             if (community && community.city) locationParts.push(community.city);
             if (community && community.state) locationParts.push(community.state);
             return {
               key,
               label: (community && community.name) || (taskEntry ? taskEntry.label : 'Community'),
               location: locationParts.join(', '),
               count: taskEntry ? taskEntry.count : 0
             };
         })
       : [];
       const communityBreakdown = managedCommunityList.length
         ? managedCommunityList
         : Array.from(communityTaskMap.values()).sort((a, b) => a.label.localeCompare(b.label));
       const purchaserGroups = Array.isArray(purchaserContacts) ? purchaserContacts : [];
       const purchaserTaskCount = purchaserGroups.reduce((sum, entry) => sum + (entry && entry.count ? entry.count : 0), 0);
       const contactStatusGroups = Array.isArray(contactStatuses) ? contactStatuses : [];
       const dueBuckets = flattenedTasks.reduce((acc, task) => {
         if (!task) return acc;
         const statusText = typeof task.status === 'string' ? task.status.toLowerCase() : '';
         const dueDate = task && task.dueDate ? new Date(task.dueDate) : null;
         if (!dueDate || Number.isNaN(dueDate.getTime())) {
           if (statusText === 'overdue') acc.overdue += 1;
           else acc.noDue += 1;
           return acc;
         }
         if (dueDate >= startOfToday && dueDate <= endOfToday) acc.today += 1;
         else if (dueDate < startOfToday && statusText !== 'completed') acc.overdue += 1;
         else if (dueDate > endOfToday) acc.upcoming += 1;
         return acc;
       }, { today: 0, overdue: 0, upcoming: 0, noDue: 0 });
    %>

    <div class="task-layout">
      <aside class="task-sidebar card shadow-sm border-0">
        <div class="task-sidebar__section">
          <h2 class="task-sidebar__heading">Due Filters</h2>
          <div class="task-sidebar__subfilters" role="group" aria-label="Filter tasks by due date">
            <button
              type="button"
              class="task-filter-chip"
              data-task-filter-group="due"
              data-task-filter-value="today">
              <span>Today</span>
              <span class="task-filter-chip__count"><%= dueBuckets.today %></span>
            </button>
            <button
              type="button"
              class="task-filter-chip"
              data-task-filter-group="due"
              data-task-filter-value="overdue">
              <span>Overdue</span>
              <span class="task-filter-chip__count"><%= dueBuckets.overdue %></span>
            </button>
            <button
              type="button"
              class="task-filter-chip"
              data-task-filter-group="due"
              data-task-filter-value="upcoming">
              <span>Upcoming</span>
              <span class="task-filter-chip__count"><%= dueBuckets.upcoming %></span>
            </button>
            <button
              type="button"
              class="task-filter-chip"
              data-task-filter-group="due"
              data-task-filter-value="no-due">
              <span>No Due Date</span>
              <span class="task-filter-chip__count"><%= dueBuckets.noDue %></span>
            </button>
          </div>
          <div class="task-priority-filters" role="group" aria-label="Filter tasks by priority">
            <button
              type="button"
              class="task-priority-chip priority-none"
              data-task-filter-group="priority"
              data-task-filter-value="none"
              title="No priority">
              <span class="task-priority-icon" aria-hidden="true"></span>
              <span class="task-priority-label">None</span>
              <span class="task-priority-dot" aria-hidden="true"></span>
            </button>
            <button
              type="button"
              class="task-priority-chip priority-low"
              data-task-filter-group="priority"
              data-task-filter-value="low"
              title="Low priority">
              <span class="task-priority-icon" aria-hidden="true"></span>
              <span class="task-priority-label">Low</span>
              <span class="task-priority-dot" aria-hidden="true"></span>
            </button>
            <button
              type="button"
              class="task-priority-chip priority-medium"
              data-task-filter-group="priority"
              data-task-filter-value="medium"
              title="Medium priority">
              <span class="task-priority-icon" aria-hidden="true"></span>
              <span class="task-priority-label">Medium</span>
              <span class="task-priority-dot" aria-hidden="true"></span>
            </button>
            <button
              type="button"
              class="task-priority-chip priority-high"
              data-task-filter-group="priority"
              data-task-filter-value="high"
              title="High priority">
              <span class="task-priority-icon" aria-hidden="true"></span>
              <span class="task-priority-label">High</span>
              <span class="task-priority-dot" aria-hidden="true"></span>
            </button>
          </div>
        </div>
        <div class="task-sidebar__section">
          <h2 class="task-sidebar__heading">Breakdown</h2>
          <div class="task-sidebar__list">
            <details class="task-filter-collapse" open>
              <summary class="task-filter-summary">
                <button
                  type="button"
                  class="task-filter-summary-btn"
                  data-task-filter-group="contacts"
                  data-task-filter-value="all">
                  <span>Contacts</span>
                  <span class="task-filter-chip__count"><%= contactTaskCount %></span>
                </button>
                <button
                  type="button"
                  class="task-filter-toggle"
                  data-task-collapse-toggle
                  aria-label="Toggle contacts section">
                  <span aria-hidden="true"></span>
                </button>
              </summary>
              <% if (contactStatusGroups.length) { %>
                <div class="task-filter-sublist">
                  <% contactStatusGroups.forEach((status) => { %>
                    <button
                      type="button"
                      class="task-filter-subchip"
                      data-task-filter-group="contact-status"
                      data-task-filter-value="<%= status.key %>"
                      data-task-filter-parent="contacts:all">
                      <span class="task-filter-subchip__label"><%= status.label %></span>
                      <span class="task-filter-subchip__count"><%= status.count %></span>
                    </button>
                  <% }) %>
                </div>
              <% } else { %>
                <div class="task-filter-sublist is-empty">
                  <span class="text-muted small">No contact tasks yet</span>
                </div>
              <% } %>
            </details>
            <details class="task-filter-collapse" <%= purchaserTaskCount ? 'open' : '' %>>
              <summary class="task-filter-summary">
                <button
                  type="button"
                  class="task-filter-summary-btn"
                  data-task-filter-group="purchasers"
                  data-task-filter-value="all">
                  <span>Purchasers</span>
                  <span class="task-filter-chip__count"><%= purchaserTaskCount %></span>
                </button>
                <button
                  type="button"
                  class="task-filter-toggle"
                  data-task-collapse-toggle
                  aria-label="Toggle purchasers section">
                  <span aria-hidden="true"></span>
                </button>
              </summary>
              <% if (purchaserGroups.length) { %>
                <div class="task-filter-sublist">
                  <% purchaserGroups.forEach((contact) => { %>
                    <button
                      type="button"
                      class="task-filter-subchip"
                      data-task-filter-group="purchaser"
                      data-task-filter-value="<%= contact.key || contact.label %>"
                      data-task-filter-parent="purchasers:all"
                      data-task-filter-label="<%= contact.label %>">
                      <span class="task-filter-subchip__group">
                        <span class="task-filter-subchip__label"><%= contact.label %></span>
                      </span>
                      <span class="task-filter-subchip__count"><%= contact.count %></span>
                    </button>
                  <% }) %>
                </div>
              <% } else { %>
                <div class="task-filter-sublist is-empty">
                  <span class="text-muted small">No purchaser tasks yet</span>
                </div>
              <% } %>
            </details>
            <details class="task-filter-collapse" open>
              <summary class="task-filter-summary">
                <button
                  type="button"
                  class="task-filter-summary-btn"
                  data-task-filter-group="communities"
                  data-task-filter-value="all">
                  <span>My Community</span>
                  <span class="task-filter-chip__count"><%= communityTaskCount %></span>
                </button>
                <button
                  type="button"
                  class="task-filter-toggle"
                  data-task-collapse-toggle
                  aria-label="Toggle communities section">
                  <span aria-hidden="true"></span>
                </button>
              </summary>
              <% if (communityBreakdown.length) { %>
                <div class="task-filter-sublist">
                  <% communityBreakdown.forEach((community) => { %>
                    <button
                      type="button"
                      class="task-filter-subchip"
                      data-task-filter-group="community"
                      data-task-filter-value="<%= community.key || community.label %>"
                      data-task-filter-parent="communities:all"
                      data-task-filter-label="<%= community.label %>">
                      <span class="task-filter-subchip__group">
                        <span class="task-filter-subchip__label"><%= community.label %></span>
                        <% if (community.location) { %>
                          <small class="task-filter-subchip__meta text-muted"><%= community.location %></small>
                        <% } %>
                      </span>
                      <span class="task-filter-subchip__count"><%= community.count %></span>
                    </button>
                  <% }) %>
                </div>
              <% } else { %>
                <div class="task-filter-sublist is-empty">
                  <span class="text-muted small">No assigned communities yet</span>
                </div>
              <% } %>
            </details>
            <details class="task-filter-collapse" open>
              <summary class="task-filter-summary">
                <button
                  type="button"
                  class="task-filter-summary-btn"
                  data-task-filter-group="competitions"
                  data-task-filter-value="all">
                  <span>My Competition</span>
                  <span class="task-filter-chip__count"><%= competitionTaskCount %></span>
                </button>
                <button
                  type="button"
                  class="task-filter-toggle"
                  data-task-collapse-toggle
                  aria-label="Toggle competition section">
                  <span aria-hidden="true"></span>
                </button>
              </summary>
              <% if (competitionCommunities.length) { %>
                <div class="task-filter-sublist">
                  <% competitionCommunities.forEach((group) => { %>
                    <button
                      type="button"
                      class="task-filter-subchip"
                      data-task-filter-group="competition"
                      data-task-filter-value="<%= group.label %>"
                      data-task-filter-parent="competitions:all"
                      data-task-filter-label="<%= group.label %>">
                      <span class="task-filter-subchip__label"><%= group.label %></span>
                      <span class="task-filter-subchip__count"><%= group.count %></span>
                    </button>
                  <% }) %>
                </div>
              <% } else { %>
                <div class="task-filter-sublist is-empty">
                  <span class="text-muted small">No competition tasks yet</span>
                </div>
              <% } %>
            </details>
          </div>
        </div>
      </aside>

      <div class="task-content">
        <section class="card shadow-sm border-0 mb-4 task-summary-card">
          <div class="card-body d-flex flex-wrap gap-4 align-items-center">
            <div>
              <div class="fs-3 fw-semibold" data-summary="due"><%= totalDue %></div>
              <div class="text-muted text-uppercase small">Due Tasks</div>
            </div>
            <div>
              <div class="fs-5 fw-semibold text-danger" data-summary="overdue"><%= overdueCount %></div>
              <div class="text-muted text-uppercase small">Overdue</div>
            </div>
            <div class="ms-auto text-muted small">
              Overview updates automatically after you create or edit a task.
            </div>
          </div>
        </section>

        <section id="task-category-container" class="task-category-container">
          <% if (Array.isArray(taskGroups) && taskGroups.length) { %>
            <div class="task-category-stack">
              <% taskGroups.forEach((group) => { %>
                <% const tasks = Array.isArray(group.tasks) ? group.tasks : []; %>
                <% const categoryLabel = (typeof group.category === 'string' && group.category.trim()) ? group.category : 'Uncategorized'; %>
                <article class="card shadow-sm border-0 task-category-card task-table-card" data-category="<%= categoryLabel %>">
                  <header class="card-header bg-white border-0 pb-0 d-flex flex-wrap align-items-center justify-content-between gap-2">
                    <div>
                      <h2 class="h5 mb-1"><%= categoryLabel %></h2>
                      <p class="text-muted small mb-0"><%= tasks.length %> <%= tasks.length === 1 ? 'task' : 'tasks' %></p>
                    </div>
                    <span class="badge text-bg-primary rounded-pill align-self-start"><%= tasks.length %></span>
                  </header>
                  <div class="card-body pt-0">
                    <div class="task-table" role="table" aria-label="<%= categoryLabel %> tasks">
                      <div class="task-table__row task-table__head" role="row">
                        <div class="task-table__cell task-table__cell--title" role="columnheader">Task</div>
                        <div class="task-table__cell task-table__cell--due" role="columnheader">Due</div>
                        <div class="task-table__cell task-table__cell--priority" role="columnheader">Priority</div>
                        <div class="task-table__cell task-table__cell--status" role="columnheader">Status</div>
                        <div class="task-table__cell task-table__cell--linked" role="columnheader">Linked</div>
                      </div>
                      <div class="task-table__body">
                        <% if (tasks.length) { %>
                          <% tasks.forEach((task) => {
                               const dueDate = task && task.dueDate ? new Date(task.dueDate) : null;
                               const hasValidDueDate = dueDate && !Number.isNaN(dueDate.getTime());
                               const isOverdue = hasValidDueDate && dueDate < startOfToday;
                               const dueLabel = hasValidDueDate
                                 ? dueDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })
                                 : 'No due date';
                               const priority = task && task.priority ? task.priority : '';
                               const statusLabel = task && task.status ? task.status : 'Pending';
                               const title = task && task.title ? task.title : 'Untitled Task';
                               const description = task && task.description ? task.description : '';
                               const linkedName = task && task.linkedName ? task.linkedName : '';
                               const linkedModel = task && task.linkedModel ? task.linkedModel : '';
                          %>
                            <div class="task-table__row <%= isOverdue ? 'is-overdue' : '' %>" role="row">
                              <div class="task-table__cell task-table__cell--title" data-label="Task" role="cell">
                                <div class="task-table__task">
                                  <div class="task-table__task-title" title="<%= title %>"><%= title %></div>
                                  <% if (description) { %>
                                    <div class="task-table__task-desc"><%= description %></div>
                                  <% } %>
                                </div>
                              </div>
                              <div class="task-table__cell task-table__cell--due" data-label="Due" role="cell">
                                <% if (hasValidDueDate) { %>
                                  <span class="task-table__due <%= isOverdue ? 'is-overdue' : '' %>"><%= dueLabel %></span>
                                  <small class="task-table__due-caption <%= isOverdue ? 'text-danger' : 'text-muted' %>">
                                    <%= isOverdue ? 'Overdue' : 'On track' %>
                                  </small>
                                <% } else { %>
                                  <span class="text-muted">No due date</span>
                                <% } %>
                              </div>
                              <div class="task-table__cell task-table__cell--priority" data-label="Priority" role="cell">
                                <% if (priority) { %>
                                  <span class="badge rounded-pill priority-pill priority-<%= priority.toLowerCase() %>"><%= priority %></span>
                                <% } else { %>
                                  <span class="text-muted">None</span>
                                <% } %>
                              </div>
                              <div class="task-table__cell task-table__cell--status" data-label="Status" role="cell">
                                <span class="badge rounded-pill text-bg-light text-uppercase"><%= statusLabel %></span>
                              </div>
                              <div class="task-table__cell task-table__cell--linked" data-label="Linked" role="cell">
                                <% if (linkedName || linkedModel) { %>
                                  <% if (linkedName) { %>
                                    <div class="task-linked-name"><%= linkedName %></div>
                                  <% } %>
                                  <% if (linkedModel) { %>
                                    <small class="task-linked-context text-muted"><%= linkedModel %></small>
                                  <% } %>
                                <% } else { %>
                                  <span class="text-muted">None</span>
                                <% } %>
                              </div>
                            </div>
                          <% }) %>
                        <% } else { %>
                          <div class="task-table__empty text-center">
                            <p class="mb-2">No tasks due in this category.</p>
                            <button type="button" class="btn btn-sm btn-outline-primary task-add-trigger">Add Task</button>
                          </div>
                        <% } %>
                      </div>
                    </div>
                  </div>
                </article>
              <% }) %>
            </div>
          <% } else { %>
            <div class="card shadow-sm border-0 text-center">
              <div class="card-body py-5">
                <h2 class="h5 mb-2">No due tasks</h2>
                <p class="text-muted mb-3">You're all caught up. Add the next follow-up to get started.</p>
                <button type="button" class="btn btn-primary task-add-trigger">Add Task</button>
              </div>
            </div>
          <% } %>
        </section>
      </div>
    </div>
  </main>

  <div id="task-modal" class="task-modal" aria-hidden="true" hidden>
    <div class="task-modal__backdrop" data-task-modal-close></div>
    <div class="task-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
      <header class="task-modal__header">
        <h2 id="task-modal-title">Add Task</h2>
        <button type="button" id="task-modal-close" class="task-modal__close" aria-label="Close task editor">&times;</button>
      </header>
      <form id="task-modal-form" class="task-modal__form" novalidate>
        <div class="task-modal__content">
          <div class="task-modal__row">
            <label for="task-modal-title-input">Title</label>
            <input id="task-modal-title-input" name="title" type="text" maxlength="160" required />
          </div>
          <div class="task-modal__row">
            <span class="task-modal__row-label">Task Type</span>
            <div id="task-type-buttons" class="task-type-group" role="group" aria-label="Task type">
              <button type="button" class="task-type-button is-selected" data-type="Follow-Up" aria-pressed="true">Follow-Up</button>
              <button type="button" class="task-type-button" data-type="Reminder" aria-pressed="false">Reminder</button>
              <button type="button" class="task-type-button" data-type="Document" aria-pressed="false">Document</button>
              <button type="button" class="task-type-button" data-type="Approval" aria-pressed="false">Approval</button>
              <button type="button" class="task-type-button" data-type="Review" aria-pressed="false">Review</button>
              <button type="button" class="task-type-button" data-type="Note" aria-pressed="false">Note</button>
              <button type="button" class="task-type-button" data-type="Custom" aria-pressed="false">Custom</button>
            </div>
            <div id="task-followup-sub" class="task-type-subgroup" hidden aria-hidden="true">
              <span class="task-type-subtitle">Follow-Up via</span>
              <div class="task-type-subbuttons" role="group" aria-label="Follow-up method">
                <button type="button" class="task-type-subbutton is-selected" data-followup="Follow-Up" aria-pressed="true">General</button>
                <button type="button" class="task-type-subbutton" data-followup="Call" aria-pressed="false">Call</button>
                <button type="button" class="task-type-subbutton" data-followup="Email" aria-pressed="false">Email</button>
                <button type="button" class="task-type-subbutton" data-followup="Meeting" aria-pressed="false">Meeting</button>
              </div>
            </div>
          </div>
          <div class="task-modal__grid two-col">
            <div class="task-modal__row">
              <label for="task-modal-category">Category</label>
              <select id="task-modal-category" name="category"></select>
            </div>
            <div class="task-modal__row">
              <label for="task-modal-priority">Priority</label>
              <select id="task-modal-priority" name="priority"></select>
            </div>
          </div>
          <div class="task-modal__grid two-col">
            <div class="task-modal__row">
              <label for="task-modal-due">Due date</label>
              <input id="task-modal-due" name="dueDate" type="date" />
            </div>
            <div class="task-modal__row">
              <label for="task-modal-status">Status</label>
              <select id="task-modal-status" name="status"></select>
            </div>
          </div>
          <div class="task-modal__row">
            <label for="task-modal-notes">Notes</label>
            <textarea id="task-modal-notes" name="description" rows="4" maxlength="2000"></textarea>
          </div>
        </div>
        <p id="task-modal-error" class="task-modal__error" role="alert" hidden></p>
        <div class="task-modal__actions">
          <div class="task-modal__actions-left">
            <button type="button" id="task-modal-complete" class="task-modal__secondary" hidden>Mark as Completed</button>
          </div>
          <div class="task-modal__actions-right">
            <button type="button" id="task-modal-cancel" class="task-modal__secondary">Cancel</button>
            <button type="submit" id="task-modal-save" class="task-modal__primary">Save Task</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script id="__TASK_PAGE_DATA__" type="application/json">
  <%- JSON.stringify({
    groups: taskGroups || [],
    meta: taskMeta || { categories: [], statuses: [], priorities: [], types: [] },
    currentUserId: (typeof user === 'object' && user && user._id) ? String(user._id) : '',
    purchasers: purchaserContacts || [],
    endpoints: {
      overview: '/api/tasks/overview',
      create: '/api/tasks',
      update: '/api/tasks'
    }
  }).replace(/</g, '\\u003c') %>
  </script>
  <script type="module" src="/assets/js/task/index.js"></script>
</body>
</html>
