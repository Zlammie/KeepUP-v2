<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Planner</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/main.css" />
</head>
<body>
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-contacts') %>

  <main class="container py-4 task-page">
    <div class="d-flex flex-wrap align-items-start justify-content-between gap-3 mb-4">
      <div>
        <h1 class="h2 mb-1">Tasks Due</h1>
        <p class="text-muted mb-0">
          Stay ahead on follow-ups across teams. Due and overdue items are grouped by category.
        </p>
      </div>
      <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-outline-secondary" id="task-refresh">Refresh</button>
        <button type="button" class="btn btn-primary task-add-trigger" id="task-add">Add Task</button>
      </div>
    </div>

    <% const startOfToday = new Date(); startOfToday.setHours(0, 0, 0, 0); %>
    <% const totalDue = Array.isArray(taskGroups) ? taskGroups.reduce((sum, group) => sum + (Array.isArray(group.tasks) ? group.tasks.length : 0), 0) : 0; %>
    <% const overdueCount = Array.isArray(taskGroups) ? taskGroups.reduce((sum, group) => {
         if (!Array.isArray(group.tasks)) return sum;
         return sum + group.tasks.filter((task) => {
           if (!task || !task.dueDate) return false;
           const due = new Date(task.dueDate);
           return !Number.isNaN(due.getTime()) && due < startOfToday;
         }).length;
       }, 0) : 0;
    %>

    <section class="card shadow-sm border-0 mb-4 task-summary-card">
      <div class="card-body d-flex flex-wrap gap-4 align-items-center">
        <div>
          <div class="fs-3 fw-semibold" data-summary="due"><%= totalDue %></div>
          <div class="text-muted text-uppercase small">Due Tasks</div>
        </div>
        <div>
          <div class="fs-5 fw-semibold text-danger" data-summary="overdue"><%= overdueCount %></div>
          <div class="text-muted text-uppercase small">Overdue</div>
        </div>
        <div class="ms-auto text-muted small">
          Overview updates automatically after you create or edit a task.
        </div>
      </div>
    </section>

    <section id="task-category-container" class="task-category-container">
      <% if (Array.isArray(taskGroups) && taskGroups.length) { %>
        <div class="row g-3">
          <% taskGroups.forEach((group) => { %>
            <% const tasks = Array.isArray(group.tasks) ? group.tasks : []; %>
            <div class="col-12 col-lg-6">
              <article class="card shadow-sm border-0 h-100 task-category-card" data-category="<%= group.category %>">
                <header class="card-header bg-white border-0 pb-0 d-flex align-items-start justify-content-between">
                  <div>
                    <h2 class="h5 mb-1"><%= group.category %></h2>
                    <p class="text-muted small mb-0"><%= tasks.length %> due</p>
                  </div>
                  <span class="badge text-bg-primary rounded-pill align-self-start"><%= tasks.length %></span>
                </header>
                <ul class="list-group list-group-flush mt-3">
                  <% tasks.forEach((task) => {
                       const dueDate = task && task.dueDate ? new Date(task.dueDate) : null;
                       const hasValidDueDate = dueDate && !Number.isNaN(dueDate.getTime());
                       const isOverdue = hasValidDueDate && dueDate < startOfToday;
                       const dueLabel = hasValidDueDate
                         ? dueDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })
                         : 'No due date';
                       const priority = task && task.priority ? task.priority : '';
                       const statusLabel = task && task.status ? task.status : 'Pending';
                       const title = task && task.title ? task.title : 'Untitled Task';
                       const description = task && task.description ? task.description : '';
                       const hasLinkedContact = task && task.linkedModel === 'Contact' && task.linkedId;
                  %>
                    <li class="list-group-item d-flex justify-content-between align-items-start gap-3">
                      <div class="flex-grow-1">
                        <div class="fw-semibold text-truncate" title="<%= title %>"><%= title %></div>
                        <% if (description) { %>
                          <p class="text-muted small mb-1"><%= description %></p>
                        <% } %>
                        <div class="d-flex flex-wrap align-items-center gap-2 small text-muted">
                          <span class="badge rounded-pill text-bg-light text-uppercase"><%= statusLabel %></span>
                          <% if (priority) { %>
                            <span class="badge rounded-pill priority-pill priority-<%= priority.toLowerCase() %>"><%= priority %></span>
                          <% } %>
                          <% if (hasLinkedContact) { %>
                            <span class="badge rounded-pill text-bg-secondary">Linked Contact</span>
                          <% } %>
                        </div>
                      </div>
                      <div class="text-end flex-shrink-0">
                        <% if (hasValidDueDate) { %>
                          <div class="small <%= isOverdue ? 'text-danger fw-semibold' : 'text-muted' %>">
                            <%= isOverdue ? 'Overdue' : 'Due' %> <span><%= dueLabel %></span>
                          </div>
                        <% } else { %>
                          <div class="small text-muted">No due date</div>
                        <% } %>
                      </div>
                    </li>
                  <% }) %>
                </ul>
              </article>
            </div>
          <% }) %>
        </div>
      <% } else { %>
        <div class="card shadow-sm border-0 text-center">
          <div class="card-body py-5">
            <h2 class="h5 mb-2">No due tasks</h2>
            <p class="text-muted mb-3">You're all caught up. Add the next follow-up to get started.</p>
            <button type="button" class="btn btn-primary task-add-trigger">Add Task</button>
          </div>
        </div>
      <% } %>
    </section>
  </main>

  <div id="task-modal" class="task-modal" aria-hidden="true" hidden>
    <div class="task-modal__backdrop" data-task-modal-close></div>
    <div class="task-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
      <header class="task-modal__header">
        <h2 id="task-modal-title">Add Task</h2>
        <button type="button" id="task-modal-close" class="task-modal__close" aria-label="Close task editor">&times;</button>
      </header>
      <form id="task-modal-form" class="task-modal__form" novalidate>
        <div class="task-modal__content">
          <div class="task-modal__row">
            <label for="task-modal-title-input">Title</label>
            <input id="task-modal-title-input" name="title" type="text" maxlength="160" required />
          </div>
          <div class="task-modal__row">
            <span class="task-modal__row-label">Task Type</span>
            <div id="task-type-buttons" class="task-type-group" role="group" aria-label="Task type">
              <button type="button" class="task-type-button is-selected" data-type="Follow-Up" aria-pressed="true">Follow-Up</button>
              <button type="button" class="task-type-button" data-type="Reminder" aria-pressed="false">Reminder</button>
              <button type="button" class="task-type-button" data-type="Document" aria-pressed="false">Document</button>
              <button type="button" class="task-type-button" data-type="Approval" aria-pressed="false">Approval</button>
              <button type="button" class="task-type-button" data-type="Review" aria-pressed="false">Review</button>
              <button type="button" class="task-type-button" data-type="Note" aria-pressed="false">Note</button>
              <button type="button" class="task-type-button" data-type="Custom" aria-pressed="false">Custom</button>
            </div>
            <div id="task-followup-sub" class="task-type-subgroup" hidden aria-hidden="true">
              <span class="task-type-subtitle">Follow-Up via</span>
              <div class="task-type-subbuttons" role="group" aria-label="Follow-up method">
                <button type="button" class="task-type-subbutton is-selected" data-followup="Follow-Up" aria-pressed="true">General</button>
                <button type="button" class="task-type-subbutton" data-followup="Call" aria-pressed="false">Call</button>
                <button type="button" class="task-type-subbutton" data-followup="Email" aria-pressed="false">Email</button>
                <button type="button" class="task-type-subbutton" data-followup="Meeting" aria-pressed="false">Meeting</button>
              </div>
            </div>
          </div>
          <div class="task-modal__grid two-col">
            <div class="task-modal__row">
              <label for="task-modal-category">Category</label>
              <select id="task-modal-category" name="category"></select>
            </div>
            <div class="task-modal__row">
              <label for="task-modal-priority">Priority</label>
              <select id="task-modal-priority" name="priority"></select>
            </div>
          </div>
          <div class="task-modal__grid two-col">
            <div class="task-modal__row">
              <label for="task-modal-due">Due date</label>
              <input id="task-modal-due" name="dueDate" type="date" />
            </div>
            <div class="task-modal__row">
              <label for="task-modal-status">Status</label>
              <select id="task-modal-status" name="status"></select>
            </div>
          </div>
          <div class="task-modal__row">
            <label for="task-modal-notes">Notes</label>
            <textarea id="task-modal-notes" name="description" rows="4" maxlength="2000"></textarea>
          </div>
        </div>
        <p id="task-modal-error" class="task-modal__error" role="alert" hidden></p>
        <div class="task-modal__actions">
          <div class="task-modal__actions-left">
            <button type="button" id="task-modal-complete" class="task-modal__secondary" hidden>Mark as Completed</button>
          </div>
          <div class="task-modal__actions-right">
            <button type="button" id="task-modal-cancel" class="task-modal__secondary">Cancel</button>
            <button type="submit" id="task-modal-save" class="task-modal__primary">Save Task</button>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script id="__TASK_PAGE_DATA__" type="application/json">
  <%- JSON.stringify({
    groups: taskGroups || [],
    meta: taskMeta || { categories: [], statuses: [], priorities: [], types: [] },
    currentUserId: (typeof user === 'object' && user && user._id) ? String(user._id) : '',
    endpoints: {
      overview: '/api/tasks/overview',
      create: '/api/tasks',
      update: '/api/tasks'
    }
  }).replace(/</g, '\\u003c') %>
  </script>
  <script type="module" src="/assets/js/task/index.js"></script>
</body>
</html>
