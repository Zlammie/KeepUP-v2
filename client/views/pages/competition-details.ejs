<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Competition Details</title>

  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/pages/competition-shared.css">
  <link rel="stylesheet" href="/assets/css/pages/competition-details.css">
  
</head>
<body>
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-competition') %>

  <main>
  

    <div class="horizontal-cont competition-details-layout">

      <!-- Editable sections (clean, grouped) -->
      <div class="side-bar card card--grey main-cont">

        <!-- Sales -->
        <section class="card card--white card--margin-bottom">
            <a href="/update-competition/<%= competition._id %>" class="btn btn-primary btn-sm mb-2">
              Update Monthly Info
            </a>
          <h2>Sales Person Info</h2>
          <div class="form-group">
            <label for="salesPerson">Sales Person</label>
            <input type="text" id="salesPerson" name="salesPerson" value="<%= competition.salesPerson || '' %>">
          </div>
          <div class="form-group">
            <label for="salesPersonPhone">Sales Person Phone #</label>
            <input type="text" id="salesPersonPhone" name="salesPersonPhone" value="<%= formatPhone(competition.salesPersonPhone || '') %>">
          </div>
          <div class="form-group">
            <label for="salesPersonEmail">Sales Person Email</label>
            <input type="email" id="salesPersonEmail" name="salesPersonEmail" value="<%= competition.salesPersonEmail || '' %>">
          </div>
        </section>

        <!-- Builder -->
        <section class="card card--white card--margin-bottom">
          <h2>Builder Info</h2>
          <div class="form-group">
            <label for="address">Address</label>
            <input type="text" id="address" name="address" value="<%= competition.address || '' %>">
          </div>
          <div class="form-group">
            <label for="city">City</label>
            <input type="text" id="city" name="city" value="<%= competition.city || '' %>">
          </div>
          <div class="form-group">
            <label for="zip">ZIP</label>
            <input type="text" id="zip" name="zip" value="<%= competition.zip || '' %>">
          </div>
          <div class="form-group">
            <label for="modelPlan">Model Floor Plan</label>
            <select id="modelPlan" name="modelPlan">
              <option value="">-- Select a floor plan --</option>
              <% if (floorPlans && floorPlans.length) { %>
                <% floorPlans.forEach(plan => { %>
                  <option value="<%= plan %>" <%= competition.modelPlan === plan ? 'selected' : '' %>><%= plan %></option>
                <% }) %>
              <% } else { %>
                <option disabled>No floor plans found</option>
              <% } %>
            </select>
          </div>
          <div class="form-group">
            <label for="lotSize">Lot Size</label>
            <input type="text" id="lotSize" name="lotSize" value="<%= competition.lotSize || '' %>">
          </div>

          <!-- Radios instead of checkboxes -->
          <% const garageTypeLower = String(competition.garageType || '').trim().toLowerCase(); %>
          <fieldset class="form-group">
            <legend>Garage Type</legend>
            <label><input type="radio" name="garageType" value="Front" <%= garageTypeLower === 'front' ? 'checked' : '' %>> Front</label>
            <label><input type="radio" name="garageType" value="Rear"  <%= garageTypeLower === 'rear'  ? 'checked' : '' %>> Rear</label>
          </fieldset>

          <div class="form-group">
            <label for="totalLots">Total Lots</label>
            <input type="number" id="totalLots" name="totalLots" value="<%= competition.totalLots || '' %>">
          </div>
        </section>

        <!-- Schools -->
        <section class="card card--white card--margin-bottom">
          <h2>School Info</h2>
          <div class="form-group">
            <label for="schoolISD">School ISD</label>
            <input type="text" id="schoolISD" name="schoolISD" value="<%= competition.schoolISD || '' %>">
          </div>
          <div class="form-group">
            <label for="elementarySchool">Elementary School</label>
            <input type="text" id="elementarySchool" name="elementarySchool" value="<%= competition.elementarySchool || '' %>">
          </div>
          <div class="form-group">
            <label for="middleSchool">Middle School</label>
            <input type="text" id="middleSchool" name="middleSchool" value="<%= competition.middleSchool || '' %>">
          </div>
          <div class="form-group">
            <label for="highSchool">High School</label>
            <input type="text" id="highSchool" name="highSchool" value="<%= competition.highSchool || '' %>">
          </div>
        </section>

        <!-- Community -->
        <section class="card card--white">
          <h2>Community Info</h2>

          <div class="form-group">
            <label for="hoaFee">HOA Fee</label>
            <input type="number" id="hoaFee" name="hoaFee" value="<%= competition.hoaFee || '' %>">
          </div>

          <div class="form-group">
            <label for="hoaFrequency">HOA Frequency</label>
            <select id="hoaFrequency" name="hoaFrequency">
              <option value="">-- Select Frequency --</option>
              <option value="Monthly"     <%= competition.hoaFrequency === 'Monthly' ? 'selected' : '' %>>Monthly</option>
              <option value="Bi-Annually" <%= competition.hoaFrequency === 'Bi-Annually' ? 'selected' : '' %>>Bi-Annually</option>
              <option value="Annually"    <%= competition.hoaFrequency === 'Annually' ? 'selected' : '' %>>Annually</option>
            </select>
          </div>

          <div class="form-group">
            <label for="tax">Annual Tax (%)</label>
            <input type="number" id="tax" name="tax" step="0.01" value="<%= competition.tax || '' %>">
          </div>

      <!-- Fee types (MUD/PID/None) -->
          <div class="form-group">
            <label>Additional Fees</label><br>

            <!-- MUD -->
            <div class="fee-option">
              <label>
                <input type="checkbox" id="feeMud" name="feeTypes" value="MUD"
                  <%= competition.feeTypes?.includes('MUD') ? 'checked' : '' %> />
                MUD
              </label>
              <div id="mudFeeGroup" style="display:none; margin-left:1.5rem;">
                <label for="mudFee" style="display:block;">MUD Fee</label>
                <input type="number" id="mudFee" name="mudFee" value="<%= competition.mudFee || '' %>" />
              </div>
            </div>

            <!-- PID -->
            <div class="fee-option">
              <label>
                <input type="checkbox" id="feePid" name="feeTypes" value="PID"
                  <%= competition.feeTypes?.includes('PID') ? 'checked' : '' %> />
                PID
              </label>
              <div id="pidFeeGroup" style="display:none; margin-left:1.5rem;">
                <div class="fee-inline">
                  <div class="fee-field">
                    <label for="pidFee" style="display:block;">PID Fee</label>
                    <input type="number" id="pidFee" name="pidFee" value="<%= competition.pidFee || '' %>" />
                  </div>
                  <div class="fee-field">
                    <label for="pidFeeFrequency" style="display:block;">Frequency</label>
                    <select id="pidFeeFrequency" name="pidFeeFrequency">
                      <option value="">— Select —</option>
                      <option value="Monthly" <%= competition.pidFeeFrequency === 'Monthly' ? 'selected' : '' %>>Monthly</option>
                      <option value="Yearly"  <%= competition.pidFeeFrequency === 'Yearly'  ? 'selected' : '' %>>Yearly</option>
                    </select>
        </div>

            <!-- None -->
            <div class="fee-option">
              <label>
                <input type="checkbox" id="feeNone" name="feeTypes" value="None"
                  <%= competition.feeTypes?.includes('None') ? 'checked' : '' %> />
                None
              </label>
            </div>
          </div> <!-- ← CLOSES .form-group -->

          <button id="openAmenitiesBtn" class="btn btn-sm btn-primary" style="margin-left:.5rem;">
            Edit Amenities
          </button>
        </section>
      </div>
      <div class="top-content-cont card card--grey top-container">
        <div class="top-card-grid">

          <!-- ROW 1 -->
          <div class="title-and-amenities">
            <h1 class="builder-title">
              <% if (competition.builderWebsite) { %>
                <a href="<%= competition.builderWebsite %>" target="_blank" rel="noopener noreferrer">
                  <%= competition.builderName %>
                </a>
              <% } else { %>
                <%= competition.builderName %>
              <% } %> – <%= competition.communityName %>
            </h1>
            <% if (competition.communityAmenities && competition.communityAmenities.length > 0) { %>
              <ul class="amenity-chiplist">
                <% competition.communityAmenities.forEach(group => { %>
                  <% (group.items || []).forEach(item => { %>
                    <li class="chip"><%= item %></li>
                  <% }) %>
                <% }) %>
              </ul>
            <% } else { %>
              <p class="muted">No amenities selected.</p>
            <% } %>
          </div>

          <ul class="lot-stats">
            <li class="lot-stat">
              <span class="stat-label">Total Lots</span>
              <span class="stat-value" id="statTotalLots"><%= competition.totalLots ?? 'N/A' %></span>
            </li>
            <li class="lot-stat">
              <span class="stat-label">Lots Sold</span>
              <span class="stat-value" id="statLotsSold">N/A</span>
            </li>
            <li class="lot-stat">
              <span class="stat-label">Remaining</span>
              <span class="stat-value" id="statLotsRemaining">N/A</span>
            </li>
            <li class="lot-stat">
              <span class="stat-label">QMI</span>
              <span class="stat-value" id="statQmiAvailable">N/A</span>
            </li>
          </ul>

          <nav class="span-full section-nav-wrap">
            <ul id="sectionNav" class="nav folder-tabs">
              <li class="nav-item">
                <a class="nav-link active" href="#" data-section="overview">Promo & HOA</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" data-section="graphs">Graphs</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" data-section="qmi">QMI vs Sold</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#" data-section="competitors">Linked Competitors</a>
              </li>
            </ul>
          </nav>

          <div class="span-full section-panels">
            <section class="section-pane" data-section-content="overview">
              <section class="section-box span-full card card--white promo-pros-wrap">
                <div class="section-block">
                  <div class="section-box__header">
                    <h4>Promotion & HOA</h4>
                  </div>
                  <div class="promo-hoa-row">
                    <div class="promo">
                      <p id="promoText"><%= (competition.promotion && competition.promotion.trim())
                        ? competition.promotion : 'No promotion recorded.' %></p>
                    </div>
                    <div class="hoa-tax">
                      <div class="kv"><span class="k">HOA</span><span class="v">
                        <% if (competition.hoaFee && competition.hoaFrequency) { %>
                          $<%= competition.hoaFee %> / <%= competition.hoaFrequency %>
                        <% } else { %>Not specified<% } %>
                      </span></div>
                      <div class="kv"><span class="k">Tax Rate</span>
                        <span class="v"><%= competition.tax ? competition.tax + '%' : 'Not specified' %></span>
                      </div>
                      <div class="kv"><span class="k">PID</span>
                      <span class="v">
                        <% if (competition.pidFee) { %>
                          $<%= competition.pidFee %><%= competition.pidFeeFrequency ? ' / ' + competition.pidFeeFrequency : '' %>
                        <% } else { %>Not specified<% } %>
                      </span>
                    </div>
                    </div>
                    
                  </div>
                </div>

                <div class="section-block">
                  <div class="section-box__header">
                    <h4>Pros & Cons</h4>
                  </div>

                  <div id="prosConsContent" class="proscons-grid">
                    <div>
                      <h5>Pros</h5>
                      <% if (competition.pros && competition.pros.length) { %>
                        <ul><% competition.pros.forEach(p => { %><li><%= p %></li><% }) %></ul>
                      <% } else { %><p class="muted">N/A</p><% } %>
                    </div>
                    <div>
                      <h5>Cons</h5>
                      <% if (competition.cons && competition.cons.length) { %>
                        <ul><% competition.cons.forEach(c => { %><li><%= c %></li><% }) %></ul>
                      <% } else { %><p class="muted">N/A</p><% } %>
                    </div>
                  </div>
                </div>
              </section>
            </section>

            <section class="section-pane is-hidden" data-section-content="graphs">
              <section class="section-box span-full card card--white" id="graphsSection">
                <div class="section-box__header graphs-header">
                  <h4 class="graphs-title">Performance Graphs</h4>

                  <div class="tab-nav" role="tablist" aria-label="Graph selector">
                    <button class="tab-btn is-active" data-tab="sales" role="tab" aria-selected="true">Sales</button>
                    <button class="tab-btn" data-tab="sqft" role="tab" aria-selected="false">Sqft Comparison</button>
                    <button class="tab-btn" data-tab="base" role="tab" aria-selected="false">Base Price</button>
                    <button class="tab-btn" data-tab="qmi" role="tab" aria-selected="false">QMI / Solds</button>
                  </div>
                </div>

                <div id="graphMount" class="graph-mount" role="region" aria-live="polite" aria-busy="false"></div>
              </section>
            </section>

            <section class="section-pane is-hidden" data-section-content="qmi">
              <section class="section-box span-full card card--white" id="qmiSoldSection">
                <div class="section-box__header">
                  <h4>QMI vs Sold Tables</h4>
                  <small class="text-muted">Recent recorded homes</small>
                </div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="card card--white p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between mb-2">
                        <h5 class="mb-0">Quick Move-In Homes</h5>
                      </div>
                      <div class="table-responsive">
                        <table class="table table-sm table-striped" id="qmiTable">
                          <thead>
                            <tr>
                              <th scope="col">Month</th>
                              <th scope="col">Address</th>
                              <th scope="col">Plan</th>
                              <th scope="col">Sqft</th>
                              <th scope="col">List Price</th>
                            </tr>
                          </thead>
                          <tbody id="qmiTableBody">
                            <tr>
                              <td colspan="5" class="text-muted">Loading quick move-in homes…</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="card card--white p-3 h-100">
                      <div class="d-flex align-items-center justify-content-between mb-2">
                        <h5 class="mb-0">Sold Homes</h5>
                      </div>
                      <div class="table-responsive">
                        <table class="table table-sm table-striped" id="soldTable">
                          <thead>
                            <tr>
                              <th scope="col">Month</th>
                              <th scope="col">Address</th>
                              <th scope="col">Plan</th>
                              <th scope="col">Sqft</th>
                              <th scope="col">Sold Price</th>
                            </tr>
                          </thead>
                          <tbody id="soldTableBody">
                            <tr>
                              <td colspan="5" class="text-muted">Loading sold homes…</td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </section>

            <section class="section-pane is-hidden" data-section-content="competitors">
              <section class="section-box span-full card card--white" id="linkedCompetitorsSection">
                <div class="section-box__header">
                  <h4>Linked Competitors</h4>
                </div>
                <% const linked = competition.linkedCompetitions || []; %>
                <% if (linked.length) { %>
                  <ul class="list-group">
                    <% linked.forEach((c) => { %>
                      <li class="list-group-item d-flex justify-content-between align-items-start">
                        <div>
                          <div class="fw-semibold"><%= c.builderName || 'Unknown builder' %></div>
                          <div class="text-muted"><%= c.communityName || 'Unnamed community' %></div>
                        </div>
                        <span class="badge bg-secondary"><%= c.city || '' %></span>
                      </li>
                    <% }) %>
                  </ul>
                <% } else { %>
                  <p class="text-muted mb-0">No competitors linked.</p>
                <% } %>
              </section>
            </section>
          </div>

        </div>
      </div>
      <div class="task-bar-outside">
        <div class="card card--white task-panel-card">
          <div
            id="todo-panel"
            class="todo-panel"
            aria-live="polite"
            data-default-title="Follow up on <%= competition.builderName %> &ndash; <%= competition.communityName %>"
          >
            <header class="todo-header">
              <button id="todo-toggle" class="todo-toggle" type="button" aria-expanded="true">
                <span class="todo-toggle-icon" aria-hidden="true">&#9662;</span>
                <span class="todo-toggle-text">Tasks</span>
                <span id="todo-count" class="todo-count">0</span>
              </button>
              <button id="todo-add" class="todo-add-btn" type="button">
                <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
                <span>Add Task</span>
              </button>
            </header>

            <section id="todo-panel-body" class="todo-body">
              <div class="todo-summary">
                <button type="button" class="todo-pill is-active" data-filter="all">
                  <span class="pill-label">All</span>
                  <span class="pill-count" aria-hidden="true">0</span>
                </button>
                <button type="button" class="todo-pill" data-filter="Pending">
                  <span class="pill-label">Pending</span>
                  <span class="pill-count" aria-hidden="true">0</span>
                </button>
                <button type="button" class="todo-pill" data-filter="Completed">
                  <span class="pill-label">Completed</span>
                  <span class="pill-count" aria-hidden="true">0</span>
                </button>
              </div>

              <div class="todo-helper">
                <p class="todo-helper-title">Keep this competition current</p>
                <p class="todo-helper-body">
                  Track follow-ups and reminders tied to this competition profile.
                </p>
              </div>

              <ul id="todo-list" class="todo-list">
                <li class="todo-empty">
                  <div class="todo-empty-state">
                    <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
                    <p class="todo-empty-text">Loading tasks for this competition…</p>
                  </div>
                </li>
              </ul>
              <footer class="todo-footer">
                <button id="todo-view-all" class="todo-view-all-btn" type="button">View All Tasks</button>
              </footer>
            </section>
          </div>
        </div>
      </div>
      
    </div>
   
   
  </main>

  <!-- Amenities Modal (JS populates content) -->
  <div id="amenitiesModal" class="modal" style="display:none;">
    <div class="modal-content">
      <span class="close" id="closeAmenitiesModal">&times;</span>
      <h2>Select Community Amenities</h2>
      <form id="amenitiesForm">
        <div id="amenitiesContainer"></div>
        <button type="submit" class="btn btn-primary">Save Amenities</button>
      </form>
    </div>
  </div>

  <!-- Bootstrap data without executing JS -->
<!-- Bootstrap data without executing JS -->
<%
  const lastMonthly = (competition.monthlyMetrics || []).slice(-1)[0] || {};
  const lotCounts = {
    soldLots: competition.soldLots ?? lastMonthly.soldLots ?? null,
    quickMoveInLots: competition.quickMoveInLots ?? lastMonthly.quickMoveInLots ?? null
  };
%>
<script id="__COMPETITION_DATA__" type="application/json">
<%- JSON.stringify({
  id: competition._id,
  totalLots: competition.totalLots ?? 0,
  soldLots: lotCounts.soldLots,
  quickMoveInLots: lotCounts.quickMoveInLots,
  monthlyMetrics: competition.monthlyMetrics || [],
  communityAmenities: competition.communityAmenities || [],
  pros: competition.pros || [],
  cons: competition.cons || [],
  promotion: competition.promotion || '',
  builderName: competition.builderName || '',
  communityName: competition.communityName || '',
  linkedCompetitions: competition.linkedCompetitions || []
}).replace(/</g, '\\u003c') %>
</script>


<!-- Entry script as an ES module -->
 <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script type="module" src="/assets/js/pages/competition-details/index.js"></script>

  <!-- Task modal used by task panel -->
  <div id="task-modal" class="task-modal" aria-hidden="true" hidden>
    <div class="task-modal__backdrop" data-task-modal-close></div>
    <div class="task-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
      <header class="task-modal__header">
        <h2 id="task-modal-title">Edit Task</h2>
        <button type="button" id="task-modal-close" class="task-modal__close" aria-label="Close task editor">&times;</button>
      </header>
      <form id="task-modal-form" class="task-modal__form" novalidate>
        <div class="task-modal__content">
          <div class="task-modal__row">
            <label for="task-modal-title-input">Title</label>
            <input id="task-modal-title-input" name="title" type="text" maxlength="160" required />
          </div>
          <div class="task-modal__row">
            <span class="task-modal__row-label">Task Type</span>
            <div id="task-type-buttons" class="task-type-group" role="group" aria-label="Task type">
              <button type="button" class="task-type-button is-selected" data-type="Follow-Up" aria-pressed="true">Follow-Up</button>
              <button type="button" class="task-type-button" data-type="Reminder" aria-pressed="false">Reminder</button>
              <button type="button" class="task-type-button" data-type="Document" aria-pressed="false">Document</button>
              <button type="button" class="task-type-button" data-type="Approval" aria-pressed="false">Approval</button>
              <button type="button" class="task-type-button" data-type="Review" aria-pressed="false">Review</button>
              <button type="button" class="task-type-button" data-type="Note" aria-pressed="false">Note</button>
              <button type="button" class="task-type-button" data-type="Custom" aria-pressed="false">Custom</button>
            </div>
            <div id="task-followup-sub" class="task-type-subgroup" hidden aria-hidden="true">
              <span class="task-type-subtitle">Follow-Up via</span>
              <div class="task-type-subbuttons" role="group" aria-label="Follow-up method">
                <button type="button" class="task-type-subbutton is-selected" data-followup="Follow-Up" aria-pressed="true">General</button>
                <button type="button" class="task-type-subbutton" data-followup="Call" aria-pressed="false">Call</button>
                <button type="button" class="task-type-subbutton" data-followup="Email" aria-pressed="false">Email</button>
                <button type="button" class="task-type-subbutton" data-followup="Meeting" aria-pressed="false">Meeting</button>
              </div>
            </div>
          </div>
          <div class="task-modal__grid two-col">
            <div class="task-modal__row">
              <label for="task-modal-due">Due date</label>
              <input id="task-modal-due" name="dueDate" type="date" />
            </div>
            <div class="task-modal__row">
              <label for="task-modal-priority">Priority</label>
              <select id="task-modal-priority" name="priority"></select>
            </div>
          </div>
          <div class="task-modal__grid two-col">
            <div class="task-modal__row">
              <label for="task-modal-status">Status</label>
              <select id="task-modal-status" name="status"></select>
            </div>
          </div>
          <div class="task-modal__row">
            <label for="task-modal-notes">Notes</label>
            <textarea id="task-modal-notes" name="description" rows="4" maxlength="2000"></textarea>
          </div>
        </div>
        <p id="task-modal-error" class="task-modal__error" role="alert" hidden></p>
        <div class="task-modal__actions">
          <div class="task-modal__actions-left">
            <button type="button" id="task-modal-complete" class="task-modal__secondary">Mark as Completed</button>
          </div>
          <div class="task-modal__actions-right">
            <button type="button" id="task-modal-cancel" class="task-modal__secondary">Cancel</button>
            <button type="submit" id="task-modal-save" class="task-modal__primary">Save Changes</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
