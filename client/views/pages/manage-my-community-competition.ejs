<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Manage My Community Competition</title>

  <!-- keep the same libs as update-competition so styles match -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/assets/css/main.css">
</head>

<body data-community-id="<%= (communityId || '') %>">
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-competition') %>

  <div class="horizontal-cont">
    <!-- ============ LEFT SIDEBAR ============ -->
    <div class="side-bar card card--grey main-cont">
<%
// Make sure these locals exist even if the route forgot to pass them:
var profile   = (typeof profile   !== 'undefined' && profile)   ? profile   : null;
var community = (typeof community !== 'undefined' && community) ? community : null;

// Now your display vars (robust to field name differences)
const commName = community
  ? (community.communityName || community.name || community.title || 'Unnamed Community')
  : 'Unnamed Community';

const builderName = community
  ? (community.builderName || community.builder || '—')
  : '—';

const addr = (profile && profile.address) || (community && community.address) || '—';
const city = (profile && profile.city)    || (community && community.city)    || '—';
const zip  = (profile && profile.zip)     || (community && community.zip)     || '';
%>

      <!-- Community Info -->
    <div class="card card--white mb-3">
        <div class="card-header">Community Info</div>
        <div class="card-body">
          <h5 class="card-title"><%= commName %></h5>
          <p class="card-text">
            Builder: <strong><%= builderName %></strong><br/>
          </p>
          <a class="btn btn-sm btn-outline-secondary"
            href="/view-lots?communityId=<%= communityId %>">View Lots</a>
        </div>
      </div>

     <button 
        id="openPlanModal"
        type="button"
        class="btn btn-secondary mb-3"
        data-bs-toggle="modal"
        data-bs-target="#floorPlanModal"
      >
        Add / Update Floor Plans
      </button>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" nonce="<%= cspNonce %>"></script>
      <!-- Floor Plans Modal -->
      <div
        class="modal fade"
        id="floorPlanModal"
        tabindex="-1"
        aria-labelledby="floorPlanModalLabel"
        aria-hidden="true"
      >
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <form id="floorPlanForm">
              <div class="modal-header">
                <h5 class="modal-title" id="floorPlanModalLabel">
                  Floor Plans
                </h5>
                <button
                  type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"
                ></button>
              </div>
              <div class="modal-body">
                <!-- existing floor plans list -->
                <div id="floorPlanList" class="list-group mb-4"></div>

                <!-- floor plan form fields -->
                <input type="hidden" id="fpId" name="id" />
                <div class="mb-3">
                  <label for="fpName" class="form-label">Floor Plan Name</label>
                  <input
                    type="text"
                    id="fpName"
                    name="name"
                    class="form-control"
                    required
                  />
                </div>
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label for="fpSqft" class="form-label">Sqft</label>
                    <input
                      type="number"
                      id="fpSqft"
                      name="sqft"
                      class="form-control"
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="fpBed" class="form-label">Bed</label>
                    <input
                      type="number"
                      id="fpBed"
                      name="bed"
                      class="form-control"
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="fpBath" class="form-label">Bath</label>
                    <input
                      type="number"
                      id="fpBath"
                      name="bath"
                      class="form-control"
                      step="any"
                      min="0"  
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="fpGarage" class="form-label">Garage</label>
                    <input
                      type="number"
                      id="fpGarage"
                      name="garage"
                      class="form-control"
                    />
                  </div>
                  <div class="col-md-4 mb-3">
                    <label for="fpStory" class="form-label">Story Type</label>
                    <select
                      id="fpStory"
                      name="storyType"
                      class="form-select"
                      required
                    >
                      <option value="Single">Single Story</option>
                      <option value="Two">Two Story</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="submit" class="btn btn-primary">
                  Save Floor Plan
                </button>
                <button
                  type="button"
                  class="btn btn-secondary"
                  data-bs-dismiss="modal"
                >
                  Close
                </button>
              </div>
            </form>
          </div>
        </div>
      </div> 
      <div class="card card--white">
        <h2>To Do List for June</h2>
        <ul>
          <li>Check Changes in Floor Plans</li>
          <li>Update Base Pricing for June</li>
          <li>Add New Quick Move-In Homes</li>
          <li>Mark Sold Quick Move-Ins</li>
          <li>Add Other Solds If applicable</li>
          <li>Check Lot Cout</li>
          <li>Check Quick Move Count</li>
          <li>Add Sales, Cans, Closings</li>
        </ul>
      </div> 
  </div>
   <main class="container mt-4">
    
           <nav class="month-nav-container mt-3">
            <div class="d-flex overflow-auto">
             <ul id="monthNav" class="nav nav-pills flex-nowrap mb-3"></ul>
            </div>
                <!-- ───────── section tabs ───────── -->
              <ul id="sectionNav" class="nav nav-tabs mt-3">
                 <li class="nav-item">
                    <a class="nav-link active" href="#" data-section="metrics">Metrics</a>
                  </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-section="price">Floor Plans</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-section="inventory">Inventory</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-section="sales">Sales</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="#" data-section="notes">Notes</a>
                </li>
              </ul>
            </nav>
            <!-- ───────── Metrics Section ───────── -->
            <div class="section d-none" data-section-content="metrics">
              <h3 class="mt-5">Community Metrics</h3>
              <div class="container mt-3">
                <form id="metricsForm">
                  <div class="mb-3">
                    <label for="promotion" class="form-label">Promotion</label>
                    <textarea
                      id="mPromotion"
                      name="promotion"
                      class="form-control"
                      rows="3"
                      placeholder="Enter promotion details"
                    ></textarea>
                  </div>
                  <!-- Top 3 Plans -->
                 <div class="mb-3 card">
                  <label class="form-label">Top 3 Plans</label>
                  <select name="topPlan1" id="topPlan1" class="form-select mb-2">
                    <option value="">1. Select Plan</option>
                  </select>
                  <select name="topPlan2" id="topPlan2" class="form-select mb-2">
                    <option value="">2. Select Plan</option>
                  </select>
                  <select name="topPlan3" id="topPlan3" class="form-select">
                    <option value="">3. Select Plan</option>
                  </select>
                </div>

                  <!-- Pros & Cons -->
                  <div class="mb-3 card">
                    <label class="form-label">Pros</label>
                    <ul id="prosList" class="list-group mb-2"></ul>
                    <div class="input-group mb-2">
                      <input type="text" id="newPro" class="form-control" placeholder="Add a pro">
                      <button type="button" id="addProBtn" class="btn btn-outline-secondary">Add</button>
                    </div>

                    <label class="form-label">Cons</label>
                    <ul id="consList" class="list-group mb-2"></ul>
                    <div class="input-group">
                      <input type="text" id="newCon" class="form-control" placeholder="Add a con">
                      <button type="button" id="addConBtn" class="btn btn-outline-secondary">Add</button>
                    </div>
                  </div>

                  <!-- Lot Counts (placeholders) -->
                  <div class="row card">
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Lot Count</label>
                      <input type="number" name="totalLots" id="lotCount" class="form-control" readonly>
                    </div>
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Sold Lots</label>
                      <input type="number" name="soldLots" id="soldLots" class="form-control" readonly>
                    </div>
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Remaining Lots</label>
                      <input type="number" id="remainingLots" class="form-control" readonly>
                    </div>
                    <div class="col-md-3 mb-3">
                      <label class="form-label">Quick Move-In Lots</label>
                      <input type="number" name="quickMoveInLots" id="quickMoveInLots" class="form-control">
                    </div>
                  </div>
                </form>
              </div>
            </div>
            <div class="section" data-section-content="price">
               <div id="monthTableContainer" class="container mt-4">
                <table id="monthTable" class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Floor Plan</th>
                      <th>Sqft</th>
                      <th>Bed</th>
                      <th>Bath</th>
                      <th>Garage</th>
                      <th>Story</th>
                      <th>Price</th>
                    </tr>
                  </thead>
                  <tbody id="monthTableBody"></tbody>
                </table>
              </div>
            </div>
            <div class="section d-none" data-section-content="inventory">
              <h3 class="mt-5">Quick Move-In Homes</h3>
              <div id="quickHomesContainer" class="container mt-2">
                <table id="quickHomesTable" class="table table-bordered">
                  <thead>
                    <tr>
                      <th></th> <!-- Delete -->
                      <th>Address</th>
                      <th>List Date</th>
                      <th>Floor Plan</th>
                      <th>List Price</th>
                      <th>Sqft</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="quickHomesBody"></tbody>
                </table>
              </div>
              <h3 class="mt-5">Sold Homes</h3>
              <div id="soldHomesContainer" class="container mt-2">
                <table id="soldHomesTable" class="table table-bordered">
                  <thead>
                    <tr>
                      <th></th> <!-- Delete -->
                      <th>Address</th>
                      <th>List Date</th>
                      <th>Floor Plan</th>
                      <th>List Price</th>
                      <th>Sqft</th>
                      <th>Status</th>
                      <th>Sold Date</th>
                      <th>Sold Price</th>
                    </tr>
                  </thead>
                  <tbody id="soldHomesBody"></tbody>
                </table>
              </div>
            </div>
            <div class="section d-none" data-section-content="sales">
              <h3 class="mt-5">Sales Summary</h3>
              <div id="salesContainer" class="container mt-2">
                <table id="salesTable" class="table table-bordered">
                  <thead>
                    <tr>
                      <th>Month</th>
                      <th>Sales</th>
                      <th>Cancels</th>
                      <th>Net</th>
                      <th>Closings</th>
                    </tr>
                  </thead>
                  <tbody id="salesTableBody"></tbody>
                </table>
              </div>
            </div>
            <div class="section d-none" data-section-content="notes">
             <h3 class="mt-5">Notes</h3>
              <div class="container mt-2">
                <textarea
                  id="notes"
                  name="notes"
                  class="form-control"
                  rows="5"
                  placeholder="Enter any notes here"
                ></textarea>
              </div>
            </div>
      </main>
</div>

  <!-- Initial data for JS -->
<script id="community-data" type="application/json" nonce="<%= cspNonce %>">
  <%- JSON.stringify({
    // force a string so JSON always has the key, never “missing”
    communityId: String(communityId || ''),
    community: community || {}
  }) %>
</script>
<script nonce="<%= cspNonce %>">
  window.MCC_BOOT = window.MCC_BOOT || {};
  window.MCC_BOOT.communityId = document.body.dataset.communityId ||
    (function(){ try { return JSON.parse(document.getElementById('community-data')?.textContent||'{}').communityId || '' } catch(_) { return '' } })();
</script>

  <!-- Page script -->
  <script type="module" nonce="<%= cspNonce %>" src="/assets/js/mcc/boot.js"></script>
</body>
</html>
