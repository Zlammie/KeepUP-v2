<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Listing Maps</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/main.css" />
  <link rel="stylesheet" href="/assets/css/pages/listing-map.css" />
  <link rel="stylesheet" href="/assets/css/maps-ten-mile-creek.css" />
</head>
<body>
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-buildrootz') %>

  <main class="container py-4 listings-page">
    <div class="d-flex align-items-start justify-content-between flex-wrap gap-3 mb-3">
      <div>
        <p class="text-uppercase text-muted small mb-1">Listings / Map</p>
        <h1 class="h4 mb-1">Community Map Upload</h1>
        <p class="text-muted mb-0 small">Select a community, upload your overlay assets, and preview the map.</p>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-12">
        <div class="card shadow-sm">
          <div class="card-body">
            <h2 class="h6 mb-3">Map Setup</h2>
            <div class="row g-3">
              <div class="col-lg-4">
                <label class="form-label fw-semibold">Community</label>
                <select id="lm-community" class="form-select form-select-sm" aria-label="Select community">
                  <option value="">Loading...</option>
                </select>
              </div>
              <div class="col-lg-8">
                <label class="form-label fw-semibold">Upload map assets (SVG + links.json)</label>
                <div class="lm-dropzone" id="lm-dropzone" tabindex="0">
                  <div class="text-center">
                    <div class="fw-semibold">Drag & drop map files here</div>
                    <div class="text-muted small">or click to browse</div>
                    <div id="lm-file-name" class="mt-2 text-muted small">No file selected</div>
                  </div>
                  <input id="lm-file-input" type="file" accept=".svg,.json,.png,.jpg,.jpeg" multiple hidden />
                </div>
                <p class="text-muted small mb-0 mt-2">Include an overlay SVG and links.json; optional background image.</p>
              </div>
            </div>
            <div class="mt-3">
              <button id="lm-upload-btn" class="btn btn-primary">Upload map assets</button>
            </div>
            <div class="mt-3">
              <label class="form-label fw-semibold">Current map files</label>
              <div id="lm-files-list" class="lm-files-list text-muted small">
                No files uploaded.
              </div>
              <div class="d-flex align-items-center gap-2 mt-2 flex-wrap">
                <button id="lm-delete-unused" class="btn btn-outline-secondary btn-sm" type="button">Delete unused files</button>
                <span class="text-muted small">Delete files not referenced by the current manifest.</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12">
        <div class="card shadow-sm lm-map-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <div>
                <p class="text-uppercase text-muted small mb-1">Preview</p>
                <h2 class="h6 mb-0">Map preview</h2>
              </div>
              <div class="d-flex align-items-center gap-2">
                <div class="btn-group btn-group-sm" role="group" aria-label="Map zoom controls">
                  <button class="btn btn-outline-secondary" id="lm-zoom-out" type="button" title="Zoom out">-</button>
                  <button class="btn btn-outline-secondary" id="lm-zoom-reset" type="button" title="Reset zoom">Reset</button>
                  <button class="btn btn-outline-secondary" id="lm-zoom-in" type="button" title="Zoom in">+</button>
                </div>
                <span class="badge bg-light text-dark" id="lm-status">Waiting for upload</span>
              </div>
            </div>
            <div id="map-root"
              class="map-test-layout"
              data-zoom="1"
              data-overlay-src=""
              data-links-src=""
              data-combined-src=""
              data-sales-info-scope="active"
              data-active-product-id=""
              data-active-product-type="">
              <div class="map-canvas card shadow-sm">
                <div class="map-frame">
                  <div id="overlay" class="map-overlay-layer" aria-hidden="true"></div>
                </div>
              </div>

              <aside class="map-info card shadow-sm" id="map-info-panel">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-3">
                    <div class="d-flex flex-column">
                      <p class="text-uppercase text-muted small mb-1">Panel</p>
                      <h2 class="h5 mb-0" id="map-panel-title">Selection</h2>
                    </div>
                    <span class="badge bg-light text-dark" id="map-status">Waiting for upload</span>
                  </div>

                  <div class="btn-group btn-group-sm map-panel-tabs mb-3" role="group" aria-label="Map panel toggles">
                    <button type="button" class="btn btn-outline-secondary active" data-panel-tab="details">Details</button>
                    <button type="button" class="btn btn-outline-secondary" data-panel-tab="tools">Tools</button>
                  </div>

                  <div id="map-panel-details">
                    <p class="fw-semibold mb-2" id="map-selected-title">No lot selected</p>
                    <h3 class="visually-hidden">Lot details</h3>
                    <div id="map-info-empty" class="text-muted">
                      Click a highlighted lot to view details from links.json.
                    </div>

                    <dl id="map-info-details" class="map-info-grid visually-hidden">
                      <div>
                        <dt>Address</dt>
                        <dd data-field="address">-</dd>
                      </div>
                      <div>
                        <dt>Lot</dt>
                        <dd data-field="lotSummary">-</dd>
                      </div>
                      <div>
                        <dt>Plan</dt>
                        <dd data-field="planName">-</dd>
                      </div>
                      <div>
                        <dt>Plan #</dt>
                        <dd data-field="planNumber">-</dd>
                      </div>
                    </dl>
                  </div>

                  <div id="map-panel-tools" class="visually-hidden" aria-live="polite">
                    <h3 class="visually-hidden">Plan tools</h3>
                    <div class="map-tools">
                      <p class="text-muted small mb-2">Adjust the colors used for each plan class.</p>
                      <div class="map-tool-row map-tool-row--scope">
                        <label class="map-tool-label" for="lm-sales-scope">Sales info</label>
                        <select id="lm-sales-scope" class="form-select form-select-sm" aria-label="Sales info scope">
                          <option value="active">Active product</option>
                          <option value="both">Both products</option>
                          <option value="none">None</option>
                        </select>
                      </div>
                      <div id="plan-tools-list" class="map-tools-list text-muted small">
                        No plan data yet.
                      </div>
                    </div>
                    <div class="map-tools map-tools--status">
                      <p class="text-muted small mb-2">Status colors (applies to all maps).</p>
                      <div id="status-tools-list" class="map-tools-list text-muted small">
                        Loading status colors...
                      </div>
                    </div>
                  </div>
                </div>
              </aside>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module" src="/assets/js/maps-ten-mile-creek.js"></script>
  <script type="module" src="/assets/js/pages/listing-map.js" nonce="<%= cspNonce %>"></script>
</body>
</html>
