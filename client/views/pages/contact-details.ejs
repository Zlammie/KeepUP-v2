<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Contact Details</title>
  <link rel="stylesheet" href="/assets/css/contact-details-critical.css">
  <link rel="preload" href="/assets/css/contact-details-deferred.css" as="style" data-defer-css>
  <noscript><link rel="stylesheet" href="/assets/css/contact-details-deferred.css"></noscript>
  <link rel="stylesheet" href="/assets/css/design-system.css">
</head>
<body>

  <div id="contact-details-root"
    data-contact-id="<%= contact._id %>"
    data-initial-status="<%= contact.status %>"
    data-current-user-id="<%= currentUser ? currentUser.id : '' %>">
  </div>

  <script id="contact-seed" type="application/json">
    <%- JSON.stringify(contact || {}) %>
  </script>

  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-contacts') %>
<div class="page-wrapper ku-app">
  <main class="contact-content">
  <form id="contactForm">
    <div class="horizontal-cont">
      <div class="card card--grey main-cont ku-content-band">

        <!-- Deal Info -->
        <div class="card card--white deal-info ku-card">
          <div class="form-group">
            <label for="owner">Owner</label>
            <input type="text" id="owner" />
          </div>
          <div class="form-group">
            <label for="community-select">Communities</label>
            <select
              id="community-select"
              name="communityIds"
              data-autosave="communityIds"
              class="select-standard visually-hidden"
              multiple
              size="6"
              aria-label="Select one or more communities (use chips below)">
            </select>
            <div id="community-chip-list" class="community-chip-list" role="listbox" aria-label="Select communities"></div>
            <!-- keep this if your existing save code expects it; our JS will fill it -->
            <input type="hidden" id="communities" />
          </div>
          <div class="form-group">
            <label for="visit-date">Visit Date</label>
            <input
              type="date"
              id="visit-date"
              value="<%= contact && contact.visitDate ? new Date(contact.visitDate).toISOString().slice(0,10) : '' %>"
            />
          </div>
        </div>

        <!-- Customer Info -->
        <div class="card card--white cus-info-container ku-card">
            <div class="form-group">
              <div class="status-cont">
                <label for="status">Status</label>
                  <select name="status" id="status" class="select-standard" >
                    <option value="new">New</option>
                    <option value="be-back">Be-Back</option>
                    <option value="cold">Cold</option>
                    <option value="target">Target</option>
                    <option value="possible">Possible</option>
                    <option value="negotiating">Negotiating</option>
                    <option value="purchased">Purchased</option>
                    <option value="closed">Closed</option>
                    <option value="not-interested">Not-Interested</option>
                    <option value="deal-lost">Deal-Lost</option>
                    <option value="bust">Bust</option>
                  </select>
              </div>
            </div>

            <div class="form-group">
              <label for="firstName">First Name</label>
              <input type="text" id="firstName" />
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input type="text" id="lastName" />
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" />
            </div>
            <div class="form-group">
              <label for="phone">Phone</label>
              <input type="text" id="phone" />
            </div>
            <div class="form-group">
              <label for="source">Lead Source</label>
              <select name="source" id="source" class="select-standard select-center">
                <option value="phone-lead">Phone</option>
                <option value="email-lead">Email</option>
                <option value="online-lead">Online</option>
                <option value="walk-in-lead">Walk-In</option>
              </select>
            </div>
          
              <!-- ✱ NEW: collapsible panel toggle bar -->
              <div id="more-info-panel" class="collapsed">
                <div id="more-info-toggle">
                  <div class="toggle-inner">
                    <span class="triangle">▶</span>
                    <span class="toggle-text">More Details</span>
                  </div>
                </div>
                <div id="more-info-body">

                  <!-- A: inputs group -->
                  <div class="inputs-group">
                    <div class="form-group">
                      <label for="lotLineUp">Lot Line Up</label>
                      <input type="text" id="lotLineUp" />
                    </div>
                    <div class="form-group">
                      <label for="buyTime">Buy Time</label>
                      <input type="text" id="buyTime" />
                    </div>
                    <div class="form-group">
                      <label for="buyMonth">Buy Month</label>
                      <input type="text" id="buyMonth" />
                    </div>
                  </div>

                  <!-- B: floorplans group -->
                  <div class="floorplans-group">
                    <label for="floorplans">Floor Plans</label>
                    <div id="floorplans-container" class="option-group no-auto">…</div>
                  </div>

                  <!-- C: facing group (spans both columns) -->
                  <div class="facing-group">
                    <label for="facing">Lot Facing</label>
                    <div class="option-group no-auto">
                      <label><input type="checkbox" name="facing" value="North" /> North</label>
                      <label><input type="checkbox" name="facing" value="South" /> South</label>
                      <label><input type="checkbox" name="facing" value="East"  /> East</label>
                      <label><input type="checkbox" name="facing" value="West"  /> West</label>
                      <label class="any-option"><input type="checkbox" name="facing" value="Any"   /> Any</label>
                    </div>
                  </div>

                  <!-- D: living-condition group (also spans both) -->
                  <div class="living-group">
                    <label for="miscInfo">Living Condition</label>
                    <div class="option-group no-auto">
                      <label><input type="checkbox" id="investor"> Investor</label>
                      <label><input type="checkbox" id="renting"> Renting</label>
                      <label><input type="checkbox" id="own-selling"> Own &amp; Selling</label>
                      <label><input type="checkbox" id="own-not-selling"> Own &amp; Not Selling</label>
                    </div>
                  </div>

                </div>
              </div>
          </div>

        <!-- Realtor Info -->
        <div class="card card--white realtor-container ku-card">
          <input type="hidden" id="realtorId" name="realtorId" data-autosave="realtorId" />

          <div class="form-group">
            <label for="realtor-search">Search Realtor</label>
            <input type="text" id="realtor-search" placeholder="Search by name, email, or phone" />
            <div id="realtor-search-results" class="search-results"></div>
          </div>
          <div class="form-group">
            <label for="realtorFirstName">First Name</label>
            <input type="text" id="realtorFirstName" />
          </div>
          <div class="form-group">
            <label for="realtorLastName">Last Name</label>
            <input type="text" id="realtorLastName" />
          </div>
          <div class="form-group">
            <label for="realtorPhone">Phone</label>
            <input type="text" id="realtorPhone" />
          </div>
          <div class="form-group">
            <label for="realtorEmail">Email</label>
            <input type="email" id="realtorEmail" />
          </div>
          <div class="form-group">
            <label for="realtorBrokerage">Brokerage</label>
            <input type="text" id="realtorBrokerage" />
          </div>
        </div>

      <div class="card card--white lender-cont ku-card">
          <!-- Lender Info -->
        <form class="lender-form">
          <div class="lender-search-container">

<!-- ===== LENDER SEARCH BLOCK ===== -->
      <section id="lender-link-section" class="lender-link-card ku-subcard">
        <h3 class="lender-link-title">Link a Lender</h3>

        <!-- Search input -->
        <div class="form-group">
          <input
            id="lender-search-input"
            type="text"
            placeholder="Search lenders by name, email, or phone"
          />
        </div>

        <div id="lender-search-results" class="search-results"></div>

        <!-- Auto-filled fields -->
        <div id="lender-info-fields" class="lender-info" style="display:none;">
          <div class="form-pair">
            <label>First Name</label>
            <input id="lender-firstName" readonly />
          </div>
          <div class="form-pair">
            <label>Last Name</label>
            <input id="lender-lastName" readonly />
          </div>
          <div class="form-pair">
            <label>Email</label>
            <input id="lender-email" readonly />
          </div>
          <div class="form-pair">
            <label>Phone</label>
            <input id="lender-phone" readonly />
          </div>
          <div class="form-pair">
            <label>Brokerage</label>
            <input id="lender-brokerage" readonly />
          </div>
          <div class="form-actions">
            <button id="lender-link-btn" type="button" disabled>
              Link to Contact
            </button>
          </div>
        </div>
      </section>
      <!-- ===== END SEARCH BLOCK ===== -->

    <!-- ===== LINKED LENDERS DISPLAY ===== -->
            <section id="linked-lenders-section" class="ku-subcard">
              <h3>Linked Lenders</h3>
              <div id="lender-list-container"></div>
            </section>
    <!-- ===== END LINKED LENDERS DISPLAY ===== -->
          </div>
        </form>
      </div>
      
</div>

        
     

    <!-- Top Container -->
        <div class="top-comment-cont">
      <div class="card card--grey top-container ku-card">
          <div class="disc-cont">
            <div id="contact-full-name" class="contact-name">Full Name</div>
            <div id="contact-status-badge" class="status-badge">Status</div>
          </div>
        <div class="bottom-cont">
          <div class="all-status-cont">
            <!--upto 3 lenders here-->
          </div>
        <div id="community-section">
          <div class="com-left-cont">
            <div id="community-summary" class="community-grid">

              <!-- Top: Lot Line Up (full width) -->
              <section class="card-block lot-line ku-subcard">
                <div class="block-label">Lot Line Up</div>
                <div class="block-value" id="summary-lotLineUp"></div>
              </section>

              <!-- Middle left: Floor Plans -->
              <section class="card-block floorplans-block ku-subcard">
                <div class="block-label">Floor Plans</div>
                <div class="block-value" id="summary-floorplans"></div>
              </section>

              <!-- Middle right: Facing -->
              <section class="card-block facing-block ku-subcard">
                <div class="block-label">Facing</div>
                <div class="block-value" id="summary-facing"></div>
              </section>

              <!-- Bottom left: Buy Time + Buy Month (stacked) -->
              <section class="card-block buy-block ku-subcard">
                <div class="sub-block">
                  <div class="block-label">Buy Time</div>
                  <div class="block-value" id="summary-buyTime"></div>
                </div>
                <div class="sub-block">
                  <div class="block-label">Buy Month</div>
                  <div class="block-value" id="summary-buyMonth"></div>
                </div>
              </section>

              <!-- Bottom right: Living Condition -->
              <section class="card-block living-block ku-subcard">
                <div class="block-label">Living Condition</div>
                <div class="block-value" id="summary-living"></div>
              </section>

            </div>
          </div>
        </div>
                        <!--Purchaser Box-->
            <div id="lot-link-container">
                <div id="purchased-community-selector" style="display: none;">
                  <label for="lot-search">Search for Lot Address</label>
                  <input type="text" id="lot-search" placeholder="Start typing an address..." />
                  <div id="lot-search-results" class="search-results"></div>
                  <button id="link-lot-btn" disabled>Link Lot to Contact</button>
                </div>
                   <!-- NEW: Sales details captured at link time -->
               <div id="sales-details" class="form-row" style="margin-top:.5rem; display:none;">
                <div class="form-group">
                  <label for="sale-date">Sales Date</label>
                  <input type="date" id="sale-date" />
                </div>
                <div class="form-group">
                  <label for="sale-price">Sales Price</label>
                  <input type="number" id="sale-price" placeholder="e.g. 435000" step="0.01" inputmode="decimal" />
                </div>
              </div>
            </div>

            

            <!-- This will show the linked lot info once it's connected -->
            <div id="linked-lot-display" style="display: none;"></div>
        
      </div>
    </div>

    <div class="comment-section ku-card">
      <h3>Comments</h3>
  
      <div class="comment-form">
        <div class="comment-type-nav" id="comment-type-buttons">
          <button type="button" data-type="Note" class="active" title="Note"><img src="/assets/icons/note.svg" alt=""></button>
          <button type="button" data-type="Phone" title="Phone"><img src="/assets/icons/phone.svg" alt=""></button>
          <button type="button" data-type="Email" title="Email"><img src="/assets/icons/email.svg" alt=""></button>
          <button type="button" data-type="Text" title="Text"><img src="/assets/icons/sms.svg" alt=""></button>
        </div>
        <textarea id="comment-text" placeholder="Add a comment..."></textarea>
        <button id="save-comment" type="button">Save Comment</button>
      </div>

      <div id="comment-history"></div>
      </div>
  </form>
</div>
</div>
</main>
<aside id="todo-panel" class="todo-panel" aria-live="polite">
    <header class="todo-header">
      <button id="todo-toggle" class="todo-toggle" type="button" aria-expanded="true">
        <span class="todo-toggle-icon" aria-hidden="true">&#9662;</span>
        <span class="todo-toggle-text">Tasks</span>
        <span id="todo-count" class="todo-count">0</span>
      </button>
      <button id="todo-add" class="todo-add-btn" type="button">
        <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
        <span>Add Task</span>
      </button>
    </header>
    <section id="todo-panel-body" class="todo-body">
      <div class="todo-summary">
        <button type="button" class="todo-pill is-active" data-filter="all">
          <span class="pill-label">All</span>
          <span class="pill-count" aria-hidden="true">0</span>
        </button>
        <button type="button" class="todo-pill" data-filter="Pending">
          <span class="pill-label">Pending</span>
          <span class="pill-count" aria-hidden="true">0</span>
        </button>
        <button type="button" class="todo-pill" data-filter="Completed">
          <span class="pill-label">Completed</span>
          <span class="pill-count" aria-hidden="true">0</span>
        </button>
      </div>

      <section class="todo-automation" data-followup-schedule>
        <div class="todo-automation-text">
          <p class="todo-automation-title">Follow-up schedule</p>
          <p class="todo-automation-body">Use your saved cadence to auto-create the next touchpoints for this contact.</p>
        </div>
        <div class="todo-automation-controls">
          <select
            id="followup-schedule-select"
            class="todo-automation-select"
            data-followup-select
            aria-label="Select a follow-up schedule"
            disabled>
            <option value="">Loading schedules...</option>
          </select>
          <button type="button" class="todo-automation-button" data-followup-apply disabled>Assign</button>
        </div>
        <div class="todo-automation-active" data-followup-active hidden>
          <div class="todo-automation-active-copy">
            <p class="todo-automation-active-label">Current schedule</p>
            <p class="todo-automation-active-name" data-followup-active-name>—</p>
            <p class="todo-automation-active-meta" data-followup-active-meta></p>
          </div>
          <button type="button" class="todo-automation-unassign" data-followup-unassign>Unassign</button>
        </div>
        <p class="todo-automation-status" data-followup-status aria-live="polite" hidden></p>
      </section>

      <ul id="todo-list" class="todo-list">
        <li class="todo-empty">
          <div class="todo-empty-state">
            <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
            <p class="todo-empty-text">No tasks yet. Add one to keep this contact moving forward.</p>
          </div>
        </li>
      </ul>
      <footer class="todo-footer">
        <button id="todo-view-all" class="todo-view-all-btn" type="button">View All Tasks</button>
      </footer>
    </section>
  </aside>

  <div id="task-modal" class="task-modal" aria-hidden="true" hidden>
    <div class="task-modal__backdrop" data-task-modal-close></div>
    <div class="task-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
      <header class="task-modal__header">
        <h2 id="task-modal-title">Edit Task</h2>
        <button type="button" id="task-modal-close" class="task-modal__close" aria-label="Close task editor">&times;</button>
      </header>
      <form id="task-modal-form" class="task-modal__form" novalidate>
        <div class="task-modal__content">
          <div class="task-modal__row">
            <label for="task-modal-title-input">Title</label>
            <input id="task-modal-title-input" name="title" type="text" maxlength="160" required />
          </div>
          <div class="task-modal__row">
            <span class="task-modal__row-label">Task Type</span>
            <div id="task-type-buttons" class="task-type-group" role="group" aria-label="Task type">
              <button type="button" class="task-type-button is-selected" data-type="Follow-Up" aria-pressed="true">Follow-Up</button>
              <button type="button" class="task-type-button" data-type="Document" aria-pressed="false">Document</button>
              <button type="button" class="task-type-button" data-type="Approval" aria-pressed="false">Approval</button>
              <button type="button" class="task-type-button" data-type="Review" aria-pressed="false">Review</button>
              <button type="button" class="task-type-button" data-type="Custom" aria-pressed="false">Custom</button>
            </div>
            <div id="task-followup-sub" class="task-type-subgroup" hidden aria-hidden="true">
              <span class="task-type-subtitle">Follow-Up via</span>
              <div class="task-type-subbuttons" role="group" aria-label="Follow-up method">
                <button type="button" class="task-type-subbutton is-selected" data-followup="Follow-Up" aria-pressed="true">General</button>
                <button type="button" class="task-type-subbutton" data-followup="Call" aria-pressed="false">Call</button>
                <button type="button" class="task-type-subbutton" data-followup="Email" aria-pressed="false">Email</button>
                <button type="button" class="task-type-subbutton" data-followup="Meeting" aria-pressed="false">Meeting</button>
              </div>
            </div>
          </div>
          <div class="task-modal__row">
            <span class="task-modal__row-label">Assign task to</span>
            <div id="task-assignee-options" class="task-modal__assignees">
              <label class="task-modal__assignee">
                <input type="checkbox" id="task-assign-contact" checked>
                Contact
              </label>
              <label class="task-modal__assignee" id="task-assignee-realtor">
                <input type="checkbox" id="task-assign-realtor">
                Realtor
                <span class="task-assignee-note">(if available)</span>
              </label>
              <label class="task-modal__assignee" id="task-assignee-lender">
                <input type="checkbox" id="task-assign-lender">
                Lender
                <select id="task-lender-select" aria-label="Select lender" disabled></select>
              </label>
            </div>
          </div>
          <div class="task-modal__grid two-col">
            <div class="task-modal__row">
              <label for="task-modal-due">Due date</label>
              <input id="task-modal-due" name="dueDate" type="date" />
            </div>
            <div class="task-modal__row">
              <label for="task-modal-priority">Priority</label>
              <select id="task-modal-priority" name="priority"></select>
            </div>
          </div>
          <div class="task-modal__row">
            <label for="task-modal-reminder-date">Reminder (optional)</label>
            <div class="task-modal__reminder-grid">
              <input id="task-modal-reminder-date" name="reminderDate" type="date" />
              <input id="task-modal-reminder-time" name="reminderTime" type="time" />
            </div>
            <p class="task-modal__hint">Pick a date and time to get nudged about this task.</p>
          </div>
          <div class="task-modal__grid two-col">
            <div class="task-modal__row">
              <label for="task-modal-status">Status</label>
              <select id="task-modal-status" name="status"></select>
            </div>
          </div>
          <div class="task-modal__row">
            <label for="task-modal-notes">Notes</label>
            <textarea id="task-modal-notes" name="description" rows="4" maxlength="2000"></textarea>
          </div>
        </div>
        <p id="task-modal-error" class="task-modal__error" role="alert" hidden></p>
        <div class="task-modal__actions">
          <div class="task-modal__actions-left">
            <button type="button" id="task-modal-complete" class="task-modal__secondary">Mark as Completed</button>
          </div>
          <div class="task-modal__actions-right">
            <button type="button" id="task-modal-cancel" class="task-modal__secondary">Cancel</button>
            <button type="submit" id="task-modal-save" class="task-modal__primary">Save Changes</button>
          </div>
        </div>
      </form>
    </div>
  </div>

</div>

<script type="module" src="/assets/js/contact-details/index.js"></script>

</body>
</html>
