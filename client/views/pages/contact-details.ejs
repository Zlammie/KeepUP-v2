<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Contact Details</title>
  <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-contacts') %>
<div class="page-wrapper">
  <main class="contact-content">
  <form id="contactForm">
    <div class="horizontal-cont">
      <div class="card .card--grey main-cont">

        <!-- Deal Info -->
        <div class="card card--white deal-info">
          <div class="form-group">
            <label for="owner">Owner</label>
            <input type="text" id="owner" />
          </div>
          <div class="form-group">
            <label for="community-select">Community</label>
              <select id="community-select" class="select-standard">
                <option value="">-- Select Community --</option>
                <!-- dynamically filled -->
              </select>
              <input type="hidden" id="communities" />
          </div>
          <div class="form-group">
            <label for="visit-date">Visit Date</label>
            <input type="text" id="visit-date" />
          </div>
        </div>

        <!-- Customer Info -->
        <div class="card card--white cus-info-container">
            <div class="form-group">
              <div class="status-cont">
                <label for="status">Status</label>
                  <select name="status" id="status" class="select-standard" >
                    <option value="new">New</option>
                    <option value="be-back">Be-Back</option>
                    <option value="cold">Cold</option>
                    <option value="target">Target</option>
                    <option value="possible">Possible</option>
                    <option value="negotiating">Negotiating</option>
                    <option value="purchased">Purchased</option>
                    <option value="closed">Closed</option>
                    <option value="not-interested">Not-Interested</option>
                    <option value="deal-lost">Deal-Lost</option>
                    <option value="bust">Bust</option>
                  </select>
              </div>
            </div>

            <div class="form-group">
              <label for="firstName">First Name</label>
              <input type="text" id="firstName" />
            </div>
            <div class="form-group">
              <label for="lastName">Last Name</label>
              <input type="text" id="lastName" />
            </div>
            <div class="form-group">
              <label for="email">Email</label>
              <input type="email" id="email" />
            </div>
            <div class="form-group">
              <label for="phone">Phone</label>
              <input type="text" id="phone" />
            </div>
            <div class="form-group">
              <label for="source">Lead Source</label>
              <select name="source" id="source" class="select-standard select-center">
                <option value="phone-lead">Phone</option>
                <option value="email-lead">Email</option>
                <option value="online-lead">Online</option>
                <option value="walk-in-lead">Walk-In</option>
              </select>
            </div>
          
              <!-- ✱ NEW: collapsible panel toggle bar -->
              <div id="more-info-panel" class="collapsed">
                <div id="more-info-toggle">
                  <div class="toggle-inner">
                    <span class="triangle">▶</span>
                    <span class="toggle-text">More Details</span>
                  </div>
                </div>
                <div id="more-info-body">

                  <!-- A: inputs group -->
                  <div class="inputs-group">
                    <div class="form-group">
                      <label for="lotLineUp">Lot Line Up</label>
                      <input type="text" id="lotLineUp" />
                    </div>
                    <div class="form-group">
                      <label for="buyTime">Buy Time</label>
                      <input type="text" id="buyTime" />
                    </div>
                    <div class="form-group">
                      <label for="buyMonth">Buy Month</label>
                      <input type="text" id="buyMonth" />
                    </div>
                  </div>

                  <!-- B: floorplans group -->
                  <div class="floorplans-group">
                    <label for="floorplans">Floor Plans</label>
                    <div id="floorplans-container" class="option-group no-auto">…</div>
                  </div>

                  <!-- C: facing group (spans both columns) -->
                  <div class="facing-group">
                    <label for="facing">Lot Facing</label>
                    <div class="option-group no-auto">
                      <label><input type="checkbox" name="facing" value="North" /> North</label>
                      <label><input type="checkbox" name="facing" value="South" /> South</label>
                      <label><input type="checkbox" name="facing" value="East"  /> East</label>
                      <label><input type="checkbox" name="facing" value="West"  /> West</label>
                      <label class="any-option"><input type="checkbox" name="facing" value="Any"   /> Any</label>
                    </div>
                  </div>

                  <!-- D: living-condition group (also spans both) -->
                  <div class="living-group">
                    <label for="miscInfo">Living Condition</label>
                    <div class="option-group no-auto">
                      <label><input type="checkbox" id="investor"> Investor</label>
                      <label><input type="checkbox" id="renting"> Renting</label>
                      <label><input type="checkbox" id="own-selling"> Own &amp; Selling</label>
                      <label><input type="checkbox" id="own-not-selling"> Own &amp; Not Selling</label>
                    </div>
                  </div>

                </div>
              </div>
          </div>

        <!-- Realtor Info -->
        <div class="card card--white realtor-container">
          <div class="form-group">
            <label for="realtor-search">Search Realtor</label>
            <input type="text" id="realtor-search" placeholder="Search by name, email, or phone" />
            <div id="realtor-search-results" class="search-results"></div>
          </div>
          <div class="form-group">
            <label for="realtorFirstName">First Name</label>
            <input type="text" id="realtorFirstName" />
          </div>
          <div class="form-group">
            <label for="realtorLastName">Last Name</label>
            <input type="text" id="realtorLastName" />
          </div>
          <div class="form-group">
            <label for="realtorPhone">Phone</label>
            <input type="text" id="realtorPhone" />
          </div>
          <div class="form-group">
            <label for="realtorEmail">Email</label>
            <input type="email" id="realtorEmail" />
          </div>
          <div class="form-group">
            <label for="realtorBrokerage">Brokerage</label>
            <input type="text" id="realtorBrokerage" />
          </div>
        </div>

      <div class="lender-cont">
          <!-- Lender Info -->
        <form class="lender-form">
          <div class="lender-search-container">

    <!-- ===== LENDER SEARCH BLOCK ===== -->
            <section id="lender-link-section">
              <h3>Link a Lender</h3>

          <!-- Search input -->
              <input
                id="lender-search-input"
                type="text"
                placeholder="Search lenders by name, email, or phone"
              />
              <div id="lender-search-results"></div>

          <!-- Auto-filled fields -->
              <div id="lender-info-fields" style="margin-top:1em; display:none;">
                <input id="lender-firstName" placeholder="First Name" readonly />
                <input id="lender-lastName"  placeholder="Last Name"  readonly />
                <input id="lender-email"     placeholder="Email"      readonly />
                <input id="lender-phone"     placeholder="Phone"      readonly />
                <input id="lender-brokerage" placeholder="Brokerage"  readonly />
                <button id="lender-link-btn" type="button" disabled>Link to Contact</button>
              </div>
            </section>
    <!-- ===== END SEARCH BLOCK ===== -->

    <!-- ===== LINKED LENDERS DISPLAY ===== -->
            <section id="linked-lenders-section">
              <h3>Linked Lenders</h3>
              <div id="lender-list-container"></div>
            </section>
    <!-- ===== END LINKED LENDERS DISPLAY ===== -->
          </div>
        </form>
      </div>
      
</div>

        
     

    <!-- Top Container -->
    <div class="top-comment-cont">
      <div class="card card--grey top-container">
          <div class="disc-cont">
            <div id="contact-full-name" class="contact-name">Full Name</div>
            <div id="contact-status-badge" class="status-badge">Status</div>
          </div>
        <div class="bottom-cont">
          <div class="all-status-cont">
            <!--upto 3 lenders here-->
          </div>
        <div id="community-section">
          <div class="com-left-cont">
            <div id="community-summary" class="community-grid">

              <!-- Top: Lot Line Up (full width) -->
              <section class="card-block lot-line">
                <div class="block-label">Lot Line Up</div>
                <div class="block-value" id="summary-lotLineUp">—</div>
              </section>

              <!-- Middle left: Floor Plans -->
              <section class="card-block floorplans-block">
                <div class="block-label">Floor Plans</div>
                <div class="block-value" id="summary-floorplans">—</div>
              </section>

              <!-- Middle right: Facing -->
              <section class="card-block facing-block">
                <div class="block-label">Facing</div>
                <div class="block-value" id="summary-facing">—</div>
              </section>

              <!-- Bottom left: Buy Time + Buy Month (stacked) -->
              <section class="card-block buy-block">
                <div class="sub-block">
                  <div class="block-label">Buy Time</div>
                  <div class="block-value" id="summary-buyTime">—</div>
                </div>
                <div class="sub-block">
                  <div class="block-label">Buy Month</div>
                  <div class="block-value" id="summary-buyMonth">—</div>
                </div>
              </section>

              <!-- Bottom right: Living Condition -->
              <section class="card-block living-block">
                <div class="block-label">Living Condition</div>
                <div class="block-value" id="summary-living">—</div>
              </section>

            </div>
          </div>
        </div>
                        <!--Purchaser Box-->
            <div id="lot-link-container">
                <div id="purchased-community-selector" style="display: none;">
                  <label for="lot-search">Search for Lot Address</label>
                  <input type="text" id="lot-search" placeholder="Start typing an address..." />
                  <div id="lot-search-results" class="search-results"></div>
                  <button id="link-lot-btn" disabled>Link Lot to Contact</button>
                </div>
                   <!-- NEW: Sales details captured at link time -->
               <div id="sales-details" class="form-row" style="margin-top:.5rem; display:none;">
                <div class="form-group">
                  <label for="sale-date">Sales Date</label>
                  <input type="date" id="sale-date" />
                </div>
                <div class="form-group">
                  <label for="sale-price">Sales Price</label>
                  <input type="number" id="sale-price" placeholder="e.g. 435000" step="0.01" inputmode="decimal" />
                </div>
              </div>
            </div>

            

            <!-- This will show the linked lot info once it's connected -->
            <div id="linked-lot-display" style="display: none;"></div>
        
      </div>
    </div>

    <div class="comment-section">
      <h3>Comments</h3>
  
      <div class="comment-form">
        <div class="comment-type-nav" id="comment-type-buttons">
          <button type="button" data-type="Note" class="active" title="Note"><img src="/assets/icons/note.svg" alt=""></button>
          <button type="button" data-type="Phone" title="Phone"><img src="/assets/icons/phone.svg" alt=""></button>
          <button type="button" data-type="Email" title="Email"><img src="/assets/icons/email.svg" alt=""></button>
          <button type="button" data-type="Text" title="Text"><img src="/assets/icons/sms.svg" alt=""></button>
        </div>
        <textarea id="comment-text" placeholder="Add a comment..."></textarea>
        <button id="save-comment" type="button">Save Comment</button>
      </div>

      <div id="comment-history"></div>
      </div>
  </form>
</div>
</div>
</main>
<aside id="todo-panel" class="todo-panel">
    <header class="todo-header">
      <button id="todo-toggle" class="todo-toggle">▸ Tasks</button>
    </header>
    <div class="todo-body">
      <!-- Placeholder for future tasks -->
      <p>No tasks yet.</p>
    </div>
  </aside>
</div>


<script>window.contactId = '<%= contact._id %>';</script>
 <script>
  

  async function populateCommunityDropdown(selectedId) {
  const res = await fetch('/api/communities');
  const communities = await res.json();
  const select = document.getElementById('community-select');

  communities.forEach(comm => {
    const opt = document.createElement('option');
    opt.value = comm._id;
    opt.textContent = comm.name;
    if (comm._id === selectedId) {
      opt.selected = true;
    }
    select.appendChild(opt);
  });
}
 
  document.addEventListener('DOMContentLoaded', () => {
    const statusSelect = document.getElementById('status');
    const communitySection = document.getElementById('community-section');
    const purchasedSelector = document.getElementById('purchased-community-selector');

    function toggleUI() {
      const isPurchased = statusSelect.value === 'purchased';
      communitySection.style.display = isPurchased ? 'none' : 'block';
      purchasedSelector.style.display = isPurchased ? 'block' : 'none';
    }

    // ✅ Run immediately on page load
    toggleUI();

    // ✅ React to status dropdown change
    statusSelect.addEventListener('change', toggleUI);
  });

  document.getElementById('todo-toggle').addEventListener('click', () => {
  const panel = document.getElementById('todo-panel');
  panel.classList.toggle('collapsed');

  // flip the arrow
  const btn = document.getElementById('todo-toggle');
  if (panel.classList.contains('collapsed')) {
    btn.textContent = '▸ Tasks';
  } else {
    btn.textContent = '▾ Tasks';
  }
});

(async function hydrateLinkedLotOnLoad() {
  try {
    // Need the current contact id — provided by Step 2
    const contactId = window.contactId || (window.getContactId ? getContactId() : null);
    if (!contactId) return;

    // Ask backend which lot is linked to this purchaser
    const res = await fetch(`/api/communities/lot-by-purchaser/${contactId}`);
    if (!res.ok) return;
    const data = await res.json();
    if (!data.found) return; // nothing linked yet

    const { communityId, lot } = data;

    // 1) Re-seed autosave context so edits persist to the right subdoc
    if (window.setLinkedLotContext) {
      window.setLinkedLotContext(communityId, lot._id, lot);
    } else {
      // Minimal fallback: store on DOM for any script that reads it
      const box = document.getElementById('linked-lot-display');
      if (box) {
        box.dataset.communityId = communityId;
        box.dataset.lotId = lot._id;
      }
    }

    // 2) Prefill inputs from saved values
    const saleDateEl  = document.getElementById('sale-date');
    const salePriceEl = document.getElementById('sale-price');

    if (saleDateEl && lot.salesDate) {
      const d = new Date(lot.salesDate);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      saleDateEl.value = `${yyyy}-${mm}-${dd}`;
    }
    if (salePriceEl && lot.salesPrice != null) {
      salePriceEl.value = lot.salesPrice;
    }

    // 3) Show the linked-lot card
    const box = document.getElementById('linked-lot-display');
    if (box) {
      box.style.display = 'block';
      box.innerHTML = `
        <div class="linked-lot-card">
          <strong>Linked Lot:</strong> ${lot.address ?? '—'}<br/>
          <strong>Job #:</strong> ${lot.jobNumber ?? '—'}<br/>
          <strong>Sales Date:</strong> ${lot.salesDate ? new Date(lot.salesDate).toLocaleDateString() : '—'}<br/>
          <strong>Sales Price:</strong> ${lot.salesPrice ? Number(lot.salesPrice).toLocaleString() : '—'}
        </div>
      `;
    }

    // 4) Make sure the two inputs are hooked into autosave
    if (window.setupLotSalesAutoSaveListeners) {
      window.setupLotSalesAutoSaveListeners();
    }
  } catch (e) {
    console.error('hydrateLinkedLotOnLoad error', e);
  }
})();

</script>

<script src="/assets/js/contact-details/utils.js"></script>
<script src="/assets/js/contact-details/commentLoader.js"></script>
<script src="/assets/js/lotSearch.js"></script>
<script src="/assets/js/contact-details/contactLoader.js"></script>
<script src="/assets/js/contact-details/lenderSearch.js"></script>
<script src="/assets/js/contact-details/autoSave.js"></script>
<script src="/assets/js/contact-details/realtorSearch.js"></script>
<script src="/assets/js/contact-details/statusStyling.js"></script>
<script>
  // After all external scripts have been loaded
  window.addEventListener('load', () => {
    const box = document.getElementById('linked-lot-display');
    const commId = box?.dataset?.communityId;
    const lotId  = box?.dataset?.lotId;

    // If the earlier hydrate already found the lot, seed context now:
    if (commId && lotId && window.setLinkedLotContext) {
      window.setLinkedLotContext(commId, lotId);
    }

    // Ensure listeners get attached even if the earlier hydrate ran too early
    if (window.setupLotSalesAutoSaveListeners) {
      window.setupLotSalesAutoSaveListeners();
    }
  });
</script>




</body>
</html>