<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Saved Lenders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/pages/lenders.css">
  <style>
    .icons-head {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .attention-filter-btn {
      padding: 2px 8px;
      line-height: 1;
      font-weight: 700;
    }
    .attention-filter-btn.active {
      background: #dc2626;
      color: #fff;
      border-color: #dc2626;
    }
    .task-drawer {
      position: fixed;
      top: 64px;
      right: 0;
      height: calc(100vh - 64px);
      width: 340px;
      max-width: 90vw;
      background: #fff;
      box-shadow: -16px 0 30px rgba(15, 26, 58, 0.12);
      transform: translateX(110%);
      transition: transform 0.3s ease;
      z-index: 999;
    }
    body.task-panel-open .task-drawer {
      transform: translateX(0);
    }
    .task-drawer-backdrop {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 26, 58, 0.35);
      z-index: 998;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    body.task-panel-open .task-drawer-backdrop {
      opacity: 1;
      pointer-events: auto;
    }
    .task-drawer-contact {
      font-size: 0.85rem;
      color: #475467;
    }
    .todo-close {
      border: none;
      background: transparent;
      font-size: 1.25rem;
      line-height: 1;
      cursor: pointer;
      color: #0f172a;
    }
    #todo-panel[data-context="lender"] .todo-automation {
      display: none;
    }
    .topbar-actions {
      display: inline-flex;
      gap: 0.4rem;
      align-items: center;
    }
  </style>
</head>
<body class="container mt-5" data-current-user-id="<%= currentUser ? currentUser.id : '' %>">
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-contacts') %>

  <!-- Lenders Top Bar -->
  <div class="contact-topbar" id="lendersTopBar">
    <div class="topbar-left" style="gap:12px;">
      <input id="lenderSearch" class="form-control form-control-sm" type="search"
            placeholder="Search name, email, phone, company" />
      <div class="topbar-total">
        <span class="total-label">Total:</span>
        <span id="lenderTotal" class="total-value">0</span>
      </div>
    </div>

    <div class="topbar-filters" id="lenderFilters">
      <button class="status-pill active" data-filter="all">
        <span class="label">All</span>
        <span class="value" data-count="all">0</span>
      </button>
      <button class="status-pill has-invited" data-filter="has-invited">
        <span class="label">Invited</span>
        <span class="value" data-count="has-invited">0</span>
      </button>
      <button class="status-pill purchased-not-approved" data-filter="purchased-not-approved">
        <span class="label">Purchased not Approved</span>
        <span class="value" data-count="purchased-not-approved">0</span>
      </button>
      <button class="status-pill has-purchased" data-filter="has-purchased">
        <span class="label">Purchased</span>
        <span class="value" data-count="has-purchased">0</span>
      </button>
    </div>
    <div class="topbar-actions">
      <button id="toggleDeleteMode" class="btn btn-sm btn-outline-danger">Delete</button>
      <button id="resetFilters" class="btn btn-sm btn-outline-secondary">Reset</button>
    </div>
  </div>

  <table class="table table-bordered lenders-table" id="lendersTable">
    <thead>
      <tr>
        <th class="contact-table-icons">
          <div class="icons-head">
            <span class="visually-hidden">Actions</span>
            <button
              type="button"
              id="attentionFilterToggle"
              class="btn btn-sm btn-outline-danger attention-filter-btn"
              aria-pressed="false"
              title="Show only lenders with urgent tasks"
            >!</button>
          </div>
        </th>
        <th><span class="visually-hidden">View</span></th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Brokerage</th>
        <th>Invited</th>
        <th>Pending Approval</th>
        <th>Purchased</th>
        <th class="col-delete d-none"><span class="visually-hidden">Delete</span></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<div id="task-drawer-backdrop" class="task-drawer-backdrop" hidden></div>
<aside id="todo-panel" class="todo-panel task-drawer" aria-live="polite" hidden>
  <header class="todo-header">
    <div class="task-drawer-header">
      <button id="todo-toggle" class="todo-toggle" type="button" aria-expanded="true">
        <span class="todo-toggle-icon" aria-hidden="true">&#9662;</span>
        <span class="todo-toggle-text">Tasks</span>
        <span id="todo-count" class="todo-count">0</span>
      </button>
      <button type="button" class="todo-close" data-task-drawer-close aria-label="Close task drawer">&times;</button>
    </div>
    <div class="task-drawer-contact" id="task-panel-contact-name"></div>
    <button id="todo-add" class="todo-add-btn" type="button">
      <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
      <span>Add Task</span>
    </button>
  </header>
  <section id="todo-panel-body" class="todo-body">
    <div class="todo-summary">
      <button type="button" class="todo-pill is-active" data-filter="all">
        <span class="pill-label">All</span>
        <span class="pill-count" aria-hidden="true">0</span>
      </button>
      <button type="button" class="todo-pill" data-filter="Pending">
        <span class="pill-label">Pending</span>
        <span class="pill-count" aria-hidden="true">0</span>
      </button>
      <button type="button" class="todo-pill" data-filter="Completed">
        <span class="pill-label">Completed</span>
        <span class="pill-count" aria-hidden="true">0</span>
      </button>
    </div>

    <section class="todo-automation" data-followup-schedule>
      <div class="todo-automation-text">
        <p class="todo-automation-title">Follow-up schedule</p>
        <p class="todo-automation-body">Use your saved cadence to auto-create the next touchpoints for this lender.</p>
      </div>
      <div class="todo-automation-controls">
        <select
          id="followup-schedule-select"
          class="todo-automation-select"
          data-followup-select
          aria-label="Select a follow-up schedule"
          disabled>
          <option value="">Loading schedules...</option>
        </select>
        <button type="button" class="todo-automation-button" data-followup-apply disabled>Assign</button>
      </div>
      <div class="todo-automation-active" data-followup-active hidden>
        <div class="todo-automation-active-copy">
          <p class="todo-automation-active-label">Current schedule</p>
          <p class="todo-automation-active-name" data-followup-active-name></p>
          <p class="todo-automation-active-meta" data-followup-active-meta></p>
        </div>
        <button type="button" class="todo-automation-unassign" data-followup-unassign>Unassign</button>
      </div>
      <p class="todo-automation-status" data-followup-status aria-live="polite" hidden></p>
    </section>

    <ul id="todo-list" class="todo-list">
      <li class="todo-empty">
        <div class="todo-empty-state">
          <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
          <p class="todo-empty-text">No tasks yet. Add one to keep this lender moving forward.</p>
        </div>
      </li>
    </ul>
    <footer class="todo-footer">
      <button id="todo-view-all" class="todo-view-all-btn" type="button">View All Tasks</button>
    </footer>
  </section>
</aside>

<div id="task-modal" class="task-modal" aria-hidden="true" hidden>
  <div class="task-modal__backdrop" data-task-modal-close></div>
  <div class="task-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
    <header class="task-modal__header">
      <h2 id="task-modal-title">Edit Task</h2>
      <button type="button" id="task-modal-close" class="task-modal__close" aria-label="Close task editor">&times;</button>
    </header>
    <form id="task-modal-form" class="task-modal__form" novalidate>
      <div class="task-modal__content">
        <div class="task-modal__row">
          <label for="task-modal-title-input">Title</label>
          <input id="task-modal-title-input" name="title" type="text" maxlength="160" required />
        </div>
        <div class="task-modal__row">
          <span class="task-modal__row-label">Task Type</span>
          <div id="task-type-buttons" class="task-type-group" role="group" aria-label="Task type">
            <button type="button" class="task-type-button is-selected" data-type="Follow-Up" aria-pressed="true">Follow-Up</button>
            <button type="button" class="task-type-button" data-type="Document" aria-pressed="false">Document</button>
            <button type="button" class="task-type-button" data-type="Approval" aria-pressed="false">Approval</button>
            <button type="button" class="task-type-button" data-type="Review" aria-pressed="false">Review</button>
            <button type="button" class="task-type-button" data-type="Custom" aria-pressed="false">Custom</button>
          </div>
          <div id="task-followup-sub" class="task-type-subgroup" hidden aria-hidden="true">
            <span class="task-type-subtitle">Follow-Up via</span>
            <div class="task-type-subbuttons" role="group" aria-label="Follow-up method">
              <button type="button" class="task-type-subbutton is-selected" data-followup="Follow-Up" aria-pressed="true">General</button>
              <button type="button" class="task-type-subbutton" data-followup="Call" aria-pressed="false">Call</button>
              <button type="button" class="task-type-subbutton" data-followup="Email" aria-pressed="false">Email</button>
              <button type="button" class="task-type-subbutton" data-followup="Meeting" aria-pressed="false">Meeting</button>
            </div>
          </div>
        </div>
        <div class="task-modal__row">
          <span class="task-modal__row-label">Assign task to</span>
          <div id="task-assignee-options" class="task-modal__assignees">
            <label class="task-modal__assignee">
              <input type="checkbox" id="task-assign-contact" checked>
              Contact
            </label>
            <label class="task-modal__assignee" id="task-assignee-realtor">
              <input type="checkbox" id="task-assign-realtor">
              Realtor
              <span class="task-assignee-note">(if available)</span>
            </label>
            <label class="task-modal__assignee" id="task-assignee-lender">
              <input type="checkbox" id="task-assign-lender">
              Lender
              <select id="task-lender-select" aria-label="Select lender" disabled></select>
            </label>
          </div>
        </div>
        <div class="task-modal__grid two-col">
          <div class="task-modal__row">
            <label for="task-modal-due">Due date</label>
            <input id="task-modal-due" name="dueDate" type="date" />
          </div>
          <div class="task-modal__row">
            <label for="task-modal-priority">Priority</label>
            <select id="task-modal-priority" name="priority"></select>
          </div>
        </div>
        <div class="task-modal__row">
          <label for="task-modal-reminder-date">Reminder (optional)</label>
          <div class="task-modal__reminder-grid">
            <input id="task-modal-reminder-date" name="reminderDate" type="date" />
            <input id="task-modal-reminder-time" name="reminderTime" type="time" />
          </div>
          <p class="task-modal__hint">Pick a date and time to get nudged about this task.</p>
        </div>
        <div class="task-modal__grid two-col">
          <div class="task-modal__row">
            <label for="task-modal-status">Status</label>
            <select id="task-modal-status" name="status"></select>
          </div>
        </div>
        <div class="task-modal__row">
          <label for="task-modal-notes">Notes</label>
          <textarea id="task-modal-notes" name="description" rows="4" maxlength="2000"></textarea>
        </div>
      </div>
      <p id="task-modal-error" class="task-modal__error" role="alert" hidden></p>
      <div class="task-modal__actions">
        <div class="task-modal__actions-left">
          <button type="button" id="task-modal-complete" class="task-modal__secondary">Mark as Completed</button>
        </div>
        <div class="task-modal__actions-right">
          <button type="button" id="task-modal-cancel" class="task-modal__secondary">Cancel</button>
          <button type="submit" id="task-modal-save" class="task-modal__primary">Save Changes</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script type="module" src="/assets/js/lenders/index.js"></script>

</body>
</html>
