<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BuildRootz Community Mapping</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/css/main.css" />
    <style>
      .brz-step { border-left: 4px solid #e5e7eb; padding-left: 12px; }
      .brz-step.active { border-color: #2563eb; }
      .brz-pill { display: inline-flex; align-items: center; gap: 6px; border-radius: 999px; padding: 4px 10px; font-size: 12px; font-weight: 600; }
      .brz-pill.mapped { background: rgba(16, 185, 129, 0.1); color: #0f766e; }
      .brz-pill.unmapped { background: #f3f4f6; color: #4b5563; }
      .brz-result { border: 1px solid #e5e7eb; border-radius: 8px; padding: 10px 12px; cursor: pointer; transition: border-color 0.15s ease; }
      .brz-result:hover { border-color: #2563eb; }
      .brz-result input { margin-right: 10px; }
    </style>
  </head>
  <body>
    <%- include('../partials/nav') %>
    <%- include('../partials/top-nav-buildrootz') %>

    <main class="main-content p-4">
      <header class="mb-3">
        <p class="text-uppercase text-muted small mb-1">BuildRootz</p>
        <h1 class="h4 mb-1">BuildRootz Community Mapping</h1>
        <p class="text-muted mb-0">
          Before publishing listings, map each KeepUp community to the canonical BuildRootz community to prevent duplicates.
        </p>
      </header>

      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="brz-step active">
                  <p class="text-uppercase small text-muted mb-0">Step 1</p>
                  <h2 class="h6 mb-0">Select KeepUp Community</h2>
                </div>
              </div>
              <label for="brzCommunitySelect" class="form-label">KeepUp Community</label>
              <select id="brzCommunitySelect" class="form-select">
                <option value="">Choose a community…</option>
                <% (communities || []).forEach((c) => { %>
                  <option value="<%= c.id %>"><%= c.name %><% if (c.city || c.state) { %> — <%= [c.city, c.state].filter(Boolean).join(', ') %><% } %></option>
                <% }) %>
              </select>
              <div class="mt-3">
                <div class="d-flex align-items-center gap-2">
                  <span class="fw-semibold">Status</span>
                  <span id="brzStatusPill" class="brz-pill unmapped">Not mapped</span>
                </div>
                <p class="text-muted small mb-0 mt-2">
                  A community must be mapped before any BuildRootz listings can be published.
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-8">
          <div class="card shadow-sm mb-3">
            <div class="card-body">
              <div class="d-flex align-items-center justify-content-between mb-2">
                <div class="brz-step">
                  <p class="text-uppercase small text-muted mb-0">Steps 2 & 3</p>
                  <h2 class="h6 mb-0">Match to BuildRootz Community</h2>
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="brzUnmapBtn" disabled>Unmap</button>
              </div>

              <div id="brzCommunityCard" class="mb-3">
                <p class="text-muted small mb-0">Select a community to view details.</p>
              </div>

              <div id="brzMappingState" class="d-none">
                <div class="alert alert-success mb-0" role="status">
                  ✅ Community mapped. You can now publish listings for this community.
                  <a href="/listings" class="alert-link ms-1">Go to Listings</a>
                </div>
              </div>

              <div id="brzSearchPanel">
                <label for="brzSearch" class="form-label">Search BuildRootz communities</label>
                <input type="search" class="form-control" id="brzSearch" placeholder="Search by name…" autocomplete="off" />
                <div class="text-muted small mt-1" id="brzSearchStatus">Start typing to search canonical BuildRootz communities.</div>

                <div class="mt-3" id="brzResults"></div>

                <div class="d-flex justify-content-end gap-2 mt-3">
                  <button type="button" class="btn btn-primary" id="brzMapBtn" disabled>Map Community</button>
                </div>

                <hr class="my-4" />
                <div class="d-flex align-items-center justify-content-between mb-2">
                  <div>
                    <p class="text-uppercase small text-muted mb-0">No match?</p>
                    <h2 class="h6 mb-0">Request New BuildRootz Community</h2>
                  </div>
                  <button type="button" class="btn btn-outline-primary btn-sm" id="brzRequestBtn">Request New</button>
                </div>
                <div class="alert alert-info d-none" id="brzRequestPending" role="status">
                  Request submitted. Status: <span id="brzRequestStatusText">pending</span>.
                  <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="brzCheckStatusBtn">Check Status</button>
                </div>
                <form id="brzRequestForm" class="row g-3 d-none">
                  <div class="col-md-6">
                    <label class="form-label" for="brzReqName">Proposed Name</label>
                    <input type="text" class="form-control" id="brzReqName" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label" for="brzReqCity">City</label>
                    <input type="text" class="form-control" id="brzReqCity" />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label" for="brzReqState">State</label>
                    <input type="text" class="form-control" id="brzReqState" />
                  </div>
                  <div class="col-12">
                    <label class="form-label" for="brzReqNotes">Notes (optional)</label>
                    <textarea id="brzReqNotes" class="form-control" rows="2" placeholder="Examples, alternate names, landmarks..."></textarea>
                  </div>
                  <div class="col-12 d-flex justify-content-end gap-2">
                    <button type="button" class="btn btn-outline-secondary" id="brzReqCancel">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="brzReqSubmit">Submit Request</button>
                  </div>
                  <div class="text-muted small" id="brzRequestStatus"></div>
                </form>
              </div>
            </div>
          </div>

          <div class="card shadow-sm">
            <div class="card-body">
              <div class="brz-step">
                <p class="text-uppercase small text-muted mb-0">Step 4</p>
                <h2 class="h6 mb-0">Ready to publish listings</h2>
              </div>
              <p class="text-muted mb-2">
                Once mapped, this community can publish and sync BuildRootz listings without creating duplicate communities.
              </p>
              <a class="btn btn-outline-primary" href="/listings">Open Listings</a>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script nonce="<%= cspNonce %>">
      window.__BRZ_COMMUNITIES__ = <%- JSON.stringify(communities || []) %>;
    </script>
    <script src="/assets/js/admin/buildrootzCommunity.js" nonce="<%= cspNonce %>" defer></script>
  </body>
</html>
