<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Simple CRM</title>
   
  <!-- single entry-point for all your app?s CSS -->
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
   <link rel="stylesheet" href="/assets/css/main.css">
</head>
<body>
  <!-- include navbar HTML at the top of every page -->
  <!-- if you?re using EJS: -->
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-competition') %>
  <!-- or (static SSI) -->
  <!--# include virtual="/views/partials/navbar.html" -->

<main class="add-lead-wrapper">
  <h1>Add Competition</h1>

  <!-- No action/method => JS controls submission -->
  <form id="competitionForm" class="competition-form">
    <div class="mb-3">
      <label for="communityName">Community Name</label>
      <input type="text" class="form-control" id="communityName" name="communityName" required />
    </div>

    <div class="mb-3">
      <label for="builderName">Builder Name</label>
      <input type="text" class="form-control" id="builderName" name="builderName" required />
    </div>

    <div class="mb-3">
      <label for="address">Address</label>
      <input type="text" class="form-control" id="address" name="address" required />
    </div>

    <div class="mb-3">
      <label for="city">City</label>
      <input type="text" class="form-control" id="city" name="city" required />
    </div>

    <div class="mb-3">
      <label for="state">State</label>
      <input type="text" class="form-control" id="state" name="state" required />
    </div>

    <div class="mb-3">
      <label for="zip">ZIP Code</label>
      <input type="text" class="form-control" id="zip" name="zip" required />
    </div>

    <button type="submit" class="btn btn-primary">Create Competition</button>
  </form>

  <!-- alert placeholder -->
  <div id="alertBox" class="alert mt-3 d-none" role="alert"></div>
</main>

<script nonce="<%= cspNonce %>">
(function () {
  const form = document.getElementById("competitionForm");
  const alertBox = document.getElementById("alertBox");

  function showAlert(msg, type = "success") {
    alertBox.textContent = msg;
    alertBox.classList.remove("d-none", "alert-success", "alert-danger");
    alertBox.classList.add(type === "success" ? "alert-success" : "alert-danger");

    // auto-hide after 4s (optional)
    setTimeout(() => {
      alertBox.classList.add("d-none");
      alertBox.textContent = "";
    }, 4000);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const data = Object.fromEntries(new FormData(form).entries());
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;

    try {
      const res = await fetch("/api/competitions", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      let payload = null;
      try {
        payload = await res.json();
      } catch (_) {
        // non-JSON response; ignore
      }

      if (!res.ok) {
        const message = payload?.error || "Failed to add competition";
        throw new Error(message);
      }

      const label = payload?.builderName && payload?.communityName
        ? `${payload.builderName} - ${payload.communityName}`
        : payload?.communityName || payload?.builderName;
      const successMsg = label ? `Competition "${label}" added successfully!` : "Competition added successfully!";
      showAlert(successMsg, "success");
      form.reset();
    } catch (err) {
      showAlert(`Error: ${err.message}`, "danger");
    } finally {
      submitBtn.disabled = false;
    }
  });
})();
</script>
</body>
</html>
