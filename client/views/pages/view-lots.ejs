<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Lots</title>
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/pages/contacts-shared.css">

  <style>
    .icons-head {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    .attention-filter-btn {
      padding: 2px 8px;
      line-height: 1;
      font-weight: 700;
    }
    .attention-filter-btn.active {
      background: #dc2626;
      color: #fff;
      border-color: #dc2626;
    }

    /* sticky first three columns */
    :root {
      --lots-actions-col: 88px;
      --lots-job-col: 80px;
      --lots-lot-col: 120px;
    }
    .lots-table .sticky-col { position: sticky; z-index: 1; }
    .lots-table .sc-1 { left: var(--lots-actions-col); z-index: 2; }
    .lots-table .sc-2 { left: calc(var(--lots-actions-col) + var(--lots-job-col)); }
    .lots-table .sc-3 {
      left: calc(var(--lots-actions-col) + var(--lots-job-col) + var(--lots-lot-col));
      min-width: 300px;
    }

    /* Task drawer (shared with contacts/lenders) */
    .task-drawer {
      position: fixed;
      top: 64px;
      right: 0;
      height: calc(100vh - 64px);
      width: 340px;
      max-width: 90vw;
      background: #fff;
      box-shadow: -16px 0 30px rgba(15, 26, 58, 0.12);
      transform: translateX(110%);
      transition: transform 0.3s ease;
      z-index: 999;
    }
    body.task-panel-open .task-drawer {
      transform: translateX(0);
    }
    .task-drawer-backdrop {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 26, 58, 0.35);
      z-index: 998;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    body.task-panel-open .task-drawer-backdrop {
      opacity: 1;
      pointer-events: auto;
    }
    .task-drawer-top {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #dfe3ea;
      background: #f7f9fc;
    }
    .task-drawer-contact {
      font-weight: 700;
    }
    .todo-close {
      border: none;
      background: transparent;
      font-size: 1.25rem;
      line-height: 1;
      cursor: pointer;
      color: #0f172a;
    }
    .task-drawer-top .todo-close {
      margin-left: auto;
    }

.lots-table .sc-3,
.lots-table .sc-3 .cell-col { white-space: normal; }
.lots-table .sc-3 a.link { display: block; }
.lots-table .sc-3 .cell-sub a.cell-sub-link { display: inline; }
.lots-table .purchaser-sub {
  font-size: 0.95em;
  opacity: 0.9;
  margin-top: 6px;
  color: #0f172a;
}

/* table look & feel */
.lots-table td, .lots-table th { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; height: 44px; }
.lots-table .text-right { text-align: right; }

#lotsTopBar.contact-topbar {
  margin: 0 20px 12px;
  justify-content: flex-start;
  gap: 16px;
}

#lotsTopBar .topbar-left {
  flex-wrap: wrap;
  row-gap: 8px;
}

#lotsTopBar .topbar-filters {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-left: 16px;
}

#vl-statusFilters .status-pill {
  --pill-bg: #f3f4f6;
  --pill-border: #e5e7eb;
  --pill-fg: #1f2937;
  border: 1px solid var(--pill-border);
  background: #ffffff;
  color: var(--pill-fg);
  border-radius: 999px;
  padding: 6px 14px;
  line-height: 1;
  display: inline-flex;
  align-items: center;
  gap: 6px;
  cursor: pointer;
  font-weight: 600;
  transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.2s ease;
}

#vl-statusFilters .status-pill--available {
  --pill-bg: #eaf7ef;
  --pill-border: #ccebd7;
  --pill-fg: #166534;
}

#vl-statusFilters .status-pill--spec {
  --pill-bg: #fff7e6;
  --pill-border: #ffe4b5;
  --pill-fg: #92400e;
}

#vl-statusFilters .status-pill--coming {
  --pill-bg: #f3e8ff;
  --pill-border: #e9d5ff;
  --pill-fg: #6b21a8;
}

#vl-statusFilters .status-pill--sold {
  --pill-bg: #fdecec;
  --pill-border: #f9caca;
  --pill-fg: #991b1b;
}

#vl-statusFilters .status-pill.active {
  background: var(--pill-bg);
  color: var(--pill-fg);
  box-shadow: 0 0 0 2px rgba(15, 23, 42, 0.08);
  transform: translateY(-1px);
}

#vl-statusFilters .status-pill:hover {
  box-shadow: 0 2px 6px rgba(15, 23, 42, 0.1);
}

#vl-statusFilters .status-pill:focus-visible {
  outline: 2px solid #0ea5e9;
  outline-offset: 2px;
}

.table-container {
  padding: 0 20px;
}

/* compact two-line cells */
.cell-col { display: flex; flex-direction: column; line-height: 1.1; }
.cell-top { font-weight: 600; }
.cell-sub { opacity: 0.75; font-size: 0.86em; }
.cell-col.strong .cell-top, .strong { font-weight: 700; }

/* status badges (match filter pill palette) */
.status-badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 0.78rem; }
.badge-available { background: #eaf7ef; color: #166534; }
.badge-spec      { background: #fff7e6; color: #92400e; }
.badge-coming    { background: #f3e8ff; color: #6b21a8; }
.badge-sold      { background: #fdecec; color: #991b1b; }
.badge-model     { background: #f3e8ff; color: #6b21a8; }
.badge-closed    { background: #e5e7eb; color: #1f2937; }
.badge-hold      { background: #fff4e6; color: #b45309; }
.badge-muted     { background: #f1f5f9; color: #334155; }
.status-split-cell .status-split {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
.status-split-row {
  display: flex;
  align-items: center;
  gap: 8px;
}
.status-split-label {
  font-size: 0.68rem;
  letter-spacing: .04em;
  text-transform: uppercase;
  color: #64748b;
}
.status-split-divider {
  height: 1px;
  background: rgba(0, 0, 0, 0.08);
  width: 100%;
}

/* timeline */
.timeline2-cell .timeline2-wrap {
  display: flex;
  flex-direction: column;
  gap: 4px;
  align-items: flex-end;
  text-align: right;
}
.timeline2-cell .timeline2-sec {
  display: flex;
  flex-direction: column;
  gap: 1px;
  align-items: flex-end;
}
.timeline2-cell .timeline2-label {
  font-size: 0.65rem;
  letter-spacing: .02em;
  text-transform: uppercase;
  opacity: .6;
}
.timeline2-cell .timeline2-value {
  font-size: 0.85rem;
  font-weight: 600;
}
.timeline2-cell .timeline2-divider {
  height: 1px;
  background: rgba(0,0,0,0.1);
  width: 100%;
  margin: 2px 0;
}

/* walks */
.walk-dots { display: inline-flex; gap: 8px; align-items: center; }
.lots-table td.walk-cell {
  overflow: visible;
  position: relative;
  z-index: 1;
}
.lots-table td.walk-cell:hover,
.lots-table td.walk-cell:focus-within {
  z-index: 10;
}
.walk-dots {
  position: relative;
  gap: 10px;
}
.dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display: inline-block;
}
.dot-none   { background: #ef4444; }  /* red */
.dot-future { background: #3b82f6; }  /* blue */
.dot-today  { background: #eab308; }  /* yellow */
.dot-past   { background: #10b981; }  /* green */

/* link and hover */
.lots-table a.link { text-decoration: none; }
.lots-table tr:hover td { background: #f5f5f5; }
.lots-table tbody tr:hover .sticky-col { background: #f5f5f5; color: inherit; }
/* Table header: swap green for a soft gray-on-charcoal look */
.lots-table thead,
.lots-table thead tr,
.lots-table thead th,
.lots-table thead th.sticky-col {
  background: #f0f0f0 !important;
  color: #111827 !important;
  border-bottom: 1px solid #d6d6d6;
}

/* Keep sticky WHITE only for BODY cells (not headers) */
.lots-table tbody td.sticky-col {
  background: #fff;                 /* body sticky bg */
}
.lots-table tbody tr:nth-child(even) td.sticky-col {
  background: #f7f7f7;              /* zebra for Job, Lot/Block, Address */
}

.lots-table .sc-3 a.link,
.lots-table .sc-3 a.link:visited,
.lots-table .sc-3 a.link:hover,
.lots-table .sc-3 a.link:active {
  text-decoration: none;
  color: inherit;
}

/* Keep accessibility: visible focus ring without underline */
.lots-table .sc-3 a.link:focus {
  outline: 2px solid #0ea5e9;
  outline-offset: 2px;
  text-decoration: none;
}

/* Two-line price cell */
.price-cell .price-wrap {
  display: flex;
  flex-direction: column;
  gap: 4px;
  align-items: flex-end; /* align everything right */
  text-align: right;
}

.price-cell .price-sec {
  display: flex;
  flex-direction: column;
  gap: 1px;
  align-items: flex-end; /* right-align label + value */
}

.price-cell .price-label {
  font-size: 0.65rem;        /* smaller label */
  letter-spacing: .02em;
  text-transform: uppercase;
  opacity: .6;
}

.price-cell .price-value {
  font-size: 0.85rem;        /* slightly smaller than before */
  font-weight: 600;
}

.price-cell .price-divider {
  height: 1px;
  background: rgba(0,0,0,0.1);
  width: 100%;
  margin: 2px 0;
}

  </style>
</head>


<body data-current-user-id="<%= currentUser ? currentUser.id : '' %>">
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-community') %>

<!-- TOP BAR (re-using Contacts topbar classes) -->
<div id="lotsTopBar" class="contact-topbar">
  <div class="topbar-left">
    <label for="vl-community" class="visually-hidden">Community</label>
    <select id="vl-community" class="form-select form-select-sm" style="min-width: 260px;">
      <!-- populated by JS -->
    </select>

    <!-- Search -->
    <div style="min-width: 260px; max-width: 420px;">
      <input id="vl-search" class="form-control form-control-sm" placeholder="Search address..." />
    </div>

    <!-- Total -->
    <div class="topbar-total">
      <span class="total-label">Total:</span>
      <span id="vl-count" class="total-value">0</span>
    </div>
  </div>

  <!-- Filter pills (visual now; wire later) -->
  <div class="topbar-filters" id="vl-statusFilters">
    <button class="status-pill status-pill--available" id="vl-filter-available" data-filter="available">
      <span class="label">Available</span>
    </button>
    <button class="status-pill status-pill--spec" id="vl-filter-spec" data-filter="spec">
      <span class="label">SPEC</span>
    </button>
    <button class="status-pill status-pill--coming" id="vl-filter-coming" data-filter="comingSoon">
      <span class="label">Coming Soon</span>
    </button>
    <button class="status-pill status-pill--sold" id="vl-filter-sold" data-filter="sold">
      <span class="label">Sold</span>
    </button>
  </div>
</div>

<div class="table-container">
  <table id="lotsTable" class="lots-table">
      <colgroup>
        <col style="width: var(--lots-actions-col)" />   <!-- Actions -->
        <col style="width: 80px" />                      <!-- Job # -->
        <col style="width: 120px" />                     <!-- Lot / Block (slimmer) -->
        <col />                                          <!-- Address (flex / wider) -->
        <col style="width: 120px" />                     <!-- Plan / Elv (slimmer) -->
        <col style="width: 130px" />                     <!-- Status -->
        <col style="width: 230px" />                     <!-- Timeline -->
        <col style="width: 110px" />                     <!-- Walks -->
        <col style="width: 180px" />                     <!-- Closing -->
    <col style="width: 140px" />                     <!-- Price -->
      </colgroup>
    <thead>
  <tr>
    <th class="contact-table-icons actions-head">
      <div class="icons-head">
        <span class="visually-hidden">Actions</span>
        <button
          type="button"
          id="attentionFilterToggle"
          class="btn btn-sm btn-outline-danger attention-filter-btn"
          aria-pressed="false"
          title="Show only lots requiring attention"
        >!</button>
      </div>
    </th>
    <th class="sticky-col sc-1">Job #</th>
    <th class="sticky-col sc-2">Lot / Block</th>
    <th class="sticky-col sc-3">Address</th>
    <th>Plan / Elv</th>
    <th>Status</th>
    <th>Timeline</th>
    <th>Walks</th>
    <th>Closing</th>
    <th class="text-right">Price</th>
  </tr>
</thead>
    <tbody id="lotsTableBody"></tbody>
  </Table>
</div>

<div id="task-drawer-backdrop" class="task-drawer-backdrop" hidden></div>
<aside id="todo-panel" class="todo-panel task-drawer" aria-live="polite" hidden>
  <div class="task-drawer-top">
    <button type="button" class="todo-close" data-task-drawer-close aria-label="Close task drawer">&times;</button>
    <div class="task-drawer-contact" id="task-panel-contact-name"></div>
    <button id="todo-add" class="todo-add-btn" type="button">
      <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
      <span>Add Task</span>
    </button>
  </div>
  <section id="todo-panel-body" class="todo-body">
    <div class="todo-summary">
      <button type="button" class="todo-pill is-active" data-filter="all">
        <span class="pill-label">All</span>
        <span class="pill-count" aria-hidden="true">0</span>
      </button>
      <button type="button" class="todo-pill" data-filter="Pending">
        <span class="pill-label">Pending</span>
        <span class="pill-count" aria-hidden="true">0</span>
      </button>
      <button type="button" class="todo-pill" data-filter="Completed">
        <span class="pill-label">Completed</span>
        <span class="pill-count" aria-hidden="true">0</span>
      </button>
      <button type="button" class="todo-pill" data-filter="today">
        <span class="pill-label">Today</span>
        <span class="pill-count" aria-hidden="true">0</span>
      </button>
    </div>

    <section class="todo-automation" data-followup-schedule>
      <div class="todo-automation-text">
        <p class="todo-automation-title">Follow-up schedule</p>
        <p class="todo-automation-body">Use your saved cadence to auto-create the next touchpoints for this record.</p>
      </div>
      <div class="todo-automation-controls">
        <select
          id="followup-schedule-select"
          class="todo-automation-select"
          data-followup-select
          aria-label="Select a follow-up schedule"
          disabled>
          <option value="">Loading schedules...</option>
        </select>
        <button type="button" class="todo-automation-button" data-followup-apply disabled>Assign</button>
      </div>
      <div class="todo-automation-active" data-followup-active hidden>
        <div class="todo-automation-active-copy">
          <p class="todo-automation-active-label">Current schedule</p>
          <p class="todo-automation-active-name" data-followup-active-name></p>
          <p class="todo-automation-active-meta" data-followup-active-meta></p>
        </div>
        <button type="button" class="todo-automation-unassign" data-followup-unassign>Unassign</button>
      </div>
      <p class="todo-automation-status" data-followup-status aria-live="polite" hidden></p>
    </section>

    <ul id="todo-list" class="todo-list">
      <li class="todo-empty">
        <div class="todo-empty-state">
          <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
          <p class="todo-empty-text">No tasks yet. Add one to keep this lot moving forward.</p>
        </div>
      </li>
    </ul>
    <footer class="todo-footer">
      <button id="todo-view-all" class="todo-view-all-btn" type="button">View All Tasks</button>
    </footer>
  </section>
</aside>

   <script type="module" src="/assets/js/view-lots/index.js"></script>
</body>
</html>
