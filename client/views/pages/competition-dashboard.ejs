<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Competition Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/assets/css/main.css">
</head>

<body data-community-id="<%= communityId || '' %>">
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-competition') %>

  <main class="container-fluid my-3">
    <!-- Top strip -->
    <div class="card card--grey p-3 mb-3">
      <div class="row g-3 align-items-stretch">
        <!-- My Community + Linked Builders -->
        <div class="col-12 col-lg">
          <div class="card card--white p-3 h-100">
            <div class="row g-3">
              <div class="col-12 col-md-3">
                <label class="form-label" for="dashCommunity">My Community</label>
                <select id="dashCommunity" class="form-select form-select-sm">
                  <option value="">-- Select a community --</option>
                </select>
                <div id="myCommunityColorWrap" class="mt-2"></div>
              </div>
              <div class="col-12 col-md-9">
                <label class="form-label">Linked Builders</label>
                <div id="dashLinkedBuilders" class="d-flex flex-wrap gap-2">
                  <!-- chips injected -->
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Filters -->
        <div class="col-lg-auto ms-lg-auto d-flex">
          <div class="card card--white p-3 h-100 w-100">
            <div class="d-flex gap-2 align-items-end">
              <div class="flex-fill">
                <label class="form-label">Months</label>
                <select id="dashMonths" class="form-select form-select-sm">
                  <option value="6">6</option>
                  <option value="12" selected>12</option>
                  <option value="24">24</option>
                </select>
              </div>
              <button id="dashRefresh" class="btn btn-sm btn-secondary">Refresh</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main grid -->
    <div class="row g-3">
      <div class="col-lg-8">
        <div class="card card--grey p-2">
          <div class="card card--white p-3">
            <h5 class="mb-2">Quick Move-In & Sold (Price vs Sqft)</h5>
            <div id="qmiLegend" class="qmi-legend mb-3" aria-live="polite"></div>
            <div style="height: 380px"><canvas id="qmiSoldsChart"></canvas></div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card card--grey p-2">
          <div class="card card--white p-3">
            <label class="form-label">Sales Window</label>
            <select id="dashSalesWindow" class="form-select">
              <option value="20d">Last 20 days</option>
              <option value="60d">Last 60 days</option>
              <option value="90d" selected>Last 90 days</option>
              <option value="6m">Last 6 months</option>
              <option value="1y">Last 1 year</option>
              <option value="ytd">Year to date</option>
            </select>

            <h5 class="mb-2">Sales Mix (12 mo)</h5>
            <div style="height: 380px"><canvas id="salesPieChart"></canvas></div>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card card--grey p-2">
          <div class="card card--white p-3">
            <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
              <h5 class="mb-0 me-auto">Base Price Comparison</h5>
              <select id="baseMonth" class="form-select form-select-sm w-auto"></select>
              <button id="toggleBaseMode" class="btn btn-sm btn-outline">Table</button>
            </div>
            <div id="baseChartWrap" style="height: 380px"><canvas id="basePriceChart"></canvas></div>
            <div id="baseTableWrap" class="d-none">
              <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0" id="baseTable"></table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card card--grey p-2" id="lotCountsCardWrap">
          <div class="card card--white p-3 lot-counts-card expandable-table-card" id="lotCountsCard">
            <div class="lot-counts-card-header expandable-table-card-header mb-3">
              <h5 class="mb-0">Lot Counts</h5>
              <button type="button"
                      id="lotCountsToggle"
                      class="btn btn-sm btn-outline-secondary expandable-table-toggle"
                      aria-expanded="false"
                      aria-controls="lotCountsTable"
                      aria-label="Expand lot counts table">
                <span class="expandable-table-toggle-icon" aria-hidden="true">[+]</span>
                <span class="visually-hidden">Expand lot counts table</span>
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-bordered align-middle mb-0" id="lotCountsTable">
                <thead>
                  <tr>
                    <th scope="col">Community</th>
                    <th scope="col" class="text-end">Total Lots</th>
                    <th scope="col" class="text-end">Lots Sold</th>
                    <th scope="col" class="text-end">Remaining</th>
                    <th scope="col" class="text-end">Quick Move-Ins</th>
                  </tr>
                </thead>
                <tbody id="lotCountsTableBody">
                  <tr>
                    <td colspan="5" class="text-center text-muted small">Select a community to view lot counts.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script type="module" src="/assets/js/competition-dashboard/index.js"></script>
</body>
</html>
