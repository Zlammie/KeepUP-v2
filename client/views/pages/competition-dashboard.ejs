<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Competition Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/assets/css/main.css">
  <link rel="stylesheet" href="/assets/css/pages/competition-dashboard.css">
</head>

<body data-community-id="<%= communityId || '' %>" data-user-id="<%= currentUserId || '' %>">
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-competition') %>

  <main class="container-fluid my-3">
    <!-- Top strip -->
    <div class="card card--grey p-3 mb-3">
      <div class="row g-3 align-items-stretch">
        <!-- My Community -->
        <div class="col-12 col-lg-auto">
          <div class="card card--white p-3 h-100" style="min-width: 260px;">
            
            <select id="dashCommunity" class="form-select form-select-sm">
              <option value="">-- Select a community --</option>
            </select>
            <div id="myCommunityColorWrap" class="mt-2"></div>
          </div>
        </div>
        <!-- Linked Builders -->
        <div class="col-12 col-lg">
          <div class="card card--white p-3 h-100">
            <div id="dashLinkedBuilders" class="d-flex flex-wrap gap-2">
              <!-- chips injected -->
            </div>
          </div>
        </div>
        <!-- Filters -->
        <div class="col-12 col-lg-auto">
          <div class="card card--white p-3 h-100" style="min-width: 220px;">
            <div class="d-flex gap-2 align-items-end">
              <div class="flex-fill">
                <label class="form-label" for="dashMonths">Months</label>
                <select id="dashMonths" class="form-select form-select-sm">
                  <option value="30d">Last 30 days</option>
                  <option value="3m">Last 3 months</option>
                  <option value="6m">Last 6 months</option>
                  <option value="12m" selected>Last 12 months</option>
                </select>
              </div>
              <button id="dashRefresh" class="btn btn-sm btn-secondary w-auto">Refresh</button>
            </div>
            <div class="mt-3">
              <button type="button" id="dashSettings" class="btn btn-outline-secondary btn-sm w-100" data-bs-toggle="modal" data-bs-target="#dashSettingsModal">
                Settings
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main grid -->
    <div class="row g-3">
      <div class="col-lg-8">
        <div class="card card--grey p-2 h-100">
          <div class="card card--white p-3 h-100 d-flex flex-column">
            <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
              <h5 class="mb-0 me-auto">Quick Move-In & Sold (Price vs Sqft)</h5>
              <div class="btn-group btn-group-sm qmi-toggle-group" role="group" aria-label="Toggle Quick Move-In and Sold">
                <button type="button" id="toggleQmi" class="btn qmi-toggle-btn active" aria-pressed="true">Quick Move-In</button>
                <button type="button" id="toggleSold" class="btn qmi-toggle-btn active" aria-pressed="true">Sold</button>
              </div>
            </div>
            <div id="qmiLegend" class="qmi-legend mb-3" aria-live="polite"></div>
            <div class="flex-grow-1" style="min-height: 380px"><canvas id="qmiSoldsChart"></canvas></div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card card--grey p-2 h-100">
          <div class="card card--white p-3 h-100 d-flex flex-column">
            <select id="dashSalesWindow" class="form-select">
              <option value="30d">Last 30 days</option>
              <option value="3m">Last 3 months</option>
              <option value="6m">Last 6 months</option>
              <option value="12m" selected>Last 12 months</option>
            </select>

            <h5 class="mb-2">Sales Mix</h5>
            <div class="flex-grow-1" style="min-height: 380px"><canvas id="salesPieChart"></canvas></div>
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card card--grey p-2">
          <div class="card card--white p-3">
            <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
              <h5 class="mb-0 me-auto">Base Price Comparison</h5>
              <select id="baseMonth" class="form-select form-select-sm w-auto"></select>
              <button id="toggleBaseMode" class="btn btn-sm btn-outline">Table</button>
            </div>
            <div id="baseChartWrap" style="height: 380px"><canvas id="basePriceChart"></canvas></div>
            <div id="baseTableWrap" class="d-none">
              <div class="table-responsive">
                <table class="table table-sm table-bordered mb-0" id="baseTable"></table>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card card--grey p-2" id="lotCountsCardWrap">
          <div class="card card--white p-3 lot-counts-card expandable-table-card" id="lotCountsCard">
            <div class="lot-counts-card-header expandable-table-card-header mb-3">
              <h5 class="mb-0">Lot Counts</h5>
              <button type="button"
                      id="lotCountsToggle"
                      class="btn btn-sm btn-outline-secondary expandable-table-toggle"
                      aria-expanded="false"
                      aria-controls="lotCountsTable"
                      aria-label="Expand lot counts table">
                <span class="expandable-table-toggle-icon" aria-hidden="true">[+]</span>
                <span class="visually-hidden">Expand lot counts table</span>
              </button>
            </div>
            <div class="table-responsive">
              <table class="table table-sm table-bordered align-middle mb-0" id="lotCountsTable">
                <thead class="small">
                  <tr>
                    <th scope="col">Community</th>
                    <th scope="col" class="text-center">Total Lots</th>
                    <th scope="col" class="text-center">Lots Sold</th>
                    <th scope="col" class="text-center">Remaining</th>
                    <th scope="col" class="text-center">QMI's</th>
                  </tr>
                </thead>
                <tbody id="lotCountsTableBody">
                  <tr>
                    <td colspan="5" class="text-center text-muted small">Select a community to view lot counts.</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module" src="/assets/js/competition-dashboard/index.js"></script>

  <!-- Settings Modal -->
  <div class="modal fade" id="dashSettingsModal" tabindex="-1" aria-labelledby="dashSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" style="max-width: 70vw; width: 70vw;">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dashSettingsModalLabel">Dashboard Settings</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted small mb-3">Manage how builder/community names display across dashboard tables.</p>
          <div class="table-responsive mb-3">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th scope="col">Builder</th>
                  <th scope="col">Community</th>
                  <th scope="col">Short Name</th>
                </tr>
              </thead>
              <tbody id="shorthandTableBody">
                <tr>
                  <td colspan="3" class="text-muted small text-center">Linked builders will appear here.</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" role="switch" id="shortNameToggle">
            <label class="form-check-label" for="shortNameToggle">Use short names in tables</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Done</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
