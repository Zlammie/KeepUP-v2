<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Saved Contacts</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/assets/css/main.css">
  <style>
    .task-drawer {
      position: fixed;
      top: 64px;
      right: 0;
      height: calc(100vh - 64px);
      width: 340px;
      max-width: 90vw;
      background: #fff;
      box-shadow: -16px 0 30px rgba(15, 26, 58, 0.12);
      transform: translateX(110%);
      transition: transform 0.3s ease;
      z-index: 999;
    }
    body.task-panel-open .task-drawer {
      transform: translateX(0);
    }
    .task-drawer-backdrop {
      position: fixed;
      top: 64px;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(15, 26, 58, 0.35);
      z-index: 998;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
    }
    body.task-panel-open .task-drawer-backdrop {
      opacity: 1;
      pointer-events: auto;
    }
    .task-drawer-contact {
      font-size: 0.85rem;
      color: #475467;
    }
    .todo-close {
      border: none;
      background: transparent;
      font-size: 1.25rem;
      line-height: 1;
      cursor: pointer;
      color: #0f172a;
    }
  </style>
</head>
<body class="container mt-5" data-current-user-id="<%= currentUser ? currentUser.id : '' %>">
  <%- include('../partials/nav') %>
  <%- include('../partials/top-nav-contacts') %>
    <!-- TOP BAR -->
  <div id="contactsTopBar" class="contact-topbar">
    <div class="topbar-left">
      <label for="communitySelect" class="visually-hidden">Community</label>
      <select id="communitySelect" class="form-select form-select-sm">
        <!-- populated by JS -->
      </select>
      <div class="topbar-total">
        <span class="total-label">Total:</span>
        <span id="countTotal" class="total-value">0</span>
      </div>
    </div>

    <div class="topbar-filters" id="statusFilters">
      <!-- each pill shows label + count; JS updates the counts -->
      <button class="status-pill active" data-status="all">
        <span class="label">All</span>
        <span class="value" data-count="all">0</span>
      </button>
      <button class="status-pill" data-status="new">
        <span class="label">New</span>
        <span class="value" data-count="new">0</span>
      </button>
      <button class="status-pill" data-status="target">
        <span class="label">Target</span>
        <span class="value" data-count="target">0</span>
      </button>
      <button class="status-pill" data-status="possible">
        <span class="label">Possible</span>
        <span class="value" data-count="possible">0</span>
      </button>
      <button class="status-pill" data-status="negotiation">
        <span class="label">Negotiation</span>
        <span class="value" data-count="negotiation">0</span>
      </button>
      <button class="status-pill" data-status="be-back">
        <span class="label">Be-Back</span>
        <span class="value" data-count="be-back">0</span>
      </button>
      <button class="status-pill" data-status="purchased">
        <span class="label">Purchased</span>
        <span class="value" data-count="purchased">0</span>
      </button>
    </div>
      <button id="toggleFilterMode" class="btn btn-sm btn-outline-secondary">
    More
  </button>
  <button id="toggleDeleteMode" class="btn btn-sm btn-outline-danger">
  Delete
</button>
  <button id="resetFilters" class="btn btn-sm btn-outline-secondary">
  Reset
</button>
  </div>
  <div id="contactsUtilityBar" class="contacts-utility-bar">
    <div id="contactsSearchWrapper" class="utility-search">
      <label for="contactsSearchInput" class="visually-hidden">Search contacts</label>
      <input
        type="search"
        id="contactsSearchInput"
        class="form-control form-control-sm"
        placeholder="Search by name, email, or phone"
        autocomplete="off"
      />
    </div>
    <button type="button" id="inlineAddLeadBtn" class="btn btn-primary btn-sm utility-add-btn">
      <img src="/assets/icons/add-circle-icon.svg" alt="Add lead" />
      <span>Add Lead</span>
    </button>
  </div>

  <form id="inlineLeadForm" class="contacts-inline-form d-none" autocomplete="off">
    <div class="row g-2 align-items-end">
      <div class="col-sm-6 col-lg">
        <label for="inlineFirstName" class="form-label">First Name</label>
        <input type="text" id="inlineFirstName" name="firstName" class="form-control form-control-sm" required />
      </div>
      <div class="col-sm-6 col-lg">
        <label for="inlineLastName" class="form-label">Last Name</label>
        <input type="text" id="inlineLastName" name="lastName" class="form-control form-control-sm" />
      </div>
      <div class="col-sm-6 col-lg">
        <label for="inlineEmail" class="form-label">Email</label>
        <input type="email" id="inlineEmail" name="email" class="form-control form-control-sm" />
      </div>
      <div class="col-sm-6 col-lg">
        <label for="inlinePhone" class="form-label">Phone</label>
        <input type="tel" id="inlinePhone" name="phone" class="form-control form-control-sm" />
      </div>
      <div class="col-sm-6 col-lg">
        <label for="inlineVisitDate" class="form-label">Visit Date</label>
        <input type="date" id="inlineVisitDate" name="visitDate" class="form-control form-control-sm" />
      </div>
      <div class="col-sm-6 col-lg">
        <label for="inlineStatus" class="form-label">Status</label>
        <select id="inlineStatus" name="status" class="form-select form-select-sm">
          <option value="New">New</option>
          <option value="Target">Target</option>
          <option value="Possible">Possible</option>
          <option value="Negotiation">Negotiation</option>
          <option value="Be-Back">Be-Back</option>
          <option value="Purchased">Purchased</option>
          <option value="Cold">Cold</option>
          <option value="Closed">Closed</option>
          <option value="Not-Interested">Not Interested</option>
          <option value="Deal-Lost">Deal Lost</option>
          <option value="Bust">Bust</option>
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-success btn-sm">Save Lead</button>
      </div>
      <div class="col-auto">
        <button type="button" id="cancelInlineLead" class="btn btn-outline-secondary btn-sm">Cancel</button>
      </div>
    </div>
  </form>
  <table class="table table-bordered contacts-table" id="contactsTable">
   <thead>
      <tr>
        <th class="contact-table-icons"><span class="visually-hidden">Actions</span></th>
        <th><span class="visually-hidden">View</span></th>    <!-- View button -->
        <th id="visitDateHeader" style="cursor:pointer;">Visit Date<span id="visitDateArrow">▲▼</span></th>
        <th>First Name</th>
        <th>Last Name</th>
        <th>Email</th>
        <th>Phone</th>
        <th>Status</th>
        <th class="col-delete d-none"><span class="visually-hidden">Delete</span></th>
      </tr>
  </thead>
    <tbody></tbody>
  </table>

<div id="commentModal" class="modal-overlay" style="display: none;">
  <div class="modal-content">
    <h5>Add Comment</h5>

    <!-- ✅ ICON NAV BAR (copied from contact-details style) -->
    <div class="comment-type-nav" id="modal-comment-type-buttons">
      <button type="button" data-type="Note" class="active" title="Note">
        <img src="/assets/icons/note.svg" alt="Note" />
      </button>
      <button type="button" data-type="Phone" title="Phone">
        <img src="/assets/icons/phone.svg" alt="Phone" />
      </button>
      <button type="button" data-type="Email" title="Email">
        <img src="/assets/icons/email.svg" alt="Email" />
      </button>
      <button type="button" data-type="Text" title="Text">
        <img src="/assets/icons/sms.svg" alt="Text" />
      </button>
    </div>

    <textarea id="modal-comment-text" rows="4" placeholder="Add a comment..."></textarea>
    <br />
    <button id="saveModalComment" class="btn btn-primary btn-sm">Save</button>
    <button id="cancelModalComment" class="btn btn-secondary btn-sm">Cancel</button>
  </div>
</div>

<div id="task-drawer-backdrop" class="task-drawer-backdrop" hidden></div>
<aside id="todo-panel" class="todo-panel task-drawer" aria-live="polite" hidden>
  <header class="todo-header">
    <div class="task-drawer-header">
      <button id="todo-toggle" class="todo-toggle" type="button" aria-expanded="true">
        <span class="todo-toggle-icon" aria-hidden="true">&#9662;</span>
        <span class="todo-toggle-text">Tasks</span>
        <span id="todo-count" class="todo-count">0</span>
      </button>
      <button type="button" class="todo-close" data-task-drawer-close aria-label="Close task drawer">&times;</button>
    </div>
    <div class="task-drawer-contact" id="task-panel-contact-name"></div>
    <button id="todo-add" class="todo-add-btn" type="button">
      <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
      <span>Add Task</span>
    </button>
  </header>
  <section id="todo-panel-body" class="todo-body">
    <div class="todo-summary">
      <button type="button" class="todo-pill is-active" data-filter="all">
        <span class="pill-label">All</span>
        <span class="pill-count" aria-hidden="true">0</span>
      </button>
      <button type="button" class="todo-pill" data-filter="Pending">
        <span class="pill-label">Pending</span>
        <span class="pill-count" aria-hidden="true">0</span>
      </button>
      <button type="button" class="todo-pill" data-filter="Completed">
        <span class="pill-label">Completed</span>
        <span class="pill-count" aria-hidden="true">0</span>
      </button>
    </div>

    <section class="todo-automation" data-followup-schedule>
      <div class="todo-automation-text">
        <p class="todo-automation-title">Follow-up schedule</p>
        <p class="todo-automation-body">Use your saved cadence to auto-create the next touchpoints for this contact.</p>
      </div>
      <div class="todo-automation-controls">
        <select
          id="followup-schedule-select"
          class="todo-automation-select"
          data-followup-select
          aria-label="Select a follow-up schedule"
          disabled>
          <option value="">Loading schedules...</option>
        </select>
        <button type="button" class="todo-automation-button" data-followup-apply disabled>Assign</button>
      </div>
      <div class="todo-automation-active" data-followup-active hidden>
        <div class="todo-automation-active-copy">
          <p class="todo-automation-active-label">Current schedule</p>
          <p class="todo-automation-active-name" data-followup-active-name></p>
          <p class="todo-automation-active-meta" data-followup-active-meta></p>
        </div>
        <button type="button" class="todo-automation-unassign" data-followup-unassign>Unassign</button>
      </div>
      <p class="todo-automation-status" data-followup-status aria-live="polite" hidden></p>
    </section>

    <ul id="todo-list" class="todo-list">
      <li class="todo-empty">
        <div class="todo-empty-state">
          <img src="/assets/icons/add_task.svg" alt="" aria-hidden="true" />
          <p class="todo-empty-text">No tasks yet. Add one to keep this contact moving forward.</p>
        </div>
      </li>
    </ul>
    <footer class="todo-footer">
      <button id="todo-view-all" class="todo-view-all-btn" type="button">View All Tasks</button>
    </footer>
  </section>
</aside>

<div id="task-modal" class="task-modal" aria-hidden="true" hidden>
  <div class="task-modal__backdrop" data-task-modal-close></div>
  <div class="task-modal__dialog" role="dialog" aria-modal="true" aria-labelledby="task-modal-title">
    <header class="task-modal__header">
      <h2 id="task-modal-title">Edit Task</h2>
      <button type="button" id="task-modal-close" class="task-modal__close" aria-label="Close task editor">&times;</button>
    </header>
    <form id="task-modal-form" class="task-modal__form" novalidate>
      <div class="task-modal__content">
        <div class="task-modal__row">
          <label for="task-modal-title-input">Title</label>
          <input id="task-modal-title-input" name="title" type="text" maxlength="160" required />
        </div>
        <div class="task-modal__row">
          <span class="task-modal__row-label">Task Type</span>
          <div id="task-type-buttons" class="task-type-group" role="group" aria-label="Task type">
            <button type="button" class="task-type-button is-selected" data-type="Follow-Up" aria-pressed="true">Follow-Up</button>
            <button type="button" class="task-type-button" data-type="Document" aria-pressed="false">Document</button>
            <button type="button" class="task-type-button" data-type="Approval" aria-pressed="false">Approval</button>
            <button type="button" class="task-type-button" data-type="Review" aria-pressed="false">Review</button>
            <button type="button" class="task-type-button" data-type="Custom" aria-pressed="false">Custom</button>
          </div>
          <div id="task-followup-sub" class="task-type-subgroup" hidden aria-hidden="true">
            <span class="task-type-subtitle">Follow-Up via</span>
            <div class="task-type-subbuttons" role="group" aria-label="Follow-up method">
              <button type="button" class="task-type-subbutton is-selected" data-followup="Follow-Up" aria-pressed="true">General</button>
              <button type="button" class="task-type-subbutton" data-followup="Call" aria-pressed="false">Call</button>
              <button type="button" class="task-type-subbutton" data-followup="Email" aria-pressed="false">Email</button>
              <button type="button" class="task-type-subbutton" data-followup="Meeting" aria-pressed="false">Meeting</button>
            </div>
          </div>
        </div>
        <div class="task-modal__row">
          <span class="task-modal__row-label">Assign task to</span>
          <div id="task-assignee-options" class="task-modal__assignees">
            <label class="task-modal__assignee">
              <input type="checkbox" id="task-assign-contact" checked>
              Contact
            </label>
            <label class="task-modal__assignee" id="task-assignee-realtor">
              <input type="checkbox" id="task-assign-realtor">
              Realtor
              <span class="task-assignee-note">(if available)</span>
            </label>
            <label class="task-modal__assignee" id="task-assignee-lender">
              <input type="checkbox" id="task-assign-lender">
              Lender
              <select id="task-lender-select" aria-label="Select lender" disabled></select>
            </label>
          </div>
        </div>
        <div class="task-modal__grid two-col">
          <div class="task-modal__row">
            <label for="task-modal-due">Due date</label>
            <input id="task-modal-due" name="dueDate" type="date" />
          </div>
          <div class="task-modal__row">
            <label for="task-modal-priority">Priority</label>
            <select id="task-modal-priority" name="priority"></select>
          </div>
        </div>
        <div class="task-modal__row">
          <label for="task-modal-reminder-date">Reminder (optional)</label>
          <div class="task-modal__reminder-grid">
            <input id="task-modal-reminder-date" name="reminderDate" type="date" />
            <input id="task-modal-reminder-time" name="reminderTime" type="time" />
          </div>
          <p class="task-modal__hint">Pick a date and time to get nudged about this task.</p>
        </div>
        <div class="task-modal__grid two-col">
          <div class="task-modal__row">
            <label for="task-modal-status">Status</label>
            <select id="task-modal-status" name="status"></select>
          </div>
        </div>
        <div class="task-modal__row">
          <label for="task-modal-notes">Notes</label>
          <textarea id="task-modal-notes" name="description" rows="4" maxlength="2000"></textarea>
        </div>
      </div>
      <p id="task-modal-error" class="task-modal__error" role="alert" hidden></p>
      <div class="task-modal__actions">
        <div class="task-modal__actions-left">
          <button type="button" id="task-modal-complete" class="task-modal__secondary">Mark as Completed</button>
        </div>
        <div class="task-modal__actions-right">
          <button type="button" id="task-modal-cancel" class="task-modal__secondary">Cancel</button>
          <button type="submit" id="task-modal-save" class="task-modal__primary">Save Changes</button>
        </div>
      </div>
    </form>
  </div>
</div>

<script type="module" src="/assets/js/contacts/index.js"></script>



</body>
</html>

