  <main class="add-lead-wrapper">
    <h1>Add a New Floor Plan</h1>

    <form id="floorPlanForm" class="mb-5">
      <div class="mb-3">
        <label for="planNumber" class="form-label">Floor Plan #</label>
        <input id="planNumber" class="form-control" name="planNumber" required />
      </div>
      <div class="mb-3">
        <label for="name" class="form-label">Floor Plan Name</label>
        <input id="name" class="form-control" name="name" required />
      </div>
      <div class="row g-3">
        <div class="col-md-3">
          <label for="squareFeet" class="form-label">Square Feet</label>
          <input id="squareFeet" class="form-control" name="squareFeet" type="number" min="0" required />
        </div>
        <div class="col-md-3">
          <label for="beds" class="form-label">Beds</label>
          <input id="beds" class="form-control" name="beds" type="number" min="0" required />
        </div>
        <div class="col-md-3">
          <label for="baths" class="form-label">Baths</label>
          <input id="baths" class="form-control" name="baths" type="number" step="0.5" min="0" required />
        </div>
        <div class="col-md-3">
          <label for="garage" class="form-label">Garage Spaces</label>
          <input id="garage" class="form-control" name="garage" type="number" min="0" required />
        </div>
      </div>
      <div class="mb-3 mt-3">
        <label for="communities" class="form-label">Communities</label>
        <select id="communities" class="form-select" name="communities" multiple required>
          <!-- Options populated via JS -->
        </select>
        <div class="form-text">Hold Ctrl/Cmd to select multiple communities.</div>
      </div>
      <button type="submit" class="btn btn-primary">Create Floor Plan</button>
      <div id="statusMsg" class="status mt-2"></div>
    </form>

    <section class="mt-4" id="existingPlansSection">
      <h2 class="h4">Existing Floor Plans</h2>
      <div class="table-responsive">
        <table class="table table-striped table-sm align-middle" id="plansTable">
          <thead>
            <tr>
              <th scope="col">Plan #</th>
              <th scope="col">Name</th>
              <th scope="col">Square Feet</th>
              <th scope="col">Beds</th>
              <th scope="col">Baths</th>
              <th scope="col">Garage</th>
              <th scope="col">Communities</th>
              <th scope="col">Created</th>
              <th scope="col">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="9" class="text-center text-muted">Loading floor plans...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>

  <div id="editPlanModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="max-width: 520px; width: 100%;">
      <div class="d-flex justify-content-between align-items-start mb-3">
        <div>
          <h5 class="mb-1">Edit Floor Plan Communities</h5>
          <p class="text-muted mb-0" id="editPlanSummary"></p>
        </div>
        <button type="button" class="btn-close" aria-label="Close" id="closeEditPlan"></button>
      </div>
      <form id="editPlanForm" autocomplete="off">
        <div class="mb-3">
          <label for="editCommunities" class="form-label">Communities</label>
          <select id="editCommunities" class="form-select" multiple></select>
          <div class="form-text">Hold Ctrl/Cmd to select multiple communities.</div>
        </div>
        <div class="d-flex justify-content-end gap-2">
          <button type="button" class="btn btn-outline-secondary" id="cancelEditPlan">Cancel</button>
          <button type="submit" class="btn btn-primary">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script nonce="<%= cspNonce %>">
    document.addEventListener('DOMContentLoaded', () => {
      const form = document.getElementById('floorPlanForm');
      const statusEl = document.getElementById('statusMsg');
      const communitiesSelect = document.getElementById('communities');
      const plansTableBody = document.querySelector('#plansTable tbody');
      const editModal = document.getElementById('editPlanModal');
      const editForm = document.getElementById('editPlanForm');
      const editCommunitiesSelect = document.getElementById('editCommunities');
      const editPlanSummary = document.getElementById('editPlanSummary');
      const closeEditPlanBtn = document.getElementById('closeEditPlan');
      const cancelEditPlanBtn = document.getElementById('cancelEditPlan');

      const communitiesMap = new Map();
      let plansCache = [];
      let currentEditPlanId = null;

      const html = String.raw;

      const planIdOf = (plan) => {
        if (!plan) return '';
        const id = plan._id ?? plan.id;
        return id ? String(id) : '';
      };

      const normalizeCommunityId = (entry) => {
        if (!entry) return null;
        if (typeof entry === 'string') return entry;
        if (typeof entry === 'object') {
          const id = entry._id ?? entry.id ?? entry.value;
          return id ? String(id) : null;
        }
        return null;
      };

      const getCommunityIds = (plan) => {
        if (!plan || !Array.isArray(plan.communities)) return [];
        return plan.communities
          .map(normalizeCommunityId)
          .filter(Boolean);
      };

      const getCommunityLabels = (plan) => {
        if (!plan || !Array.isArray(plan.communities)) return [];
        return plan.communities
          .map((entry) => {
            if (!entry) return null;
            if (typeof entry === 'string') {
              return communitiesMap.get(entry) || '(unknown)';
            }
            if (typeof entry === 'object') {
              const id = entry._id ?? entry.id ?? entry.value;
              const label = entry.name || entry.communityName || communitiesMap.get(String(id)) || '(unknown)';
              if (id && label && label !== '(unknown)' && !communitiesMap.has(String(id))) {
                communitiesMap.set(String(id), label);
              }
              return label || '(unknown)';
            }
            return '(unknown)';
          })
          .filter(Boolean);
      };

      function populateSelectOptions(select) {
        if (!select) return;
        select.innerHTML = '';
        communitiesMap.forEach((label, id) => {
          const option = document.createElement('option');
          option.value = id;
          option.textContent = label;
          select.appendChild(option);
        });
      }

      function setStatus(message, isError = false) {
        if (!statusEl) return;
        statusEl.textContent = message || '';
        statusEl.classList.toggle('text-danger', isError);
        statusEl.classList.toggle('text-success', !isError && message);
      }

      function renderCommunities(communities) {
        communitiesMap.clear();
        communities.forEach((c) => {
          const id = c && (c._id ?? c.id);
          if (!id) return;
          const label = c.name || c.communityName || '(unnamed)';
          communitiesMap.set(String(id), label);
        });

        populateSelectOptions(communitiesSelect);
        populateSelectOptions(editCommunitiesSelect);
      }

      function renderPlans(plans) {
        if (!plans.length) {
          plansTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No floor plans yet.</td></tr>';
          return;
        }

        const rows = plans.map(plan => {
          const specs = plan.specs || {};
          const communityLabels = getCommunityLabels(plan).filter(Boolean);

          const created = plan.createdAt ? new Date(plan.createdAt) : null;
          const planId = planIdOf(plan);
          const actionCell = planId
            ? `<button type="button" class="btn btn-sm btn-outline-primary" data-action="edit-plan" data-plan-id="${planId}">Edit</button>`
            : '<span class="text-muted">N/A</span>';

          return html`<tr>
            <td>${plan.planNumber || ''}</td>
            <td>${plan.name || ''}</td>
            <td>${specs.squareFeet ?? ''}</td>
            <td>${specs.beds ?? ''}</td>
            <td>${specs.baths ?? ''}</td>
            <td>${specs.garage ?? ''}</td>
            <td>${communityLabels.length ? communityLabels.join(', ') : 'None'}</td>
            <td>${created && !Number.isNaN(created.valueOf()) ? created.toLocaleString() : 'N/A'}</td>
            <td>${actionCell}</td>
          </tr>`;
        });

        plansTableBody.innerHTML = rows.join('');
      }

      async function loadCommunities() {
        const res = await fetch('/api/communities');
        if (!res.ok) throw new Error(`GET /api/communities -> ${res.status}`);
        return res.json();
      }

      async function loadPlans() {
        const res = await fetch('/api/floorplans');
        if (!res.ok) throw new Error(`GET /api/floorplans -> ${res.status}`);
        return res.json();
      }

      async function hydrate() {
        try {
          const [communities, plans] = await Promise.all([loadCommunities(), loadPlans()]);
          renderCommunities(communities);
          plansCache = plans;
          renderPlans(plansCache);
        } catch (err) {
          console.error('Failed to hydrate page:', err);
          plansTableBody.innerHTML = '<tr><td colspan="9" class="text-center text-danger">Failed to load floor plans.</td></tr>';
        }
      }

      function prependPlan(plan) {
        const newId = planIdOf(plan);
        plansCache = [plan, ...plansCache.filter(p => planIdOf(p) !== newId)];
        renderPlans(plansCache);
      }

      function setEditModalVisible(visible) {
        if (!editModal) return;
        editModal.style.display = visible ? 'flex' : 'none';
        if (!visible) {
          currentEditPlanId = null;
          if (editForm) editForm.reset();
          if (editPlanSummary) editPlanSummary.textContent = '';
        }
      }

      function openEditModal(planId) {
        if (!planId || !editCommunitiesSelect) return;
        const plan = plansCache.find((p) => planIdOf(p) === String(planId));
        if (!plan) return;

        currentEditPlanId = String(planId);
        if (editPlanSummary) {
          const parts = [];
          if (plan.planNumber) parts.push(`#${plan.planNumber}`);
          if (plan.name) parts.push(plan.name);
          editPlanSummary.textContent = parts.join(' â€¢ ') || 'Selected floor plan';
        }

        populateSelectOptions(editCommunitiesSelect);
        const selectedIds = new Set(getCommunityIds(plan));
        Array.from(editCommunitiesSelect.options).forEach((opt) => {
          opt.selected = selectedIds.has(opt.value);
        });

        setEditModalVisible(true);
      }

      function closeEditModal() {
        setEditModalVisible(false);
      }

      plansTableBody.addEventListener('click', (event) => {
        const btn = event.target.closest('[data-action="edit-plan"]');
        if (!btn) return;
        const planId = btn.getAttribute('data-plan-id');
        if (planId) openEditModal(planId);
      });

      cancelEditPlanBtn?.addEventListener('click', closeEditModal);
      closeEditPlanBtn?.addEventListener('click', closeEditModal);
      editModal?.addEventListener('click', (event) => {
        if (event.target === editModal) closeEditModal();
      });
      document.addEventListener('keydown', (event) => {
        if (event.key === 'Escape' && editModal && editModal.style.display === 'flex') {
          closeEditModal();
        }
      });

      editForm?.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!currentEditPlanId || !editCommunitiesSelect) return;

        const selectedCommunities = Array.from(editCommunitiesSelect.selectedOptions, (opt) => opt.value);

        try {
          const res = await fetch(`/api/floorplans/${encodeURIComponent(currentEditPlanId)}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ communities: selectedCommunities })
          });

          if (!res.ok) {
            const payload = await res.json().catch(() => ({}));
            throw new Error(payload.error || `Request failed (${res.status})`);
          }

          const updatedPlan = await res.json();
          const updatedId = planIdOf(updatedPlan) || currentEditPlanId;
          plansCache = plansCache.map((plan) => (planIdOf(plan) === updatedId ? updatedPlan : plan));
          renderPlans(plansCache);
          setStatus(`Updated communities for ${updatedPlan.name || updatedPlan.planNumber || 'floor plan'}`);
          closeEditModal();
        } catch (error) {
          console.error('Update floor plan failed:', error);
          setStatus(`Error: ${error.message}`, true);
        }
      });

      form.addEventListener('submit', async (event) => {
        event.preventDefault();
        setStatus('');

        const payload = {
          planNumber: document.getElementById('planNumber').value.trim(),
          name: document.getElementById('name').value.trim(),
          specs: {
            squareFeet: Number(document.getElementById('squareFeet').value) || 0,
            beds: Number(document.getElementById('beds').value) || 0,
            baths: Number(document.getElementById('baths').value) || 0,
            garage: Number(document.getElementById('garage').value) || 0
          },
          communities: Array.from(communitiesSelect.selectedOptions, opt => opt.value)
        };

        try {
          const res = await fetch('/api/floorplans', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!res.ok) {
            const errorPayload = await res.json().catch(() => ({}));
            throw new Error(errorPayload.error || `Request failed (${res.status})`);
          }

          const plan = await res.json();
          setStatus(`Created Floor Plan: ${plan.planNumber} - ${plan.name}`);
          form.reset();
          prependPlan(plan);
        } catch (error) {
          console.error('Create floor plan failed:', error);
          setStatus(`Error: ${error.message}`, true);
        }
      });

      hydrate();
    });
  </script>
</body>
</html>

