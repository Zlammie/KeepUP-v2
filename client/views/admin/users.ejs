<!DOCTYPE html>
<html>
<head><title>Users</title></head>
<body>

  <p>
  <a href="/admin/companies" class="btn btn-primary">+ Add Company</a>
</p>
  <h1>Users</h1>

  
  <table border="1" cellpadding="4" cellspacing="0">
  <tr>
    <th>Email</th>
    <th>Roles</th>
    <th>Company</th>
    <th>Communities</th>
    <th>Active</th>
    <th>Actions</th>
    <th>Manage</th>
  </tr>

  <% users.forEach(u => { %>
    <tr>
      <td><%= u.email %></td>
      <td><%= Array.isArray(u.roles) ? u.roles.join(', ') : (u.role || '') %></td>
      <td><%= u.company?.name || '' %></td>

     <td>
      <% if (Array.isArray(u.allowedCommunityIds) && u.allowedCommunityIds.length) { %>
        <%= u.allowedCommunityIds.map(c => c.name).join(', ') %>
      <% } else { %>
        <em>All (company)</em>
      <% } %>
    </td>

      <td><%= u.isActive ? 'Yes' : 'No' %></td>

      <td>
        <form method="POST" action="/admin/users/<%= u._id %>" style="display:inline">
          <select name="role">
            <option value="USER" <%= (u.roles||[]).includes('USER')?'selected':'' %>>USER</option>
            <option value="MANAGER" <%= (u.roles||[]).includes('MANAGER')?'selected':'' %>>MANAGER</option>
            <option value="COMPANY_ADMIN" <%= (u.roles||[]).includes('COMPANY_ADMIN')?'selected':'' %>>COMPANY_ADMIN</option>
            <% /* SUPER option omitted on purpose in UI */ %>
          </select>
          <select name="isActive">
            <option value="true"  <%= u.isActive?'selected':'' %>>Active</option>
            <option value="false" <%= !u.isActive?'selected':'' %>>Inactive</option>
          </select>
          <input name="password" type="password" placeholder="(optional) new password"/>
          <button type="submit">Update</button>
        </form>
      </td>

      <td class="text-nowrap">
        <a class="btn btn-sm btn-outline-secondary"
           href="/admin/users/<%= u._id %>/communities">Manage</a>
      </td>
    </tr>
  <% }) %>
</table>

  <p class="text-muted">
    User creation now lives in the Admin Section &rarr; Impersonation tab (SUPER ADMIN only).
  </p>
</body>
</html>
